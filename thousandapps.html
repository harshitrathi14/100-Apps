<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBFC Quant Toolbox (1000 Apps v4.0)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif; background-color: #f8fafc; }
    .scroll-table { max-height: 25rem; overflow: auto; }
    .tab-btn.active { background-color: #eef2ff; color: #4338ca; border-color: #6366f1; }
    .file-input {
      display: block;
      width: 100%;
      font-size: 0.875rem;
      color: #4b5563;
      cursor: pointer;
    }
    .file-input::file-selector-button {
      margin-right: 1rem;
      border: 0;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      background-color: #e0e7ff;
      color: #3730a3;
      cursor: pointer;
    }
    .file-input::file-selector-button:hover { background-color: #c7d2fe; }
    /* Securitisation Suite Specifics */
    .sec-input { @apply w-full border rounded p-2 text-sm font-mono; }
    .panel-hidden { display: none; }

    /* === ENHANCED NAVIGATION STYLES === */
    .nav-search { position: relative; }
    .nav-search input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; font-size: 0.875rem; }
    .nav-search input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    .nav-search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
    .nav-search-kbd { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: #f1f5f9; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; color: #64748b; font-family: monospace; }

    .filter-chip { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; background: #f1f5f9; color: #475569; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
    .filter-chip:hover { background: #e2e8f0; }
    .filter-chip.active { background: #eef2ff; color: #4338ca; border-color: #c7d2fe; }
    .filter-chip svg { width: 14px; height: 14px; }

    .dept-tabs { display: flex; gap: 0.25rem; border-bottom: 1px solid #e2e8f0; overflow-x: auto; }
    .dept-tab { padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 500; color: #64748b; background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap; transition: all 0.15s; }
    .dept-tab:hover { color: #334155; background: #f8fafc; }
    .dept-tab.active { color: #4338ca; border-bottom-color: #6366f1; }

    .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; max-height: 400px; overflow-y: auto; padding: 0.5rem; }
    .tool-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; cursor: pointer; transition: all 0.15s; }
    .tool-card:hover { border-color: #c7d2fe; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1); }
    .tool-card.selected { border-color: #6366f1; background: #eef2ff; }
    .tool-card-title { font-size: 0.875rem; font-weight: 600; color: #1e293b; margin-bottom: 0.25rem; }
    .tool-card-desc { font-size: 0.75rem; color: #64748b; line-height: 1.4; }
    .tool-card-cat { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-top: 0.5rem; }

    .category-sidebar { min-width: 200px; border-right: 1px solid #e2e8f0; padding-right: 1rem; }
    .category-item { padding: 0.5rem 0.75rem; font-size: 0.8125rem; color: #475569; border-radius: 0.375rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .category-item:hover { background: #f8fafc; }
    .category-item.active { background: #eef2ff; color: #4338ca; font-weight: 500; }
    .category-count { font-size: 0.6875rem; background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 9999px; color: #64748b; }

    /* Save/Load Toolbar */
    .save-toolbar { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
    .save-toolbar button { padding: 0.375rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
    .save-toolbar .btn-save { background: #10b981; color: white; border: none; }
    .save-toolbar .btn-save:hover { background: #059669; }
    .save-toolbar .btn-load { background: #3b82f6; color: white; border: none; }
    .save-toolbar .btn-load:hover { background: #2563eb; }
    .save-toolbar select { padding: 0.375rem 0.5rem; font-size: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; background: white; }
    .save-status { font-size: 0.6875rem; color: #64748b; margin-left: auto; }

    /* Virtual scroll container */
    .virtual-scroll { position: relative; overflow-y: auto; }
    .virtual-scroll-content { position: relative; }
    .virtual-scroll-items { position: absolute; top: 0; left: 0; right: 0; }
  </style>
</head>
<body class="text-slate-900">
  <div class="min-h-screen flex flex-col">
    <header class="bg-slate-900 text-slate-50 shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">NBFC Quant Toolbox</h1>
          <p class="text-xs text-slate-400">1000+ Tools: Lending, Risk, Treasury, Collections, Compliance & More</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="backup-btn" class="text-xs text-slate-400 hover:text-slate-200 flex items-center gap-1" title="Export/Import Data">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
            Backup
          </button>
          <div class="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full">v4.0 · 1000 Apps</div>
        </div>
      </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6 space-y-6">
      <!-- Enhanced Tool Navigator -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200">
        <!-- Search Bar -->
        <div class="nav-search mb-4">
          <svg class="nav-search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" id="tool-search" placeholder="Search 1000+ tools... (e.g., EMI, NPA, XIRR, FOIR)" autocomplete="off">
          <span class="nav-search-kbd">Ctrl+K</span>
        </div>

        <!-- Quick Filters -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="filter-chip" data-filter="favorites">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
            Favorites
          </button>
          <button class="filter-chip" data-filter="recent">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Recent
          </button>
          <button class="filter-chip active" data-filter="all">All Tools</button>
        </div>

        <!-- Department Tabs -->
        <div class="dept-tabs mb-4" id="dept-tabs">
          <button class="dept-tab active" data-dept="all">All</button>
          <button class="dept-tab" data-dept="Retail Lending">Lending</button>
          <button class="dept-tab" data-dept="Treasury & ALM">Treasury</button>
          <button class="dept-tab" data-dept="Risk & Compliance">Risk</button>
          <button class="dept-tab" data-dept="Collections">Collections</button>
          <button class="dept-tab" data-dept="Operations">Operations</button>
          <button class="dept-tab" data-dept="MSME & Corporate">MSME</button>
          <button class="dept-tab" data-dept="Securitisation">Securitisation</button>
        </div>

        <!-- Tool Grid -->
        <div class="tool-grid" id="tool-grid"></div>

        <!-- Fallback: Classic Dropdown (hidden by default, shown on small screens) -->
        <div class="mt-4 pt-4 border-t border-slate-100">
          <label class="block text-xs font-medium text-slate-500 mb-2">Or use dropdown:</label>
          <select id="tool-select" class="block w-full sm:w-96 rounded-lg border-slate-300 border py-2 px-3 text-sm shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></select>
        </div>
      </section>

      <!-- Tool Header -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200 space-y-2">
        <h2 id="tool-title" class="text-xl font-bold text-slate-800"></h2>
        <p id="tool-desc" class="text-sm text-slate-600"></p>
      </section>

      <!-- Input Format Guide -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200">
        <details>
          <summary class="cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-800">View Input Requirements & Usage Guide</summary>
          <div class="mt-4 space-y-4">
            <div>
              <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">CSV Columns Required</h3>
              <div class="overflow-x-auto border rounded-lg">
                <table class="min-w-full text-xs">
                  <thead class="bg-slate-100">
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold border-b">Column</th>
                      <th class="px-3 py-2 text-left font-semibold border-b">Description</th>
                      <th class="px-3 py-2 text-center font-semibold border-b w-16">Req</th>
                    </tr>
                  </thead>
                  <tbody id="input-format-body"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">How to Use</h3>
              <ul id="usage-list" class="list-disc list-inside text-xs text-slate-700 space-y-1"></ul>
            </div>
          </div>
        </details>
      </section>

      <!-- Main Tool Container -->
      <section class="bg-white shadow-lg rounded-xl p-1 border border-slate-200 min-h-[600px]">
        <div id="tool-container" class="p-4"></div>
      </section>
    </main>

    <footer class="border-t border-slate-200 text-xs text-slate-500 py-6 bg-white mt-8">
      <div class="max-w-7xl mx-auto px-4 flex justify-between">
        <span>Runs 100% locally in browser. No server uploads.</span>
        <span>Generated by Gemini</span>
      </div>
    </footer>
  </div>

<script>
/**
 * ============================================================================
 * NBFC STORAGE - Persistence Layer (IndexedDB + LocalStorage)
 * ============================================================================
 */
const NBFCStorage = (() => {
  const DB_NAME = 'NBFCQuantToolbox';
  const DB_VERSION = 1;
  let db = null;

  // ============ INITIALIZATION ============
  async function init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => { db = request.result; resolve(db); };
      request.onupgradeneeded = (event) => {
        const database = event.target.result;
        if (!database.objectStoreNames.contains('preferences')) {
          database.createObjectStore('preferences', { keyPath: 'key' });
        }
        if (!database.objectStoreNames.contains('toolState')) {
          const ts = database.createObjectStore('toolState', { keyPath: 'id' });
          ts.createIndex('toolId', 'toolId', { unique: false });
          ts.createIndex('updatedAt', 'updatedAt', { unique: false });
        }
        if (!database.objectStoreNames.contains('datasets')) {
          const ds = database.createObjectStore('datasets', { keyPath: 'id' });
          ds.createIndex('toolId', 'toolId', { unique: false });
          ds.createIndex('createdAt', 'createdAt', { unique: false });
        }
      };
    });
  }

  function ensureDb() { if (!db) throw new Error('DB not initialized'); return db; }
  function generateId() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16); }); }

  // ============ PREFERENCES (LocalStorage for sync access) ============
  const Preferences = {
    STORAGE_KEY: 'nbfc_prefs',
    defaults: { theme: 'light', lastToolId: 'securitisationSuite', recentTools: [], favorites: [], autoSaveEnabled: true },
    get() { try { const s = localStorage.getItem(this.STORAGE_KEY); return s ? { ...this.defaults, ...JSON.parse(s) } : { ...this.defaults }; } catch { return { ...this.defaults }; } },
    set(prefs) { try { localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ ...this.get(), ...prefs, updatedAt: Date.now() })); return true; } catch { return false; } },
    update(key, value) { const p = this.get(); p[key] = value; return this.set(p); },
    addRecentTool(toolId) { const p = this.get(); const r = p.recentTools.filter(t => t !== toolId); r.unshift(toolId); p.recentTools = r.slice(0, 15); this.set(p); },
    toggleFavorite(toolId) { const p = this.get(); const i = p.favorites.indexOf(toolId); if (i === -1) p.favorites.push(toolId); else p.favorites.splice(i, 1); this.set(p); return p.favorites; },
    isFavorite(toolId) { return this.get().favorites.includes(toolId); }
  };

  // ============ TOOL STATE (IndexedDB) ============
  const ToolState = {
    async save(toolId, inputs, options = {}) {
      const database = ensureDb();
      const slotName = options.slotName || 'default';
      const existing = await this.get(toolId, slotName);
      const record = { id: `${toolId}_${slotName}`, toolId, slotName, displayName: options.displayName || `${toolId}`, inputs, datasetRefs: options.datasetRefs || [], createdAt: existing?.createdAt || Date.now(), updatedAt: Date.now() };
      return new Promise((resolve, reject) => { const tx = database.transaction('toolState', 'readwrite'); const req = tx.objectStore('toolState').put(record); req.onsuccess = () => resolve(record); req.onerror = () => reject(req.error); });
    },
    async get(toolId, slotName = 'default') {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('toolState', 'readonly'); const req = tx.objectStore('toolState').get(`${toolId}_${slotName}`); req.onsuccess = () => resolve(req.result || null); req.onerror = () => reject(req.error); });
    },
    async listForTool(toolId) {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('toolState', 'readonly'); const req = tx.objectStore('toolState').index('toolId').getAll(IDBKeyRange.only(toolId)); req.onsuccess = () => resolve(req.result || []); req.onerror = () => reject(req.error); });
    },
    async delete(toolId, slotName = 'default') {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('toolState', 'readwrite'); const req = tx.objectStore('toolState').delete(`${toolId}_${slotName}`); req.onsuccess = () => resolve(true); req.onerror = () => reject(req.error); });
    }
  };

  // ============ DATASETS (Large CSV/Results Data) ============
  const Datasets = {
    async save(toolId, data, options = {}) {
      const database = ensureDb();
      const record = { id: options.id || generateId(), toolId, type: options.type || 'csv', name: options.name || 'Dataset', data, rowCount: Array.isArray(data) ? data.length : 1, sizeBytes: new Blob([JSON.stringify(data)]).size, createdAt: options.createdAt || Date.now(), updatedAt: Date.now() };
      return new Promise((resolve, reject) => { const tx = database.transaction('datasets', 'readwrite'); const req = tx.objectStore('datasets').put(record); req.onsuccess = () => resolve(record); req.onerror = () => reject(req.error); });
    },
    async get(id) {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('datasets', 'readonly'); const req = tx.objectStore('datasets').get(id); req.onsuccess = () => resolve(req.result || null); req.onerror = () => reject(req.error); });
    },
    async listForTool(toolId) {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('datasets', 'readonly'); const req = tx.objectStore('datasets').index('toolId').getAll(IDBKeyRange.only(toolId)); req.onsuccess = () => resolve(req.result || []); req.onerror = () => reject(req.error); });
    },
    async delete(id) {
      const database = ensureDb();
      return new Promise((resolve, reject) => { const tx = database.transaction('datasets', 'readwrite'); const req = tx.objectStore('datasets').delete(id); req.onsuccess = () => resolve(true); req.onerror = () => reject(req.error); });
    }
  };

  // ============ BACKUP/EXPORT ============
  const Backup = {
    async exportAll() {
      const database = ensureDb();
      const exp = { version: DB_VERSION, exportedAt: new Date().toISOString(), preferences: Preferences.get(), toolStates: [], datasets: [] };
      await new Promise(r => { const tx = database.transaction('toolState', 'readonly'); const req = tx.objectStore('toolState').getAll(); req.onsuccess = () => { exp.toolStates = req.result; r(); }; });
      await new Promise(r => { const tx = database.transaction('datasets', 'readonly'); const req = tx.objectStore('datasets').getAll(); req.onsuccess = () => { exp.datasets = req.result; r(); }; });
      return exp;
    },
    async downloadBackup() {
      const data = await this.exportAll();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `nbfc-toolbox-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
      URL.revokeObjectURL(url);
    },
    async importBackup(jsonData) {
      const database = ensureDb();
      const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
      if (!data.toolStates || !data.datasets) throw new Error('Invalid backup format');
      if (data.preferences) Preferences.set(data.preferences);
      const stx = database.transaction('toolState', 'readwrite'); data.toolStates.forEach(s => stx.objectStore('toolState').put(s));
      const dtx = database.transaction('datasets', 'readwrite'); data.datasets.forEach(d => dtx.objectStore('datasets').put(d));
      return { toolStates: data.toolStates.length, datasets: data.datasets.length };
    }
  };

  // ============ CLEANUP ============
  const Cleanup = {
    async getStats() {
      const database = ensureDb();
      let totalSize = 0, toolStateCount = 0, datasetCount = 0;
      await new Promise(r => { const tx = database.transaction('toolState', 'readonly'); const req = tx.objectStore('toolState').getAll(); req.onsuccess = () => { toolStateCount = req.result.length; totalSize += new Blob([JSON.stringify(req.result)]).size; r(); }; });
      await new Promise(r => { const tx = database.transaction('datasets', 'readonly'); const req = tx.objectStore('datasets').getAll(); req.onsuccess = () => { datasetCount = req.result.length; totalSize += req.result.reduce((s, d) => s + (d.sizeBytes || 0), 0); r(); }; });
      return { totalSize, toolStateCount, datasetCount, totalSizeMB: (totalSize / 1024 / 1024).toFixed(2) };
    },
    async clearAll() {
      const database = ensureDb();
      for (const store of ['preferences', 'toolState', 'datasets']) { await new Promise(r => { const tx = database.transaction(store, 'readwrite'); tx.objectStore(store).clear().onsuccess = r; }); }
      localStorage.removeItem('nbfc_prefs');
      return true;
    }
  };

  return { init, Preferences, ToolState, Datasets, Backup, Cleanup, generateId };
})();

/**
 * ============================================================================
 * CENTRAL CONFIGURATION & METADATA
 * ============================================================================
 */
const TOOL_METADATA = [
  // --- SECURITISATION ---
  { id: 'securitisationSuite', title: 'Indian Securitisation AI Suite', shortDescription: 'End-to-end PTC modeling: Waterfall, Gaussian Copula LE, Pricing, Term Sheet.', type: 'securitisationSuite', category: 'Securitisation',
    inputColumns: [
      { name: 'period', description: 'YYYY-MM-DD', required: true },
      { name: 'pool_principal', description: 'Collection Amount', required: true },
      { name: 'pool_interest', description: 'Collection Amount', required: true },
    ],
    usageNotes: ['Complete suite for PTC transactions.', '1. Waterfall: Define structure & run flow.', '2. LE: Run simulation for Credit Enhancement.', '3. Docs: Generate Term Sheet.']
  },
  // --- RETAIL LENDING ---
  { id: 'retailEligibility', title: 'Retail Eligibility (FOIR)', shortDescription: 'Max loan calculator based on Income & Obligations.', type: 'retailEligibility', category: 'Retail Lending', inputColumns: [], usageNotes: ['Enter Net Income & EMIs to get Max Loan.'] },
  { id: 'lapCalculator', title: 'Loan Against Property (LAP)', shortDescription: 'LTV vs FOIR eligibility check.', type: 'lapCalculator', category: 'Retail Lending', inputColumns: [], usageNotes: ['Compares Property-based vs Income-based limits.'] },
  { id: 'educationLoan', title: 'Education Loan Structurer', shortDescription: 'Moratorium interest & capitalization.', type: 'educationLoan', category: 'Retail Lending', inputColumns: [], usageNotes: ['Structures loan with study-period interest logic.'] },
  // --- MSME & CORPORATE ---
  { id: 'scfDiscounting', title: 'Supply Chain / Invoice Discounting', shortDescription: 'Net disbursement & yield calculator.', type: 'scfDiscounting', category: 'MSME & Corporate', inputColumns: [], usageNotes: ['Calculates upfront discount and effective yield.'] },
  { id: 'wholesaleRatios', title: 'Corporate Financial Analysis', shortDescription: 'Financial statement spreading & ratio analysis.', type: 'wholesaleRatios', category: 'MSME & Corporate', inputColumns: [], usageNotes: ['Enter financials to get DSCR, DE, Current Ratio.'] },
  { id: 'coLending', title: 'Co-Lending Structurer', shortDescription: 'Blended rate & spread calculator for 80:20 deals.', type: 'coLending', category: 'MSME & Corporate', inputColumns: [], usageNotes: ['Input Bank/NBFC share to get Blended Rate.'] },
  // --- RISK & COMPLIANCE ---
  { id: 'npaProvisioning', title: 'NPA & Provisioning (IRAC)', shortDescription: 'Asset classification & provisioning per RBI norms.', type: 'npaProvisioning', category: 'Risk & Compliance',
    inputColumns: [{ name: 'loan_id', description: 'ID', required: true }, { name: 'os_balance', description: 'OS', required: true }, { name: 'dpd', description: 'DPD', required: true }], usageNotes: ['Calculates provisions: 0.4% (Std), 15/25% (SS), etc.']
  },
  { id: 'staticPool', title: 'Static Pool Analyzer', shortDescription: 'Vintage analysis heatmap (Triangular View).', type: 'staticPool', category: 'Risk & Compliance',
    inputColumns: [{ name: 'vintage', description: 'YYYY-MM', required: true }, { name: 'mob', description: 'Month', required: true }, { name: 'value', description: 'Metric', required: true }], usageNotes: ['Generates cohort analysis table.']
  },
  { id: 'geoPerformance', title: 'Geo Performance Visualiser', shortDescription: 'State/district AUM & PAR view.', type: 'geo', category: 'Risk & Compliance',
    inputColumns: [{ name: 'state', description: 'Region', required: true }, { name: 'aum', description: 'OS', required: true }], usageNotes: ['Visualise geographic risk.']
  },
  // --- TREASURY & ALM ---
  { id: 'xirr', title: 'XIRR & Cashflow Analyzer', shortDescription: 'Account-wise and portfolio XIRR.', type: 'xirr', category: 'Treasury & ALM',
    inputColumns: [{ name: 'account_id', description: 'ID', required: true }, { name: 'date', description: 'YYYY-MM-DD', required: true }, { name: 'amount', description: 'Cashflow', required: true }], usageNotes: ['Upload raw cashflows. Negative=disbursal.']
  },
  { id: 'hpr', title: 'HPR & Annualised Return', shortDescription: 'Holding period returns for securities.', type: 'hpr', category: 'Treasury & ALM',
    inputColumns: [{ name: 'instrument_id', description: 'ID', required: true }, { name: 'purchase_date', description: 'Date', required: true }, { name: 'sale_date', description: 'Date', required: true }, { name: 'purchase_value', description: 'Price', required: true }, { name: 'sale_value', description: 'Price', required: true }], usageNotes: ['Upload instrument ledger.']
  },
  { id: 'almStress', title: 'ALM Stress & Duration Lab', shortDescription: 'Parallel + twist scenarios.', type: 'alm', category: 'Treasury & ALM',
    inputColumns: [{ name: 'bucket_months', description: 'Tenor', required: true }, { name: 'cashflow', description: 'Amount', required: true }, { name: 'yield_pct', description: 'Yield %', required: true }], usageNotes: ['Duration/Convexity analysis.']
  },
  { id: 'macro', title: 'Macro / CMIE Dashboard', shortDescription: 'GDP & CPI quick view.', type: 'macro', category: 'Treasury & ALM', inputColumns: [], usageNotes: ['Pre-loaded macro indicators.'] },
  { id: 'daCalculator', title: 'DA Upfront Income Calculator', shortDescription: 'Manual + pool CSV calc.', type: 'da', category: 'Securitisation',
    inputColumns: [{ name: 'POS', description: 'Principal', required: true }, { name: 'End borrower Rate', description: 'Yield', required: true }, { name: 'Residual Tenure', description: 'Mths', required: true }], usageNotes: ['Calculate IO strip value.']
  },
  { id: 'regValidator', title: 'Regulatory Return Validator', shortDescription: 'CRILC / RBI schema QC.', type: 'regValidator', category: 'Risk & Compliance', inputColumns: [], usageNotes: ['Checks CSV schema.'] },
  { id: 'ews', title: 'Early Warning Scorecard', shortDescription: 'DPD + bureau + bounce triggers.', type: 'ews', category: 'Collections', inputColumns: [{ name: 'loan_id', description: 'ID', required: true }, { name: 'dpd', description: 'DPD', required: true }], usageNotes: ['Classifies risk categories.'] }
];

const PROTOTYPE_APPS = [
  // Retail Lending
  { id: 'homeLoanEligibility', title: 'Home Loan Eligibility', shortDescription: 'FOIR + LTV with stamp duty and insurance adders.', usageNotes: ['Input income, property value, duties, existing EMIs.'], type: 'homeLoanEligibility', category: 'Retail Lending',
    inputColumns: [{ name: 'income', description: 'Monthly net income', required: true }, { name: 'existing_emi', description: 'Current EMIs', required: true }, { name: 'property_value', description: 'Property value', required: true }] },
  { id: 'autoLoanStructurer', title: 'Auto Loan On-Road Structurer', shortDescription: 'On-road price breakup, margin, FOIR & tenure.', usageNotes: ['Enter ex-showroom, taxes, accessories, and income.'], type: 'autoLoanStructurer', category: 'Retail Lending',
    inputColumns: [{ name: 'income', description: 'Monthly net income', required: true }, { name: 'existing_emi', description: 'Other EMIs', required: true }] },
  { id: 'goldLoanLtv', title: 'Gold Loan LTV Optimizer', shortDescription: 'LTV vs per-gram price and auction buffer.', usageNotes: ['Enter karat, grams, market price, and margin.'], type: 'goldLoanLtv', category: 'Retail Lending',
    inputColumns: [{ name: 'karat', description: 'Purity (K)', required: true }, { name: 'grams', description: 'Gold weight', required: true }, { name: 'price_per_gram', description: 'INR/gram', required: true }] },
  { id: 'plTopUp', title: 'Personal Loan Top-Up Calculator', shortDescription: 'Top-up eligibility net of foreclosure and charges.', usageNotes: ['Enter OS balance, rate, remaining tenor, new rate.'], type: 'plTopUp', category: 'Retail Lending',
    inputColumns: [{ name: 'os_balance', description: 'Outstanding', required: true }, { name: 'remaining_tenor_m', description: 'Months left', required: true }, { name: 'income', description: 'Monthly income', required: true }] },
  { id: 'btSavings', title: 'Balance Transfer Savings Estimator', shortDescription: 'EMI and interest savings after BT with fees.', usageNotes: ['Compare current EMI vs proposed EMI and one-time fees.'], type: 'btSavings', category: 'Retail Lending',
    inputColumns: [{ name: 'os_balance', description: 'Outstanding', required: true }, { name: 'remaining_tenor_m', description: 'Months left', required: true }] },
  { id: 'mfiGroupSplitter', title: 'Microfinance Group Loan Splitter', shortDescription: 'Group-level and member-level ticket sizing.', usageNotes: ['Enter group income, member list, and repeat vs new.'], type: 'mfiGroupSplitter', category: 'Microfinance',
    inputColumns: [{ name: 'name', description: 'Member name', required: true }, { name: 'income', description: 'Monthly income', required: true }, { name: 'status', description: 'repeat/new', required: true }] },
  // MSME / Corporate
  { id: 'wcGap', title: 'Working Capital Gap Analyzer', shortDescription: 'Net working capital vs drawing power.', usageNotes: ['Enter inventory, receivables, payables, bank margins.'], type: 'prototype', category: 'MSME & Corporate' },
  { id: 'ccDp', title: 'Cash-Credit DP Calculator', shortDescription: 'Stock and book debts net of margins and ineligibles.', usageNotes: ['Upload stock & debtor aging; set margin %.'], type: 'prototype', category: 'MSME & Corporate' },
  { id: 'billDiscountLimit', title: 'Bill Discounting Limit Setter', shortDescription: 'Limit sizing from turnover, acceptances, and tenor.', usageNotes: ['Enter turnover, average acceptance days, dilution %.'], type: 'prototype', category: 'MSME & Corporate' },
  { id: 'projFinanceDscr', title: 'Project Finance DSCR Builder', shortDescription: 'DSCR timeline with moratorium and ballooning.', usageNotes: ['Upload project cash flows; set debt profile.'], type: 'prototype', category: 'MSME & Corporate' },
  { id: 'consortiumAllocator', title: 'Consortium Share Allocator', shortDescription: 'Bank-wise share, security, and rate splits.', usageNotes: ['Enter facility amount and bank participation %.'], type: 'prototype', category: 'MSME & Corporate' },
  { id: 'fxCoverage', title: 'FX Forward Coverage Planner', shortDescription: 'Coverage ladder vs payable schedule.', usageNotes: ['Upload currency payables; set hedge ratio and tenor.'], type: 'prototype', category: 'Treasury & ALM' },
  // Cards & BNPL
  { id: 'cardLimitEngine', title: 'Credit Card Limit Engine', shortDescription: 'Limit setting using income, bureau, and utilization.', usageNotes: ['Enter income, bureau score, utilization bands.'], type: 'prototype', category: 'Cards & Digital' },
  { id: 'revolverProfit', title: 'Revolver vs Transactor Profitability', shortDescription: 'Profit bridge by revolve share and costs.', usageNotes: ['Input revolve rate, MDR, funding cost, rewards %.'], type: 'prototype', category: 'Cards & Digital' },
  { id: 'bnplTenorPricing', title: 'BNPL Tenor Pricing Tool', shortDescription: 'Tenor-wise MDR, subvention, and NPV.', usageNotes: ['Enter ticket size, MDR/subvention %, loss %, CoF.'], type: 'prototype', category: 'Cards & Digital' },
  { id: 'mdrSimulator', title: 'MDR & Interchange Simulator', shortDescription: 'Take rate decomposition and net yield.', usageNotes: ['Enter scheme fees, issuer/acquirer splits, FX fees.'], type: 'prototype', category: 'Cards & Digital' },
  { id: 'emiConversionPicker', title: 'EMI Conversion Offer Picker', shortDescription: 'Best plan given fee, tenure, and uptake.', usageNotes: ['Input fee %, tenure options, expected adoption.'], type: 'prototype', category: 'Cards & Digital' },
  { id: 'rewardsLiability', title: 'Rewards Liability Forecaster', shortDescription: 'Accrual vs redemption and breakage.', usageNotes: ['Enter earn/burn rates, avg points value, expiry.'], type: 'prototype', category: 'Cards & Digital' },
  // Collections & Recovery
  { id: 'ptpTracker', category: 'Collections & Recovery', title: 'Promise-to-Pay Tracker', shortDescription: 'PTP capture, hit-rate, and slippage monitor.', usageNotes: ['Upload PTP log with dates, amounts, status.'], type: 'ptpTracker' },
  { id: 'settlementOptimizer', category: 'Collections & Recovery', title: 'Settlement Offer Optimizer', shortDescription: 'Optimal settlement curves by bucket.', usageNotes: ['Set bucket-wise min %, cost-to-collect, recoveries.'], type: 'settlementOptimizer' },
  { id: 'rollRateCube', category: 'Collections & Recovery', title: 'Roll-Rate Cube Visualizer', shortDescription: 'DPD migration matrix over time.', usageNotes: ['Upload DPD snapshots; see heatmap and stability.'], type: 'rollRateCube' },
  { id: 'cureForecast', category: 'Collections & Recovery', title: 'Cure Rate Forecast', shortDescription: 'Forecast cures using logistic fit.', usageNotes: ['Upload bucketed cures; tool fits curve for outlook.'], type: 'cureForecast' },
  { id: 'fieldRoute', category: 'Collections & Recovery', title: 'Field Ops Route Planner', shortDescription: 'Route prioritisation by amount and proximity.', usageNotes: ['Upload address+amount; set max visits/day.'], type: 'fieldRoute' },
  { id: 'legalRoi', category: 'Collections & Recovery', title: 'Legal Bucket ROI Calculator', shortDescription: 'Compare legal costs vs expected recoveries.', usageNotes: ['Enter claim amount, fees, win rate, timeline.'], type: 'legalRoi' },
  // Credit Policy & Scoring
  { id: 'policyMatrix', title: 'Policy Matrix Validator', shortDescription: 'Rules vs portfolio hit-rate.', usageNotes: ['Upload rules and portfolio; see pass/fail % and overrides.'], type: 'prototype', category: 'Underwriting & Policy' },
  { id: 'thinFileScore', title: 'Thin File Surrogate Score', shortDescription: 'Alternate data weights for thin files.', usageNotes: ['Enter bureau flags, bank statements, device signals.'], type: 'prototype', category: 'Underwriting & Policy' },
  { id: 'bureauCutoff', title: 'Bureau Score Cutoff Optimizer', shortDescription: 'Cutoff vs approval and loss trade-off.', usageNotes: ['Upload score vs loss; get KS/Gini and max profit.'], type: 'prototype', category: 'Underwriting & Policy' },
  { id: 'incomeUplift', title: 'Income Surrogate Uplift Analyzer', shortDescription: 'Incremental approvals from surrogate income.', usageNotes: ['Upload declared vs surrogate income; see lift.'], type: 'prototype', category: 'Underwriting & Policy' },
  { id: 'fraudRules', title: 'Fraud Rule Hit-Rate Tracker', shortDescription: 'Rule-wise hit, precision, and recall.', usageNotes: ['Upload rule hits and confirmed fraud tags.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'riskPricingGrid', title: 'Risk-Based Pricing Grid Builder', shortDescription: 'Price grid by risk bands and LTV/FOIR.', usageNotes: ['Define bands; export pricing matrix.'], type: 'prototype', category: 'Pricing & Profitability' },
  // Risk Analytics
  { id: 'pdLgdEad', title: 'PD/LGD/EAD Calibrator', shortDescription: 'Binning + WoE and calibration.', usageNotes: ['Upload defaults/non-defaults; set binning strategy.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'vintageCnl', title: 'Vintage CNL & NCL Tracker', shortDescription: 'Cumulative loss tracking by vintage.', usageNotes: ['Upload vintage loss data; view CNL/NCL curves.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'parTriangle', title: 'PAR/DPD Triangle Explorer', shortDescription: 'PAR matrix across MOB and vintages.', usageNotes: ['Upload PAR by MOB; see heatmap and peaks.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'ccfCalc', title: 'CCF Calculator for Unused Limits', shortDescription: 'CCF by product, utilisation, and behavior.', usageNotes: ['Upload limit/utilisation; set product CCFs.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'stressLoss', title: 'Stress Loss Attribution', shortDescription: 'Impact of PD/LGD shocks separately.', usageNotes: ['Set PD/LGD shocks; tool decomposes loss lift.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'giniKs', title: 'Gini/KS Model Validation', shortDescription: 'Scorecard validation metrics.', usageNotes: ['Upload scores with good/bad; get KS/Gini/Lift.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'delinqLadder', category: 'Collections & Recovery', title: 'Delinquency Ladder Converter', shortDescription: 'Map PAR/DPD ladder to lifetime loss and annualised spread.', usageNotes: ['Input PAR30/60/90, cure rates, LGD, WAL to get implied loss and bps.'], type: 'delinqLadder' },
  { id: 'productMixRisk', category: 'Risk & Pricing', title: 'Product Mix Risk Uplift', shortDescription: 'Weighted risk premium by product PD/LGD and prepay.', usageNotes: ['Enter product share, PD, LGD, prepay to get weighted spread.'], type: 'productMixRisk' },
  { id: 'severityFrequency', category: 'Risk & Pricing', title: 'Severity vs Frequency Decomposer', shortDescription: 'Split lifetime loss into PD and LGD levers; price each.', usageNotes: ['Enter PD, LGD, WAL, add-ons to see total spread and lever impact.'], type: 'severityFrequency' },
  // Treasury & Markets
  { id: 'cpPlanner', title: 'CP/CD Issuance Planner', shortDescription: 'Optimal size/tenor vs ALM and investors.', usageNotes: ['Enter cash need, tenor options, investor rates.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'ytwTool', title: 'Bond Yield-to-Worst Tool', shortDescription: 'YTW across call/put schedules.', usageNotes: ['Upload cashflows and call/put dates.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'durationMatch', title: 'Duration Matching Optimizer', shortDescription: 'Match asset/liability duration.', usageNotes: ['Upload buckets; tool suggests rebalancing.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'liqGapBehavioral', title: 'Liquidity Gap (Behavioral)', shortDescription: 'ALM with decay and prepayment assumptions.', usageNotes: ['Upload gaps; set decay/prepay multipliers.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'fxArb', title: 'FX Swap vs Forward Arbitrage Checker', shortDescription: 'Checks covered interest parity.', usageNotes: ['Enter spot, forward, swap points, rates.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'ftpCurve', title: 'FTP Curve Builder', shortDescription: 'Funds transfer pricing term structure.', usageNotes: ['Input market curves; add liquidity and op-cost spreads.'], type: 'prototype', category: 'Treasury & ALM' },
  // Securitisation & Structured
  { id: 'ceBacktest', title: 'CE Sufficiency Back-tester', shortDescription: 'Back-test CE vs historical losses.', usageNotes: ['Upload pool loss curves; test CE % sufficiency.'], type: 'prototype', category: 'Securitisation' },
  { id: 'triggerMonitor', title: 'Trigger Breach Monitor', shortDescription: 'Track OC/CC/DR triggers.', usageNotes: ['Upload monthly pool metrics; flag breaches.'], type: 'prototype', category: 'Securitisation' },
  { id: 'replQc', title: 'Replenishment Pool QC', shortDescription: 'QC checklist for replenishment criteria.', usageNotes: ['Upload candidate pool; see pass/fail.'], type: 'prototype', category: 'Securitisation' },
  { id: 'delinqDiversion', title: 'Delinquency Diversion Scenario', shortDescription: 'Simulate diversion of delinq collections.', usageNotes: ['Set diversion %, stress delinq path.'], type: 'prototype', category: 'Securitisation' },
  { id: 'collateralStrat', title: 'Collateral Stratification Dashboard', shortDescription: 'Strats by LTV, bureau, geography.', usageNotes: ['Upload pool tape; view stratified charts.'], type: 'prototype', category: 'Securitisation' },
  { id: 'waterfallComparator', title: 'Waterfall Comparator', shortDescription: 'Compare structure A vs B outputs.', usageNotes: ['Upload two structures and pools; view diff.'], type: 'prototype', category: 'Securitisation' },
  // Funding & Capital
  { id: 'costOfFunds', title: 'Cost of Funds Tracker', shortDescription: 'Weighted cost by source mix.', usageNotes: ['Enter mix and rate per source; view WAC trend.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'capitalAdequacy', title: 'Capital Adequacy Calculator', shortDescription: 'RWA, CAR, Tier-1 buffers.', usageNotes: ['Upload exposures with risk weights; compute CAR.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'leverageRatio', title: 'Leverage Ratio Monitor', shortDescription: 'Tier-1 capital vs exposure measure.', usageNotes: ['Enter Tier-1 and total exposure; track trend.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'icaapSheet', title: 'ICAAP Scenario Worksheet', shortDescription: 'Scenario-wise capital consumption.', usageNotes: ['Define scenarios; map to RWA and capital.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'ecbVsNcd', title: 'ECB vs NCD Funding Choice', shortDescription: 'Compare all-in cost and covenants.', usageNotes: ['Enter spreads, fees, hedge cost, covenants.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'callableLadder', title: 'Callable vs Non-Callable Ladder', shortDescription: 'Ladder planner for callable paper.', usageNotes: ['Define maturities; view cashflow ladder.'], type: 'prototype', category: 'Treasury & ALM' },
  // Regulatory & Compliance
  { id: 'iracEngine', title: 'IRAC Rule Engine', shortDescription: 'Multi-product IRAC classification.', usageNotes: ['Upload account DPD; get IRAC class & provision.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'indasEcl', title: 'IND-AS ECL Calculator', shortDescription: 'Stage migration and lifetime ECL.', usageNotes: ['Upload stage data, PD/LGD, EAD; compute ECL.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'rbiForms', title: 'RLNG/ALM Form Pack Validator', shortDescription: 'Schema QC for regulatory forms.', usageNotes: ['Upload CSV/XML; get missing/format errors.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'kycCompleteness', title: 'KYC Completeness Checker', shortDescription: 'KYC field gap analysis.', usageNotes: ['Upload KYC dataset; see missing/expired items.'], type: 'prototype', category: 'Operations' },
  { id: 'fatcaCrs', title: 'FATCA/CRS Flagger', shortDescription: 'Flags reportable accounts.', usageNotes: ['Upload customer profile; flag indicia.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'udyamGst', title: 'Udyam/GST Mismatch Detector', shortDescription: 'Cross-check Udyam vs GST data.', usageNotes: ['Upload Udyam and GST extracts; see mismatches.'], type: 'prototype', category: 'Operations' },
  // Ops & Servicing
  { id: 'tatMonitor', title: 'Disbursement TAT Monitor', shortDescription: 'Stage-wise TAT and bottleneck finder.', usageNotes: ['Upload application timestamps; view SLA hits.'], type: 'prototype', category: 'Operations' },
  { id: 'enachForecast', title: 'E-NACH Success Forecaster', shortDescription: 'Predicts success by bank and time.', usageNotes: ['Upload NACH attempts with bank/time; get success lift.'], type: 'prototype', category: 'Operations' },
  { id: 'bounceFee', title: 'Bounce Fee Engine', shortDescription: 'Bounce fee rules and realized collections.', usageNotes: ['Enter product-wise fee rules and bounce counts.'], type: 'prototype', category: 'Operations' },
  { id: 'escrowReco', title: 'Escrow Reconciliation Tool', shortDescription: 'Match escrow credits to loans.', usageNotes: ['Upload bank statement and loan ledger; auto-match.'], type: 'prototype', category: 'Operations' },
  { id: 'pdcTracker', title: 'PDC Inventory Tracker', shortDescription: 'Track PDC status and expiries.', usageNotes: ['Upload PDC register; see expiries and gaps.'], type: 'prototype', category: 'Operations' },
  { id: 'slaDashboard', title: 'Service Request SLA Dashboard', shortDescription: 'SLA adherence for service tickets.', usageNotes: ['Upload SR log with timestamps; see SLA % and breaches.'], type: 'prototype', category: 'Operations' },
  // Pricing & Profitability
  { id: 'nimBridge', title: 'NIM Bridge Analyzer', shortDescription: 'Drivers of NIM movement.', usageNotes: ['Enter asset yield, CoF, OPEX, LLP changes.'], type: 'prototype', category: 'Pricing & Profitability' },
  { id: 'netYield', title: 'Net Yield after Costs', shortDescription: 'Product net yield after all costs.', usageNotes: ['Enter rates, fees, CoF, opex, credit cost.'], type: 'netYield', category: 'Pricing & Profitability' },
  { id: 'feeImpact', title: 'Upfront vs Amortized Fee Impact', shortDescription: 'PV and accrual impact of fees.', usageNotes: ['Enter upfront fee %, tenure, amortization method.'], type: 'feeImpact', category: 'Pricing & Profitability' },
  { id: 'crossSell', title: 'Cross-Sell Take-Rate Forecaster', shortDescription: 'Forecast take-rate and margin.', usageNotes: ['Enter base conversion, uplift factors, margin.'], type: 'crossSell', category: 'Pricing & Profitability' },
  { id: 'prepayPenalty', title: 'Prepayment Penalty Optimizer', shortDescription: 'Optimal prepay charges vs attrition.', usageNotes: ['Input churn sensitivity; see revenue vs retention.'], type: 'prepayPenalty', category: 'Pricing & Profitability' },
  { id: 'lossLeader', title: 'Loss-Leader Payback Calculator', shortDescription: 'Payback period for promo offers.', usageNotes: ['Enter CAC, promo loss, LTV uplift assumptions.'], type: 'lossLeader', category: 'Pricing & Profitability' },
  { id: 'annualLossRate', title: 'Annualised Loss Rate (Risk Premium)', shortDescription: 'Convert lifetime loss to annualised credit spread on amortising loans.', usageNotes: ['Enter principal, coupon, tenor, frequency, prepay %, and lifetime loss % to get annualised risk premium (bps).'], type: 'annualLossRate', category: 'Pricing & Profitability',
    inputColumns: [{ name: 'principal', description: 'Loan amount', required: true }, { name: 'rate', description: 'Annual interest %', required: true }, { name: 'tenor_months', description: 'Months', required: true }, { name: 'freq', description: 'monthly/quarterly', required: false }, { name: 'prepay_rate', description: '% per period', required: false }, { name: 'lifetime_loss_pct', description: '% of orig', required: true }] },
  { id: 'vintageLossForecaster', title: 'Vintage Loss Forecaster', shortDescription: 'Extrapolate partial vintage losses to full lifetime with bands and cushion.', usageNotes: ['Paste MOB, cum loss% data; set horizon; tool projects tail and bps cushion.'], type: 'vintageLossForecaster', category: 'Pricing & Profitability',
    inputColumns: [{ name: 'mob', description: 'Month-on-book', required: true }, { name: 'cum_loss_pct', description: '% cumulative', required: true }] },
  { id: 'stressUplift', title: 'Stress Uplift Recommender', shortDescription: 'Scenario add-ons (bps) for GDP, inflation, and rate shocks.', usageNotes: ['Input base spread and macro shocks to get uplift grid.'], type: 'stressUplift', category: 'Pricing & Profitability' },
  { id: 'coLendFls', title: 'Co-Lending First-Loss Splitter', shortDescription: 'Spread split given FLDG/first-loss share and PD/LGD.', usageNotes: ['Enter pool loss, first-loss %, and share to allocate spread.'], type: 'coLendFls', category: 'Pricing & Profitability' },
  { id: 'bureauPricing', title: 'Bureau Score Cutoff Pricing', shortDescription: 'Discount/premium by score band to hold target ROE.', usageNotes: ['Enter band loss %, CoF, opex, ROE target, base rate.'], type: 'bureauPricing', category: 'Pricing & Profitability' },
  { id: 'excelToolkit', title: 'Excel Daily Toolkit', shortDescription: 'Quick CAGR, % change, EMI utilities.', usageNotes: ['Use mini-calculators that mirror day-to-day Excel tasks.'], type: 'excelToolkit', category: 'Data Quality & Utilities' },
  // Data Quality & Utilities
  { id: 'schemaProfiler', title: 'Schema Profiler', shortDescription: 'Missingness, type, and format scan.', usageNotes: ['Upload CSV; get missing %, invalid formats.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'dedupeResolver', title: 'Duplicate Entity Resolver', shortDescription: 'Fuzzy matching for duplicates.', usageNotes: ['Upload master data; configure match keys.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'outlierDetector', title: 'Outlier Detector', shortDescription: 'Z-score and IQR outlier flags.', usageNotes: ['Upload numeric columns; pick method and threshold.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'dateAmountSanitizer', title: 'Date/Amount Sanitizer', shortDescription: 'Fix date formats and sign flips.', usageNotes: ['Upload raw extract; choose date format; sign rules.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'currencyNormalizer', title: 'Currency/Unit Normalizer', shortDescription: 'Normalize units and FX rates.', usageNotes: ['Upload amounts with units; set FX and unit map.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'masterDiff', title: 'Master Data Diff Tool', shortDescription: 'Diff two masters and highlight changes.', usageNotes: ['Upload old vs new master; see adds/drops/changes.'], type: 'prototype', category: 'Data Quality & Utilities' },
  // Portfolio Monitoring & Dashboards
  { id: 'aumRollforward', title: 'AUM/OS Rollforward Builder', shortDescription: 'Open, disb, collection, prepay, close.', usageNotes: ['Upload monthly flows; tool builds rollforward.'], type: 'prototype', category: 'MIS & Reporting' },
  { id: 'cohortRetention', title: 'Cohort Retention Dashboard', shortDescription: 'Retention curves by cohort.', usageNotes: ['Upload cohort-months; view survival curves.'], type: 'prototype', category: 'MIS & Reporting' },
  { id: 'rbiGeoHeatmap', title: 'Geo Heatmap (RBI Districts)', shortDescription: 'District-level AUM and PAR.', usageNotes: ['Upload district codes and metrics; see map/heat.'], type: 'prototype', category: 'MIS & Reporting' },
  { id: 'segmentProfitTree', title: 'Segment Profitability Tree', shortDescription: 'Waterfall of revenue to PAT by segment.', usageNotes: ['Upload segment P&L; view waterfall.'], type: 'prototype', category: 'MIS & Reporting' },
  { id: 'earlyDelinqPulse', title: 'Early Delinquency Pulse (0–30)', shortDescription: 'Early bucket monitoring.', usageNotes: ['Upload early DPD counts and amounts; view trend.'], type: 'prototype', category: 'MIS & Reporting' },
  { id: 'ntcPerformance', title: 'New-to-Credit Performance Tracker', shortDescription: 'NTC vs existing borrower performance.', usageNotes: ['Upload NTC flag with losses; compare metrics.'], type: 'prototype', category: 'MIS & Reporting' },

  // NEW HIGH-PRIORITY TOOLS
  // Retail Lending
  { id: 'foirCalculator', title: 'FOIR Calculator', shortDescription: 'Fixed Obligation to Income Ratio check.', usageNotes: ['Enter income, existing EMIs, proposed EMI, other obligations.'], type: 'foirCalculator', category: 'Retail Lending' },
  { id: 'emiCalculator', title: 'EMI Calculator', shortDescription: 'Standard EMI calculation with schedule.', usageNotes: ['Enter principal, rate, tenure; get EMI and amortization.'], type: 'emiCalculator', category: 'Retail Lending' },
  { id: 'prepaymentCalculator', title: 'Prepayment Calculator', shortDescription: 'Impact of part/full prepayment on loan.', usageNotes: ['Enter outstanding, rate, remaining tenure, prepay amount.'], type: 'prepaymentCalculator', category: 'Retail Lending' },
  { id: 'stepUpEmi', title: 'Step-Up EMI Calculator', shortDescription: 'Graduated EMI plan with annual increases.', usageNotes: ['Enter loan, rate, tenure, step-up % per year.'], type: 'stepUpEmi', category: 'Retail Lending' },
  { id: 'partPayOptimizer', title: 'Part-Payment Optimizer', shortDescription: 'Reduce EMI vs reduce tenure analysis.', usageNotes: ['Compare prepayment strategies for savings.'], type: 'partPayOptimizer', category: 'Retail Lending' },
  { id: 'rateResetCalc', title: 'Rate Reset Calculator', shortDescription: 'New EMI after MCLR/repo rate change.', usageNotes: ['Enter current EMI, outstanding, remaining tenure, rate change.'], type: 'rateResetCalc', category: 'Retail Lending' },
  { id: 'coBorrowerSplit', title: 'Co-Borrower Income Split', shortDescription: 'Combine incomes for eligibility check.', usageNotes: ['Enter primary and co-borrower incomes, obligations.'], type: 'coBorrowerSplit', category: 'Retail Lending' },
  { id: 'debtConsolidation', title: 'Debt Consolidation Analyzer', shortDescription: 'Consolidate multiple loans into one.', usageNotes: ['Enter existing loans; see consolidated EMI savings.'], type: 'debtConsolidation', category: 'Retail Lending' },

  // Collections
  { id: 'bounceAnalysis', title: 'Bounce Analysis', shortDescription: 'NACH/ECS bounce rate by reason.', usageNotes: ['Upload bounce file with reason codes; view patterns.'], type: 'prototype', category: 'Collections' },
  { id: 'otsCalculator', title: 'OTS Calculator', shortDescription: 'One-time settlement computation.', usageNotes: ['Enter outstanding, provisions, recovery cost; get OTS range.'], type: 'otsCalculator', category: 'Collections' },
  { id: 'dpdBucketReport', title: 'DPD Bucket Report', shortDescription: 'Delinquency bucket analysis.', usageNotes: ['Upload loan tape with DPD; view bucket distribution.'], type: 'prototype', category: 'Collections' },
  { id: 'agentPerformance', title: 'Collection Agent Performance', shortDescription: 'Agent-wise collection efficiency.', usageNotes: ['Upload collection log; view agent metrics and ranking.'], type: 'prototype', category: 'Collections' },
  { id: 'paymentPlanBuilder', title: 'Payment Plan Builder', shortDescription: 'Custom repayment plans for delinquents.', usageNotes: ['Enter overdues, capacity; generate flexible plan.'], type: 'paymentPlanBuilder', category: 'Collections' },
  { id: 'agencyPayout', title: 'Agency Payout Calculator', shortDescription: 'Collection agency commission calc.', usageNotes: ['Enter collections, slab rates; calculate payout.'], type: 'agencyPayout', category: 'Collections' },
  { id: 'recoveryForecast', title: 'Recovery Forecast Model', shortDescription: 'Project future recoveries from NPA pool.', usageNotes: ['Enter NPA pool, historical recovery curve; forecast.'], type: 'prototype', category: 'Collections' },

  // Risk Analytics
  { id: 'eclCalculator', title: 'ECL Calculator (Ind AS 109)', shortDescription: 'Expected Credit Loss computation.', usageNotes: ['Enter EAD, PD, LGD by stage; compute ECL.'], type: 'eclCalculator', category: 'Risk & Compliance' },
  { id: 'pdLgdCalibrator', title: 'PD/LGD/EAD Calibrator', shortDescription: 'Calibrate risk parameters from data.', usageNotes: ['Upload defaults and recoveries; estimate PD, LGD, EAD.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'stageMigration', title: 'Stage Migration Matrix', shortDescription: 'Ind AS 109 stage transition analysis.', usageNotes: ['Upload stage data over time; view migration matrix.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'giniKsTracker', title: 'Gini/KS Score Tracker', shortDescription: 'Model discrimination metrics.', usageNotes: ['Upload score, good/bad flag; compute Gini and KS.'], type: 'giniKsTracker', category: 'Risk & Compliance' },
  { id: 'provisionCoverage', title: 'Provision Coverage Ratio', shortDescription: 'PCR calculation with stage breakdown.', usageNotes: ['Enter provisions and NPAs by stage; compute PCR.'], type: 'provisionCoverage', category: 'Risk & Compliance' },
  { id: 'smaClassification', title: 'SMA Classification Tool', shortDescription: 'SMA-0/1/2 bucket classification.', usageNotes: ['Upload DPD data; classify into SMA buckets.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'writeOffEligibility', title: 'Write-Off Eligibility Checker', shortDescription: 'Check accounts eligible for write-off.', usageNotes: ['Enter DPD, collection efforts; check WO eligibility.'], type: 'writeOffEligibility', category: 'Risk & Compliance' },
  { id: 'concentrationRisk', title: 'Concentration Risk Analyzer', shortDescription: 'Sector/geography/borrower concentration.', usageNotes: ['Upload exposure data; view HHI and concentration.'], type: 'prototype', category: 'Risk & Compliance' },
  { id: 'gnpaNnpaCalc', title: 'GNPA/NNPA Calculator', shortDescription: 'Gross and Net NPA ratios.', usageNotes: ['Enter advances, gross NPA, provisions; compute ratios.'], type: 'gnpaNnpaCalc', category: 'Risk & Compliance' },
  { id: 'parReport', title: 'PAR Report Generator', shortDescription: 'Portfolio at Risk by DPD bucket.', usageNotes: ['Upload loan tape; generate PAR30, PAR60, PAR90.'], type: 'prototype', category: 'Risk & Compliance' },

  // Treasury & ALM
  { id: 'bondYtm', title: 'Bond YTM Calculator', shortDescription: 'Yield to maturity for bonds.', usageNotes: ['Enter coupon, price, maturity, face value; get YTM.'], type: 'bondYtm', category: 'Treasury & ALM' },
  { id: 'durationConvexity', title: 'Duration & Convexity', shortDescription: 'Bond price sensitivity measures.', usageNotes: ['Enter bond details; compute Macaulay/modified duration.'], type: 'durationConvexity', category: 'Treasury & ALM' },
  { id: 'cofCalculator', title: 'Cost of Funds Calculator', shortDescription: 'Blended cost of all funding sources.', usageNotes: ['Enter funding sources with amounts and rates; get blended CoF.'], type: 'cofCalculator', category: 'Treasury & ALM' },
  { id: 'nimBridgeCalc', title: 'NIM Bridge Calculator', shortDescription: 'Break down NIM movement drivers.', usageNotes: ['Enter yield, CoF changes; see NIM waterfall.'], type: 'nimBridgeCalc', category: 'Treasury & ALM' },
  { id: 'lcrNsfrCalc', title: 'LCR/NSFR Calculator', shortDescription: 'Liquidity coverage and stable funding ratios.', usageNotes: ['Enter HQLA, outflows, stable funding; compute ratios.'], type: 'lcrNsfrCalc', category: 'Treasury & ALM' },
  { id: 'ftpCurve', title: 'FTP Curve Builder', shortDescription: 'Funds transfer pricing curve.', usageNotes: ['Enter benchmark rates by tenor; build FTP curve.'], type: 'prototype', category: 'Treasury & ALM' },
  { id: 'rateScenario', title: 'Interest Rate Scenario', shortDescription: 'NII impact under rate shocks.', usageNotes: ['Enter gap profile; apply rate shocks; see NII impact.'], type: 'rateScenario', category: 'Treasury & ALM' },

  // Operations
  { id: 'tatMonitor', title: 'TAT Monitor', shortDescription: 'Turnaround time tracking.', usageNotes: ['Upload process timestamps; view TAT metrics.'], type: 'prototype', category: 'Operations' },
  { id: 'nachStatus', title: 'NACH Status Tracker', shortDescription: 'NACH mandate status monitoring.', usageNotes: ['Upload mandate file; view active/pending/rejected.'], type: 'prototype', category: 'Operations' },
  { id: 'documentChecklist', title: 'Document Checklist', shortDescription: 'Loan document completeness check.', usageNotes: ['Select product; see required documents checklist.'], type: 'documentChecklist', category: 'Operations' },
  { id: 'disbursementQueue', title: 'Disbursement Queue Manager', shortDescription: 'Track pending disbursements.', usageNotes: ['Upload approved loans; prioritize disbursement queue.'], type: 'prototype', category: 'Operations' },
  { id: 'emiScheduleGen', title: 'EMI Schedule Generator', shortDescription: 'Generate printable EMI schedule.', usageNotes: ['Enter loan details; generate and download schedule.'], type: 'emiScheduleGen', category: 'Operations' },
  { id: 'balanceConfirmation', title: 'Balance Confirmation Letter', shortDescription: 'Generate balance confirmation.', usageNotes: ['Enter loan/customer; generate confirmation letter.'], type: 'balanceConfirmation', category: 'Operations' },
  { id: 'foreclosureStatement', title: 'Foreclosure Statement', shortDescription: 'Pre-closure amount calculation.', usageNotes: ['Enter loan; calculate foreclosure amount with charges.'], type: 'foreclosureStatement', category: 'Operations' },
  { id: 'nocGenerator', title: 'NOC Generator', shortDescription: 'No Objection Certificate generator.', usageNotes: ['Enter loan details; generate NOC document.'], type: 'nocGenerator', category: 'Operations' },

  // Regulatory & Compliance
  { id: 'crilcValidator', title: 'CRILC Data Validator', shortDescription: 'Validate CRILC submission format.', usageNotes: ['Upload CRILC file; check for errors and warnings.'], type: 'prototype', category: 'Regulatory & Compliance' },
  { id: 'tdsCalculator', title: 'TDS Calculator', shortDescription: 'TDS on interest/fees calculation.', usageNotes: ['Enter interest amount, PAN status; compute TDS.'], type: 'tdsCalculator', category: 'Regulatory & Compliance' },
  { id: 'form15ghValidator', title: 'Form 15G/15H Validator', shortDescription: 'Validate 15G/H declarations.', usageNotes: ['Upload declarations; check eligibility and limits.'], type: 'prototype', category: 'Regulatory & Compliance' },
  { id: 'kycCompleteness', title: 'KYC Completeness Checker', shortDescription: 'Check KYC document completeness.', usageNotes: ['Enter customer type; check required KYC fields.'], type: 'kycCompleteness', category: 'Regulatory & Compliance' },
  { id: 'amlRiskRating', title: 'AML Risk Rating', shortDescription: 'Customer AML risk classification.', usageNotes: ['Enter customer profile; compute AML risk score.'], type: 'amlRiskRating', category: 'Regulatory & Compliance' },
  { id: 'largeExposure', title: 'Large Exposure Check', shortDescription: 'RBI large exposure limit check.', usageNotes: ['Enter exposure, capital; check LEL compliance.'], type: 'largeExposure', category: 'Regulatory & Compliance' },
  { id: 'carCalculator', title: 'CAR Calculator', shortDescription: 'Capital Adequacy Ratio computation.', usageNotes: ['Enter capital, RWA; compute CRAR.'], type: 'carCalculator', category: 'Regulatory & Compliance' },
  { id: 'pslClassification', title: 'PSL Classification Tool', shortDescription: 'Priority sector lending classification.', usageNotes: ['Enter loan purpose, amount; classify under PSL norms.'], type: 'pslClassification', category: 'Regulatory & Compliance' },
  { id: 'regulatoryCalendar', title: 'Regulatory Calendar', shortDescription: 'RBI/SEBI submission deadlines.', usageNotes: ['View upcoming regulatory filing dates.'], type: 'regulatoryCalendar', category: 'Regulatory & Compliance' },

  // MSME & Corporate
  { id: 'workingCapitalGap', title: 'Working Capital Gap Analyzer', shortDescription: 'WC requirement calculation.', usageNotes: ['Enter inventory, receivables, payables; compute WC gap.'], type: 'workingCapitalGap', category: 'MSME & Corporate' },
  { id: 'dscrCalculator', title: 'DSCR Calculator', shortDescription: 'Debt Service Coverage Ratio.', usageNotes: ['Enter EBITDA, interest, principal; compute DSCR.'], type: 'dscrCalculator', category: 'MSME & Corporate' },
  { id: 'financialSpreading', title: 'Financial Spreading Tool', shortDescription: 'Analyze 3-year financials.', usageNotes: ['Enter P&L and BS data; auto-compute ratios.'], type: 'financialSpreading', category: 'MSME & Corporate' },
  { id: 'cashCreditDp', title: 'Cash Credit DP Calculator', shortDescription: 'Drawing power calculation.', usageNotes: ['Enter debtors, stock, margins; compute DP.'], type: 'cashCreditDp', category: 'MSME & Corporate' },
  { id: 'cgtmseCalculator', title: 'CGTMSE Calculator', shortDescription: 'CGTMSE guarantee fee calculation.', usageNotes: ['Enter loan amount, tenure; compute guarantee fee.'], type: 'cgtmseCalculator', category: 'MSME & Corporate' },
  { id: 'udyamValidator', title: 'Udyam Validator', shortDescription: 'Validate Udyam registration.', usageNotes: ['Enter Udyam number; validate format and lookup.'], type: 'udyamValidator', category: 'MSME & Corporate' },
  { id: 'turnoverMethod', title: 'Turnover Method Limit', shortDescription: 'WC limit by turnover method.', usageNotes: ['Enter turnover, margin; compute permissible limit.'], type: 'turnoverMethod', category: 'MSME & Corporate' },
  { id: 'ratioAnalysis', title: 'Ratio Analysis Dashboard', shortDescription: 'Key financial ratios analysis.', usageNotes: ['Enter financials; view profitability, liquidity ratios.'], type: 'ratioAnalysis', category: 'MSME & Corporate' },
  { id: 'billDiscounting', title: 'Bill Discounting Calculator', shortDescription: 'Discount rate and proceeds.', usageNotes: ['Enter bill amount, tenor, rate; compute proceeds.'], type: 'billDiscounting', category: 'MSME & Corporate' },
  { id: 'msmeClassification', title: 'MSME Classification Tool', shortDescription: 'Classify as Micro/Small/Medium.', usageNotes: ['Enter investment, turnover; classify per RBI norms.'], type: 'msmeClassification', category: 'MSME & Corporate' },

  // Data Quality & Utilities (more)
  { id: 'cagrCalculator', title: 'CAGR Calculator', shortDescription: 'Compound annual growth rate.', usageNotes: ['Enter start value, end value, years; compute CAGR.'], type: 'cagrCalculator', category: 'Data Quality & Utilities' },
  { id: 'irrCalculator', title: 'IRR Calculator', shortDescription: 'Internal rate of return.', usageNotes: ['Enter cash flows; compute IRR.'], type: 'irrCalculator', category: 'Data Quality & Utilities' },
  { id: 'npvCalculator', title: 'NPV Calculator', shortDescription: 'Net present value of cash flows.', usageNotes: ['Enter discount rate, cash flows; compute NPV.'], type: 'npvCalculator', category: 'Data Quality & Utilities' },
  { id: 'dateCalculator', title: 'Date Calculator', shortDescription: 'Date difference and add/subtract.', usageNotes: ['Compute days between dates or add days to date.'], type: 'dateCalculator', category: 'Data Quality & Utilities' },
  { id: 'percentChange', title: 'Percentage Change Calculator', shortDescription: '% change between two values.', usageNotes: ['Enter old and new values; compute % change.'], type: 'percentChange', category: 'Data Quality & Utilities' },
  { id: 'weightedAverage', title: 'Weighted Average Calculator', shortDescription: 'Compute weighted average.', usageNotes: ['Enter values and weights; compute weighted average.'], type: 'weightedAverage', category: 'Data Quality & Utilities' },
  { id: 'csvValidator', title: 'CSV Schema Validator', shortDescription: 'Validate CSV against schema.', usageNotes: ['Define schema; upload CSV; check compliance.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'amountNormalizer', title: 'Amount Normalizer', shortDescription: 'Convert lakhs/crores to numbers.', usageNotes: ['Enter amounts in various formats; normalize.'], type: 'amountNormalizer', category: 'Data Quality & Utilities' },
  { id: 'dateStandardizer', title: 'Date Standardizer', shortDescription: 'Standardize date formats.', usageNotes: ['Upload dates in mixed formats; standardize.'], type: 'prototype', category: 'Data Quality & Utilities' },
  { id: 'unitConverter', title: 'Unit Converter', shortDescription: 'Convert units (lakhs, crores, etc).', usageNotes: ['Enter value, from unit, to unit; convert.'], type: 'unitConverter', category: 'Data Quality & Utilities' },

  // DAY-TO-DAY USAGE TOOLS
  { id: 'lifetimeToSpread', title: 'Lifetime Loss to Annualized Spread', shortDescription: 'Convert lifetime loss to annual risk spread for amortizing loans.', usageNotes: ['Enter principal, rate, tenure, prepay rate, lifetime loss; get annualized spread in bps.'], type: 'lifetimeToSpread', category: 'Pricing & Profitability',
    inputColumns: [{ name: 'principal', description: 'Loan amount', required: true }, { name: 'rate', description: 'Interest rate %', required: true }, { name: 'tenure_months', description: 'Tenure in months', required: true }, { name: 'lifetime_loss', description: 'Lifetime loss %', required: true }] },
  { id: 'xirrCalculator', title: 'XIRR Calculator', shortDescription: 'IRR for irregular cash flows with dates.', usageNotes: ['Enter dates and cash flows; compute XIRR.'], type: 'xirrCalculator', category: 'Data Quality & Utilities' },
  { id: 'loanComparison', title: 'Loan Comparison Tool', shortDescription: 'Compare multiple loan offers side by side.', usageNotes: ['Enter up to 4 loan offers; compare EMI, total cost, effective rate.'], type: 'loanComparison', category: 'Retail Lending' },
  { id: 'rateConverter', title: 'Interest Rate Converter', shortDescription: 'Convert between flat, reducing, APR, EIR.', usageNotes: ['Enter rate in one format; see equivalent in all formats.'], type: 'rateConverter', category: 'Pricing & Profitability' },
  { id: 'breakEvenSpread', title: 'Break-Even Spread Calculator', shortDescription: 'Min spread needed to cover costs and loss.', usageNotes: ['Enter CoF, opex, credit loss, capital cost; get break-even spread.'], type: 'breakEvenSpread', category: 'Pricing & Profitability' },
  { id: 'effectiveRate', title: 'Effective Interest Rate (EIR)', shortDescription: 'True cost of loan with fees and charges.', usageNotes: ['Enter principal, EMI, tenure, processing fee; get effective rate.'], type: 'effectiveRate', category: 'Retail Lending' },
  { id: 'tenureOptimizer', title: 'Tenure Optimizer', shortDescription: 'Optimal tenure for target EMI or total interest.', usageNotes: ['Enter loan amount, rate, and target; find optimal tenure.'], type: 'tenureOptimizer', category: 'Retail Lending' },
  { id: 'moratoriumImpact', title: 'Moratorium Impact Calculator', shortDescription: 'EMI change after moratorium period.', usageNotes: ['Enter loan details and moratorium months; see new EMI and total cost.'], type: 'moratoriumImpact', category: 'Retail Lending' },
  { id: 'floatRateRisk', title: 'Floating Rate Risk Analyzer', shortDescription: 'EMI sensitivity to rate changes.', usageNotes: ['Enter loan details; see EMI at different rate scenarios.'], type: 'floatRateRisk', category: 'Retail Lending' },
  { id: 'loanToValue', title: 'LTV Calculator & Analyzer', shortDescription: 'Loan-to-Value with multiple collaterals.', usageNotes: ['Enter property values and loan; compute LTV with haircuts.'], type: 'loanToValue', category: 'Retail Lending' },
  { id: 'stampDutyCalc', title: 'Stamp Duty & Registration Calculator', shortDescription: 'State-wise stamp duty for loan documents.', usageNotes: ['Select state, document type, loan amount; get duty payable.'], type: 'stampDutyCalc', category: 'Operations' },
  { id: 'penalInterest', title: 'Penal Interest Calculator', shortDescription: 'Calculate penal charges on overdue.', usageNotes: ['Enter overdue amount, DPD, penal rate; get charges.'], type: 'penalInterest', category: 'Collections' },
  { id: 'penalWaiverImpact', title: 'Penal Waiver Yield Impact', shortDescription: 'Impact of penal interest waiver on total yield.', usageNotes: ['Enter loan details and waiver amount; see yield and IRR impact.'], type: 'penalWaiverImpact', category: 'Pricing & Profitability' },
  { id: 'interestOnInterest', title: 'Interest on Interest Calculator', shortDescription: 'Compound interest on unpaid interest.', usageNotes: ['For moratorium/default scenarios; compute IoI.'], type: 'interestOnInterest', category: 'Collections' },
  { id: 'poolYield', title: 'Pool Yield Calculator', shortDescription: 'Weighted average yield of loan pool.', usageNotes: ['Enter loans with amounts and rates; get pool WAY.'], type: 'poolYield', category: 'Securitisation' },
  { id: 'collectionEfficiency', title: 'Collection Efficiency Calculator', shortDescription: 'CE% with different methodologies.', usageNotes: ['Enter demand and collection; compute CE by bucket.'], type: 'collectionEfficiency', category: 'Collections' },
  { id: 'disbursalPacing', title: 'Disbursal Pacing Calculator', shortDescription: 'Monthly disbursal to hit annual target.', usageNotes: ['Enter YTD disbursal and target; get monthly run-rate needed.'], type: 'disbursalPacing', category: 'Operations' },
  { id: 'marginMoney', title: 'Margin Money Calculator', shortDescription: 'Required margin for different products.', usageNotes: ['Enter loan amount and product; get margin requirement.'], type: 'marginMoney', category: 'Retail Lending' },
  { id: 'chequeCalculator', title: 'PDC/RPDC Calculator', shortDescription: 'Generate cheque series for EMI.', usageNotes: ['Enter EMI, start date, tenure; get cheque schedule.'], type: 'chequeCalculator', category: 'Operations' },
  { id: 'gracePeriodCalc', title: 'Grace Period Interest Calculator', shortDescription: 'Interest accrued during grace period.', usageNotes: ['Enter principal, rate, grace days; get accrued interest.'], type: 'gracePeriodCalc', category: 'Operations' },
  { id: 'subventionCalc', title: 'Subvention Calculator', shortDescription: 'Dealer/manufacturer subvention computation.', usageNotes: ['Enter subvention scheme; compute payout and net rate.'], type: 'subventionCalc', category: 'Pricing & Profitability' },
  { id: 'yieldToMaturity', title: 'Portfolio Yield to Maturity', shortDescription: 'YTM of loan portfolio considering prepay.', usageNotes: ['Enter portfolio with prepay assumptions; get YTM.'], type: 'yieldToMaturity', category: 'Treasury & ALM' },
  { id: 'riskAdjustedReturn', title: 'Risk-Adjusted Return (RAROC)', shortDescription: 'Return on capital adjusted for risk.', usageNotes: ['Enter income, loss, capital; compute RAROC.'], type: 'riskAdjustedReturn', category: 'Pricing & Profitability' },
  { id: 'quickRatios', title: 'Quick Financial Ratios', shortDescription: 'Instant ratio calculations.', usageNotes: ['Enter basic financials; get all key ratios at once.'], type: 'quickRatios', category: 'MSME & Corporate' },
  { id: 'amortScheduleAnalyzer', title: 'Amortization Schedule Analyzer', shortDescription: 'Analyze EMI split over loan life.', usageNotes: ['See principal/interest split, cumulative payments by period.'], type: 'amortScheduleAnalyzer', category: 'Retail Lending' },
  { id: 'prepaymentAnalyzer', title: 'Prepayment Impact Analyzer', shortDescription: 'Compare reduce-EMI vs reduce-tenure.', usageNotes: ['Enter prepayment amount; see savings in both scenarios.'], type: 'prepaymentAnalyzer', category: 'Retail Lending' },
];

const ALL_TOOLS = [...TOOL_METADATA, ...PROTOTYPE_APPS];

let selectedToolId = 'securitisationSuite';
const moneyFmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });
const pct = v => isFinite(v) ? (v * 100).toFixed(2) + '%' : '-';

// --- GLOBAL HELPERS ---
function formatDateFlexible(v) {
  if (!v) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const parts = String(v).split(/[\/\-]/);
  if (parts.length === 3) {
    const a = parseInt(parts[0], 10);
    const b = parseInt(parts[1], 10) - 1;
    const c = parseInt(parts[2], 10);
    return new Date(c, b, a);
  }
  return null;
}

function downloadCSV(rows, filename) {
    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Normal Distribution Helpers
const normCdf = (x) => jStat.normal.cdf(x, 0, 1);
const normInv = (p) => jStat.normal.inv(p, 0, 1);

// Loan math helpers
function calcEmi(principal, annualRatePct, months) {
  const r = annualRatePct / 1200;
  if (!principal || !months) return 0;
  if (r === 0) return principal / months;
  const pow = Math.pow(1 + r, months);
  return principal * r * pow / (pow - 1);
}
function loanFromEmi(emi, annualRatePct, months) {
  const r = annualRatePct / 1200;
  if (!emi || !months) return 0;
  if (r === 0) return emi * months;
  const pow = Math.pow(1 + r, months);
  return emi * (pow - 1) / (r * pow);
}

// --- CORE APP LOGIC ---
let currentFilter = 'all';
let currentDept = 'all';
let searchQuery = '';

document.addEventListener('DOMContentLoaded', async () => {
  // Initialize storage
  try {
    await NBFCStorage.init();
    console.log('NBFCStorage initialized');
  } catch (e) {
    console.warn('Storage init failed, running without persistence:', e);
  }

  // Load last used tool from preferences
  const prefs = NBFCStorage.Preferences.get();
  if (prefs.lastToolId && ALL_TOOLS.find(t => t.id === prefs.lastToolId)) {
    selectedToolId = prefs.lastToolId;
  }

  renderSelector();
  renderToolGrid();
  renderMeta();
  renderToolBody();
  setupNavigation();
  setupBackupButton();
});

function getMeta(id) { return ALL_TOOLS.find(t => t.id === id); }

// --- NAVIGATION LOGIC ---
function setupNavigation() {
  // Search input
  const searchInput = document.getElementById('tool-search');
  let searchTimeout;
  searchInput.addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.toLowerCase().trim();
      renderToolGrid();
    }, 150);
  });

  // Keyboard shortcut Ctrl+K
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      searchInput.focus();
      searchInput.select();
    }
  });

  // Filter chips
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentFilter = chip.dataset.filter;
      renderToolGrid();
    });
  });

  // Department tabs
  document.querySelectorAll('.dept-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.dept-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentDept = tab.dataset.dept;
      renderToolGrid();
    });
  });
}

function renderToolGrid() {
  const grid = document.getElementById('tool-grid');
  const prefs = NBFCStorage.Preferences.get();

  let tools = [...ALL_TOOLS];

  // Apply filter
  if (currentFilter === 'favorites') {
    tools = tools.filter(t => prefs.favorites.includes(t.id));
  } else if (currentFilter === 'recent') {
    const recentIds = prefs.recentTools.slice(0, 15);
    tools = recentIds.map(id => ALL_TOOLS.find(t => t.id === id)).filter(Boolean);
  }

  // Apply department filter
  if (currentDept !== 'all') {
    tools = tools.filter(t => {
      const cat = t.category || 'General';
      return cat.toLowerCase().includes(currentDept.toLowerCase());
    });
  }

  // Apply search
  if (searchQuery) {
    tools = tools.filter(t => {
      const searchText = `${t.title} ${t.shortDescription} ${t.id} ${t.category || ''}`.toLowerCase();
      return searchText.includes(searchQuery);
    });
  }

  // Limit display for performance
  const displayTools = tools.slice(0, 50);

  grid.innerHTML = displayTools.length === 0
    ? '<div class="col-span-full text-center text-slate-500 py-8">No tools found. Try a different search or filter.</div>'
    : displayTools.map(t => `
        <div class="tool-card ${t.id === selectedToolId ? 'selected' : ''}" data-id="${t.id}">
          <div class="flex justify-between items-start">
            <div class="tool-card-title">${t.title}</div>
            <button class="fav-btn text-slate-300 hover:text-yellow-500 ${prefs.favorites.includes(t.id) ? 'text-yellow-500' : ''}" data-id="${t.id}" title="Toggle favorite">
              <svg class="w-4 h-4" fill="${prefs.favorites.includes(t.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
            </button>
          </div>
          <div class="tool-card-desc">${t.shortDescription}</div>
          <div class="tool-card-cat">${t.category || 'General'}</div>
        </div>
      `).join('');

  // Tool card click handlers
  grid.querySelectorAll('.tool-card').forEach(card => {
    card.addEventListener('click', e => {
      if (e.target.closest('.fav-btn')) return;
      selectTool(card.dataset.id);
    });
  });

  // Favorite button handlers
  grid.querySelectorAll('.fav-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      NBFCStorage.Preferences.toggleFavorite(btn.dataset.id);
      renderToolGrid();
    });
  });

  // Show count
  if (tools.length > 50) {
    grid.insertAdjacentHTML('beforeend', `<div class="col-span-full text-center text-xs text-slate-400 py-2">Showing 50 of ${tools.length} tools. Use search to narrow down.</div>`);
  }
}

function selectTool(toolId) {
  selectedToolId = toolId;
  NBFCStorage.Preferences.update('lastToolId', toolId);
  NBFCStorage.Preferences.addRecentTool(toolId);
  document.getElementById('tool-select').value = toolId;
  renderToolGrid();
  renderMeta();
  renderToolBody();
}

function setupBackupButton() {
  document.getElementById('backup-btn').addEventListener('click', async () => {
    if (confirm('Download backup of all saved tool data?')) {
      await NBFCStorage.Backup.downloadBackup();
    }
  });
}

// Save/Load Toolbar Helper
function renderSaveToolbar(toolId) {
  return `
    <div class="save-toolbar">
      <button class="btn-save" onclick="saveToolState('${toolId}')">Save</button>
      <select id="${toolId}-slots" class="slots-select">
        <option value="default">Default Slot</option>
      </select>
      <button class="btn-load" onclick="loadToolState('${toolId}')">Load</button>
      <span class="save-status" id="${toolId}-save-status"></span>
    </div>
  `;
}

async function saveToolState(toolId) {
  const inputs = extractToolInputs();
  await NBFCStorage.ToolState.save(toolId, inputs);
  document.getElementById(`${toolId}-save-status`).textContent = `Saved ${new Date().toLocaleTimeString()}`;
}

async function loadToolState(toolId) {
  const slotName = document.getElementById(`${toolId}-slots`)?.value || 'default';
  const state = await NBFCStorage.ToolState.get(toolId, slotName);
  if (state && state.inputs) {
    restoreToolInputs(state.inputs);
    document.getElementById(`${toolId}-save-status`).textContent = 'Loaded!';
  }
}

function extractToolInputs() {
  const inputs = {};
  document.querySelectorAll('#tool-container input, #tool-container select, #tool-container textarea').forEach(el => {
    if (!el.id) return;
    if (el.type === 'checkbox') inputs[el.id] = el.checked;
    else if (el.type === 'number') inputs[el.id] = +el.value;
    else inputs[el.id] = el.value;
  });
  return inputs;
}

function restoreToolInputs(inputs) {
  Object.entries(inputs).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.type === 'checkbox') el.checked = !!value;
    else el.value = value;
  });
}

function renderSelector() {
  const sel = document.getElementById('tool-select');
  sel.innerHTML = '';
  const byCat = {};
  ALL_TOOLS.forEach(t => {
    const cat = t.category || 'General';
    if (!byCat[cat]) byCat[cat] = [];
    byCat[cat].push(t);
  });
  Object.keys(byCat).sort().forEach(cat => {
    const og = document.createElement('optgroup');
    og.label = cat;
    byCat[cat].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.title;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  });
  sel.value = selectedToolId;
  sel.addEventListener('change', e => {
    selectedToolId = e.target.value;
    renderMeta();
    renderToolBody();
  });
}

function renderMeta() {
  const meta = getMeta(selectedToolId);
  if (!meta) return;
  document.getElementById('tool-title').textContent = meta.title;
  document.getElementById('tool-desc').textContent = meta.shortDescription;
  const tbody = document.getElementById('input-format-body');
  tbody.innerHTML = '';
  (meta.inputColumns || []).forEach(col => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-3 py-2 border-t font-mono text-xs">${col.name}</td><td class="px-3 py-2 border-t text-xs">${col.description}</td><td class="px-3 py-2 border-t text-center text-xs">${col.required ? 'Yes' : ''}</td>`;
    tbody.appendChild(tr);
  });
  const usage = document.getElementById('usage-list');
  usage.innerHTML = '';
  meta.usageNotes.forEach(note => {
    const li = document.createElement('li');
    li.textContent = note;
    usage.appendChild(li);
  });
}

function renderToolBody() {
  const meta = getMeta(selectedToolId);
  const container = document.getElementById('tool-container');
  container.innerHTML = '';
  
  const map = {
    securitisationSuite: renderSecuritisationSuite,
    retailEligibility: renderRetailEligibility,
    lapCalculator: renderLAPCalculator,
    educationLoan: renderEducationLoan,
    scfDiscounting: renderSCFDiscounting,
    wholesaleRatios: renderWholesaleRatios,
    xirr: renderXirr,
    hpr: renderHpr,
    staticPool: renderStaticPool,
    geo: renderGeo,
    alm: renderAlm,
    macro: renderMacro,
    da: renderDa,
    regValidator: renderRegValidator,
    ews: renderEws,
    npaProvisioning: renderNpaProvisioning,
    coLending: renderCoLending,
    annualLossRate: renderAnnualLossRate,
    delinqLadder: renderDelinqLadder,
    productMixRisk: renderProductMixRisk,
    netYield: renderNetYield,
    feeImpact: renderFeeImpact,
    crossSell: renderCrossSell,
    prepayPenalty: renderPrepayPenalty,
    lossLeader: renderLossLeader,
    vintageLossForecaster: renderVintageLossForecaster,
    stressUplift: renderStressUplift,
    coLendFls: renderCoLendFls,
    bureauPricing: renderBureauPricing,
    excelToolkit: renderExcelToolkit,
    delinqLadder: renderDelinqLadder,
    productMixRisk: renderProductMixRisk,
    severityFrequency: renderSeverityFrequency,
    ptpTracker: renderPtpTracker,
    settlementOptimizer: renderSettlementOptimizer,
    rollRateCube: renderRollRateCube,
    cureForecast: renderCureForecast,
    fieldRoute: renderFieldRoute,
    legalRoi: renderLegalRoi,
    homeLoanEligibility: renderHomeLoanEligibility,
    autoLoanStructurer: renderAutoLoanStructurer,
    goldLoanLtv: renderGoldLoanLtv,
    plTopUp: renderPlTopUp,
    btSavings: renderBtSavings,
    mfiGroupSplitter: renderMfiGroupSplitter,
    prototype: renderPrototype,
  };
  
  if (map[meta.type]) map[meta.type](meta);
  else container.innerHTML = '<div class="text-gray-500 text-center mt-10">Tool logic loading...</div>';
}

/* ==========================================================================
   1. SECURITISATION AI SUITE (FULL)
   ========================================================================== */
let WF_RES = null, LE_SUMMARY = null, LE_VEC = null;

function renderSecuritisationSuite() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="space-y-6">
        <div class="flex flex-wrap gap-2 border-b border-slate-200 pb-2">
            <button data-tab="waterfall" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50 active">Waterfall</button>
            <button data-tab="le" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">LE & CE</button>
            <button data-tab="pricing" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Pricing</button>
            <button data-tab="termsheet" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Term Sheet</button>
            <button data-tab="diagnostics" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Diagnostics</button>
        </div>

        <div id="sec-panels">
            <!-- Waterfall Panel -->
            <div id="panel-waterfall" class="sec-panel block">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 class="font-bold text-sm mb-3">Pool & Structure Inputs</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <div><label class="text-xs text-gray-500">Pool Principal (₹)</label><input id="wf-pool" type="number" value="523651962" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">A1 %</label><input id="wf-a1pct" type="number" step="0.0001" value="0.84" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">A2 %</label><input id="wf-a2pct" type="number" step="0.0001" value="0.03" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">OC %</label><input id="wf-ocpct" type="number" step="0.0001" value="0.13" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">CC %</label><input id="wf-ccpct" type="number" step="0.0001" value="0.08" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Pool WAC</label><input id="wf-wac" type="number" step="0.0001" value="0.24" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Tenor (M)</label><input id="wf-tenor" type="number" value="18" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Payout Start</label><input id="wf-start" type="date" value="2025-09-20" class="w-full border rounded p-1 text-sm"></div>
                                <div><label class="text-xs text-gray-500">Loss Rate (Est)</label><input id="wf-loss-rate" type="number" step="0.0001" value="0.05" class="w-full border rounded p-1 text-sm font-mono bg-gray-100"></div>
                            </div>
                        </div>
                        <div>
                             <div class="flex justify-between items-end mb-1">
                                <label class="font-bold text-sm">Collection Schedule</label>
                                <div class="space-x-1">
                                    <button id="wf-gen-schedule" class="px-2 py-1 bg-slate-700 text-white text-xs rounded">Auto-Gen</button>
                                    <button id="wf-clear" class="px-2 py-1 bg-red-600 text-white text-xs rounded">Clear</button>
                                </div>
                             </div>
                             <div class="border rounded h-48 overflow-auto">
                                <table class="w-full text-xs text-left">
                                    <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2">Date</th><th class="p-2">Prin</th><th class="p-2">Int</th><th class="p-2">Prepay</th></tr></thead>
                                    <tbody id="wf-body"></tbody>
                                </table>
                             </div>
                        </div>
                        <button id="wf-run" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-semibold shadow hover:bg-indigo-700">Run Waterfall Model</button>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-sm mb-2">Results Output</h3>
                        <div id="wf-out" class="text-sm space-y-2 p-3 bg-slate-50 rounded mb-4 border border-slate-200 min-h-[80px]">Results will appear here...</div>
                        <canvas id="wf-chart" class="w-full h-48"></canvas>
                        <button id="wf-export-model" class="text-xs text-indigo-600 underline mt-2">Export CSV</button>
                    </div>
                </div>
            </div>

            <!-- LE Panel -->
            <div id="panel-le" class="sec-panel hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 class="font-bold text-sm mb-3">Simulation Config</h3>
                            <div class="space-y-2">
                                <div><label class="text-xs text-gray-500">Simulations (N)</label><input id="le-n" type="number" value="5000" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Target Rating</label><select id="le-rating" class="w-full border rounded p-1 text-sm"><option value="A" selected data-percentile="0.965">A</option></select></div>
                                <div><label class="text-xs text-gray-500">Target Percentile</label><input id="le-percentile" type="number" step="0.001" value="0.965" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">EIS Buffer</label><input id="le-eis" type="number" step="0.0001" value="0.05" readonly class="w-full border rounded p-1 text-sm font-mono bg-gray-100"></div>
                            </div>
                        </div>
                        <button id="le-run" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-semibold shadow hover:bg-indigo-700">Run Monte Carlo LE</button>
                    </div>
                    <div class="col-span-2 space-y-4">
                        <div class="bg-white border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm">Portfolio Concentration</h3>
                                <button id="le-seed" class="text-xs bg-slate-200 px-2 py-1 rounded">Load Default</button>
                            </div>
                            <table class="w-full text-xs text-left">
                                <thead class="bg-slate-100"><tr><th class="p-2">Bucket Name</th><th class="p-2">Weight</th><th class="p-2">PD</th><th class="p-2">LGD</th></tr></thead>
                                <tbody id="le-body"></tbody>
                            </table>
                            <button id="le-add" class="mt-2 text-xs text-indigo-600">+ Add Bucket</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded border">
                                <h4 class="font-bold text-xs text-slate-500 uppercase">Results</h4>
                                <div id="le-out" class="text-sm mt-2 space-y-1">Run simulation...</div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded border">
                                <h4 class="font-bold text-xs text-slate-500 uppercase">Sufficiency</h4>
                                <div id="ce-out" class="text-sm mt-2 space-y-1">Waiting for results...</div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Pricing Panel -->
            <div id="panel-pricing" class="sec-panel hidden">
                <div class="bg-white p-6 rounded-lg border border-slate-200 text-center space-y-4 max-w-2xl mx-auto">
                     <h3 class="font-bold">Tranche Pricing</h3>
                     <div class="grid grid-cols-2 gap-4 text-left">
                        <div><label class="text-xs text-gray-500">A1 Base Rate</label><input id="pr-base-rate-a1" type="number" step="0.01" value="0.09" class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="text-xs text-gray-500">A2 Base Rate</label><input id="pr-base-rate-a2" type="number" step="0.01" value="0.12" class="w-full border rounded p-2 text-sm"></div>
                     </div>
                     <button id="pr-run" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Calculate Spreads</button>
                     <div id="pr-out" class="text-left bg-slate-50 p-4 rounded border mt-4"></div>
                </div>
            </div>

            <!-- Term Sheet -->
            <div id="panel-termsheet" class="sec-panel hidden">
                 <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <h3 class="font-bold text-sm">Term Sheet Parameters</h3>
                        <div><label class="text-xs">Issuer Name</label><input id="ts-issuer" value="Newton 08 2025" class="sec-input"></div>
                        <div><label class="text-xs">Originator</label><input id="ts-originator" value="Midland Microfin" class="sec-input"></div>
                        <button id="ts-generate" class="w-full py-2 bg-indigo-600 text-white rounded mt-4">Download DOCX Term Sheet</button>
                    </div>
                 </div>
            </div>

            <!-- Diagnostics -->
            <div id="panel-diagnostics" class="sec-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">CE Sufficiency Back-tester</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-ce" type="number" value="15" class="border rounded p-2" placeholder="CE %">
                            <input id="diag-hor" type="number" value="36" class="border rounded p-2" placeholder="Horizon MOB">
                            <input id="diag-tail" type="number" value="75" class="border rounded p-2" placeholder="Tail decay %">
                        </div>
                        <textarea id="diag-loss" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="mob,cum_loss% (e.g. 1,0.2)">1,0.2
3,0.4
6,0.7
9,0.9
12,1.0</textarea>
                        <div id="diag-ce-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Run to see sufficiency.</div>
                        <button id="diag-ce-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run CE Back-test</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Trigger Breach Monitor</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-oc" type="number" value="14" class="border rounded p-2" placeholder="OC %">
                            <input id="diag-cc" type="number" value="8" class="border rounded p-2" placeholder="CC %">
                            <input id="diag-dr" type="number" value="2.1" class="border rounded p-2" placeholder="DR %">
                            <input id="diag-oc-min" type="number" value="12" class="border rounded p-2" placeholder="OC Min %">
                            <input id="diag-cc-min" type="number" value="6" class="border rounded p-2" placeholder="CC Min %">
                            <input id="diag-dr-max" type="number" value="3" class="border rounded p-2" placeholder="DR Max %">
                        </div>
                        <div id="diag-trig-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Status will appear here.</div>
                        <button id="diag-trig-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Check Triggers</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Replenishment Pool QC</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <input id="diag-max-ltv" type="number" value="85" class="border rounded p-2" placeholder="Max LTV %">
                            <input id="diag-max-dpd" type="number" value="0" class="border rounded p-2" placeholder="Max DPD">
                        </div>
                        <textarea id="diag-pool" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="id,ltv,dpd">A1,72,0
A2,81,10
A3,65,0</textarea>
                        <div id="diag-qc-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">QC summary will show here.</div>
                        <button id="diag-qc-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run QC</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Delinquency Diversion Scenario</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-coll" type="number" value="8000000" class="border rounded p-2" placeholder="Monthly Collections">
                            <input id="diag-delinq" type="number" value="12" class="border rounded p-2" placeholder="Delinq % of coll">
                            <input id="diag-divert" type="number" value="50" class="border rounded p-2" placeholder="Divert % of delinq">
                        </div>
                        <div id="diag-div-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Diversion impact will appear here.</div>
                        <button id="diag-div-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run Diversion</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Collateral Stratification Dashboard</div>
                        <textarea id="diag-strat" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="ltv,score,amt">70,750,1000000
80,720,800000
65,780,1200000
90,690,600000</textarea>
                        <div id="diag-strat-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Strat summary will appear here.</div>
                        <button id="diag-strat-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Summarize</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Waterfall Comparator (A vs B)</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <input id="diag-a-wac" type="number" value="9.5" class="border rounded p-2" placeholder="A WAC %">
                            <input id="diag-b-wac" type="number" value="10.2" class="border rounded p-2" placeholder="B WAC %">
                            <input id="diag-a-ce" type="number" value="14" class="border rounded p-2" placeholder="A CE %">
                            <input id="diag-b-ce" type="number" value="12" class="border rounded p-2" placeholder="B CE %">
                        </div>
                        <div id="diag-comp-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Compare structures to see delta.</div>
                        <button id="diag-comp-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Compare</button>
                    </div>
                </div>
            </div>
        </div>
    </div>`;

    // Securitisation: Tab Logic
    const tabs = c.querySelectorAll('.tab-btn');
    const panels = c.querySelectorAll('.sec-panel');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            panels.forEach(p => p.classList.add('hidden'));
            document.getElementById(`panel-${btn.dataset.tab}`).classList.remove('hidden');
        });
    });
    tabs[0].classList.add('active');

    // Securitisation: Waterfall Logic
    const generateSchedule = () => {
        const p = +document.getElementById('wf-pool').value;
        const wac = +document.getElementById('wf-wac').value;
        const tenor = +document.getElementById('wf-tenor').value;
        const start = new Date(document.getElementById('wf-start').value);
        const tbody = document.getElementById('wf-body');
        tbody.innerHTML = '';
        const prinPerMonth = p / tenor;
        let bal = p;
        for(let i=1; i<=tenor; i++) {
            const date = new Date(start);
            date.setMonth(start.getMonth() + i);
            const int = bal * (wac/12);
            const prin = Math.min(bal, prinPerMonth);
            bal -= prin;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-1"><input type="date" value="${date.toISOString().split('T')[0]}" class="w-full border text-xs"></td><td class="p-1"><input type="number" value="${prin.toFixed(0)}" class="w-full border text-xs font-mono"></td><td class="p-1"><input type="number" value="${int.toFixed(0)}" class="w-full border text-xs font-mono"></td><td class="p-1"><input type="number" value="0" class="w-full border text-xs font-mono"></td>`;
            tbody.appendChild(tr);
        }
    };

    document.getElementById('wf-gen-schedule').addEventListener('click', generateSchedule);
    document.getElementById('wf-clear').addEventListener('click', () => document.getElementById('wf-body').innerHTML = '');
    document.getElementById('wf-run').addEventListener('click', runWaterfallModel);
    document.getElementById('wf-export-model').addEventListener('click', () => {
        if(WF_RES) downloadCSV(WF_RES.map(r => Object.values(r)), 'waterfall_model.csv');
    });

    // Securitisation: LE Logic
    document.getElementById('le-seed').addEventListener('click', () => {
        const tbody = document.getElementById('le-body');
        tbody.innerHTML = '';
        [['Agri', 0.4, 0.08, 0.6], ['MSME', 0.3, 0.12, 0.7], ['Personal', 0.3, 0.15, 0.8]].forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-1"><input value="${row[0]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[1]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[2]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[3]}" class="border w-full text-xs"></td>`;
            tbody.appendChild(tr);
        });
    });
    document.getElementById('le-add').addEventListener('click', () => {
         const tr = document.createElement('tr');
         tr.innerHTML = `<td class="p-1"><input class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td>`;
         document.getElementById('le-body').appendChild(tr);
    });
    document.getElementById('le-run').addEventListener('click', runLEModel);
    document.getElementById('pr-run').addEventListener('click', runPricing);
    document.getElementById('ts-generate').addEventListener('click', generateDocx);

    // Diagnostics: CE back-test
    document.getElementById('diag-ce-run').addEventListener('click', () => {
        const hor = +document.getElementById('diag-hor').value;
        const tail = +document.getElementById('diag-tail').value / 100;
        const ce = +document.getElementById('diag-ce').value;
        const lines = document.getElementById('diag-loss').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        let pts = lines.map(l=>{ const p=l.split(','); return { mob:+p[0], loss:+p[1] }; }).filter(p=>p.mob>0 && p.loss>=0).sort((a,b)=>a.mob-b.mob);
        if(!pts.length) { document.getElementById('diag-ce-res').innerText = 'No data.'; return; }
        const data=[];
        for(let i=0;i<pts.length-1;i++){ const a=pts[i],b=pts[i+1]; data.push(a); const gap=b.mob-a.mob; if(gap>1){ const step=(b.loss-a.loss)/gap; for(let g=1; g<gap; g++) data.push({mob:a.mob+g, loss:a.loss+step*g}); }}
        data.push(pts[pts.length-1]);
        let lastDelta = data.length>1 ? data[data.length-1].loss - data[data.length-2].loss : 0;
        let lastLoss = data[data.length-1].loss;
        for(let m=data[data.length-1].mob+1; m<=hor; m++){ lastDelta*=tail; lastLoss+=lastDelta; data.push({mob:m, loss:lastLoss}); }
        const finalLoss = data[data.length-1].loss;
        const suff = ce - finalLoss;
        document.getElementById('diag-ce-res').innerHTML = `Lifetime loss ~ <b>${finalLoss.toFixed(2)}%</b>. CE ${ce.toFixed(1)}% → ${suff>=0?'<span class="text-green-700">Sufficient</span>':'<span class="text-red-600">Shortfall</span>'} (${suff.toFixed(2)}%)`;
    });

    // Diagnostics: Triggers
    document.getElementById('diag-trig-run').addEventListener('click', () => {
        const oc=+document.getElementById('diag-oc').value, cc=+document.getElementById('diag-cc').value, dr=+document.getElementById('diag-dr').value;
        const ocMin=+document.getElementById('diag-oc-min').value, ccMin=+document.getElementById('diag-cc-min').value, drMax=+document.getElementById('diag-dr-max').value;
        const breaches=[];
        if(oc < ocMin) breaches.push(`OC ${oc}% < ${ocMin}%`);
        if(cc < ccMin) breaches.push(`CC ${cc}% < ${ccMin}%`);
        if(dr > drMax) breaches.push(`DR ${dr}% > ${drMax}%`);
        document.getElementById('diag-trig-res').innerHTML = breaches.length ? `<span class="text-red-600 font-semibold">Breach:</span> ${breaches.join('; ')}` : `<span class="text-green-700 font-semibold">All triggers OK</span>`;
    });

    // Diagnostics: Replenishment QC
    document.getElementById('diag-qc-run').addEventListener('click', () => {
        const maxLtv = +document.getElementById('diag-max-ltv').value;
        const maxDpd = +document.getElementById('diag-max-dpd').value;
        const lines = document.getElementById('diag-pool').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        const fails=[]; let total=0;
        lines.forEach(l=>{
            const p=l.split(','); if(p.length<3) return;
            const id=p[0], ltv=+p[1], dpd=+p[2]; total++;
            if(ltv>maxLtv || dpd>maxDpd) fails.push(`${id} (LTV ${ltv} / DPD ${dpd})`);
        });
        document.getElementById('diag-qc-res').innerHTML = fails.length ? `<span class="text-red-600 font-semibold">${fails.length} fails</span> / ${total}: ${fails.join(', ')}` : `<span class="text-green-700 font-semibold">All ${total} loans pass</span>`;
    });

    // Diagnostics: Delinquency Diversion
    document.getElementById('diag-div-run').addEventListener('click', () => {
        const coll=+document.getElementById('diag-coll').value;
        const del=+document.getElementById('diag-delinq').value/100;
        const div=+document.getElementById('diag-divert').value/100;
        const delAmt = coll * del;
        const diverted = delAmt * div;
        const toSenior = coll - diverted;
        document.getElementById('diag-div-res').innerHTML = `Delinq ${moneyFmt.format(delAmt)} → Diverted ${moneyFmt.format(diverted)}. Residual to waterfall ${moneyFmt.format(toSenior)}.`;
    });

    // Diagnostics: Stratification
    document.getElementById('diag-strat-run').addEventListener('click', () => {
        const lines = document.getElementById('diag-strat').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        let totAmt=0, ltvSum=0, scoreSum=0, n=0;
        lines.forEach(l=>{
            const p=l.split(','); if(p.length<3) return;
            const ltv=+p[0], score=+p[1], amt=+p[2]; if(!amt) return;
            totAmt += amt; ltvSum += ltv*amt; scoreSum += score*amt; n++;
        });
        const wtdLtv = totAmt? ltvSum/totAmt : 0;
        const wtdScore = totAmt? scoreSum/totAmt : 0;
        document.getElementById('diag-strat-res').innerHTML = `Pools: ${n} | AUM ${moneyFmt.format(totAmt)} | Wtd LTV ${wtdLtv.toFixed(1)}% | Wtd Score ${wtdScore.toFixed(0)}`;
    });

    // Diagnostics: Waterfall Comparator
    document.getElementById('diag-comp-run').addEventListener('click', () => {
        const aw = +document.getElementById('diag-a-wac').value;
        const bw = +document.getElementById('diag-b-wac').value;
        const ac = +document.getElementById('diag-a-ce').value;
        const bc = +document.getElementById('diag-b-ce').value;
        const wacDelta = bw - aw;
        const ceDelta = bc - ac;
        document.getElementById('diag-comp-res').innerHTML = `WAC Δ ${wacDelta.toFixed(2)}% | CE Δ ${ceDelta.toFixed(2)}% → ${wacDelta<=0 && ceDelta<=0 ? '<span class="text-green-700">Structure B cheaper/riskier trade-off</span>' : 'Assess yield vs protection'}`;
    });
    
    generateSchedule(); 
    document.getElementById('le-seed').click();
}

function runWaterfallModel() {
    const rows = Array.from(document.querySelectorAll('#wf-body tr')).map(tr => {
        const inps = tr.querySelectorAll('input');
        return { date: inps[0].value, prin: +inps[1].value, int: +inps[2].value, prepay: +inps[3].value };
    });
    if(rows.length === 0) return alert("Please generate schedule first.");

    const pool_prin = +document.getElementById('wf-pool').value;
    let a1_bal = pool_prin * +document.getElementById('wf-a1pct').value;
    let result = [];
    let total_eis = 0;

    rows.forEach(r => {
        let avail = r.prin + r.int + r.prepay - 5000;
        let a1_int = a1_bal * (0.09 / 12);
        let pay_a1_int = Math.min(avail, a1_int);
        avail -= pay_a1_int;
        let pay_a1_prin = Math.min(avail, a1_bal);
        avail -= pay_a1_prin;
        a1_bal -= pay_a1_prin;
        total_eis += avail;

        result.push({ date: r.date, coll: r.prin + r.int, a1_pay: pay_a1_int + pay_a1_prin, a1_bal: a1_bal, eis: avail });
    });

    WF_RES = result;
    document.getElementById('wf-out').innerHTML = `<div><b>Total Collections:</b> ${moneyFmt.format(rows.reduce((a,b)=>a+b.prin+b.int,0))}</div><div><b>A1 Principal Paid:</b> ${pct(1 - a1_bal/(pool_prin * +document.getElementById('wf-a1pct').value))}</div><div><b>Total EIS Generated:</b> ${moneyFmt.format(total_eis)}</div>`;
    document.getElementById('le-eis').value = (total_eis / pool_prin).toFixed(4);
    
    const ctx = document.getElementById('wf-chart').getContext('2d');
    if(window.wfChart) window.wfChart.destroy();
    window.wfChart = new Chart(ctx, { type: 'line', data: { labels: result.map(r => r.date), datasets: [ { label: 'Collections', data: result.map(r => r.coll), borderColor: 'blue', fill: false }, { label: 'A1 Payment', data: result.map(r => r.a1_pay), borderColor: 'green', fill: false } ] }, options: { responsive: true, maintainAspectRatio: false } });
}

function runLEModel() {
    const n = +document.getElementById('le-n').value;
    const buckets = Array.from(document.querySelectorAll('#le-body tr')).map(tr => {
        const i = tr.querySelectorAll('input');
        return { w: +i[1].value, pd: +i[2].value, lgd: +i[3].value };
    });
    const rho = 0.15;
    let losses = [];
    for(let i=0; i<n; i++) {
        const sys = jStat.normal.sample(0, 1);
        let l = 0;
        buckets.forEach(b => {
            const thresh = jStat.normal.inv(b.pd, 0, 1);
            const condPD = jStat.normal.cdf((thresh - Math.sqrt(rho)*sys) / Math.sqrt(1-rho), 0, 1);
            l += b.w * condPD * b.lgd;
        });
        losses.push(l);
    }
    losses.sort((a,b)=>a-b);
    const pctl = +document.getElementById('le-percentile').value;
    const lossAtPctl = losses[Math.floor(n * pctl)];
    const eis = +document.getElementById('le-eis').value;
    const ceReq = Math.max(0, lossAtPctl - eis);
    const ceAvail = +document.getElementById('wf-ocpct').value + +document.getElementById('wf-ccpct').value;
    LE_VEC = losses;
    document.getElementById('le-out').innerHTML = `<div><b>Mean Loss:</b> ${pct(losses.reduce((a,b)=>a+b,0)/n)}</div><div><b>Loss @ ${(pctl*100).toFixed(1)}%:</b> <span class="font-bold text-red-600">${pct(lossAtPctl)}</span></div>`;
    const isSafe = ceAvail >= ceReq;
    document.getElementById('ce-out').innerHTML = `<div>Available Hard CE: ${pct(ceAvail)}</div><div>Less: Req after EIS: ${pct(ceReq)}</div><div class="mt-2 font-bold ${isSafe ? 'text-green-600' : 'text-red-600'}">${isSafe ? 'SUFFICIENT' : 'SHORTFALL'}</div>`;
}

function runPricing() {
    if(!LE_VEC) return alert("Run LE Model first");
    const baseA1 = +document.getElementById('pr-base-rate-a1').value;
    const creditSupportA1 = +document.getElementById('wf-a2pct').value + +document.getElementById('wf-ocpct').value + +document.getElementById('wf-ccpct').value + +document.getElementById('le-eis').value;
    let a1LossSum = 0;
    LE_VEC.forEach(l => { a1LossSum += Math.max(0, l - creditSupportA1); });
    const expLossA1 = a1LossSum / LE_VEC.length;
    document.getElementById('pr-out').innerHTML = `<div class="grid grid-cols-2 gap-2"><div>A1 Expected Loss:</div><div class="font-mono">${(expLossA1*10000).toFixed(1)} bps</div><div>A1 Fair Yield:</div><div class="font-bold text-indigo-700">${pct(baseA1 + expLossA1)}</div></div>`;
}

async function generateDocx() {
    if(!window.docx) return alert("DOCX lib not loaded");
    const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
    const issuer = document.getElementById('ts-issuer').value;
    const doc = new Document({ sections: [{ children: [ new Paragraph({ text: `Term Sheet: ${issuer}`, heading: HeadingLevel.HEADING_1 }), new Paragraph({ text: `Generated via NBFC Quant Toolbox`, spacing: { after: 200 } }), new Paragraph({ text: `Principal: ${moneyFmt.format(document.getElementById('wf-pool').value)}` }), new Paragraph({ text: `Structure: A1 (${document.getElementById('wf-a1pct').value*100}%) / A2 (${document.getElementById('wf-a2pct').value*100}%)` }) ] }] });
    const blob = await Packer.toBlob(doc);
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${issuer}_TermSheet.docx`;
    link.click();
}

/* ==========================================================================
   2. NEW RETAIL/LENDING TOOLS
   ========================================================================== */

function renderRetailEligibility() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Net Income</label><input id="ret-inc" type="number" value="50000" class="border rounded p-1">
            <label>Existing EMI</label><input id="ret-obl" type="number" value="5000" class="border rounded p-1">
            <label>FOIR %</label><input id="ret-foir" type="number" value="50" class="border rounded p-1">
            <label>ROI %</label><input id="ret-roi" type="number" value="12" class="border rounded p-1">
            <label>Tenure (M)</label><input id="ret-ten" type="number" value="60" class="border rounded p-1">
        </div>
        <button id="ret-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Calculate</button>
        <div id="ret-res" class="hidden text-center pt-4 border-t"><div class="text-xs text-gray-500">Max Loan Eligibility</div><div class="text-2xl font-bold text-green-600" id="ret-val"></div></div>
    </div>`;
    document.getElementById('ret-calc').onclick = () => {
        const inc=+document.getElementById('ret-inc').value, obl=+document.getElementById('ret-obl').value, foir=+document.getElementById('ret-foir').value/100;
        const r=+document.getElementById('ret-roi').value/1200, n=+document.getElementById('ret-ten').value;
        const maxEmi = Math.max(0, inc*foir - obl);
        const loan = maxEmi * (1 - Math.pow(1+r, -n)) / r;
        document.getElementById('ret-val').innerText = moneyFmt.format(loan);
        document.getElementById('ret-res').classList.remove('hidden');
    };
}

function renderLAPCalculator() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Property Value</label><input id="lap-prop" type="number" value="10000000" class="border rounded p-1">
            <label>Max LTV %</label><input id="lap-ltv" type="number" value="60" class="border rounded p-1">
            <label>Net Income</label><input id="lap-inc" type="number" value="100000" class="border rounded p-1">
            <label>FOIR %</label><input id="lap-foir" type="number" value="60" class="border rounded p-1">
            <label>ROI %</label><input id="lap-roi" type="number" value="10" class="border rounded p-1">
            <label>Tenure (Y)</label><input id="lap-ten" type="number" value="15" class="border rounded p-1">
        </div>
        <button id="lap-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Check</button>
        <div id="lap-res" class="hidden space-y-2 pt-4 border-t text-sm">
            <div class="flex justify-between"><span>LTV Limit:</span><span id="lap-res-ltv" class="font-bold"></span></div>
            <div class="flex justify-between"><span>Income Limit:</span><span id="lap-res-inc" class="font-bold"></span></div>
            <div class="flex justify-between bg-green-50 p-2 rounded text-green-800 font-bold"><span>Final Eligibility:</span><span id="lap-res-fin"></span></div>
        </div>
    </div>`;
    document.getElementById('lap-calc').onclick = () => {
        const prop=+document.getElementById('lap-prop').value, ltv=+document.getElementById('lap-ltv').value/100;
        const inc=+document.getElementById('lap-inc').value, foir=+document.getElementById('lap-foir').value/100;
        const r=+document.getElementById('lap-roi').value/1200, n=+document.getElementById('lap-ten').value*12;
        
        const ltvLim = prop * ltv;
        const emiCap = inc * foir;
        const incLim = emiCap * (1 - Math.pow(1+r, -n)) / r;
        
        document.getElementById('lap-res-ltv').innerText = moneyFmt.format(ltvLim);
        document.getElementById('lap-res-inc').innerText = moneyFmt.format(incLim);
        document.getElementById('lap-res-fin').innerText = moneyFmt.format(Math.min(ltvLim, incLim));
        document.getElementById('lap-res').classList.remove('hidden');
    };
}

function renderEducationLoan() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Loan Amt</label><input id="edu-amt" type="number" value="2000000" class="border rounded p-1">
            <label>Moratorium (M)</label><input id="edu-mor" type="number" value="24" class="border rounded p-1">
            <label>ROI %</label><input id="edu-roi" type="number" value="11" class="border rounded p-1">
            <label>Repay Tenure (M)</label><input id="edu-ten" type="number" value="84" class="border rounded p-1">
            <div class="col-span-2"><label class="inline-flex items-center"><input id="edu-cap" type="checkbox" checked> Capitalize Interest?</label></div>
        </div>
        <button id="edu-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Structurer</button>
        <div id="edu-res" class="hidden pt-4 border-t text-sm space-y-2">
             <div>Accrued Int: <span id="edu-acc" class="font-bold"></span></div>
             <div>Final Principal: <span id="edu-fin" class="font-bold"></span></div>
             <div>EMI: <span id="edu-emi" class="font-bold text-green-600 text-lg"></span></div>
        </div>
    </div>`;
    document.getElementById('edu-calc').onclick = () => {
        const p=+document.getElementById('edu-amt').value, mor=+document.getElementById('edu-mor').value;
        const r=+document.getElementById('edu-roi').value/1200, n=+document.getElementById('edu-ten').value;
        const cap = document.getElementById('edu-cap').checked;
        
        const intAcc = p * r * mor;
        const finalP = cap ? p + intAcc : p;
        const emi = finalP * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
        
        document.getElementById('edu-acc').innerText = moneyFmt.format(intAcc);
        document.getElementById('edu-fin').innerText = moneyFmt.format(finalP);
        document.getElementById('edu-emi').innerText = moneyFmt.format(emi);
        document.getElementById('edu-res').classList.remove('hidden');
    };
}

function renderSCFDiscounting() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl border space-y-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Invoice Value</label><input id="scf-val" type="number" value="500000" class="border rounded p-1">
            <label>Tenor (Days)</label><input id="scf-days" type="number" value="90" class="border rounded p-1">
            <label>Rate % p.a.</label><input id="scf-rate" type="number" value="14" class="border rounded p-1">
            <label>Fee %</label><input id="scf-fee" type="number" value="0.5" class="border rounded p-1">
        </div>
        <button id="scf-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Calculate</button>
        <div id="scf-res" class="hidden pt-4 border-t space-y-2 text-sm">
            <div class="flex justify-between"><span>Interest:</span><span id="scf-int" class="text-red-600"></span></div>
            <div class="flex justify-between"><span>Fee:</span><span id="scf-fee-amt" class="text-red-600"></span></div>
            <div class="flex justify-between font-bold text-lg"><span>Net Disb:</span><span id="scf-net" class="text-green-600"></span></div>
            <div class="text-center text-xs text-gray-500 mt-2">Effective Yield: <span id="scf-yld"></span></div>
        </div>
    </div>`;
    document.getElementById('scf-calc').onclick = () => {
        const val=+document.getElementById('scf-val').value, d=+document.getElementById('scf-days').value;
        const r=+document.getElementById('scf-rate').value/100, f=+document.getElementById('scf-fee').value/100;
        const int = val * r * (d/365);
        const fee = val * f;
        const net = val - int - fee;
        const yieldVal = ((int+fee)/net) * (365/d);
        document.getElementById('scf-int').innerText = moneyFmt.format(int);
        document.getElementById('scf-fee-amt').innerText = moneyFmt.format(fee);
        document.getElementById('scf-net').innerText = moneyFmt.format(net);
        document.getElementById('scf-yld').innerText = pct(yieldVal);
        document.getElementById('scf-res').classList.remove('hidden');
    };
}

function renderWholesaleRatios() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-3 gap-3 text-xs mb-4">
            <div><label>EBITDA</label><input id="ws-ebitda" type="number" value="50" class="w-full border rounded p-1"></div>
            <div><label>Debt Service</label><input id="ws-ds" type="number" value="35" class="w-full border rounded p-1"></div>
            <div><label>Total Debt</label><input id="ws-debt" type="number" value="200" class="w-full border rounded p-1"></div>
            <div><label>Net Worth</label><input id="ws-nw" type="number" value="80" class="w-full border rounded p-1"></div>
            <div><label>Curr Assets</label><input id="ws-ca" type="number" value="100" class="w-full border rounded p-1"></div>
            <div><label>Curr Liab</label><input id="ws-cl" type="number" value="80" class="w-full border rounded p-1"></div>
        </div>
        <button id="ws-calc" class="w-full bg-gray-800 text-white py-2 rounded mb-4">Analyze</button>
        <div id="ws-res" class="grid grid-cols-3 gap-4 text-center"></div>
    </div>`;
    document.getElementById('ws-calc').onclick = () => {
        const d = { e: +document.getElementById('ws-ebitda').value, ds: +document.getElementById('ws-ds').value, dt: +document.getElementById('ws-debt').value, nw: +document.getElementById('ws-nw').value, ca: +document.getElementById('ws-ca').value, cl: +document.getElementById('ws-cl').value };
        const res = document.getElementById('ws-res');
        res.innerHTML = `
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">DSCR</div><div class="font-bold text-lg ${(d.e/d.ds)>1.2?'text-green-600':'text-red-600'}">${(d.e/d.ds).toFixed(2)}x</div></div>
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">Debt/Equity</div><div class="font-bold text-lg ${(d.dt/d.nw)<3?'text-green-600':'text-red-600'}">${(d.dt/d.nw).toFixed(2)}x</div></div>
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">Current Ratio</div><div class="font-bold text-lg ${(d.ca/d.cl)>1.1?'text-green-600':'text-red-600'}">${(d.ca/d.cl).toFixed(2)}x</div></div>
        `;
    };
}

/* ==========================================================================
   RETAIL LENDING APPS
   ========================================================================== */
function renderHomeLoanEligibility() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="hle-inc" type="number" value="120000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Existing EMIs</label><input id="hle-emi" type="number" value="20000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="hle-foir" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Property Value</label><input id="hle-prop" type="number" value="7500000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Stamp Duty %</label><input id="hle-stamp" type="number" value="7" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Insurance %</label><input id="hle-ins" type="number" value="1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV % Cap</label><input id="hle-ltv" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate % (Annual)</label><input id="hle-rate" type="number" value="8.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="hle-tenor" type="number" value="240" class="w-full border rounded p-2"></div>
      </div>
      <button id="hle-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Eligibility</button>
      <div id="hle-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-sm"></div>
    </div>
  `;
  document.getElementById('hle-run').onclick = () => {
    const inc = +document.getElementById('hle-inc').value;
    const foir = +document.getElementById('hle-foir').value / 100;
    const existEmi = +document.getElementById('hle-emi').value;
    const prop = +document.getElementById('hle-prop').value;
    const stamp = +document.getElementById('hle-stamp').value / 100;
    const ins = +document.getElementById('hle-ins').value / 100;
    const ltv = +document.getElementById('hle-ltv').value / 100;
    const rate = +document.getElementById('hle-rate').value;
    const ten = +document.getElementById('hle-tenor').value;

    const onRoad = prop * (1 + stamp + ins);
    const emiCap = Math.max(0, inc * foir - existEmi);
    const loanByFoir = loanFromEmi(emiCap, rate, ten);
    const loanByLtv = prop * ltv;
    const elig = Math.max(0, Math.min(loanByFoir, loanByLtv));
    const emiElig = calcEmi(elig, rate, ten);
    const down = Math.max(0, onRoad - elig);

    document.getElementById('hle-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">EMI Cap (FOIR)</div><div class="font-bold text-lg">${moneyFmt.format(emiCap)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Eligible Loan</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(elig)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emiElig)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">LTV Limit</div><div class="font-bold text-lg">${moneyFmt.format(loanByLtv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Required Down Payment</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(down)}</div><div class="text-xs text-slate-500">On-road ${moneyFmt.format(onRoad)}</div></div>
    `;
  };
}

function renderAutoLoanStructurer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Ex-Showroom</label><input id="auto-ex" type="number" value="800000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Road Tax %</label><input id="auto-tax" type="number" value="10" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Insurance</label><input id="auto-ins" type="number" value="32000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Accessories</label><input id="auto-acc" type="number" value="15000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other Charges</label><input id="auto-oth" type="number" value="5000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Customer Margin %</label><input id="auto-margin" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="auto-inc" type="number" value="70000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Existing EMIs</label><input id="auto-emi" type="number" value="8000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="auto-foir" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate %</label><input id="auto-rate" type="number" value="11" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="auto-tenor" type="number" value="60" class="w-full border rounded p-2"></div>
      </div>
      <button id="auto-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Structure</button>
      <div id="auto-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('auto-run').onclick = () => {
    const ex = +document.getElementById('auto-ex').value;
    const tax = +document.getElementById('auto-tax').value / 100;
    const ins = +document.getElementById('auto-ins').value;
    const acc = +document.getElementById('auto-acc').value;
    const oth = +document.getElementById('auto-oth').value;
    const margin = +document.getElementById('auto-margin').value / 100;
    const inc = +document.getElementById('auto-inc').value;
    const existEmi = +document.getElementById('auto-emi').value;
    const foir = +document.getElementById('auto-foir').value / 100;
    const rate = +document.getElementById('auto-rate').value;
    const ten = +document.getElementById('auto-tenor').value;

    const onRoad = ex * (1 + tax) + ins + acc + oth;
    const customerContribution = onRoad * margin;
    const loanNeed = Math.max(0, onRoad - customerContribution);
    const emiCap = Math.max(0, inc * foir - existEmi);
    const loanByFoir = loanFromEmi(emiCap, rate, ten);
    const sanctioned = Math.min(loanNeed, loanByFoir);
    const emiSanctioned = calcEmi(sanctioned, rate, ten);
    const extraDown = Math.max(0, onRoad - sanctioned);

    document.getElementById('auto-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">On-road Price</div><div class="font-bold text-lg">${moneyFmt.format(onRoad)}</div><div class="text-xs text-slate-500">Margin ${moneyFmt.format(customerContribution)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Loan Needed</div><div class="font-bold text-lg">${moneyFmt.format(loanNeed)}</div><div class="text-xs text-slate-500">FOIR Caps at ${moneyFmt.format(loanByFoir)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Sanctioned (FOIR bound)</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(sanctioned)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emiSanctioned)}</div><div class="text-xs text-amber-700">${extraDown>0 ? 'Additional down '+moneyFmt.format(extraDown) : 'FOIR OK'}</div></div>
    `;
  };
}

function renderGoldLoanLtv() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Karat</label><input id="gold-karat" type="number" value="22" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Grams</label><input id="gold-grams" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Price / Gram</label><input id="gold-ppg" type="number" value="6000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV % Cap</label><input id="gold-ltv" type="number" value="75" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Auction Buffer %</label><input id="gold-buf" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Safety Margin %</label><input id="gold-safety" type="number" value="2" class="w-full border rounded p-2"></div>
      </div>
      <button id="gold-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute</button>
      <div id="gold-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('gold-run').onclick = () => {
    const karat = +document.getElementById('gold-karat').value;
    const grams = +document.getElementById('gold-grams').value;
    const ppg = +document.getElementById('gold-ppg').value;
    const ltv = +document.getElementById('gold-ltv').value / 100;
    const buf = +document.getElementById('gold-buf').value / 100;
    const safety = +document.getElementById('gold-safety').value / 100;

    const purity = Math.min(1, karat / 24);
    const baseValue = grams * ppg * purity;
    const disbursable = baseValue * ltv * (1 - buf - safety);
    const actualLtv = baseValue ? (disbursable / baseValue) * 100 : 0;

    document.getElementById('gold-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Assessed Value</div><div class="font-bold text-lg">${moneyFmt.format(baseValue)}</div><div class="text-xs text-slate-500">Purity ${(purity*100).toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Disbursable</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(disbursable)}</div><div class="text-xs text-slate-500">Actual LTV ${actualLtv.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Buffer Applied</div><div class="font-bold text-lg text-amber-700">${((buf+safety)*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Headroom ${moneyFmt.format(baseValue - disbursable)}</div></div>
    `;
  };
}

function renderPlTopUp() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Outstanding Loan</label><input id="pl-os" type="number" value="350000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Foreclosure %</label><input id="pl-fc" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Processing Fee %</label><input id="pl-pf" type="number" value="1.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Rate %</label><input id="pl-rate" type="number" value="14" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="pl-ten" type="number" value="48" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="pl-inc" type="number" value="90000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other EMIs</label><input id="pl-emi" type="number" value="12000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="pl-foir" type="number" value="45" class="w-full border rounded p-2"></div>
      </div>
      <button id="pl-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Top-Up</button>
      <div id="pl-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('pl-run').onclick = () => {
    const os = +document.getElementById('pl-os').value;
    const fc = +document.getElementById('pl-fc').value / 100;
    const pf = +document.getElementById('pl-pf').value / 100;
    const rate = +document.getElementById('pl-rate').value;
    const ten = +document.getElementById('pl-ten').value;
    const inc = +document.getElementById('pl-inc').value;
    const otherEmi = +document.getElementById('pl-emi').value;
    const foir = +document.getElementById('pl-foir').value / 100;

    const emiCap = Math.max(0, inc * foir - otherEmi);
    const maxLoan = loanFromEmi(emiCap, rate, ten);
    const foreclosure = os * fc;
    const proc = maxLoan * pf;
    const netTopUp = maxLoan - os - foreclosure - proc;
    const newEmi = calcEmi(maxLoan, rate, ten);

    document.getElementById('pl-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Loan (FOIR)</div><div class="font-bold text-lg">${moneyFmt.format(maxLoan)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(newEmi)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Payout / Charges</div><div class="font-bold text-lg text-amber-700">FC ${moneyFmt.format(foreclosure)} | PF ${moneyFmt.format(proc)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Top-Up</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(netTopUp)}</div><div class="text-xs text-slate-500">${netTopUp<0?'Insufficient eligibility':'After closing old loan'}</div></div>
    `;
  };
}

function renderBtSavings() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Outstanding</label><input id="bt-os" type="number" value="800000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Current Rate %</label><input id="bt-crate" type="number" value="17" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Remaining Tenor (M)</label><input id="bt-cten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Rate %</label><input id="bt-prate" type="number" value="12" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Tenor (M)</label><input id="bt-pten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Processing Fee</label><input id="bt-pf" type="number" value="5000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other Fees</label><input id="bt-oth" type="number" value="2500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Prepay Penalty %</label><input id="bt-pen" type="number" value="2" class="w-full border rounded p-2"></div>
      </div>
      <button id="bt-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Estimate Savings</button>
      <div id="bt-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
    </div>
  `;
  document.getElementById('bt-run').onclick = () => {
    const os = +document.getElementById('bt-os').value;
    const cr = +document.getElementById('bt-crate').value;
    const ct = +document.getElementById('bt-cten').value;
    const pr = +document.getElementById('bt-prate').value;
    const pt = +document.getElementById('bt-pten').value;
    const pf = +document.getElementById('bt-pf').value;
    const oth = +document.getElementById('bt-oth').value;
    const pen = +document.getElementById('bt-pen').value / 100;

    const curEmi = calcEmi(os, cr, ct);
    const curInt = curEmi * ct - os;
    const newEmi = calcEmi(os, pr, pt);
    const newInt = newEmi * pt - os;
    const totalFees = pf + oth + os * pen;
    const netSavings = curInt - (newInt + totalFees);
    const monthlySave = curEmi - newEmi;
    const payback = (monthlySave > 0 && totalFees > 0) ? (totalFees / monthlySave) : null;

    document.getElementById('bt-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Current EMI</div><div class="font-bold text-lg">${moneyFmt.format(curEmi)}</div><div class="text-xs text-slate-500">Interest ${moneyFmt.format(curInt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Proposed EMI</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(newEmi)}</div><div class="text-xs text-slate-500">Interest ${moneyFmt.format(newInt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">One-time Fees</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(totalFees)}</div><div class="text-xs text-slate-500">Penalty + PF + Other</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Savings</div><div class="font-bold text-lg ${netSavings>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(netSavings)}</div><div class="text-xs text-slate-500">${payback?`Payback ~${payback.toFixed(1)} months`:'-'}</div></div>
    `;
  };
}

function renderMfiGroupSplitter() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Ticket Multiplier (x monthly income)</label><input id="mfi-mult" type="number" value="6" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Repeat Uplift %</label><input id="mfi-uplift" type="number" value="10" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cap per Member</label><input id="mfi-cap" type="number" value="80000" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Members (name,income,status)</label>
        <textarea id="mfi-rows" class="w-full border rounded p-3 font-mono text-xs" rows="6">Asha,12000,repeat
Meena,10000,new
Kiran,9000,new
Sunita,11000,repeat
Radha,9500,new</textarea>
      </div>
      <button id="mfi-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Allocate</button>
      <div id="mfi-res" class="space-y-3"></div>
    </div>
  `;
  document.getElementById('mfi-run').onclick = () => {
    const mult = +document.getElementById('mfi-mult').value;
    const uplift = +document.getElementById('mfi-uplift').value / 100;
    const cap = +document.getElementById('mfi-cap').value;
    const lines = document.getElementById('mfi-rows').value.split(/\n+/).map(l => l.trim()).filter(Boolean);
    const members = lines.map(l => {
      const parts = l.split(',').map(p => p.trim());
      return { name: parts[0] || 'Member', income: +parts[1] || 0, status: (parts[2] || 'new').toLowerCase() };
    }).filter(m => m.income > 0);
    if (!members.length) {
      document.getElementById('mfi-res').innerHTML = `<div class="text-red-600 text-sm">No valid members found.</div>`;
      return;
    }
    const totalIncome = members.reduce((s,m)=>s+m.income,0);
    const groupLimit = totalIncome * mult;
    let totalWeight = 0;
    members.forEach(m => {
      const w = m.income * (m.status==='repeat' ? (1+uplift) : 1);
      m.weight = w;
      totalWeight += w;
    });
    members.forEach(m => {
      const alloc = groupLimit * (m.weight / totalWeight);
      m.allocation = Math.min(cap, alloc);
    });
    const netGroup = members.reduce((s,m)=>s+m.allocation,0);
    const rows = members.map(m => `<tr><td class="p-2 border">${m.name}</td><td class="p-2 border text-right">${moneyFmt.format(m.income)}</td><td class="p-2 border text-center">${m.status}</td><td class="p-2 border text-right font-semibold">${moneyFmt.format(m.allocation)}</td></tr>`).join('');
    document.getElementById('mfi-res').innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Group Income</div><div class="font-bold text-lg">${moneyFmt.format(totalIncome)}</div></div>
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Group Ticket (x${mult})</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(groupLimit)}</div></div>
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Allocated (after caps)</div><div class="font-bold text-lg text-green-700">${moneyFmt.format(netGroup)}</div></div>
      </div>
      <div class="overflow-auto max-h-64 border rounded">
        <table class="w-full text-xs">
          <thead class="bg-slate-100"><tr><th class="p-2 border text-left">Member</th><th class="p-2 border text-right">Income</th><th class="p-2 border text-center">Status</th><th class="p-2 border text-right">Allocation</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  };
}

/* ==========================================================================
   3. RESTORED LEGACY TOOLS
   ========================================================================== */

// XIRR
function renderXirr() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `<div class="space-y-3"><input id="xirr-file" type="file" accept=".csv" class="file-input"><div id="xirr-res" class="bg-green-50 p-4 border rounded text-green-800 font-bold hidden">Portfolio XIRR: <span id="xirr-val"></span></div></div>`;
  document.getElementById('xirr-file').addEventListener('change', e => {
    Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: res => {
        const rows = [];
        res.data.forEach(r => {
           const amt = Number(r.amount), dt = formatDateFlexible(r.date);
           if(r.account_id && dt && isFinite(amt)) rows.push({ account: r.account_id, date: dt, amount: amt });
        });
        const portXirr = xnpv(rows);
        document.getElementById('xirr-val').textContent = pct(portXirr);
        document.getElementById('xirr-res').classList.remove('hidden');
    }});
  });
}
function xnpv(cfs) {
  if (!cfs.length) return 0;
  const sorted = cfs.slice().sort((a, b) => a.date - b.date);
  const t0 = sorted[0].date.getTime();
  const calc = (r) => sorted.reduce((acc, cf) => acc + cf.amount / Math.pow(1+r, (cf.date-t0)/(365*24*3600*1000)), 0);
  let r = 0.1; for(let i=0; i<50; i++) { let v = calc(r); if(Math.abs(v)<1) break; r += v > 0 ? 0.01 : -0.01; }
  return r;
}

// HPR
function renderHpr() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `<div class="space-y-3"><input id="hpr-file" type="file" accept=".csv" class="file-input"><div id="hpr-res" class="hidden text-sm"></div></div>`;
  document.getElementById('hpr-file').addEventListener('change', e => {
    Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: res => {
        let avg = 0;
        res.data.forEach(r => {
           const pd = formatDateFlexible(r.purchase_date), sd = formatDateFlexible(r.sale_date);
           const pv = +r.purchase_value, sv = +r.sale_value;
           if (pd && sd && pv) {
               const days = Math.max(1, (sd - pd)/(1000*60*60*24));
               const hpr = (sv - pv)/pv;
               avg += (Math.pow(1+hpr, 365/days)-1);
           }
        });
        document.getElementById('hpr-res').innerText = `Avg Annualised Return: ${pct(avg/res.data.length)}`;
        document.getElementById('hpr-res').classList.remove('hidden');
    }});
  });
}

// Geo Performance
function renderGeo() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><input id="geo-file" type="file" accept=".csv" class="file-input"><div id="geo-chart" style="height:300px;"></div></div>`;
    document.getElementById('geo-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            const map = new Map();
            res.data.forEach(r => {
                const s = r.state||r.region; const aum = +r.aum;
                if(s) { if(!map.has(s)) map.set(s,0); map.set(s, map.get(s)+aum); }
            });
            const x = Array.from(map.keys()), y = Array.from(map.values());
            Plotly.newPlot('geo-chart', [{x, y, type:'bar', marker:{color:'#6366f1'}}], {title:'State-wise AUM', margin:{t:30}});
        }});
    });
}

// ALM
function renderAlm() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="grid grid-cols-2 gap-2 text-xs"><label>Shock (bps)</label><input id="alm-shock" type="number" value="200" class="border rounded p-1"></div><input id="alm-file" type="file" accept=".csv" class="file-input"><div id="alm-res" class="font-mono text-sm"></div></div>`;
    document.getElementById('alm-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            let pv=0, pvShock=0;
            const shock = +document.getElementById('alm-shock').value/10000;
            res.data.forEach(r => {
                const t = +r.bucket_months/12, cf = +r.cashflow, y = +r.yield_pct/100;
                if(t && cf) {
                    pv += cf/Math.pow(1+y, t);
                    pvShock += cf/Math.pow(1+y+shock, t);
                }
            });
            document.getElementById('alm-res').innerHTML = `PV Base: ${moneyFmt.format(pv)}<br>PV Shock: ${moneyFmt.format(pvShock)}<br>Delta: <span class="text-red-600">${moneyFmt.format(pvShock-pv)}</span>`;
        }});
    });
}

// Macro
function renderMacro() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div id="macro-chart" style="height:400px;"></div>`;
    const data = [{x:['Q1','Q2','Q3','Q4'], y:[6.1, 7.2, 6.5, 7.8], name:'GDP Growth %', type:'scatter'}, {x:['Q1','Q2','Q3','Q4'], y:[5.5, 5.1, 4.8, 5.2], name:'CPI Inflation %', type:'bar', yaxis:'y2', opacity:0.5}];
    const layout = {title:'Macro Indicators (Sample)', yaxis:{title:'GDP'}, yaxis2:{title:'CPI', overlaying:'y', side:'right'}};
    Plotly.newPlot('macro-chart', data, layout);
}

// DA Calc
function renderDa() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="grid grid-cols-2 gap-2 text-xs"><label>Sell Rate %</label><input id="da-sell" type="number" value="9.5" class="border rounded p-1"></div><input id="da-file" type="file" accept=".csv" class="file-input"><div id="da-res" class="font-mono text-sm"></div></div>`;
    document.getElementById('da-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            let totalSpreadPV = 0;
            const sellRate = +document.getElementById('da-sell').value/100;
            res.data.forEach(r => {
                const pos = +(r.POS||r.pos), bRate = +(r['End borrower Rate']||r.borrower_rate)/100, ten = +(r['Residual Tenure']||r.residual);
                if(pos && bRate && ten) {
                    const spread = bRate - sellRate;
                    for(let i=1; i<=ten; i++) totalSpreadPV += (pos * spread/12) / Math.pow(1+0.08/12, i);
                }
            });
            document.getElementById('da-res').innerText = `Total PV of Spread (IO Strip): ${moneyFmt.format(totalSpreadPV)}`;
        }});
    });
}

// Reg Validator
function renderRegValidator() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><select id="reg-type" class="border p-1"><option>CRILC</option><option>RBI_ALM</option></select><input id="reg-file" type="file" accept=".csv" class="file-input"><div id="reg-res" class="text-sm"></div></div>`;
    document.getElementById('reg-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, complete: res => {
            const req = { CRILC:['loan_id','pan','dpd','os'], RBI_ALM:['bucket','inflow','outflow'] };
            const type = document.getElementById('reg-type').value;
            const miss = req[type].filter(f => !res.meta.fields.includes(f));
            document.getElementById('reg-res').innerHTML = miss.length ? `<span class="text-red-600">Missing: ${miss.join(', ')}</span>` : `<span class="text-green-600">Schema Validated. Rows: ${res.data.length}</span>`;
        }});
    });
}

// EWS
function renderEws() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><input id="ews-file" type="file" accept=".csv" class="file-input"><div class="overflow-auto max-h-60 border rounded"><table class="w-full text-xs"><tbody id="ews-body"></tbody></table></div></div>`;
    document.getElementById('ews-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, complete: res => {
            const tbody = document.getElementById('ews-body'); tbody.innerHTML='';
            res.data.forEach(r => {
                const dpd = +r.dpd;
                const risk = dpd>30 ? 'HIGH' : (dpd>0 ? 'MED' : 'LOW');
                const col = risk==='HIGH'?'text-red-600 font-bold':(risk==='MED'?'text-yellow-600':'text-green-600');
                tbody.innerHTML += `<tr><td class="p-2 border-t">${r.loan_id}</td><td class="p-2 border-t">DPD:${dpd}</td><td class="p-2 border-t ${col}">${risk}</td></tr>`;
            });
        }});
    });
}

/* ==========================================================================
   4. RISK & OPS (NPA, CO-LENDING, STATIC POOL)
   ========================================================================== */

function renderNpaProvisioning() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="text-xs bg-blue-50 p-2 border text-blue-800">RBI Norms: Std 0.4%, SS 15/25%, D1 25%, D2 40%, D3 100%</div><input id="npa-file" type="file" accept=".csv" class="file-input"><div id="npa-res" class="grid grid-cols-2 gap-4 pt-2"></div></div>`;
    document.getElementById('npa-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], {header:true, complete: res=>{
            let prov=0, tot=0;
            res.data.forEach(r=>{
                const os=+r.os_balance, dpd=+r.dpd; tot+=os;
                if(dpd<=90) prov+=os*0.004;
                else if(dpd<=455) prov+=os*0.15; 
                else prov+=os*0.4; 
            });
            document.getElementById('npa-res').innerHTML = `<div class="p-3 border rounded bg-white text-center"><div>Portfolio</div><div class="font-bold">${moneyFmt.format(tot)}</div></div><div class="p-3 border rounded bg-white text-center"><div>Provision</div><div class="font-bold text-red-600">${moneyFmt.format(prov)}</div></div>`;
        }});
    });
}

function renderCoLending() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="max-w-2xl mx-auto bg-white p-6 border rounded space-y-4"><div class="grid grid-cols-2 gap-4 text-sm"><label>Cust ROI</label><input id="clm-croi" type="number" value="18" class="border p-1"><label>Bank Share %</label><input id="clm-bshare" type="number" value="80" class="border p-1"><label>Bank Rate</label><input id="clm-broi" type="number" value="9.5" class="border p-1"></div><button id="clm-go" class="w-full bg-indigo-600 text-white py-2 rounded">Calc NBFC Rate</button><div id="clm-out" class="hidden text-center font-bold text-xl text-indigo-700 pt-4"></div></div>`;
    document.getElementById('clm-go').onclick = () => {
        const c=+document.getElementById('clm-croi').value, b=+document.getElementById('clm-bshare').value/100, br=+document.getElementById('clm-broi').value;
        const nshare = 1-b;
        const nrate = (c - (br*b))/nshare;
        document.getElementById('clm-out').innerText = `NBFC Rate: ${nrate.toFixed(2)}%`;
        document.getElementById('clm-out').classList.remove('hidden');
    };
}

function renderStaticPool() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-2"><input id="sp-file" type="file" accept=".csv" class="file-input"><div id="sp-heat" class="overflow-auto p-2 border rounded bg-white min-h-[200px]"></div></div>`;
    document.getElementById('sp-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], {header:true, complete:res=>{
            let html='<table class="w-full text-xs border">', mobs=new Set();
            res.data.forEach(r=>mobs.add(+r.mob));
            let mobArr=Array.from(mobs).sort((a,b)=>a-b);
            html+='<tr><th class="border p-1">Vintage</th>'+mobArr.map(m=>`<th class="border p-1">${m}</th>`).join('')+'</tr>';
            let vints={}; res.data.forEach(r=>{ if(!vints[r.vintage]) vints[r.vintage]={}; vints[r.vintage][r.mob]=+r.value; });
            Object.keys(vints).sort().forEach(v=>{
                html+=`<tr><td class="border p-1 font-bold">${v}</td>`+mobArr.map(m=>{
                    let val=vints[v][m]; return `<td class="border p-1 text-center" style="background-color:rgba(255,0,0,${val?val/10:0})">${val?val.toFixed(2)+'%':''}</td>`;
                }).join('')+'</tr>';
            });
            document.getElementById('sp-heat').innerHTML = html+'</table>';
        }});
    });
}

function renderAnnualLossRate() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Principal</label><input id="alr-prin" type="number" value="1000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Coupon % (Annual)</label><input id="alr-rate" type="number" value="12" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="alr-tenor" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Frequency</label>
          <select id="alr-freq" class="w-full border rounded p-2">
            <option value="monthly" selected>Monthly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
        <div><label class="text-xs text-slate-500">Prepayment % per Period</label><input id="alr-prepay" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Lifetime Loss % of Orig</label><input id="alr-loss" type="number" value="4" class="w-full border rounded p-2"></div>
      </div>
      <button id="alr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Annualised Loss Rate</button>
      <div id="alr-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
      <div id="alr-chart" class="h-64"></div>
      <div class="text-xs text-slate-500">Method: Converts lifetime loss (as % of original principal) into an annualised risk premium by dividing expected loss amount by time-weighted exposure (sum of avg outstanding * years), factoring amortisation and constant prepayment per period.</div>
    </div>
  `;
  document.getElementById('alr-run').onclick = () => {
    const prin = +document.getElementById('alr-prin').value;
    const rate = +document.getElementById('alr-rate').value;
    const tenorM = +document.getElementById('alr-tenor').value;
    const freq = document.getElementById('alr-freq').value;
    const prepayPct = +document.getElementById('alr-prepay').value / 100;
    const lossPct = +document.getElementById('alr-loss').value / 100;
    const monthsPer = freq === 'quarterly' ? 3 : 1;
    const periods = Math.ceil(tenorM / monthsPer);
    const perRate = rate / (12 / monthsPer) / 100;
    const perEmi = perRate === 0 ? prin / periods : prin * perRate * Math.pow(1 + perRate, periods) / (Math.pow(1 + perRate, periods) - 1);
    let bal = prin, exposureTime = 0, walNum = 0, sched = [];

    for (let p = 1; p <= periods; p++) {
      const interest = bal * perRate;
      const schedPrin = Math.min(bal, Math.max(0, perEmi - interest));
      const prepay = bal * prepayPct;
      const totalPrin = Math.min(bal, schedPrin + prepay);
      const endBal = bal - totalPrin;
      const avgBal = (bal + endBal) / 2;
      const years = monthsPer / 12;
      exposureTime += avgBal * years;
      walNum += totalPrin * p * years;
      sched.push({ period: p, balStart: bal, interest, schedPrin, prepay, endBal });
      bal = endBal;
      if (bal <= 1) break;
    }

    const lossAmount = prin * lossPct;
    const annualLossRate = exposureTime > 0 ? lossAmount / exposureTime : 0; // annualised spread as % of outstanding
    const wal = prin > 0 ? walNum / prin : 0;

    document.getElementById('alr-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Lifetime Loss</div><div class="font-bold text-lg text-red-600">${moneyFmt.format(lossAmount)}</div><div class="text-xs text-slate-500">${(lossPct*100).toFixed(2)}% of orig</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Annualised Risk Premium</div><div class="font-bold text-lg text-indigo-700">${(annualLossRate*100).toFixed(2)}%</div><div class="text-xs text-slate-500">${(annualLossRate*10000).toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Exposure Time (Principal-Years)</div><div class="font-bold text-lg">${moneyFmt.format(exposureTime)}</div><div class="text-xs text-slate-500">Avg Outstand ${moneyFmt.format(exposureTime / (tenorM/12 || 1))}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">WAL (approx)</div><div class="font-bold text-lg">${wal.toFixed(2)} yrs</div><div class="text-xs text-slate-500">Freq ${freq}, Prepay ${(prepayPct*100).toFixed(1)}%</div></div>
    `;

    const trace = {
      x: sched.map(r => r.period),
      y: sched.map(r => r.balStart),
      type: 'scatter',
      name: 'Outstanding',
      line: { color: '#6366f1' }
    };
    Plotly.newPlot('alr-chart', [trace], { margin:{t:20}, xaxis:{title:'Period'}, yaxis:{title:'Outstanding'} });
  };
}

function renderDelinqLadder() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">PAR30 %</label><input id="dl-30" type="number" value="6" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PAR60 %</label><input id="dl-60" type="number" value="3.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PAR90 %</label><input id="dl-90" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cure 30 %</label><input id="dl-cure30" type="number" value="65" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cure 60 %</label><input id="dl-cure60" type="number" value="35" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="dl-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">WAL (yrs)</label><input id="dl-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Portfolio OS</label><input id="dl-os" type="number" value="10000000" class="w-full border rounded p-2"></div>
      </div>
      <button id="dl-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Convert Ladder</button>
      <div id="dl-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('dl-run').onclick = () => {
    const par30=+document.getElementById('dl-30').value/100;
    const par60=+document.getElementById('dl-60').value/100;
    const par90=+document.getElementById('dl-90').value/100;
    const cure30=+document.getElementById('dl-cure30').value/100;
    const cure60=+document.getElementById('dl-cure60').value/100;
    const lgd=+document.getElementById('dl-lgd').value/100;
    const wal=+document.getElementById('dl-wal').value;
    const os=+document.getElementById('dl-os').value;
    const b30 = Math.max(0, par30 - par60);
    const b60 = Math.max(0, par60 - par90);
    const b90 = Math.max(0, par90);
    const defFrom60 = b60 * (1 - cure60);
    const defFrom30 = b30 * (1 - cure30) * (1 - cure60);
    const totalDefaultPct = b90 + defFrom60 + defFrom30;
    const lifetimeLossPct = totalDefaultPct * lgd * 100;
    const lossAmt = os * totalDefaultPct * lgd;
    const spread = wal>0 ? (lossAmt/os)/wal : 0;
    document.getElementById('dl-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Implied Default %</div><div class="font-bold text-lg">${(totalDefaultPct*100).toFixed(2)}%</div><div class="text-xs text-slate-500">30→60 ${defFrom30>0? (defFrom30*100).toFixed(2)+'%':''}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Lifetime Loss</div><div class="font-bold text-lg text-red-600">${lifetimeLossPct.toFixed(2)}%</div><div class="text-xs text-slate-500">${moneyFmt.format(lossAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Annualised Spread</div><div class="font-bold text-lg text-indigo-700">${(spread*10000).toFixed(0)} bps</div><div class="text-xs text-slate-500">WAL ${wal} yrs</div></div>
    `;
  };
}

function renderProductMixRisk() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="pm-base" type="number" value="400" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Default WAL (yrs)</label><input id="pm-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Prepay Adj Factor</label><input id="pm-prepayf" type="number" value="0.8" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Optional: Pool OS</label><input id="pm-os" type="number" value="10000000" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Products (name,share%,PD%,LGD%,prepay%/yr)</label>
        <textarea id="pm-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs">MFI,40,4,50,20
LAP,25,2,35,10
PL,25,5,60,25
Vehicle,10,3,45,18</textarea>
      </div>
      <button id="pm-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Uplift</button>
      <div id="pm-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div class="overflow-auto max-h-64 border rounded"><table class="w-full text-xs"><tbody id="pm-table"></tbody></table></div>
    </div>
  `;
  document.getElementById('pm-run').onclick = () => {
    const base=+document.getElementById('pm-base').value;
    const wal=+document.getElementById('pm-wal').value;
    const prepayF=+document.getElementById('pm-prepayf').value;
    const os=+document.getElementById('pm-os').value;
    const lines=document.getElementById('pm-rows').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
    let totalShare=0, weightedEL=0, weightedWal=0;
    const rows=[];
    lines.forEach(l=>{
      const p=l.split(',').map(v=>v.trim());
      if(p.length<5) return;
      const name=p[0], share=+p[1]/100, pd=+p[2]/100, lgd=+p[3]/100, prepay=+p[4]/100;
      if(share<=0) return;
      totalShare += share;
      const el=pd*lgd;
      const adjWal = wal * (1 - prepay*prepayF);
      weightedEL += share*el;
      weightedWal += share*adjWal;
      rows.push({name, share, el, adjWal});
    });
    const avgWal = weightedWal/(totalShare||1);
    const spread = avgWal>0 ? (weightedEL)/(avgWal)*10000 : 0;
    const uplift = spread - base;
    document.getElementById('pm-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Weighted EL</div><div class="font-bold text-lg text-red-600">${(weightedEL*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Adj WAL</div><div class="font-bold text-lg">${avgWal.toFixed(2)} yrs</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Risk Premium</div><div class="font-bold text-lg text-indigo-700">${spread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Uplift vs base ${uplift.toFixed(0)} bps</div></div>
    `;
    const body = rows.map(r=>`<tr><td class="p-2 border">${r.name}</td><td class="p-2 border text-right">${(r.share*100).toFixed(1)}%</td><td class="p-2 border text-right">${(r.el*100).toFixed(2)}%</td><td class="p-2 border text-right">${r.adjWal.toFixed(2)}</td></tr>`).join('');
    document.getElementById('pm-table').innerHTML = `<tr class="bg-slate-100"><th class="p-2 border text-left">Product</th><th class="p-2 border text-right">Share</th><th class="p-2 border text-right">EL %</th><th class="p-2 border text-right">Adj WAL</th></tr>${body}`;
  };
}

function renderSeverityFrequency() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">PD %</label><input id="sf-pd" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="sf-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">WAL (yrs)</label><input id="sf-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="sf-base" type="number" value="400" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PD Add-on (bps/1pp)</label><input id="sf-pdadd" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD Add-on (bps/5pp)</label><input id="sf-lgdadd" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Target Buffer bps</label><input id="sf-buf" type="number" value="50" class="w-full border rounded p-2"></div>
      </div>
      <button id="sf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Decompose</button>
      <div id="sf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('sf-run').onclick = () => {
    const pd=+document.getElementById('sf-pd').value/100;
    const lgd=+document.getElementById('sf-lgd').value/100;
    const wal=+document.getElementById('sf-wal').value;
    const base=+document.getElementById('sf-base').value;
    const pdAdd=+document.getElementById('sf-pdadd').value;
    const lgdAdd=+document.getElementById('sf-lgdadd').value;
    const buf=+document.getElementById('sf-buf').value;
    const el = pd*lgd;
    const spread = wal>0 ? (el/wal)*10000 : 0;
    const pdLever = (pd*100)*pdAdd;
    const lgdLever = (lgd*100/5)*lgdAdd;
    const total = base + spread + pdLever + lgdLever + buf;
    document.getElementById('sf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">EL</div><div class="font-bold text-lg text-red-600">${(el*100).toFixed(2)}%</div><div class="text-xs text-slate-500">Spread from EL ${(spread).toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Frequency Lever</div><div class="font-bold text-lg">${pdLever.toFixed(0)} bps</div><div class="text-xs text-slate-500">PD ${(pd*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Severity Lever</div><div class="font-bold text-lg">${lgdLever.toFixed(0)} bps</div><div class="text-xs text-slate-500">LGD ${(lgd*100).toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Total Suggested Spread</div><div class="font-bold text-lg text-indigo-700">${total.toFixed(0)} bps</div><div class="text-xs text-slate-500">Includes base ${base} + buffer ${buf}</div></div>
    `;
  };
}

function renderPtpTracker() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">PTP Horizon (days)</label><input id="ptp-hor" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Max Days Late to Count</label><input id="ptp-late" type="number" value="5" class="w-full border rounded p-2"></div>
      </div>
      <textarea id="ptp-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="date,amount,status,paid_date(optional)">2025-01-01,25000,promise,2025-01-03
2025-01-02,18000,broken,
2025-01-03,12000,promise,2025-01-10</textarea>
      <button id="ptp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Track PTP</button>
      <div id="ptp-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ptp-run').onclick = () => {
    const hor=+document.getElementById('ptp-hor').value;
    const late=+document.getElementById('ptp-late').value;
    const lines=document.getElementById('ptp-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let promised=0, kept=0, broken=0;
    lines.forEach(l=>{
      const p=l.split(','); if(p.length<3) return;
      const amt=+p[1]; const status=(p[2]||'').toLowerCase();
      promised += amt;
      if(status==='promise'){
        const paidDate = p[3] ? new Date(p[3]) : null;
        const promiseDate = p[0] ? new Date(p[0]) : null;
        const diffDays = paidDate && promiseDate ? (paidDate - promiseDate)/(1000*60*60*24) : Infinity;
        if(paidDate && diffDays <= (hor+late)) kept += amt; else broken += amt;
      } else if(status==='kept') kept += amt; else broken += amt;
    });
    const hitRate = promised ? (kept/promised)*100 : 0;
    document.getElementById('ptp-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Promised</div><div class="font-bold text-lg">${moneyFmt.format(promised)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Kept</div><div class="font-bold text-lg text-green-700">${moneyFmt.format(kept)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Hit Rate</div><div class="font-bold text-lg ${hitRate>=50?'text-green-700':'text-red-600'}">${hitRate.toFixed(1)}%</div><div class="text-xs text-slate-500">Broken ${moneyFmt.format(broken)}</div></div>
    `;
  };
}

function renderSettlementOptimizer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Bucket OS</label><input id="so-os" type="number" value="5000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Min Offer %</label><input id="so-min" type="number" value="40" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Expected Uptake %</label><input id="so-uptake" type="number" value="25" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cost-to-Collect %</label><input id="so-ctc" type="number" value="3" class="w-full border rounded p-2"></div>
      </div>
      <button id="so-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Optimize Offer</button>
      <div id="so-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('so-run').onclick = () => {
    const os=+document.getElementById('so-os').value;
    const min=+document.getElementById('so-min').value/100;
    const uptake=+document.getElementById('so-uptake').value/100;
    const ctc=+document.getElementById('so-ctc').value/100;
    const settleAmt=os*min*uptake;
    const ctcAmt=os*ctc;
    const net=settleAmt-ctcAmt;
    document.getElementById('so-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Offer Collected</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(settleAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cost-to-Collect</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(ctcAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net</div><div class="font-bold text-lg ${net>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(net)}</div></div>
    `;
  };
}

function renderRollRateCube() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <textarea id="rrc-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="from,to,rate%">0,0,85
0,30,10
0,60,3
30,0,30
30,60,50
60,90,20
90,wo,40</textarea>
      <button id="rrc-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Build Cube</button>
      <div id="rrc-table" class="overflow-auto max-h-80 border rounded"></div>
    </div>
  `;
  document.getElementById('rrc-run').onclick = () => {
    const lines=document.getElementById('rrc-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rates={}; const cats=new Set();
    lines.forEach(l=>{ const p=l.split(','); if(p.length<3)return; const f=p[0], t=p[1], r=+p[2]; cats.add(f); cats.add(t); rates[`${f}|${t}`]=r; });
    const headers=Array.from(cats);
    let html='<table class="w-full text-xs"><tr><th class="p-2 border">From\\To</th>'+headers.map(h=>`<th class="p-2 border">${h}</th>`).join('')+'</tr>';
    headers.forEach(f=>{
      html+=`<tr><td class="p-2 border font-semibold">${f}</td>`+headers.map(t=>{
        const r=rates[`${f}|${t}`]; return `<td class="p-2 border text-right ${r>=50?'text-red-600':'text-slate-700'}">${isFinite(r)?r.toFixed(1)+'%':''}</td>`;
      }).join('')+'</tr>';
    });
    html+='</table>';
    document.getElementById('rrc-table').innerHTML = html;
  };
}

function renderCureForecast() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Max Cure %</label><input id="cf-max" type="number" value="85" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Midpoint (days)</label><input id="cf-mid" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Steepness</label><input id="cf-k" type="number" value="0.2" step="0.05" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Horizon (days)</label><input id="cf-hor" type="number" value="90" class="w-full border rounded p-2"></div>
      </div>
      <button id="cf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast Cure</button>
      <div id="cf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div id="cf-chart" class="h-64"></div>
    </div>
  `;
  document.getElementById('cf-run').onclick = () => {
    const max=+document.getElementById('cf-max').value/100;
    const mid=+document.getElementById('cf-mid').value;
    const k=+document.getElementById('cf-k').value;
    const hor=+document.getElementById('cf-hor').value;
    const xs=[], ys=[];
    for(let d=0; d<=hor; d+=5){
      const cure = max/(1+Math.exp(-k*(d-mid)));
      xs.push(d); ys.push(cure*100);
    }
    const day30 = max/(1+Math.exp(-k*(30-mid)))*100;
    const day60 = max/(1+Math.exp(-k*(60-mid)))*100;
    document.getElementById('cf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cure @30d</div><div class="font-bold text-lg">${day30.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cure @60d</div><div class="font-bold text-lg">${day60.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Cure</div><div class="font-bold text-lg text-indigo-700">${(max*100).toFixed(1)}%</div></div>
    `;
    Plotly.newPlot('cf-chart', [{x:xs, y:ys, type:'scatter', line:{color:'#6366f1'}}], {margin:{t:20}, xaxis:{title:'Days'}, yaxis:{title:'Cure %'}});
  };
}

function renderFieldRoute() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Max Visits/Day</label><input id="fr-max" type="number" value="8" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Distance Penalty (per km)</label><input id="fr-pen" type="number" value="1" class="w-full border rounded p-2"></div>
      </div>
      <textarea id="fr-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="name,amount,km_from_base">Asha,15000,5
Ravi,22000,12
Meera,9000,3
Suman,14000,2
Kiran,18000,9</textarea>
      <button id="fr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Plan Visits</button>
      <div id="fr-res" class="overflow-auto max-h-80 border rounded"></div>
    </div>
  `;
  document.getElementById('fr-run').onclick = () => {
    const max=+document.getElementById('fr-max').value;
    const pen=+document.getElementById('fr-pen').value;
    const lines=document.getElementById('fr-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rows=lines.map(l=>{ const p=l.split(','); return {name:p[0], amt:+p[1], dist:+p[2], score:(+p[1])-(pen*(+p[2]))}; }).sort((a,b)=>b.score-a.score);
    const pick=rows.slice(0, max);
    const html=pick.map(r=>`<tr><td class="p-2 border">${r.name}</td><td class="p-2 border text-right">${moneyFmt.format(r.amt)}</td><td class="p-2 border text-right">${r.dist||0} km</td><td class="p-2 border text-right">${r.score.toFixed(0)}</td></tr>`).join('');
    document.getElementById('fr-res').innerHTML = `<table class="w-full text-xs"><tr class="bg-slate-100"><th class="p-2 border text-left">Cust</th><th class="p-2 border text-right">Amount</th><th class="p-2 border text-right">Dist</th><th class="p-2 border text-right">Priority</th></tr>${html}</table>`;
  };
}

function renderLegalRoi() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Claim Amount</label><input id="lr-claim" type="number" value="1000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Legal Fees</label><input id="lr-fee" type="number" value="80000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Win Rate %</label><input id="lr-win" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Recovery % on Win</label><input id="lr-rec" type="number" value="55" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Timeline (months)</label><input id="lr-time" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Discount Rate %</label><input id="lr-disc" type="number" value="12" class="w-full border rounded p-2"></div>
      </div>
      <button id="lr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute ROI</button>
      <div id="lr-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('lr-run').onclick = () => {
    const claim=+document.getElementById('lr-claim').value;
    const fee=+document.getElementById('lr-fee').value;
    const win=+document.getElementById('lr-win').value/100;
    const rec=+document.getElementById('lr-rec').value/100;
    const time=+document.getElementById('lr-time').value;
    const disc=+document.getElementById('lr-disc').value/1200;
    const expected = claim*rec*win;
    const pv = expected/Math.pow(1+disc, time);
    const roi = fee>0 ? (pv-fee)/fee : 0;
    const annual = time>0 ? Math.pow(pv/fee, 12/time)-1 : roi;
    document.getElementById('lr-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Expected Recovery</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(expected)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV @Discount</div><div class="font-bold text-lg">${moneyFmt.format(pv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">ROI</div><div class="font-bold text-lg ${roi>=0?'text-green-700':'text-red-600'}">${(roi*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Annualised ${(annual*100).toFixed(1)}%</div></div>
    `;
  };
}

function renderNetYield() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Customer Rate %</label><input id="ny-rate" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="ny-cof" type="number" value="9" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Opex bps</label><input id="ny-opex" type="number" value="200" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Credit Cost %</label><input id="ny-cc" type="number" value="2.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Fee % (annualised)</label><input id="ny-fee" type="number" value="1" class="w-full border rounded p-2"></div>
      </div>
      <button id="ny-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Net Yield</button>
      <div id="ny-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ny-run').onclick = () => {
    const rate=+document.getElementById('ny-rate').value;
    const cof=+document.getElementById('ny-cof').value;
    const opex=+document.getElementById('ny-opex').value/100; // bps to %
    const cc=+document.getElementById('ny-cc').value;
    const fee=+document.getElementById('ny-fee').value;
    const net = rate + fee - cof - opex - cc;
    document.getElementById('ny-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Gross Yield</div><div class="font-bold text-lg">${rate.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Costs (CoF+Opex+CC)</div><div class="font-bold text-lg text-red-600">${(cof+opex+cc).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Yield</div><div class="font-bold text-lg text-indigo-700">${net.toFixed(2)}%</div><div class="text-xs text-slate-500">Includes fee ${fee.toFixed(2)}%</div></div>
    `;
  };
}

function renderFeeImpact() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Principal</label><input id="fi-amt" type="number" value="500000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Fee % (Upfront)</label><input id="fi-fee" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate %</label><input id="fi-rate" type="number" value="16" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (M)</label><input id="fi-ten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Amortize Fee? (Y/N)</label><select id="fi-amort" class="w-full border rounded p-2"><option value="yes">Yes</option><option value="no" selected>No</option></select></div>
        <div><label class="text-xs text-slate-500">Discount Rate %</label><input id="fi-discount" type="number" value="12" class="w-full border rounded p-2"></div>
      </div>
      <button id="fi-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compare Impact</button>
      <div id="fi-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('fi-run').onclick = () => {
    const p=+document.getElementById('fi-amt').value;
    const feePct=+document.getElementById('fi-fee').value/100;
    const rate=+document.getElementById('fi-rate').value;
    const ten=+document.getElementById('fi-ten').value;
    const amort=document.getElementById('fi-amort').value==='yes';
    const disc=+document.getElementById('fi-discount').value/1200;
    const feeAmt=p*feePct;
    const emi=calcEmi(p, rate, ten);
    let pvUpfront = feeAmt; // received at t0
    let pvAmort = 0;
    if(amort){
      const feePer = feeAmt/ten;
      for(let i=1;i<=ten;i++){ pvAmort += feePer / Math.pow(1+disc, i); }
    }
    document.getElementById('fi-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Fee Amount</div><div class="font-bold text-lg">${moneyFmt.format(feeAmt)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emi)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV (Upfront)</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(pvUpfront)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV (Amortized)</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(pvAmort)}</div><div class="text-xs text-slate-500">${amort?'Spread over tenor':'N/A'}</div></div>
    `;
  };
}

function renderCrossSell() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Base Conversion %</label><input id="cs-base" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Uplift %</label><input id="cs-uplift" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Revenue per Convert</label><input id="cs-rev" type="number" value="1500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cost per Outreach</label><input id="cs-cost" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Base Population</label><input id="cs-pop" type="number" value="10000" class="w-full border rounded p-2"></div>
      </div>
      <button id="cs-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast</button>
      <div id="cs-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('cs-run').onclick = () => {
    const base=+document.getElementById('cs-base').value/100;
    const uplift=+document.getElementById('cs-uplift').value/100;
    const rev=+document.getElementById('cs-rev').value;
    const cost=+document.getElementById('cs-cost').value;
    const pop=+document.getElementById('cs-pop').value;
    const baseConv = pop*base;
    const newConv = pop*(base+uplift);
    const incrConv = newConv - baseConv;
    const gross = newConv*rev;
    const spend = pop*cost;
    const roi = spend>0 ? (gross-spend)/spend : 0;
    document.getElementById('cs-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Conversions</div><div class="font-bold text-lg">${newConv.toFixed(0)}</div><div class="text-xs text-slate-500">Base ${baseConv.toFixed(0)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Revenue</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(gross)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">ROI</div><div class="font-bold text-lg ${roi>=0?'text-green-700':'text-red-600'}">${(roi*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Spend ${moneyFmt.format(spend)}</div></div>
    `;
  };
}

function renderPrepayPenalty() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Portfolio OS</label><input id="pp-os" type="number" value="100000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Annual Prepay %</label><input id="pp-pre" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Penalty %</label><input id="pp-pen" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Attrition Sensitivity (pp per %pen)</label><input id="pp-sens" type="number" value="0.8" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="pp-cof" type="number" value="9" class="w-full border rounded p-2"></div>
      </div>
      <button id="pp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Optimize</button>
      <div id="pp-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('pp-run').onclick = () => {
    const os=+document.getElementById('pp-os').value;
    const pre=+document.getElementById('pp-pre').value/100;
    const pen=+document.getElementById('pp-pen').value/100;
    const sens=+document.getElementById('pp-sens').value/100;
    const cof=+document.getElementById('pp-cof').value/100;
    const penaltyIncome = os*pre*pen;
    const churnImpact = os*pre*(pen*100*sens/100); // attrition increase proportional to sensitivity
    const carryLoss = churnImpact*cof;
    const net = penaltyIncome - carryLoss;
    document.getElementById('pp-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Penalty Income</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(penaltyIncome)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Extra Attrition OS</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(churnImpact)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Impact</div><div class="font-bold text-lg ${net>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(net)}</div><div class="text-xs text-slate-500">Carry loss ${moneyFmt.format(carryLoss)}</div></div>
    `;
  };
}

function renderLossLeader() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">CAC</label><input id="ll-cac" type="number" value="1500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Promo Loss per Cust</label><input id="ll-loss" type="number" value="800" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Gross Margin</label><input id="ll-mgm" type="number" value="150" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Churn % / month</label><input id="ll-churn" type="number" value="4" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV Uplift % (cross/upsell)</label><input id="ll-uplift" type="number" value="25" class="w-full border rounded p-2"></div>
      </div>
      <button id="ll-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Payback</button>
      <div id="ll-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ll-run').onclick = () => {
    const cac=+document.getElementById('ll-cac').value;
    const loss=+document.getElementById('ll-loss').value;
    const mgm=+document.getElementById('ll-mgm').value;
    const churn=+document.getElementById('ll-churn').value/100;
    const uplift=+document.getElementById('ll-uplift').value/100;
    const baseLtv = mgm / (churn>0 ? churn : 0.01);
    const totalLtv = baseLtv * (1+uplift);
    const payback = (cac+loss)/(mgm>0?mgm:1);
    const netUnit = totalLtv - (cac+loss);
    document.getElementById('ll-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Base LTV</div><div class="font-bold text-lg">${moneyFmt.format(baseLtv)}</div><div class="text-xs text-slate-500">With uplift ${moneyFmt.format(totalLtv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Payback (months)</div><div class="font-bold text-lg text-indigo-700">${payback.toFixed(1)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Unit Profit</div><div class="font-bold text-lg ${netUnit>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(netUnit)}</div></div>
    `;
  };
}
function renderVintageLossForecaster() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-5xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Horizon (MOB)</label><input id="vlf-hor" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tail Decay (% of last delta)</label><input id="vlf-decay" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Band Width %</label><input id="vlf-band" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Price Cushion bps</label><input id="vlf-cush" type="number" value="50" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Vintage Data (mob,cum_loss%)</label>
        <textarea id="vlf-data" rows="6" class="w-full border rounded p-3 font-mono text-xs">1,0.20
2,0.32
3,0.45
4,0.55
5,0.63
6,0.70
9,0.85
12,0.95
15,1.05
18,1.10</textarea>
      </div>
      <button id="vlf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast Lifetime Loss</button>
      <div id="vlf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div id="vlf-chart" class="h-72"></div>
    </div>
  `;
  document.getElementById('vlf-run').onclick = () => {
    const hor = +document.getElementById('vlf-hor').value;
    const decay = +document.getElementById('vlf-decay').value / 100;
    const band = +document.getElementById('vlf-band').value / 100;
    const cushion = +document.getElementById('vlf-cush').value;
    const lines = document.getElementById('vlf-data').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let pts = lines.map(l => { const p=l.split(','); return { mob:+p[0], loss:+p[1] }; }).filter(p=>p.mob>0 && p.loss>=0).sort((a,b)=>a.mob-b.mob);
    if (!pts.length) return;
    const data = [];
    // interpolate missing mobs
    for (let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1];
      data.push(a);
      const gap = b.mob - a.mob;
      if (gap>1){
        const step = (b.loss - a.loss)/gap;
        for(let g=1; g<gap; g++) data.push({ mob:a.mob+g, loss:a.loss+step*g });
      }
    }
    data.push(pts[pts.length-1]);
    let lastLoss = data[data.length-1].loss;
    let lastDelta = data.length>1 ? data[data.length-1].loss - data[data.length-2].loss : 0;
    for (let m = data[data.length-1].mob+1; m<=hor; m++){
      lastDelta = lastDelta * decay;
      lastLoss = lastLoss + lastDelta;
      data.push({ mob:m, loss:lastLoss });
    }
    const finalLoss = data[data.length-1].loss;
    const low = finalLoss*(1-band), high = finalLoss*(1+band);
    document.getElementById('vlf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Forecast Lifetime Loss</div><div class="font-bold text-lg text-indigo-700">${finalLoss.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Confidence Band</div><div class="font-bold text-lg">${low.toFixed(2)}% - ${high.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Pricing Cushion</div><div class="font-bold text-lg text-amber-700">${cushion} bps</div></div>
    `;
    Plotly.newPlot('vlf-chart', [
      { x:data.map(d=>d.mob), y:data.map(d=>d.loss), type:'scatter', name:'Forecast', line:{color:'#6366f1'} },
      { x:[data[0].mob, data[data.length-1].mob], y:[low, low], mode:'lines', name:'Lower', line:{dash:'dot', color:'#22c55e'} },
      { x:[data[0].mob, data[data.length-1].mob], y:[high, high], mode:'lines', name:'Upper', line:{dash:'dot', color:'#ef4444'} },
    ], { margin:{t:20}, xaxis:{title:'MOB'}, yaxis:{title:'Cum Loss %'} });
  };
}

function renderStressUplift() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="su-base" type="number" value="450" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">GDP Shock (ppt)</label><input id="su-gdp" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Inflation Shock (ppt)</label><input id="su-inf" type="number" value="1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate Shock (bps)</label><input id="su-rate" type="number" value="100" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">GDP Sens (bps/ppt)</label><input id="su-gdpw" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Infl Sens (bps/ppt)</label><input id="su-infw" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate Sens (bps/100bps)</label><input id="su-ratew" type="number" value="10" class="w-full border rounded p-2"></div>
      </div>
      <button id="su-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Recommend Uplift</button>
      <div id="su-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('su-run').onclick = () => {
    const base = +document.getElementById('su-base').value;
    const gdp = +document.getElementById('su-gdp').value;
    const inf = +document.getElementById('su-inf').value;
    const rate = +document.getElementById('su-rate').value;
    const gw = +document.getElementById('su-gdpw').value;
    const iw = +document.getElementById('su-infw').value;
    const rw = +document.getElementById('su-ratew').value;
    const uplift = gdp*gw + inf*iw + (rate/100)*rw;
    const stressed = base + uplift;
    document.getElementById('su-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Base Spread</div><div class="font-bold text-lg">${base} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Stress Uplift</div><div class="font-bold text-lg text-amber-700">${uplift.toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Stressed Spread</div><div class="font-bold text-lg text-indigo-700">${stressed.toFixed(0)} bps</div></div>
    `;
  };
}

function renderCoLendFls() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Bank Share %</label><input id="fls-bank" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">NBFC Share %</label><input id="fls-nbfc" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">First-Loss / FLDG % of Pool</label><input id="fls-fl" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PD %</label><input id="fls-pd" type="number" value="4" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="fls-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Target ROE Buffer bps</label><input id="fls-roe" type="number" value="150" class="w-full border rounded p-2"></div>
      </div>
      <button id="fls-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Split Spread</button>
      <div id="fls-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('fls-run').onclick = () => {
    const bShare = +document.getElementById('fls-bank').value/100;
    const nShare = +document.getElementById('fls-nbfc').value/100;
    const fl = +document.getElementById('fls-fl').value/100;
    const pd = +document.getElementById('fls-pd').value/100;
    const lgd = +document.getElementById('fls-lgd').value/100;
    const roe = +document.getElementById('fls-roe').value;
    const el = pd*lgd;
    const residual = Math.max(0, el - fl);
    const bankLoss = residual * bShare;
    const nbfcLoss = residual * nShare + fl;
    const bankSpread = bankLoss*10000 + roe;
    const nbfcSpread = nbfcLoss*10000 + roe;
    document.getElementById('fls-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Pool EL</div><div class="font-bold text-lg text-red-600">${(el*100).toFixed(2)}%</div><div class="text-xs text-slate-500">First-loss ${ (fl*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Bank Allocation</div><div class="font-bold text-lg text-indigo-700">${bankSpread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Net loss ${(bankLoss*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">NBFC Allocation</div><div class="font-bold text-lg text-amber-700">${nbfcSpread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Net loss ${(nbfcLoss*100).toFixed(2)}%</div></div>
    `;
  };
}

function renderBureauPricing() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-5xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Base Rate %</label><input id="bp-base" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="bp-cof" type="number" value="9" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Opex bps</label><input id="bp-opex" type="number" value="200" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">ROE Target bps</label><input id="bp-roe" type="number" value="300" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Bands (from-to, annualised loss %)</label>
        <textarea id="bp-bands" rows="6" class="w-full border rounded p-3 font-mono text-xs">750,800,1.8
700,749,3.0
650,699,4.2
600,649,6.5</textarea>
      </div>
      <button id="bp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Band Pricing</button>
      <div id="bp-res" class="overflow-auto max-h-72 border rounded"></div>
    </div>
  `;
  document.getElementById('bp-run').onclick = () => {
    const base = +document.getElementById('bp-base').value;
    const cof = +document.getElementById('bp-cof').value;
    const opex = +document.getElementById('bp-opex').value;
    const roe = +document.getElementById('bp-roe').value;
    const lines = document.getElementById('bp-bands').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rows = lines.map(l => {
      const p = l.split(',').map(v=>v.trim());
      return { from:+p[0], to:+p[1], loss:+p[2] };
    }).filter(r=>r.loss>=0);
    const html = rows.map(r => {
      const lossBps = r.loss*100;
      const reqRate = (cof*100 + opex + lossBps + roe)/100; // convert bps back to %
      const premium = (reqRate - base)*100;
      return `<tr>
        <td class="p-2 border text-center">${r.from}-${r.to}</td>
        <td class="p-2 border text-right">${r.loss.toFixed(2)}%</td>
        <td class="p-2 border text-right">${reqRate.toFixed(2)}%</td>
        <td class="p-2 border text-right ${premium>=0?'text-red-600':'text-green-700'}">${premium.toFixed(0)} bps</td>
      </tr>`;
    }).join('');
    document.getElementById('bp-res').innerHTML = `
      <table class="w-full text-xs">
        <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2 border">Score Band</th><th class="p-2 border">Ann Loss %</th><th class="p-2 border">Req Rate %</th><th class="p-2 border">Premium vs Base</th></tr></thead>
        <tbody>${html}</tbody>
      </table>
    `;
  };
}

function renderExcelToolkit() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">Percent Change</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <input id="xtk-old" type="number" value="100" class="border rounded p-2" placeholder="Old">
            <input id="xtk-new" type="number" value="125" class="border rounded p-2" placeholder="New">
          </div>
          <div id="xtk-pc" class="text-lg font-bold text-indigo-700">+25.0%</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">CAGR</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <input id="xtk-beg" type="number" value="100" class="border rounded p-2" placeholder="Start">
            <input id="xtk-end" type="number" value="200" class="border rounded p-2" placeholder="End">
            <input id="xtk-yrs" type="number" value="3" class="border rounded p-2" placeholder="Years">
          </div>
          <div id="xtk-cagr" class="text-lg font-bold text-indigo-700">25.99%</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">EMI</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <input id="xtk-amt" type="number" value="500000" class="border rounded p-2" placeholder="Amount">
            <input id="xtk-ir" type="number" value="10" class="border rounded p-2" placeholder="Rate %">
            <input id="xtk-mon" type="number" value="60" class="border rounded p-2" placeholder="Months">
          </div>
          <div id="xtk-emi" class="text-lg font-bold text-indigo-700">${moneyFmt.format(calcEmi(500000,10,60))}</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">Weighted Average</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <textarea id="xtk-wt" rows="3" class="border rounded p-2 font-mono text-xs" placeholder="value,weight">10,2
20,3
30,1</textarea>
          </div>
          <div id="xtk-wavg" class="text-lg font-bold text-indigo-700">—</div>
        </div>
      </div>
    </div>
  `;
  const recalc = () => {
    const old = +document.getElementById('xtk-old').value;
    const nw = +document.getElementById('xtk-new').value;
    const pc = old ? ((nw-old)/old)*100 : 0;
    document.getElementById('xtk-pc').innerText = `${pc>=0?'+':''}${pc.toFixed(1)}%`;
    const beg = +document.getElementById('xtk-beg').value;
    const end = +document.getElementById('xtk-end').value;
    const yrs = +document.getElementById('xtk-yrs').value;
    const cagr = beg>0 && yrs>0 ? Math.pow(end/beg,1/yrs)-1 : 0;
    document.getElementById('xtk-cagr').innerText = `${(cagr*100).toFixed(2)}%`;
    const emi = calcEmi(+document.getElementById('xtk-amt').value, +document.getElementById('xtk-ir').value, +document.getElementById('xtk-mon').value);
    document.getElementById('xtk-emi').innerText = moneyFmt.format(emi);
    const lines = document.getElementById('xtk-wt').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let num=0, den=0;
    lines.forEach(l=>{
      const p=l.split(',').map(v=>+v.trim());
      if(p.length>=2 && isFinite(p[0]) && isFinite(p[1])){ num += p[0]*p[1]; den += p[1]; }
    });
    document.getElementById('xtk-wavg').innerText = den? (num/den).toFixed(2) : '—';
  };
  ['xtk-old','xtk-new','xtk-beg','xtk-end','xtk-yrs','xtk-amt','xtk-ir','xtk-mon','xtk-wt'].forEach(id=>{
    document.getElementById(id).addEventListener('input', recalc);
  });
  recalc();
}

// === NEW HIGH-PRIORITY TOOL RENDER FUNCTIONS ===

// FOIR Calculator
function renderFoirCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('foirCalculator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">FOIR Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Fixed Obligation to Income Ratio - max typically 50-60% for retail loans</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Net Monthly Income (₹)</label>
        <input type="number" id="foir-income" class="w-full border rounded px-3 py-2" value="100000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Existing EMIs (₹)</label>
        <input type="number" id="foir-existing" class="w-full border rounded px-3 py-2" value="15000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Proposed EMI (₹)</label>
        <input type="number" id="foir-proposed" class="w-full border rounded px-3 py-2" value="25000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Other Obligations (₹)</label>
        <input type="number" id="foir-other" class="w-full border rounded px-3 py-2" value="5000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Max FOIR Allowed (%)</label>
        <input type="number" id="foir-max" class="w-full border rounded px-3 py-2" value="55"></div>
      </div>
      <button onclick="calcFoir()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="foir-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcFoir = function() {
  const income = parseFloat(document.getElementById('foir-income').value) || 0;
  const existing = parseFloat(document.getElementById('foir-existing').value) || 0;
  const proposed = parseFloat(document.getElementById('foir-proposed').value) || 0;
  const other = parseFloat(document.getElementById('foir-other').value) || 0;
  const maxFoir = parseFloat(document.getElementById('foir-max').value) || 55;
  const totalObligation = existing + proposed + other;
  const foir = income > 0 ? (totalObligation / income * 100) : 0;
  const maxAllowed = income * maxFoir / 100;
  const eligible = foir <= maxFoir;
  const surplus = maxAllowed - totalObligation;
  document.getElementById('foir-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">FOIR:</div><div class="${eligible ? 'text-green-600' : 'text-red-600'} font-bold">${foir.toFixed(1)}%</div>
      <div class="font-medium">Total Obligations:</div><div>${moneyFmt.format(totalObligation)}</div>
      <div class="font-medium">Max Allowed:</div><div>${moneyFmt.format(maxAllowed)}</div>
      <div class="font-medium">Status:</div><div class="${eligible ? 'text-green-600' : 'text-red-600'} font-bold">${eligible ? '✓ Eligible' : '✗ Exceeds Limit'}</div>
      <div class="font-medium">Surplus/(Deficit):</div><div class="${surplus >= 0 ? 'text-green-600' : 'text-red-600'}">${moneyFmt.format(surplus)}</div>
    </div>`;
  saveToolState('foirCalculator');
};

// EMI Calculator with Schedule
function renderEmiCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('emiCalculator')}
    <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">EMI Calculator</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Principal (₹)</label>
        <input type="number" id="emi-principal" class="w-full border rounded px-3 py-2" value="1000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Interest Rate (% p.a.)</label>
        <input type="number" step="0.1" id="emi-rate" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Tenure (Months)</label>
        <input type="number" id="emi-tenure" class="w-full border rounded px-3 py-2" value="60"></div>
      </div>
      <button onclick="calcEmiSchedule()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <button onclick="downloadEmiSchedule()" class="bg-slate-600 text-white px-4 py-2 rounded font-medium ml-2">Download CSV</button>
      <div id="emi-summary" class="mt-4 p-4 bg-indigo-50 rounded border"></div>
      <div id="emi-schedule" class="mt-4 max-h-96 overflow-auto"></div>
    </div>`;
}
let emiScheduleData = [];
window.calcEmiSchedule = function() {
  const P = parseFloat(document.getElementById('emi-principal').value) || 0;
  const r = (parseFloat(document.getElementById('emi-rate').value) || 0) / 1200;
  const n = parseInt(document.getElementById('emi-tenure').value) || 0;
  if (!P || !n) return;
  const emi = r === 0 ? P / n : P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
  const totalPayment = emi * n;
  const totalInterest = totalPayment - P;
  document.getElementById('emi-summary').innerHTML = `
    <div class="grid grid-cols-4 gap-4 text-sm">
      <div><span class="text-slate-600">EMI:</span><div class="font-bold text-lg">${moneyFmt.format(emi)}</div></div>
      <div><span class="text-slate-600">Total Payment:</span><div class="font-bold">${moneyFmt.format(totalPayment)}</div></div>
      <div><span class="text-slate-600">Total Interest:</span><div class="font-bold text-red-600">${moneyFmt.format(totalInterest)}</div></div>
      <div><span class="text-slate-600">Interest %:</span><div class="font-bold">${(totalInterest/P*100).toFixed(1)}%</div></div>
    </div>`;
  emiScheduleData = [['Month', 'Opening', 'EMI', 'Principal', 'Interest', 'Closing']];
  let balance = P;
  let html = '<table class="w-full text-xs"><thead class="bg-slate-100 sticky top-0"><tr><th class="p-2">Month</th><th class="p-2 text-right">Opening</th><th class="p-2 text-right">EMI</th><th class="p-2 text-right">Principal</th><th class="p-2 text-right">Interest</th><th class="p-2 text-right">Closing</th></tr></thead><tbody>';
  for (let m = 1; m <= n; m++) {
    const interest = balance * r;
    const principal = emi - interest;
    const closing = balance - principal;
    emiScheduleData.push([m, balance.toFixed(0), emi.toFixed(0), principal.toFixed(0), interest.toFixed(0), Math.max(0, closing).toFixed(0)]);
    html += `<tr class="border-b"><td class="p-2">${m}</td><td class="p-2 text-right">${moneyFmt.format(balance)}</td><td class="p-2 text-right">${moneyFmt.format(emi)}</td><td class="p-2 text-right">${moneyFmt.format(principal)}</td><td class="p-2 text-right">${moneyFmt.format(interest)}</td><td class="p-2 text-right">${moneyFmt.format(Math.max(0, closing))}</td></tr>`;
    balance = closing;
  }
  html += '</tbody></table>';
  document.getElementById('emi-schedule').innerHTML = html;
  saveToolState('emiCalculator');
};
window.downloadEmiSchedule = function() {
  if (emiScheduleData.length > 1) downloadCSV(emiScheduleData, 'emi_schedule.csv');
};

// ECL Calculator (Ind AS 109)
function renderEclCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('eclCalculator')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">ECL Calculator (Ind AS 109)</h3>
      <p class="text-sm text-slate-600 mb-4">Expected Credit Loss = EAD × PD × LGD</p>
      <div class="overflow-x-auto">
        <table class="w-full text-sm mb-4">
          <thead class="bg-slate-100"><tr><th class="p-2">Stage</th><th class="p-2">EAD (₹ Cr)</th><th class="p-2">PD (%)</th><th class="p-2">LGD (%)</th><th class="p-2">ECL (₹ Cr)</th></tr></thead>
          <tbody>
            <tr class="border-b"><td class="p-2 font-medium">Stage 1 (12M)</td><td class="p-2"><input type="number" id="ecl-ead1" class="w-full border rounded px-2 py-1" value="1000"></td><td class="p-2"><input type="number" step="0.1" id="ecl-pd1" class="w-full border rounded px-2 py-1" value="2"></td><td class="p-2"><input type="number" id="ecl-lgd1" class="w-full border rounded px-2 py-1" value="35"></td><td class="p-2 font-bold" id="ecl-out1">-</td></tr>
            <tr class="border-b"><td class="p-2 font-medium">Stage 2 (Lifetime)</td><td class="p-2"><input type="number" id="ecl-ead2" class="w-full border rounded px-2 py-1" value="200"></td><td class="p-2"><input type="number" step="0.1" id="ecl-pd2" class="w-full border rounded px-2 py-1" value="15"></td><td class="p-2"><input type="number" id="ecl-lgd2" class="w-full border rounded px-2 py-1" value="45"></td><td class="p-2 font-bold" id="ecl-out2">-</td></tr>
            <tr class="border-b"><td class="p-2 font-medium">Stage 3 (Credit Impaired)</td><td class="p-2"><input type="number" id="ecl-ead3" class="w-full border rounded px-2 py-1" value="50"></td><td class="p-2"><input type="number" step="0.1" id="ecl-pd3" class="w-full border rounded px-2 py-1" value="100"></td><td class="p-2"><input type="number" id="ecl-lgd3" class="w-full border rounded px-2 py-1" value="65"></td><td class="p-2 font-bold" id="ecl-out3">-</td></tr>
          </tbody>
        </table>
      </div>
      <button onclick="calcEcl()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate ECL</button>
      <div id="ecl-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcEcl = function() {
  let totalEad = 0, totalEcl = 0;
  for (let i = 1; i <= 3; i++) {
    const ead = parseFloat(document.getElementById('ecl-ead' + i).value) || 0;
    const pd = (parseFloat(document.getElementById('ecl-pd' + i).value) || 0) / 100;
    const lgd = (parseFloat(document.getElementById('ecl-lgd' + i).value) || 0) / 100;
    const ecl = ead * pd * lgd;
    totalEad += ead;
    totalEcl += ecl;
    document.getElementById('ecl-out' + i).innerText = ecl.toFixed(2);
  }
  const coverage = totalEad > 0 ? (totalEcl / totalEad * 100) : 0;
  document.getElementById('ecl-result').innerHTML = `
    <div class="grid grid-cols-3 gap-4 text-center">
      <div><span class="text-slate-600">Total EAD</span><div class="font-bold text-lg">₹${totalEad.toFixed(0)} Cr</div></div>
      <div><span class="text-slate-600">Total ECL</span><div class="font-bold text-lg text-red-600">₹${totalEcl.toFixed(2)} Cr</div></div>
      <div><span class="text-slate-600">ECL Coverage</span><div class="font-bold text-lg">${coverage.toFixed(2)}%</div></div>
    </div>`;
  saveToolState('eclCalculator');
};

// DSCR Calculator
function renderDscrCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('dscrCalculator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">DSCR Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Debt Service Coverage Ratio - typically min 1.25x required</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">EBITDA (₹)</label>
        <input type="number" id="dscr-ebitda" class="w-full border rounded px-3 py-2" value="5000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Annual Interest (₹)</label>
        <input type="number" id="dscr-interest" class="w-full border rounded px-3 py-2" value="1500000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Annual Principal (₹)</label>
        <input type="number" id="dscr-principal" class="w-full border rounded px-3 py-2" value="2000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Min DSCR Required</label>
        <input type="number" step="0.1" id="dscr-min" class="w-full border rounded px-3 py-2" value="1.25"></div>
      </div>
      <button onclick="calcDscr()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="dscr-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcDscr = function() {
  const ebitda = parseFloat(document.getElementById('dscr-ebitda').value) || 0;
  const interest = parseFloat(document.getElementById('dscr-interest').value) || 0;
  const principal = parseFloat(document.getElementById('dscr-principal').value) || 0;
  const minDscr = parseFloat(document.getElementById('dscr-min').value) || 1.25;
  const debtService = interest + principal;
  const dscr = debtService > 0 ? ebitda / debtService : 0;
  const eligible = dscr >= minDscr;
  const maxDebt = ebitda / minDscr;
  document.getElementById('dscr-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">DSCR:</div><div class="${eligible ? 'text-green-600' : 'text-red-600'} font-bold text-xl">${dscr.toFixed(2)}x</div>
      <div class="font-medium">Debt Service:</div><div>${moneyFmt.format(debtService)}</div>
      <div class="font-medium">Status:</div><div class="${eligible ? 'text-green-600' : 'text-red-600'} font-bold">${eligible ? '✓ Adequate' : '✗ Below Threshold'}</div>
      <div class="font-medium">Max Serviceable Debt:</div><div>${moneyFmt.format(maxDebt)}</div>
    </div>`;
  saveToolState('dscrCalculator');
};

// CAGR Calculator
function renderCagrCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('cagrCalculator')}
    <div class="max-w-lg mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">CAGR Calculator</h3>
      <div class="space-y-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Beginning Value</label>
        <input type="number" id="cagr-begin" class="w-full border rounded px-3 py-2" value="1000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Ending Value</label>
        <input type="number" id="cagr-end" class="w-full border rounded px-3 py-2" value="1500000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Number of Years</label>
        <input type="number" step="0.1" id="cagr-years" class="w-full border rounded px-3 py-2" value="3"></div>
      </div>
      <button onclick="calcCagr()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium w-full">Calculate CAGR</button>
      <div id="cagr-result" class="mt-4 p-6 bg-indigo-50 rounded border text-center"></div>
    </div>`;
}
window.calcCagr = function() {
  const begin = parseFloat(document.getElementById('cagr-begin').value) || 0;
  const end = parseFloat(document.getElementById('cagr-end').value) || 0;
  const years = parseFloat(document.getElementById('cagr-years').value) || 1;
  if (begin <= 0 || years <= 0) return;
  const cagr = (Math.pow(end / begin, 1 / years) - 1) * 100;
  const totalGrowth = ((end - begin) / begin) * 100;
  document.getElementById('cagr-result').innerHTML = `
    <div class="text-slate-600 text-sm">Compound Annual Growth Rate</div>
    <div class="text-4xl font-bold ${cagr >= 0 ? 'text-green-600' : 'text-red-600'} my-2">${cagr.toFixed(2)}%</div>
    <div class="text-sm text-slate-600">Total Growth: ${totalGrowth.toFixed(1)}% over ${years} years</div>`;
  saveToolState('cagrCalculator');
};

// GNPA/NNPA Calculator
function renderGnpaNnpaCalc() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('gnpaNnpaCalc')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">GNPA/NNPA Calculator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Gross Advances (₹ Cr)</label>
        <input type="number" id="npa-advances" class="w-full border rounded px-3 py-2" value="10000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Gross NPA (₹ Cr)</label>
        <input type="number" id="npa-gnpa" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Provisions Held (₹ Cr)</label>
        <input type="number" id="npa-provision" class="w-full border rounded px-3 py-2" value="350"></div>
      </div>
      <button onclick="calcNpaRatios()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="npa-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcNpaRatios = function() {
  const advances = parseFloat(document.getElementById('npa-advances').value) || 0;
  const gnpa = parseFloat(document.getElementById('npa-gnpa').value) || 0;
  const provision = parseFloat(document.getElementById('npa-provision').value) || 0;
  const nnpa = gnpa - provision;
  const gnpaRatio = advances > 0 ? (gnpa / advances * 100) : 0;
  const nnpaRatio = advances > 0 ? (nnpa / advances * 100) : 0;
  const pcr = gnpa > 0 ? (provision / gnpa * 100) : 0;
  document.getElementById('npa-result').innerHTML = `
    <div class="grid grid-cols-2 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">GNPA Ratio</span><div class="font-bold text-2xl text-orange-600">${gnpaRatio.toFixed(2)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">NNPA Ratio</span><div class="font-bold text-2xl text-red-600">${nnpaRatio.toFixed(2)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Net NPA</span><div class="font-bold text-xl">₹${nnpa.toFixed(0)} Cr</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Provision Coverage</span><div class="font-bold text-xl text-green-600">${pcr.toFixed(1)}%</div></div>
    </div>`;
  saveToolState('gnpaNnpaCalc');
};

// Bond YTM Calculator
function renderBondYtm() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('bondYtm')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Bond YTM Calculator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Face Value (₹)</label>
        <input type="number" id="ytm-face" class="w-full border rounded px-3 py-2" value="100"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Current Price (₹)</label>
        <input type="number" step="0.01" id="ytm-price" class="w-full border rounded px-3 py-2" value="95"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Coupon Rate (% p.a.)</label>
        <input type="number" step="0.01" id="ytm-coupon" class="w-full border rounded px-3 py-2" value="8"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Years to Maturity</label>
        <input type="number" step="0.5" id="ytm-years" class="w-full border rounded px-3 py-2" value="5"></div>
      </div>
      <button onclick="calcYtm()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate YTM</button>
      <div id="ytm-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcYtm = function() {
  const F = parseFloat(document.getElementById('ytm-face').value) || 100;
  const P = parseFloat(document.getElementById('ytm-price').value) || 100;
  const c = (parseFloat(document.getElementById('ytm-coupon').value) || 0) / 100;
  const n = parseFloat(document.getElementById('ytm-years').value) || 1;
  const C = F * c;
  // Approximate YTM formula
  const ytmApprox = (C + (F - P) / n) / ((F + P) / 2) * 100;
  // Newton-Raphson for better accuracy
  let ytm = ytmApprox / 100;
  for (let i = 0; i < 20; i++) {
    let pv = 0, dpv = 0;
    for (let t = 1; t <= n; t++) {
      pv += C / Math.pow(1 + ytm, t);
      dpv -= t * C / Math.pow(1 + ytm, t + 1);
    }
    pv += F / Math.pow(1 + ytm, n);
    dpv -= n * F / Math.pow(1 + ytm, n + 1);
    const diff = pv - P;
    if (Math.abs(diff) < 0.0001) break;
    ytm -= diff / dpv;
  }
  const currentYield = P > 0 ? (C / P * 100) : 0;
  document.getElementById('ytm-result').innerHTML = `
    <div class="grid grid-cols-3 gap-4 text-center">
      <div><span class="text-slate-600 text-sm">YTM</span><div class="font-bold text-2xl text-indigo-600">${(ytm * 100).toFixed(3)}%</div></div>
      <div><span class="text-slate-600 text-sm">Current Yield</span><div class="font-bold text-xl">${currentYield.toFixed(2)}%</div></div>
      <div><span class="text-slate-600 text-sm">Annual Coupon</span><div class="font-bold text-xl">₹${C.toFixed(2)}</div></div>
    </div>`;
  saveToolState('bondYtm');
};

// TDS Calculator
function renderTdsCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('tdsCalculator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">TDS Calculator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Interest Amount (₹)</label>
        <input type="number" id="tds-amount" class="w-full border rounded px-3 py-2" value="50000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Payment Type</label>
        <select id="tds-type" class="w-full border rounded px-3 py-2">
          <option value="interest">Interest (194A)</option>
          <option value="commission">Commission (194H)</option>
          <option value="rent">Rent (194I)</option>
          <option value="professional">Professional (194J)</option>
        </select></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">PAN Status</label>
        <select id="tds-pan" class="w-full border rounded px-3 py-2">
          <option value="valid">Valid PAN</option>
          <option value="invalid">Invalid/No PAN</option>
        </select></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Threshold Limit (₹)</label>
        <input type="number" id="tds-threshold" class="w-full border rounded px-3 py-2" value="40000"></div>
      </div>
      <button onclick="calcTds()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate TDS</button>
      <div id="tds-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcTds = function() {
  const amount = parseFloat(document.getElementById('tds-amount').value) || 0;
  const type = document.getElementById('tds-type').value;
  const panValid = document.getElementById('tds-pan').value === 'valid';
  const threshold = parseFloat(document.getElementById('tds-threshold').value) || 0;
  const rates = { interest: 10, commission: 5, rent: 10, professional: 10 };
  let rate = rates[type] || 10;
  if (!panValid) rate = 20;
  const tdsApplicable = amount > threshold;
  const tds = tdsApplicable ? amount * rate / 100 : 0;
  const netAmount = amount - tds;
  document.getElementById('tds-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">TDS Rate:</div><div class="font-bold">${rate}%${!panValid ? ' (No PAN)' : ''}</div>
      <div class="font-medium">TDS Applicable:</div><div class="${tdsApplicable ? 'text-orange-600' : 'text-green-600'} font-bold">${tdsApplicable ? 'Yes' : 'No (Below Threshold)'}</div>
      <div class="font-medium">TDS Amount:</div><div class="font-bold text-red-600">${moneyFmt.format(tds)}</div>
      <div class="font-medium">Net Payable:</div><div class="font-bold text-green-600">${moneyFmt.format(netAmount)}</div>
    </div>`;
  saveToolState('tdsCalculator');
};

// Unit Converter (Lakhs/Crores)
function renderUnitConverter() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('unitConverter')}
    <div class="max-w-lg mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Unit Converter (Indian Numbering)</h3>
      <div class="space-y-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Enter Value</label>
        <input type="number" id="unit-value" class="w-full border rounded px-3 py-2" value="10000000"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-xs font-medium text-slate-700 mb-1">From</label>
          <select id="unit-from" class="w-full border rounded px-3 py-2">
            <option value="1">Units</option>
            <option value="1000">Thousands</option>
            <option value="100000">Lakhs</option>
            <option value="10000000" selected>Crores</option>
            <option value="1000000">Millions</option>
            <option value="1000000000">Billions</option>
          </select></div>
          <div><label class="block text-xs font-medium text-slate-700 mb-1">To</label>
          <select id="unit-to" class="w-full border rounded px-3 py-2">
            <option value="1">Units</option>
            <option value="1000">Thousands</option>
            <option value="100000" selected>Lakhs</option>
            <option value="10000000">Crores</option>
            <option value="1000000">Millions</option>
            <option value="1000000000">Billions</option>
          </select></div>
        </div>
      </div>
      <button onclick="convertUnit()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium w-full">Convert</button>
      <div id="unit-result" class="mt-4 p-6 bg-indigo-50 rounded border text-center"></div>
    </div>`;
}
window.convertUnit = function() {
  const value = parseFloat(document.getElementById('unit-value').value) || 0;
  const from = parseFloat(document.getElementById('unit-from').value) || 1;
  const to = parseFloat(document.getElementById('unit-to').value) || 1;
  const baseValue = value * from;
  const result = baseValue / to;
  const labels = { 1: 'Units', 1000: 'Thousands', 100000: 'Lakhs', 10000000: 'Crores', 1000000: 'Millions', 1000000000: 'Billions' };
  document.getElementById('unit-result').innerHTML = `
    <div class="text-slate-600 text-sm">Converted Value</div>
    <div class="text-3xl font-bold text-indigo-600 my-2">${result.toLocaleString('en-IN', { maximumFractionDigits: 4 })}</div>
    <div class="text-sm text-slate-600">${labels[to]}</div>
    <div class="mt-3 text-xs text-slate-500">Base: ₹${baseValue.toLocaleString('en-IN')}</div>`;
  saveToolState('unitConverter');
};

// CAR Calculator
function renderCarCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('carCalculator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">CAR Calculator (Capital Adequacy Ratio)</h3>
      <p class="text-sm text-slate-600 mb-4">RBI requires min 15% for NBFCs, 9% for banks</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Tier 1 Capital (₹ Cr)</label>
        <input type="number" id="car-tier1" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Tier 2 Capital (₹ Cr)</label>
        <input type="number" id="car-tier2" class="w-full border rounded px-3 py-2" value="100"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Risk Weighted Assets (₹ Cr)</label>
        <input type="number" id="car-rwa" class="w-full border rounded px-3 py-2" value="3000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Min CAR Required (%)</label>
        <input type="number" id="car-min" class="w-full border rounded px-3 py-2" value="15"></div>
      </div>
      <button onclick="calcCar()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate CAR</button>
      <div id="car-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcCar = function() {
  const tier1 = parseFloat(document.getElementById('car-tier1').value) || 0;
  const tier2 = parseFloat(document.getElementById('car-tier2').value) || 0;
  const rwa = parseFloat(document.getElementById('car-rwa').value) || 0;
  const minCar = parseFloat(document.getElementById('car-min').value) || 15;
  const totalCapital = tier1 + tier2;
  const car = rwa > 0 ? (totalCapital / rwa * 100) : 0;
  const tier1Ratio = rwa > 0 ? (tier1 / rwa * 100) : 0;
  const compliant = car >= minCar;
  const cushion = car - minCar;
  document.getElementById('car-result').innerHTML = `
    <div class="grid grid-cols-2 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">CRAR</span><div class="font-bold text-2xl ${compliant ? 'text-green-600' : 'text-red-600'}">${car.toFixed(2)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Tier 1 Ratio</span><div class="font-bold text-xl">${tier1Ratio.toFixed(2)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Status</span><div class="font-bold ${compliant ? 'text-green-600' : 'text-red-600'}">${compliant ? '✓ Compliant' : '✗ Below Minimum'}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Cushion</span><div class="font-bold ${cushion >= 0 ? 'text-green-600' : 'text-red-600'}">${cushion.toFixed(2)}%</div></div>
    </div>`;
  saveToolState('carCalculator');
};

// Working Capital Gap Analyzer
function renderWorkingCapitalGap() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('workingCapitalGap')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Working Capital Gap Analyzer</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Inventory (₹)</label>
        <input type="number" id="wc-inventory" class="w-full border rounded px-3 py-2" value="5000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Receivables (₹)</label>
        <input type="number" id="wc-receivables" class="w-full border rounded px-3 py-2" value="3000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Other Current Assets (₹)</label>
        <input type="number" id="wc-other" class="w-full border rounded px-3 py-2" value="500000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Payables (₹)</label>
        <input type="number" id="wc-payables" class="w-full border rounded px-3 py-2" value="2500000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Other Current Liabilities (₹)</label>
        <input type="number" id="wc-liab" class="w-full border rounded px-3 py-2" value="1000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Margin Required (%)</label>
        <input type="number" id="wc-margin" class="w-full border rounded px-3 py-2" value="25"></div>
      </div>
      <button onclick="calcWcGap()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="wc-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcWcGap = function() {
  const inventory = parseFloat(document.getElementById('wc-inventory').value) || 0;
  const receivables = parseFloat(document.getElementById('wc-receivables').value) || 0;
  const otherCA = parseFloat(document.getElementById('wc-other').value) || 0;
  const payables = parseFloat(document.getElementById('wc-payables').value) || 0;
  const otherCL = parseFloat(document.getElementById('wc-liab').value) || 0;
  const margin = parseFloat(document.getElementById('wc-margin').value) || 25;
  const currentAssets = inventory + receivables + otherCA;
  const currentLiab = payables + otherCL;
  const wcGap = currentAssets - currentLiab;
  const marginAmount = wcGap * margin / 100;
  const bankFinance = wcGap - marginAmount;
  document.getElementById('wc-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Current Assets:</div><div>${moneyFmt.format(currentAssets)}</div>
      <div class="font-medium">Current Liabilities:</div><div>${moneyFmt.format(currentLiab)}</div>
      <div class="font-medium border-t pt-2">Working Capital Gap:</div><div class="font-bold text-lg border-t pt-2">${moneyFmt.format(wcGap)}</div>
      <div class="font-medium">Promoter Margin (${margin}%):</div><div>${moneyFmt.format(marginAmount)}</div>
      <div class="font-medium">Max Bank Finance:</div><div class="font-bold text-green-600">${moneyFmt.format(bankFinance)}</div>
    </div>`;
  saveToolState('workingCapitalGap');
};

// OTS Calculator
function renderOtsCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('otsCalculator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">OTS Calculator (One-Time Settlement)</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Outstanding (₹)</label>
        <input type="number" id="ots-outstanding" class="w-full border rounded px-3 py-2" value="1000000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Provisions Held (₹)</label>
        <input type="number" id="ots-provision" class="w-full border rounded px-3 py-2" value="700000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Legal/Recovery Cost (₹)</label>
        <input type="number" id="ots-cost" class="w-full border rounded px-3 py-2" value="50000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Security Value (₹)</label>
        <input type="number" id="ots-security" class="w-full border rounded px-3 py-2" value="200000"></div>
      </div>
      <button onclick="calcOts()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate OTS Range</button>
      <div id="ots-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcOts = function() {
  const outstanding = parseFloat(document.getElementById('ots-outstanding').value) || 0;
  const provision = parseFloat(document.getElementById('ots-provision').value) || 0;
  const cost = parseFloat(document.getElementById('ots-cost').value) || 0;
  const security = parseFloat(document.getElementById('ots-security').value) || 0;
  const netBook = outstanding - provision;
  const minOts = Math.max(netBook, security) + cost;
  const maxOts = outstanding * 0.75;
  const recommendedOts = (minOts + maxOts) / 2;
  const haircut = outstanding > 0 ? ((outstanding - recommendedOts) / outstanding * 100) : 0;
  document.getElementById('ots-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Net Book Value:</div><div>${moneyFmt.format(netBook)}</div>
      <div class="font-medium">Recovery Floor:</div><div>${moneyFmt.format(minOts)}</div>
      <div class="font-medium">Recovery Ceiling:</div><div>${moneyFmt.format(maxOts)}</div>
      <div class="font-medium border-t pt-2">Recommended OTS:</div><div class="font-bold text-lg text-green-600 border-t pt-2">${moneyFmt.format(recommendedOts)}</div>
      <div class="font-medium">Haircut:</div><div class="text-red-600">${haircut.toFixed(1)}%</div>
    </div>`;
  saveToolState('otsCalculator');
};

// Date Calculator
function renderDateCalculator() {
  const c = document.getElementById('tool-container');
  const today = new Date().toISOString().split('T')[0];
  c.innerHTML = `
    ${renderSaveToolbar('dateCalculator')}
    <div class="max-w-lg mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Date Calculator</h3>
      <div class="space-y-6">
        <div class="p-4 bg-slate-50 rounded border">
          <div class="font-medium text-sm mb-3">Days Between Dates</div>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div><label class="text-xs text-slate-600">Start Date</label><input type="date" id="date-start" class="w-full border rounded px-3 py-2" value="${today}"></div>
            <div><label class="text-xs text-slate-600">End Date</label><input type="date" id="date-end" class="w-full border rounded px-3 py-2"></div>
          </div>
          <button onclick="calcDateDiff()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Calculate</button>
          <span id="date-diff-result" class="ml-3 font-bold"></span>
        </div>
        <div class="p-4 bg-slate-50 rounded border">
          <div class="font-medium text-sm mb-3">Add/Subtract Days</div>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div><label class="text-xs text-slate-600">From Date</label><input type="date" id="date-from" class="w-full border rounded px-3 py-2" value="${today}"></div>
            <div><label class="text-xs text-slate-600">Days (+/-)</label><input type="number" id="date-days" class="w-full border rounded px-3 py-2" value="30"></div>
          </div>
          <button onclick="calcDateAdd()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Calculate</button>
          <span id="date-add-result" class="ml-3 font-bold"></span>
        </div>
      </div>
    </div>`;
}
window.calcDateDiff = function() {
  const start = new Date(document.getElementById('date-start').value);
  const end = new Date(document.getElementById('date-end').value);
  if (isNaN(start) || isNaN(end)) return;
  const diff = Math.round((end - start) / (1000 * 60 * 60 * 24));
  document.getElementById('date-diff-result').innerText = `${diff} days`;
};
window.calcDateAdd = function() {
  const from = new Date(document.getElementById('date-from').value);
  const days = parseInt(document.getElementById('date-days').value) || 0;
  if (isNaN(from)) return;
  const result = new Date(from);
  result.setDate(result.getDate() + days);
  document.getElementById('date-add-result').innerText = result.toLocaleDateString('en-IN');
};

// === MSME & CORPORATE TOOLS ===

// Working Capital Gap (wcGap)
function renderWcGap() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('wcGap')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Working Capital Gap vs Drawing Power</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Inventory (₹ L)</label>
        <input type="number" id="wcg-inv" class="w-full border rounded px-3 py-2" value="50"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Receivables (₹ L)</label>
        <input type="number" id="wcg-recv" class="w-full border rounded px-3 py-2" value="30"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Payables (₹ L)</label>
        <input type="number" id="wcg-pay" class="w-full border rounded px-3 py-2" value="25"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Bank Margin on Stock (%)</label>
        <input type="number" id="wcg-mstock" class="w-full border rounded px-3 py-2" value="25"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Bank Margin on Debtors (%)</label>
        <input type="number" id="wcg-mdebt" class="w-full border rounded px-3 py-2" value="40"></div>
      </div>
      <button onclick="calcWcGapVsDp()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="wcg-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcWcGapVsDp = function() {
  const inv = parseFloat(document.getElementById('wcg-inv').value) || 0;
  const recv = parseFloat(document.getElementById('wcg-recv').value) || 0;
  const pay = parseFloat(document.getElementById('wcg-pay').value) || 0;
  const mStock = parseFloat(document.getElementById('wcg-mstock').value) / 100 || 0.25;
  const mDebt = parseFloat(document.getElementById('wcg-mdebt').value) / 100 || 0.40;
  const wcGap = (inv + recv) - pay;
  const dpStock = inv * (1 - mStock);
  const dpDebt = recv * (1 - mDebt);
  const totalDp = dpStock + dpDebt;
  const shortfall = wcGap - totalDp;
  document.getElementById('wcg-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">WC Gap:</div><div class="font-bold">₹${wcGap.toFixed(1)} L</div>
      <div class="font-medium">DP on Stock:</div><div>₹${dpStock.toFixed(1)} L</div>
      <div class="font-medium">DP on Debtors:</div><div>₹${dpDebt.toFixed(1)} L</div>
      <div class="font-medium border-t pt-2">Total Drawing Power:</div><div class="font-bold text-green-600 border-t pt-2">₹${totalDp.toFixed(1)} L</div>
      <div class="font-medium">Gap vs DP:</div><div class="${shortfall > 0 ? 'text-red-600' : 'text-green-600'}">${shortfall > 0 ? 'Shortfall: ' : 'Surplus: '}₹${Math.abs(shortfall).toFixed(1)} L</div>
    </div>`;
};

// Cash Credit DP Calculator (ccDp)
function renderCcDp() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('ccDp')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Cash Credit Drawing Power Calculator</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Stock Value (₹ L)</label>
        <input type="number" id="ccdp-stock" class="w-full border rounded px-3 py-2" value="100"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Ineligible Stock (₹ L)</label>
        <input type="number" id="ccdp-inelig-s" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Stock Margin (%)</label>
        <input type="number" id="ccdp-margin-s" class="w-full border rounded px-3 py-2" value="25"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Book Debts (₹ L)</label>
        <input type="number" id="ccdp-debt" class="w-full border rounded px-3 py-2" value="80"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Ineligible Debts (₹ L)</label>
        <input type="number" id="ccdp-inelig-d" class="w-full border rounded px-3 py-2" value="15"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Debtor Margin (%)</label>
        <input type="number" id="ccdp-margin-d" class="w-full border rounded px-3 py-2" value="40"></div>
      </div>
      <button onclick="calcCcDp()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate DP</button>
      <div id="ccdp-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcCcDp = function() {
  const stock = parseFloat(document.getElementById('ccdp-stock').value) || 0;
  const ineligS = parseFloat(document.getElementById('ccdp-inelig-s').value) || 0;
  const marginS = parseFloat(document.getElementById('ccdp-margin-s').value) / 100 || 0.25;
  const debt = parseFloat(document.getElementById('ccdp-debt').value) || 0;
  const ineligD = parseFloat(document.getElementById('ccdp-inelig-d').value) || 0;
  const marginD = parseFloat(document.getElementById('ccdp-margin-d').value) / 100 || 0.40;
  const eligStock = stock - ineligS;
  const eligDebt = debt - ineligD;
  const dpStock = eligStock * (1 - marginS);
  const dpDebt = eligDebt * (1 - marginD);
  const totalDp = dpStock + dpDebt;
  document.getElementById('ccdp-result').innerHTML = `
    <table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Component</th><th class="p-2 text-right">Gross</th><th class="p-2 text-right">Ineligible</th><th class="p-2 text-right">Eligible</th><th class="p-2 text-right">DP Value</th></tr></thead>
    <tbody>
      <tr class="border-b"><td class="p-2">Stock</td><td class="p-2 text-right">₹${stock}L</td><td class="p-2 text-right">₹${ineligS}L</td><td class="p-2 text-right">₹${eligStock.toFixed(1)}L</td><td class="p-2 text-right font-medium">₹${dpStock.toFixed(1)}L</td></tr>
      <tr class="border-b"><td class="p-2">Book Debts</td><td class="p-2 text-right">₹${debt}L</td><td class="p-2 text-right">₹${ineligD}L</td><td class="p-2 text-right">₹${eligDebt.toFixed(1)}L</td><td class="p-2 text-right font-medium">₹${dpDebt.toFixed(1)}L</td></tr>
      <tr class="bg-indigo-50"><td class="p-2 font-bold" colspan="4">Total Drawing Power</td><td class="p-2 text-right font-bold text-indigo-700">₹${totalDp.toFixed(1)}L</td></tr>
    </tbody></table>`;
};

// Bill Discounting Limit (billDiscountLimit)
function renderBillDiscountLimit() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('billDiscountLimit')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Bill Discounting Limit Setter</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Annual Turnover (₹ Cr)</label>
        <input type="number" id="bd-turnover" class="w-full border rounded px-3 py-2" value="50"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Credit Sales % of Turnover</label>
        <input type="number" id="bd-credit" class="w-full border rounded px-3 py-2" value="70"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Avg Acceptance Days</label>
        <input type="number" id="bd-days" class="w-full border rounded px-3 py-2" value="60"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Dilution Factor (%)</label>
        <input type="number" id="bd-dilution" class="w-full border rounded px-3 py-2" value="10"></div>
      </div>
      <button onclick="calcBdLimit()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Limit</button>
      <div id="bd-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcBdLimit = function() {
  const turnover = parseFloat(document.getElementById('bd-turnover').value) || 0;
  const creditPct = parseFloat(document.getElementById('bd-credit').value) / 100 || 0.7;
  const days = parseFloat(document.getElementById('bd-days').value) || 60;
  const dilution = parseFloat(document.getElementById('bd-dilution').value) / 100 || 0.1;
  const creditSales = turnover * creditPct;
  const avgOutstanding = creditSales * (days / 365);
  const limit = avgOutstanding * (1 - dilution);
  document.getElementById('bd-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Credit Sales:</div><div>₹${creditSales.toFixed(1)} Cr/year</div>
      <div class="font-medium">Avg Outstanding:</div><div>₹${avgOutstanding.toFixed(2)} Cr</div>
      <div class="font-medium">After Dilution (${(dilution*100).toFixed(0)}%):</div><div class="font-bold text-green-600 text-lg">₹${limit.toFixed(2)} Cr</div>
    </div>`;
};

// Project Finance DSCR (projFinanceDscr)
function renderProjFinanceDscr() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('projFinanceDscr')}
    <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Project Finance DSCR Builder</h3>
      <div class="grid grid-cols-4 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Project Cost (₹ Cr)</label>
        <input type="number" id="pf-cost" class="w-full border rounded px-3 py-2" value="100"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Debt (₹ Cr)</label>
        <input type="number" id="pf-debt" class="w-full border rounded px-3 py-2" value="70"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Interest Rate (%)</label>
        <input type="number" step="0.1" id="pf-rate" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Tenure (Years)</label>
        <input type="number" id="pf-tenure" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Moratorium (Years)</label>
        <input type="number" id="pf-mora" class="w-full border rounded px-3 py-2" value="2"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Avg Annual EBITDA (₹ Cr)</label>
        <input type="number" id="pf-ebitda" class="w-full border rounded px-3 py-2" value="15"></div>
      </div>
      <button onclick="calcPfDscr()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Build DSCR</button>
      <div id="pf-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcPfDscr = function() {
  const debt = parseFloat(document.getElementById('pf-debt').value) || 0;
  const rate = parseFloat(document.getElementById('pf-rate').value) / 100 || 0.1;
  const tenure = parseInt(document.getElementById('pf-tenure').value) || 10;
  const mora = parseInt(document.getElementById('pf-mora').value) || 2;
  const ebitda = parseFloat(document.getElementById('pf-ebitda').value) || 0;
  const repayYears = tenure - mora;
  const annualPrincipal = debt / repayYears;
  let html = '<table class="w-full text-xs"><thead class="bg-slate-100"><tr><th class="p-2">Year</th><th class="p-2 text-right">Opening</th><th class="p-2 text-right">Interest</th><th class="p-2 text-right">Principal</th><th class="p-2 text-right">Total DS</th><th class="p-2 text-right">EBITDA</th><th class="p-2 text-right">DSCR</th></tr></thead><tbody>';
  let balance = debt;
  for (let y = 1; y <= tenure; y++) {
    const interest = balance * rate;
    const principal = y <= mora ? 0 : annualPrincipal;
    const ds = interest + principal;
    const dscr = ds > 0 ? ebitda / ds : 0;
    const dscrClass = dscr >= 1.5 ? 'text-green-600' : dscr >= 1.2 ? 'text-yellow-600' : 'text-red-600';
    html += `<tr class="border-b"><td class="p-2">${y}</td><td class="p-2 text-right">₹${balance.toFixed(1)}</td><td class="p-2 text-right">₹${interest.toFixed(1)}</td><td class="p-2 text-right">₹${principal.toFixed(1)}</td><td class="p-2 text-right font-medium">₹${ds.toFixed(1)}</td><td class="p-2 text-right">₹${ebitda}</td><td class="p-2 text-right font-bold ${dscrClass}">${dscr.toFixed(2)}x</td></tr>`;
    balance -= principal;
  }
  html += '</tbody></table>';
  document.getElementById('pf-result').innerHTML = html;
};

// Consortium Share Allocator (consortiumAllocator)
function renderConsortiumAllocator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('consortiumAllocator')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Consortium Share Allocator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Facility (₹ Cr)</label>
        <input type="number" id="cons-total" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Security Value (₹ Cr)</label>
        <input type="number" id="cons-sec" class="w-full border rounded px-3 py-2" value="600"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Banks (Name, Share %, Rate %) - one per line</label>
        <textarea id="cons-banks" class="w-full border rounded px-3 py-2 h-24" placeholder="SBI, 35, 9.5
HDFC, 25, 9.75
ICICI, 25, 9.6
Axis, 15, 9.8">SBI, 35, 9.5
HDFC, 25, 9.75
ICICI, 25, 9.6
Axis, 15, 9.8</textarea>
      </div>
      <button onclick="calcConsortium()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Allocate</button>
      <div id="cons-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcConsortium = function() {
  const total = parseFloat(document.getElementById('cons-total').value) || 0;
  const security = parseFloat(document.getElementById('cons-sec').value) || 0;
  const lines = document.getElementById('cons-banks').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Bank</th><th class="p-2 text-right">Share %</th><th class="p-2 text-right">Amount</th><th class="p-2 text-right">Security</th><th class="p-2 text-right">Rate</th></tr></thead><tbody>';
  let totalShare = 0, wavgRate = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const name = parts[0];
      const share = parseFloat(parts[1]) || 0;
      const rate = parseFloat(parts[2]) || 0;
      const amount = total * share / 100;
      const sec = security * share / 100;
      totalShare += share;
      wavgRate += rate * share;
      html += `<tr class="border-b"><td class="p-2">${name}</td><td class="p-2 text-right">${share}%</td><td class="p-2 text-right">₹${amount.toFixed(1)} Cr</td><td class="p-2 text-right">₹${sec.toFixed(1)} Cr</td><td class="p-2 text-right">${rate}%</td></tr>`;
    }
  });
  wavgRate = totalShare > 0 ? wavgRate / totalShare : 0;
  html += `<tr class="bg-indigo-50 font-bold"><td class="p-2">Total</td><td class="p-2 text-right">${totalShare}%</td><td class="p-2 text-right">₹${total} Cr</td><td class="p-2 text-right">₹${security} Cr</td><td class="p-2 text-right">${wavgRate.toFixed(2)}%</td></tr>`;
  html += '</tbody></table>';
  document.getElementById('cons-result').innerHTML = html;
};

// === CARDS & DIGITAL TOOLS ===

// Credit Card Limit Engine (cardLimitEngine)
function renderCardLimitEngine() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('cardLimitEngine')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Credit Card Limit Engine</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Income (₹)</label>
        <input type="number" id="ccl-income" class="w-full border rounded px-3 py-2" value="100000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Bureau Score</label>
        <input type="number" id="ccl-score" class="w-full border rounded px-3 py-2" value="750"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Existing Card Limits (₹)</label>
        <input type="number" id="ccl-existing" class="w-full border rounded px-3 py-2" value="200000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Utilization on Existing (%)</label>
        <input type="number" id="ccl-util" class="w-full border rounded px-3 py-2" value="30"></div>
      </div>
      <button onclick="calcCardLimit()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Limit</button>
      <div id="ccl-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcCardLimit = function() {
  const income = parseFloat(document.getElementById('ccl-income').value) || 0;
  const score = parseInt(document.getElementById('ccl-score').value) || 0;
  const existing = parseFloat(document.getElementById('ccl-existing').value) || 0;
  const util = parseFloat(document.getElementById('ccl-util').value) || 0;
  // Score multiplier
  let scoreMult = score >= 800 ? 4 : score >= 750 ? 3 : score >= 700 ? 2.5 : score >= 650 ? 2 : 1.5;
  // Utilization adjustment
  let utilAdj = util <= 30 ? 1.2 : util <= 50 ? 1 : util <= 70 ? 0.8 : 0.6;
  const baseLimit = income * scoreMult * utilAdj;
  const maxAllowed = income * 5; // Regulatory cap
  const recommended = Math.min(baseLimit, maxAllowed - existing);
  document.getElementById('ccl-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Score Multiplier:</div><div>${scoreMult}x</div>
      <div class="font-medium">Utilization Adj:</div><div>${utilAdj}x</div>
      <div class="font-medium">Base Limit:</div><div>${moneyFmt.format(baseLimit)}</div>
      <div class="font-medium">Existing Limits:</div><div>${moneyFmt.format(existing)}</div>
      <div class="font-medium border-t pt-2">Recommended Limit:</div><div class="font-bold text-lg text-green-600 border-t pt-2">${moneyFmt.format(Math.max(0, recommended))}</div>
    </div>`;
};

// Revolver vs Transactor Profitability (revolverProfit)
function renderRevolverProfit() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('revolverProfit')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Revolver vs Transactor Profitability</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Spend (₹ L/year)</label>
        <input type="number" id="rev-spend" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Revolve Rate (%)</label>
        <input type="number" id="rev-rate" class="w-full border rounded px-3 py-2" value="30"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Revolver APR (%)</label>
        <input type="number" id="rev-apr" class="w-full border rounded px-3 py-2" value="36"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">MDR/Interchange (%)</label>
        <input type="number" step="0.1" id="rev-mdr" class="w-full border rounded px-3 py-2" value="1.8"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Funding Cost (%)</label>
        <input type="number" step="0.1" id="rev-cof" class="w-full border rounded px-3 py-2" value="8"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Rewards Cost (%)</label>
        <input type="number" step="0.1" id="rev-rewards" class="w-full border rounded px-3 py-2" value="0.5"></div>
      </div>
      <button onclick="calcRevolverProfit()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="rev-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcRevolverProfit = function() {
  const spend = parseFloat(document.getElementById('rev-spend').value) * 100000 || 0;
  const revolveRate = parseFloat(document.getElementById('rev-rate').value) / 100 || 0;
  const apr = parseFloat(document.getElementById('rev-apr').value) / 100 || 0;
  const mdr = parseFloat(document.getElementById('rev-mdr').value) / 100 || 0;
  const cof = parseFloat(document.getElementById('rev-cof').value) / 100 || 0;
  const rewards = parseFloat(document.getElementById('rev-rewards').value) / 100 || 0;
  const revolveAmt = spend * revolveRate;
  const interestIncome = revolveAmt * apr;
  const interchangeIncome = spend * mdr;
  const fundingCost = revolveAmt * cof;
  const rewardsCost = spend * rewards;
  const transactorProfit = interchangeIncome * (1 - revolveRate) - rewardsCost * (1 - revolveRate);
  const revolverProfit = interestIncome + interchangeIncome * revolveRate - fundingCost - rewardsCost * revolveRate;
  document.getElementById('rev-result').innerHTML = `
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Revolver Profit</span><div class="font-bold text-xl text-green-600">${moneyFmt.format(revolverProfit)}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Transactor Profit</span><div class="font-bold text-xl">${moneyFmt.format(transactorProfit)}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Revolver Premium</span><div class="font-bold text-xl text-indigo-600">${((revolverProfit/transactorProfit - 1) * 100).toFixed(0)}%</div></div>
    </div>`;
};

// BNPL Tenor Pricing (bnplTenorPricing)
function renderBnplTenorPricing() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('bnplTenorPricing')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">BNPL Tenor Pricing Tool</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Ticket Size (₹)</label>
        <input type="number" id="bnpl-ticket" class="w-full border rounded px-3 py-2" value="10000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Cost of Funds (%)</label>
        <input type="number" step="0.1" id="bnpl-cof" class="w-full border rounded px-3 py-2" value="12"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Credit Loss (%)</label>
        <input type="number" step="0.1" id="bnpl-loss" class="w-full border rounded px-3 py-2" value="3"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Tenors & MDR (Months, MDR%) - one per line</label>
        <textarea id="bnpl-tenors" class="w-full border rounded px-3 py-2 h-20">3, 2.5
6, 4.5
9, 6.5
12, 8</textarea>
      </div>
      <button onclick="calcBnplPricing()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate NPV</button>
      <div id="bnpl-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcBnplPricing = function() {
  const ticket = parseFloat(document.getElementById('bnpl-ticket').value) || 0;
  const cof = parseFloat(document.getElementById('bnpl-cof').value) / 100 || 0;
  const loss = parseFloat(document.getElementById('bnpl-loss').value) / 100 || 0;
  const lines = document.getElementById('bnpl-tenors').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2">Tenor</th><th class="p-2 text-right">MDR %</th><th class="p-2 text-right">MDR ₹</th><th class="p-2 text-right">Funding Cost</th><th class="p-2 text-right">Credit Loss</th><th class="p-2 text-right">Net Margin</th><th class="p-2 text-right">NPV</th></tr></thead><tbody>';
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 2) {
      const months = parts[0];
      const mdrPct = parts[1] / 100;
      const mdrAmt = ticket * mdrPct;
      const fundCost = ticket * cof * months / 12;
      const lossAmt = ticket * loss;
      const netMargin = mdrAmt - fundCost - lossAmt;
      const npv = netMargin / Math.pow(1 + cof/12, months/2);
      const marginClass = netMargin >= 0 ? 'text-green-600' : 'text-red-600';
      html += `<tr class="border-b"><td class="p-2">${months}M</td><td class="p-2 text-right">${(mdrPct*100).toFixed(1)}%</td><td class="p-2 text-right">₹${mdrAmt.toFixed(0)}</td><td class="p-2 text-right">₹${fundCost.toFixed(0)}</td><td class="p-2 text-right">₹${lossAmt.toFixed(0)}</td><td class="p-2 text-right font-medium ${marginClass}">₹${netMargin.toFixed(0)}</td><td class="p-2 text-right font-bold">₹${npv.toFixed(0)}</td></tr>`;
    }
  });
  html += '</tbody></table>';
  document.getElementById('bnpl-result').innerHTML = html;
};

// MDR & Interchange Simulator (mdrSimulator)
function renderMdrSimulator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('mdrSimulator')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">MDR & Interchange Simulator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Transaction Value (₹)</label>
        <input type="number" id="mdr-txn" class="w-full border rounded px-3 py-2" value="10000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Merchant MDR (%)</label>
        <input type="number" step="0.1" id="mdr-rate" class="w-full border rounded px-3 py-2" value="1.8"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Interchange to Issuer (%)</label>
        <input type="number" step="0.1" id="mdr-ic" class="w-full border rounded px-3 py-2" value="1.2"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Scheme Fee (%)</label>
        <input type="number" step="0.01" id="mdr-scheme" class="w-full border rounded px-3 py-2" value="0.15"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Switch/Network Fee (₹)</label>
        <input type="number" step="0.1" id="mdr-switch" class="w-full border rounded px-3 py-2" value="2"></div>
      </div>
      <button onclick="calcMdrSplit()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Split</button>
      <div id="mdr-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcMdrSplit = function() {
  const txn = parseFloat(document.getElementById('mdr-txn').value) || 0;
  const mdrPct = parseFloat(document.getElementById('mdr-rate').value) / 100 || 0;
  const icPct = parseFloat(document.getElementById('mdr-ic').value) / 100 || 0;
  const schemePct = parseFloat(document.getElementById('mdr-scheme').value) / 100 || 0;
  const switchFee = parseFloat(document.getElementById('mdr-switch').value) || 0;
  const mdrAmt = txn * mdrPct;
  const icAmt = txn * icPct;
  const schemeAmt = txn * schemePct;
  const acquirerNet = mdrAmt - icAmt - schemeAmt - switchFee;
  document.getElementById('mdr-result').innerHTML = `
    <table class="w-full text-sm">
      <tr class="border-b"><td class="p-2 font-medium">Total MDR</td><td class="p-2 text-right">${moneyFmt.format(mdrAmt)}</td><td class="p-2 text-right text-slate-500">${(mdrPct*100).toFixed(2)}%</td></tr>
      <tr class="border-b bg-green-50"><td class="p-2">→ Issuer (Interchange)</td><td class="p-2 text-right text-green-600">${moneyFmt.format(icAmt)}</td><td class="p-2 text-right">${(icPct*100).toFixed(2)}%</td></tr>
      <tr class="border-b"><td class="p-2">→ Scheme Fee</td><td class="p-2 text-right">${moneyFmt.format(schemeAmt)}</td><td class="p-2 text-right">${(schemePct*100).toFixed(2)}%</td></tr>
      <tr class="border-b"><td class="p-2">→ Switch Fee</td><td class="p-2 text-right">${moneyFmt.format(switchFee)}</td><td class="p-2 text-right">Fixed</td></tr>
      <tr class="bg-indigo-50"><td class="p-2 font-bold">Acquirer Net</td><td class="p-2 text-right font-bold text-indigo-600">${moneyFmt.format(acquirerNet)}</td><td class="p-2 text-right">${(acquirerNet/txn*100).toFixed(2)}%</td></tr>
    </table>`;
};

// EMI Conversion Picker (emiConversionPicker)
function renderEmiConversionPicker() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('emiConversionPicker')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">EMI Conversion Offer Picker</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Transaction Amount (₹)</label>
        <input type="number" id="emic-amt" class="w-full border rounded px-3 py-2" value="50000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Cost of Funds (%)</label>
        <input type="number" step="0.1" id="emic-cof" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Expected Adoption (%)</label>
        <input type="number" id="emic-adopt" class="w-full border rounded px-3 py-2" value="40"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Plans (Tenure, Fee%, Interest%) - one per line</label>
        <textarea id="emic-plans" class="w-full border rounded px-3 py-2 h-20">3, 1.5, 0
6, 2.5, 0
9, 0, 14
12, 0, 15</textarea>
      </div>
      <button onclick="calcEmiConversion()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Compare Plans</button>
      <div id="emic-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcEmiConversion = function() {
  const amt = parseFloat(document.getElementById('emic-amt').value) || 0;
  const cof = parseFloat(document.getElementById('emic-cof').value) / 100 || 0;
  const adopt = parseFloat(document.getElementById('emic-adopt').value) / 100 || 0;
  const lines = document.getElementById('emic-plans').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2">Tenure</th><th class="p-2 text-right">Fee</th><th class="p-2 text-right">Interest</th><th class="p-2 text-right">Total Revenue</th><th class="p-2 text-right">Funding Cost</th><th class="p-2 text-right">Net Profit</th><th class="p-2 text-right">ROE (ann.)</th></tr></thead><tbody>';
  let best = { tenure: 0, profit: -Infinity };
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 3) {
      const tenure = parts[0];
      const feePct = parts[1] / 100;
      const intPct = parts[2] / 100;
      const feeAmt = amt * feePct;
      const intAmt = amt * intPct * tenure / 12;
      const totalRev = feeAmt + intAmt;
      const fundCost = amt * cof * tenure / 12;
      const netProfit = totalRev - fundCost;
      const roe = netProfit / amt * 12 / tenure * 100;
      if (netProfit > best.profit) best = { tenure, profit: netProfit };
      html += `<tr class="border-b"><td class="p-2">${tenure}M</td><td class="p-2 text-right">₹${feeAmt.toFixed(0)}</td><td class="p-2 text-right">₹${intAmt.toFixed(0)}</td><td class="p-2 text-right">₹${totalRev.toFixed(0)}</td><td class="p-2 text-right">₹${fundCost.toFixed(0)}</td><td class="p-2 text-right font-medium ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">₹${netProfit.toFixed(0)}</td><td class="p-2 text-right font-bold">${roe.toFixed(1)}%</td></tr>`;
    }
  });
  html += '</tbody></table>';
  html += `<div class="mt-3 p-3 bg-green-50 rounded text-sm font-medium">Recommended: <span class="text-green-700">${best.tenure}M tenure</span> (highest net profit)</div>`;
  document.getElementById('emic-result').innerHTML = html;
};

// Rewards Liability Forecaster (rewardsLiability)
function renderRewardsLiability() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('rewardsLiability')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Rewards Liability Forecaster</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Outstanding Points (M)</label>
        <input type="number" id="rwl-points" class="w-full border rounded px-3 py-2" value="100"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Point Value (₹)</label>
        <input type="number" step="0.01" id="rwl-value" class="w-full border rounded px-3 py-2" value="0.25"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Earn Rate (M points)</label>
        <input type="number" id="rwl-earn" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Burn Rate (%)</label>
        <input type="number" id="rwl-burn" class="w-full border rounded px-3 py-2" value="5"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Expiry Rate (%)</label>
        <input type="number" step="0.1" id="rwl-expiry" class="w-full border rounded px-3 py-2" value="2"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Forecast Months</label>
        <input type="number" id="rwl-months" class="w-full border rounded px-3 py-2" value="12"></div>
      </div>
      <button onclick="calcRewardsLiab()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Forecast</button>
      <div id="rwl-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcRewardsLiab = function() {
  let points = parseFloat(document.getElementById('rwl-points').value) * 1000000 || 0;
  const value = parseFloat(document.getElementById('rwl-value').value) || 0.25;
  const earn = parseFloat(document.getElementById('rwl-earn').value) * 1000000 || 0;
  const burnRate = parseFloat(document.getElementById('rwl-burn').value) / 100 || 0;
  const expiryRate = parseFloat(document.getElementById('rwl-expiry').value) / 100 || 0;
  const months = parseInt(document.getElementById('rwl-months').value) || 12;
  let totalBurn = 0, totalExpiry = 0, totalEarn = 0;
  for (let m = 0; m < months; m++) {
    const burn = points * burnRate;
    const expiry = points * expiryRate;
    totalBurn += burn;
    totalExpiry += expiry;
    totalEarn += earn;
    points = points - burn - expiry + earn;
  }
  const startLiab = (parseFloat(document.getElementById('rwl-points').value) * 1000000) * value;
  const endLiab = points * value;
  const breakage = totalExpiry * value;
  document.getElementById('rwl-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Starting Liability:</div><div>${moneyFmt.format(startLiab)}</div>
      <div class="font-medium">Points Earned:</div><div>${(totalEarn/1000000).toFixed(1)}M</div>
      <div class="font-medium">Points Burned:</div><div>${(totalBurn/1000000).toFixed(1)}M</div>
      <div class="font-medium">Points Expired (Breakage):</div><div class="text-green-600">${(totalExpiry/1000000).toFixed(1)}M</div>
      <div class="font-medium border-t pt-2">Ending Liability:</div><div class="font-bold text-lg border-t pt-2">${moneyFmt.format(endLiab)}</div>
      <div class="font-medium">Breakage Benefit:</div><div class="text-green-600 font-bold">${moneyFmt.format(breakage)}</div>
    </div>`;
};

// === UNDERWRITING & POLICY TOOLS ===

// Policy Matrix Validator (policyMatrix)
function renderPolicyMatrix() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('policyMatrix')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Policy Matrix Validator</h3>
      <p class="text-sm text-slate-600 mb-4">Define rules and see portfolio hit-rate</p>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Applications</label>
        <input type="number" id="pm-total" class="w-full border rounded px-3 py-2" value="10000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Min Bureau Score</label>
        <input type="number" id="pm-score" class="w-full border rounded px-3 py-2" value="650"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">% Above Score Cutoff</label>
        <input type="number" id="pm-pct-score" class="w-full border rounded px-3 py-2" value="75"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Max FOIR (%)</label>
        <input type="number" id="pm-foir" class="w-full border rounded px-3 py-2" value="55"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">% Within FOIR</label>
        <input type="number" id="pm-pct-foir" class="w-full border rounded px-3 py-2" value="80"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">% KYC Complete</label>
        <input type="number" id="pm-pct-kyc" class="w-full border rounded px-3 py-2" value="95"></div>
      </div>
      <button onclick="calcPolicyMatrix()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Validate</button>
      <div id="pm-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcPolicyMatrix = function() {
  const total = parseFloat(document.getElementById('pm-total').value) || 0;
  const pctScore = parseFloat(document.getElementById('pm-pct-score').value) / 100 || 0;
  const pctFoir = parseFloat(document.getElementById('pm-pct-foir').value) / 100 || 0;
  const pctKyc = parseFloat(document.getElementById('pm-pct-kyc').value) / 100 || 0;
  const passAll = pctScore * pctFoir * pctKyc;
  const approved = Math.round(total * passAll);
  const rejected = total - approved;
  document.getElementById('pm-result').innerHTML = `
    <div class="grid grid-cols-2 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Pass Rate</span><div class="font-bold text-2xl text-green-600">${(passAll*100).toFixed(1)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Approved</span><div class="font-bold text-xl">${approved.toLocaleString()}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Rejected</span><div class="font-bold text-xl text-red-600">${rejected.toLocaleString()}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Funnel Leakage</span><div class="font-bold text-xl">${((1-passAll)*100).toFixed(1)}%</div></div>
    </div>
    <div class="mt-4 text-sm text-slate-600">
      <div>Score filter: ${(pctScore*100).toFixed(0)}% pass → FOIR filter: ${(pctFoir*100).toFixed(0)}% pass → KYC: ${(pctKyc*100).toFixed(0)}% pass</div>
    </div>`;
};

// Thin File Surrogate Score (thinFileScore)
function renderThinFileScore() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('thinFileScore')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Thin File Surrogate Score</h3>
      <p class="text-sm text-slate-600 mb-4">Score using alternate data when bureau history is thin</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Bank Balance Avg (₹)</label>
        <input type="number" id="tf-bal" class="w-full border rounded px-3 py-2" value="50000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Inflows (₹)</label>
        <input type="number" id="tf-inflow" class="w-full border rounded px-3 py-2" value="80000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Rent/EMI Payments (months)</label>
        <input type="number" id="tf-rent" class="w-full border rounded px-3 py-2" value="12"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">UPI/Digital Txn Count/month</label>
        <input type="number" id="tf-upi" class="w-full border rounded px-3 py-2" value="50"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Device Age (months)</label>
        <input type="number" id="tf-device" class="w-full border rounded px-3 py-2" value="18"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Employment Verified</label>
        <select id="tf-emp" class="w-full border rounded px-3 py-2"><option value="1">Yes</option><option value="0">No</option></select></div>
      </div>
      <button onclick="calcThinFileScore()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Score</button>
      <div id="tf-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcThinFileScore = function() {
  const bal = parseFloat(document.getElementById('tf-bal').value) || 0;
  const inflow = parseFloat(document.getElementById('tf-inflow').value) || 0;
  const rent = parseInt(document.getElementById('tf-rent').value) || 0;
  const upi = parseInt(document.getElementById('tf-upi').value) || 0;
  const device = parseInt(document.getElementById('tf-device').value) || 0;
  const emp = parseInt(document.getElementById('tf-emp').value) || 0;
  // Weighted scoring
  let score = 300; // Base
  score += Math.min(bal / 5000, 100); // Max 100 points for balance
  score += Math.min(inflow / 10000, 100); // Max 100 points for inflows
  score += Math.min(rent * 5, 60); // Max 60 for rent history
  score += Math.min(upi, 50); // Max 50 for digital engagement
  score += Math.min(device * 2, 40); // Max 40 for device age
  score += emp * 50; // 50 for verified employment
  score = Math.round(Math.min(score, 900));
  const band = score >= 750 ? 'Prime' : score >= 650 ? 'Near-Prime' : score >= 550 ? 'Sub-Prime' : 'High Risk';
  const color = score >= 750 ? 'text-green-600' : score >= 650 ? 'text-yellow-600' : score >= 550 ? 'text-orange-600' : 'text-red-600';
  document.getElementById('tf-result').innerHTML = `
    <div class="text-center">
      <div class="text-slate-600 text-sm">Surrogate Score</div>
      <div class="text-5xl font-bold ${color} my-2">${score}</div>
      <div class="text-lg font-medium ${color}">${band}</div>
    </div>`;
};

// Bureau Score Cutoff Optimizer (bureauCutoff)
function renderBureauCutoff() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('bureauCutoff')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Bureau Score Cutoff Optimizer</h3>
      <p class="text-sm text-slate-600 mb-4">Find optimal cutoff for approval vs loss trade-off</p>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Score Bands (Score, Approval %, Loss %) - one per line</label>
        <textarea id="bco-data" class="w-full border rounded px-3 py-2 h-32">750, 25, 1.5
700, 30, 2.5
650, 25, 4.5
600, 15, 8.0
550, 5, 15.0</textarea>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Target Max Loss (%)</label>
        <input type="number" step="0.1" id="bco-target" class="w-full border rounded px-3 py-2" value="4"></div>
      </div>
      <button onclick="calcBureauCutoff()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Optimize</button>
      <div id="bco-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcBureauCutoff = function() {
  const targetLoss = parseFloat(document.getElementById('bco-target').value) || 4;
  const lines = document.getElementById('bco-data').value.trim().split('\n');
  const bands = [];
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 3) bands.push({ score: parts[0], approval: parts[1], loss: parts[2] });
  });
  bands.sort((a, b) => b.score - a.score);
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2">Cutoff</th><th class="p-2 text-right">Bands Included</th><th class="p-2 text-right">Approval %</th><th class="p-2 text-right">Wtd Loss %</th><th class="p-2 text-center">Status</th></tr></thead><tbody>';
  let optimalCutoff = bands[0].score;
  for (let i = 0; i < bands.length; i++) {
    const cutoff = bands[i].score;
    const included = bands.slice(0, i + 1);
    const totalApproval = included.reduce((s, b) => s + b.approval, 0);
    const wtdLoss = included.reduce((s, b) => s + b.approval * b.loss, 0) / totalApproval;
    const pass = wtdLoss <= targetLoss;
    if (pass) optimalCutoff = cutoff;
    html += `<tr class="border-b ${pass ? '' : 'bg-red-50'}"><td class="p-2 font-medium">${cutoff}+</td><td class="p-2 text-right">${i + 1}</td><td class="p-2 text-right">${totalApproval.toFixed(0)}%</td><td class="p-2 text-right">${wtdLoss.toFixed(2)}%</td><td class="p-2 text-center">${pass ? '✓' : '✗'}</td></tr>`;
  }
  html += '</tbody></table>';
  html += `<div class="mt-3 p-3 bg-green-50 rounded text-sm font-medium">Optimal Cutoff: <span class="text-green-700 text-lg">${optimalCutoff}+</span> (max approval within ${targetLoss}% loss target)</div>`;
  document.getElementById('bco-result').innerHTML = html;
};

// Income Surrogate Uplift (incomeUplift)
function renderIncomeUplift() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('incomeUplift')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Income Surrogate Uplift Analyzer</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Applications</label>
        <input type="number" id="iu-total" class="w-full border rounded px-3 py-2" value="1000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Declared Income Approval %</label>
        <input type="number" id="iu-dec-appr" class="w-full border rounded px-3 py-2" value="60"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Avg Declared Income (₹)</label>
        <input type="number" id="iu-dec-inc" class="w-full border rounded px-3 py-2" value="50000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Avg Surrogate Income (₹)</label>
        <input type="number" id="iu-sur-inc" class="w-full border rounded px-3 py-2" value="65000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Income Requirement (₹)</label>
        <input type="number" id="iu-req" class="w-full border rounded px-3 py-2" value="55000"></div>
      </div>
      <button onclick="calcIncomeUplift()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Uplift</button>
      <div id="iu-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcIncomeUplift = function() {
  const total = parseFloat(document.getElementById('iu-total').value) || 0;
  const decAppr = parseFloat(document.getElementById('iu-dec-appr').value) / 100 || 0;
  const decInc = parseFloat(document.getElementById('iu-dec-inc').value) || 0;
  const surInc = parseFloat(document.getElementById('iu-sur-inc').value) || 0;
  const req = parseFloat(document.getElementById('iu-req').value) || 0;
  const decPass = decInc >= req ? 1 : 0;
  const surPass = surInc >= req ? 1 : 0;
  const rejected = total * (1 - decAppr);
  const surApproved = surPass ? rejected * 0.7 : 0; // Assume 70% of rejected have good surrogate
  const newApproval = (total * decAppr + surApproved) / total;
  const uplift = newApproval - decAppr;
  document.getElementById('iu-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Original Approval:</div><div>${(decAppr*100).toFixed(0)}% (${Math.round(total*decAppr)} apps)</div>
      <div class="font-medium">Rejected Pool:</div><div>${Math.round(rejected)} apps</div>
      <div class="font-medium">Surrogate Rescues:</div><div class="text-green-600">${Math.round(surApproved)} apps</div>
      <div class="font-medium border-t pt-2">New Approval Rate:</div><div class="font-bold text-lg text-green-600 border-t pt-2">${(newApproval*100).toFixed(1)}%</div>
      <div class="font-medium">Uplift:</div><div class="font-bold text-indigo-600">+${(uplift*100).toFixed(1)}%</div>
    </div>`;
};

// === RISK & COMPLIANCE TOOLS ===

// Fraud Rule Hit-Rate Tracker (fraudRules)
function renderFraudRules() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('fraudRules')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Fraud Rule Hit-Rate Tracker</h3>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Rules (Name, Hits, Confirmed Fraud) - one per line</label>
        <textarea id="fr-data" class="w-full border rounded px-3 py-2 h-32">Velocity_5min, 150, 45
Device_New, 300, 30
Location_Mismatch, 200, 80
Amount_High, 100, 25
IP_Proxy, 50, 40</textarea>
      </div>
      <button onclick="calcFraudRules()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Analyze</button>
      <div id="fr-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcFraudRules = function() {
  const lines = document.getElementById('fr-data').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Rule</th><th class="p-2 text-right">Hits</th><th class="p-2 text-right">Fraud</th><th class="p-2 text-right">Precision</th><th class="p-2 text-right">Status</th></tr></thead><tbody>';
  let totalHits = 0, totalFraud = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const name = parts[0];
      const hits = parseInt(parts[1]) || 0;
      const fraud = parseInt(parts[2]) || 0;
      const precision = hits > 0 ? (fraud / hits * 100) : 0;
      totalHits += hits;
      totalFraud += fraud;
      const status = precision >= 30 ? '✓ Keep' : precision >= 15 ? '⚠ Review' : '✗ Disable';
      const color = precision >= 30 ? 'text-green-600' : precision >= 15 ? 'text-yellow-600' : 'text-red-600';
      html += `<tr class="border-b"><td class="p-2">${name}</td><td class="p-2 text-right">${hits}</td><td class="p-2 text-right">${fraud}</td><td class="p-2 text-right font-medium">${precision.toFixed(1)}%</td><td class="p-2 text-right ${color}">${status}</td></tr>`;
    }
  });
  const totalPrecision = totalHits > 0 ? (totalFraud / totalHits * 100) : 0;
  html += `<tr class="bg-indigo-50 font-bold"><td class="p-2">Total</td><td class="p-2 text-right">${totalHits}</td><td class="p-2 text-right">${totalFraud}</td><td class="p-2 text-right">${totalPrecision.toFixed(1)}%</td><td class="p-2"></td></tr>`;
  html += '</tbody></table>';
  document.getElementById('fr-result').innerHTML = html;
};

// Risk-Based Pricing Grid (riskPricingGrid)
function renderRiskPricingGrid() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('riskPricingGrid')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Risk-Based Pricing Grid Builder</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Base Rate (%)</label>
        <input type="number" step="0.1" id="rpg-base" class="w-full border rounded px-3 py-2" value="12"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Cost of Funds (%)</label>
        <input type="number" step="0.1" id="rpg-cof" class="w-full border rounded px-3 py-2" value="8"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Target ROE (%)</label>
        <input type="number" step="0.1" id="rpg-roe" class="w-full border rounded px-3 py-2" value="15"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Risk Bands (Band, PD%, LGD%) - one per line</label>
        <textarea id="rpg-bands" class="w-full border rounded px-3 py-2 h-24">Prime, 1, 30
Near-Prime, 3, 35
Sub-Prime, 8, 45
High-Risk, 15, 55</textarea>
      </div>
      <button onclick="calcRiskPricing()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Build Grid</button>
      <div id="rpg-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcRiskPricing = function() {
  const base = parseFloat(document.getElementById('rpg-base').value) || 12;
  const cof = parseFloat(document.getElementById('rpg-cof').value) || 8;
  const roe = parseFloat(document.getElementById('rpg-roe').value) || 15;
  const lines = document.getElementById('rpg-bands').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Band</th><th class="p-2 text-right">PD</th><th class="p-2 text-right">LGD</th><th class="p-2 text-right">EL</th><th class="p-2 text-right">Risk Premium</th><th class="p-2 text-right">Final Rate</th></tr></thead><tbody>';
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const band = parts[0];
      const pd = parseFloat(parts[1]) || 0;
      const lgd = parseFloat(parts[2]) || 0;
      const el = pd * lgd / 100;
      const riskPremium = el * 1.5; // Add buffer
      const finalRate = base + riskPremium;
      html += `<tr class="border-b"><td class="p-2 font-medium">${band}</td><td class="p-2 text-right">${pd}%</td><td class="p-2 text-right">${lgd}%</td><td class="p-2 text-right">${el.toFixed(2)}%</td><td class="p-2 text-right">+${riskPremium.toFixed(2)}%</td><td class="p-2 text-right font-bold text-indigo-600">${finalRate.toFixed(2)}%</td></tr>`;
    }
  });
  html += '</tbody></table>';
  document.getElementById('rpg-result').innerHTML = html;
};

// Vintage CNL Tracker (vintageCnl)
function renderVintageCnl() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('vintageCnl')}
    <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Vintage CNL/NCL Tracker</h3>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Vintage Data (Vintage, MOB, CumLoss%) - one per line</label>
        <textarea id="vcnl-data" class="w-full border rounded px-3 py-2 h-32">2023-Q1, 12, 2.5
2023-Q1, 24, 4.2
2023-Q2, 12, 2.8
2023-Q2, 24, 4.8
2023-Q3, 12, 3.1
2023-Q4, 12, 2.9</textarea>
      </div>
      <button onclick="calcVintageCnl()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Analyze</button>
      <div id="vcnl-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcVintageCnl = function() {
  const lines = document.getElementById('vcnl-data').value.trim().split('\n');
  const vintages = {};
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const v = parts[0];
      const mob = parseInt(parts[1]) || 0;
      const loss = parseFloat(parts[2]) || 0;
      if (!vintages[v]) vintages[v] = [];
      vintages[v].push({ mob, loss });
    }
  });
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Vintage</th><th class="p-2 text-right">Latest MOB</th><th class="p-2 text-right">CNL</th><th class="p-2 text-right">Status</th></tr></thead><tbody>';
  Object.keys(vintages).sort().forEach(v => {
    const data = vintages[v].sort((a, b) => b.mob - a.mob);
    const latest = data[0];
    const status = latest.loss > 5 ? '⚠ High' : latest.loss > 3 ? 'Watch' : '✓ Good';
    const color = latest.loss > 5 ? 'text-red-600' : latest.loss > 3 ? 'text-yellow-600' : 'text-green-600';
    html += `<tr class="border-b"><td class="p-2 font-medium">${v}</td><td class="p-2 text-right">${latest.mob}M</td><td class="p-2 text-right font-bold">${latest.loss.toFixed(2)}%</td><td class="p-2 text-right ${color}">${status}</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('vcnl-result').innerHTML = html;
};

// Gini/KS Model Validation (giniKs)
function renderGiniKs() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('giniKs')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Gini/KS Model Validation</h3>
      <p class="text-sm text-slate-600 mb-4">Quick estimation based on decile performance</p>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Decile Data (Decile, BadRate%) - 10 rows</label>
        <textarea id="gks-data" class="w-full border rounded px-3 py-2 h-40">1, 0.5
2, 1.0
3, 1.5
4, 2.5
5, 3.5
6, 5.0
7, 7.0
8, 10.0
9, 15.0
10, 25.0</textarea>
      </div>
      <button onclick="calcGiniKs()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="gks-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcGiniKs = function() {
  const lines = document.getElementById('gks-data').value.trim().split('\n');
  const rates = [];
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 2) rates.push(parts[1]);
  });
  if (rates.length < 2) return;
  const avgBad = rates.reduce((a, b) => a + b, 0) / rates.length;
  // Simplified Gini approximation
  let auc = 0;
  for (let i = 0; i < rates.length; i++) {
    auc += (rates[rates.length - 1] - rates[i]) / rates[rates.length - 1];
  }
  const gini = Math.min(0.9, Math.max(0.1, auc / rates.length));
  // KS approximation
  const cumGood = [], cumBad = [];
  let totalGood = 0, totalBad = 0;
  rates.forEach((r, i) => {
    totalBad += r;
    totalGood += 10 - r/10;
    cumBad.push(totalBad);
    cumGood.push(totalGood);
  });
  let maxKs = 0;
  cumBad.forEach((b, i) => {
    const pctBad = b / totalBad * 100;
    const pctGood = cumGood[i] / totalGood * 100;
    maxKs = Math.max(maxKs, Math.abs(pctBad - pctGood));
  });
  const ks = Math.min(60, maxKs);
  const status = gini >= 0.4 && ks >= 30 ? 'Strong' : gini >= 0.3 && ks >= 20 ? 'Moderate' : 'Weak';
  const color = gini >= 0.4 ? 'text-green-600' : gini >= 0.3 ? 'text-yellow-600' : 'text-red-600';
  document.getElementById('gks-result').innerHTML = `
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Gini Coefficient</span><div class="font-bold text-2xl ${color}">${(gini*100).toFixed(1)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">KS Statistic</span><div class="font-bold text-2xl ${color}">${ks.toFixed(1)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Model Strength</span><div class="font-bold text-xl ${color}">${status}</div></div>
    </div>`;
};

// Stress Loss Attribution (stressLoss)
function renderStressLoss() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('stressLoss')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Stress Loss Attribution</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Base PD (%)</label>
        <input type="number" step="0.1" id="sl-pd" class="w-full border rounded px-3 py-2" value="3"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Base LGD (%)</label>
        <input type="number" id="sl-lgd" class="w-full border rounded px-3 py-2" value="40"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">PD Stress Multiplier</label>
        <input type="number" step="0.1" id="sl-pd-mult" class="w-full border rounded px-3 py-2" value="1.5"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">LGD Stress Add-on (%)</label>
        <input type="number" id="sl-lgd-add" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">EAD (₹ Cr)</label>
        <input type="number" id="sl-ead" class="w-full border rounded px-3 py-2" value="1000"></div>
      </div>
      <button onclick="calcStressLoss()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="sl-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcStressLoss = function() {
  const pd = parseFloat(document.getElementById('sl-pd').value) / 100 || 0;
  const lgd = parseFloat(document.getElementById('sl-lgd').value) / 100 || 0;
  const pdMult = parseFloat(document.getElementById('sl-pd-mult').value) || 1;
  const lgdAdd = parseFloat(document.getElementById('sl-lgd-add').value) / 100 || 0;
  const ead = parseFloat(document.getElementById('sl-ead').value) || 0;
  const baseLoss = ead * pd * lgd;
  const stressedPd = pd * pdMult;
  const stressedLgd = lgd + lgdAdd;
  const stressLoss = ead * stressedPd * stressedLgd;
  const pdImpact = ead * (stressedPd - pd) * lgd;
  const lgdImpact = ead * pd * lgdAdd;
  const crossImpact = stressLoss - baseLoss - pdImpact - lgdImpact;
  document.getElementById('sl-result').innerHTML = `
    <table class="w-full text-sm">
      <tr class="border-b"><td class="p-2 font-medium">Base Loss</td><td class="p-2 text-right">₹${baseLoss.toFixed(2)} Cr</td></tr>
      <tr class="border-b bg-orange-50"><td class="p-2">+ PD Impact</td><td class="p-2 text-right text-orange-600">₹${pdImpact.toFixed(2)} Cr</td></tr>
      <tr class="border-b bg-red-50"><td class="p-2">+ LGD Impact</td><td class="p-2 text-right text-red-600">₹${lgdImpact.toFixed(2)} Cr</td></tr>
      <tr class="border-b"><td class="p-2">+ Cross Effect</td><td class="p-2 text-right">₹${crossImpact.toFixed(2)} Cr</td></tr>
      <tr class="bg-indigo-50"><td class="p-2 font-bold">Stressed Loss</td><td class="p-2 text-right font-bold text-indigo-700">₹${stressLoss.toFixed(2)} Cr</td></tr>
      <tr><td class="p-2 font-medium">Stress Uplift</td><td class="p-2 text-right text-red-600 font-bold">${((stressLoss/baseLoss - 1)*100).toFixed(0)}%</td></tr>
    </table>`;
};

// Leverage Ratio Monitor (leverageRatio)
function renderLeverageRatio() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('leverageRatio')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Leverage Ratio Monitor</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Tier 1 Capital (₹ Cr)</label>
        <input type="number" id="lr-t1" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Exposure (₹ Cr)</label>
        <input type="number" id="lr-exp" class="w-full border rounded px-3 py-2" value="5000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Min Leverage Ratio (%)</label>
        <input type="number" step="0.1" id="lr-min" class="w-full border rounded px-3 py-2" value="4"></div>
      </div>
      <button onclick="calcLeverage()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="lr-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcLeverage = function() {
  const t1 = parseFloat(document.getElementById('lr-t1').value) || 0;
  const exp = parseFloat(document.getElementById('lr-exp').value) || 0;
  const minLr = parseFloat(document.getElementById('lr-min').value) || 4;
  const lr = exp > 0 ? (t1 / exp * 100) : 0;
  const compliant = lr >= minLr;
  const maxExposure = t1 / (minLr / 100);
  const headroom = maxExposure - exp;
  document.getElementById('lr-result').innerHTML = `
    <div class="grid grid-cols-2 gap-4 text-center">
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Leverage Ratio</span><div class="font-bold text-2xl ${compliant ? 'text-green-600' : 'text-red-600'}">${lr.toFixed(2)}%</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Status</span><div class="font-bold text-xl ${compliant ? 'text-green-600' : 'text-red-600'}">${compliant ? '✓ Compliant' : '✗ Breach'}</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Max Exposure</span><div class="font-bold text-lg">₹${maxExposure.toFixed(0)} Cr</div></div>
      <div class="p-3 bg-white rounded border"><span class="text-slate-600 text-sm">Headroom</span><div class="font-bold text-lg ${headroom >= 0 ? 'text-green-600' : 'text-red-600'}">₹${headroom.toFixed(0)} Cr</div></div>
    </div>`;
};

// === TREASURY & ALM TOOLS ===

// FX Forward Coverage Planner (fxCoverage)
function renderFxCoverage() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('fxCoverage')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">FX Forward Coverage Planner</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Payable (USD M)</label>
        <input type="number" id="fx-total" class="w-full border rounded px-3 py-2" value="10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Hedge Ratio (%)</label>
        <input type="number" id="fx-hedge" class="w-full border rounded px-3 py-2" value="70"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Spot Rate (₹)</label>
        <input type="number" step="0.1" id="fx-spot" class="w-full border rounded px-3 py-2" value="83.5"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Monthly Payables (Month, Amount USD M, Forward Rate) - one per line</label>
        <textarea id="fx-data" class="w-full border rounded px-3 py-2 h-24">1, 2, 83.7
3, 3, 84.0
6, 3, 84.5
12, 2, 85.2</textarea>
      </div>
      <button onclick="calcFxCoverage()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Plan Coverage</button>
      <div id="fx-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcFxCoverage = function() {
  const total = parseFloat(document.getElementById('fx-total').value) || 0;
  const hedgeRatio = parseFloat(document.getElementById('fx-hedge').value) / 100 || 0.7;
  const spot = parseFloat(document.getElementById('fx-spot').value) || 83.5;
  const lines = document.getElementById('fx-data').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2">Month</th><th class="p-2 text-right">Payable</th><th class="p-2 text-right">Hedge</th><th class="p-2 text-right">Fwd Rate</th><th class="p-2 text-right">Cost (₹ Cr)</th><th class="p-2 text-right">vs Spot</th></tr></thead><tbody>';
  let totalHedge = 0, totalCost = 0, spotCost = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 3) {
      const month = parts[0];
      const amount = parts[1];
      const fwdRate = parts[2];
      const hedge = amount * hedgeRatio;
      const cost = hedge * fwdRate;
      const spotVal = hedge * spot;
      totalHedge += hedge;
      totalCost += cost;
      spotCost += spotVal;
      const diff = cost - spotVal;
      html += `<tr class="border-b"><td class="p-2">M+${month}</td><td class="p-2 text-right">$${amount}M</td><td class="p-2 text-right">$${hedge.toFixed(1)}M</td><td class="p-2 text-right">₹${fwdRate}</td><td class="p-2 text-right">₹${(cost/10).toFixed(2)}Cr</td><td class="p-2 text-right ${diff > 0 ? 'text-red-600' : 'text-green-600'}">${diff > 0 ? '+' : ''}₹${(diff/10).toFixed(2)}Cr</td></tr>`;
    }
  });
  html += `<tr class="bg-indigo-50 font-bold"><td class="p-2">Total</td><td class="p-2 text-right">$${total}M</td><td class="p-2 text-right">$${totalHedge.toFixed(1)}M</td><td class="p-2"></td><td class="p-2 text-right">₹${(totalCost/10).toFixed(2)}Cr</td><td class="p-2 text-right">${((totalCost - spotCost)/10).toFixed(2)}Cr</td></tr>`;
  html += '</tbody></table>';
  html += `<div class="mt-3 text-sm text-slate-600">Coverage: ${(totalHedge/total*100).toFixed(0)}% | Forward Premium: ${((totalCost/spotCost - 1)*100).toFixed(2)}%</div>`;
  document.getElementById('fx-result').innerHTML = html;
};

// CP/CD Issuance Planner (cpPlanner)
function renderCpPlanner() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('cpPlanner')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">CP/CD Issuance Planner</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Funding Need (₹ Cr)</label>
        <input type="number" id="cp-need" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">CP Rating</label>
        <select id="cp-rating" class="w-full border rounded px-3 py-2"><option value="A1+">A1+</option><option value="A1">A1</option><option value="A2">A2</option></select></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Benchmark Rate (%)</label>
        <input type="number" step="0.1" id="cp-bench" class="w-full border rounded px-3 py-2" value="7"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Tenor Options (Days, Spread bps) - one per line</label>
        <textarea id="cp-tenors" class="w-full border rounded px-3 py-2 h-20">30, 10
60, 15
90, 20
180, 35</textarea>
      </div>
      <button onclick="calcCpPlan()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Compare Options</button>
      <div id="cp-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcCpPlan = function() {
  const need = parseFloat(document.getElementById('cp-need').value) || 0;
  const bench = parseFloat(document.getElementById('cp-bench').value) || 7;
  const lines = document.getElementById('cp-tenors').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2">Tenor</th><th class="p-2 text-right">Spread</th><th class="p-2 text-right">All-in Rate</th><th class="p-2 text-right">Interest Cost</th><th class="p-2 text-right">Annualized</th></tr></thead><tbody>';
  let bestTenor = '', lowestCost = Infinity;
  lines.forEach(line => {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 2) {
      const days = parts[0];
      const spread = parts[1];
      const rate = bench + spread / 100;
      const cost = need * rate / 100 * days / 365;
      if (cost / days * 365 < lowestCost) {
        lowestCost = cost / days * 365;
        bestTenor = days + 'D';
      }
      html += `<tr class="border-b"><td class="p-2">${days} days</td><td class="p-2 text-right">+${spread} bps</td><td class="p-2 text-right font-medium">${rate.toFixed(2)}%</td><td class="p-2 text-right">₹${cost.toFixed(2)} Cr</td><td class="p-2 text-right">${rate.toFixed(2)}%</td></tr>`;
    }
  });
  html += '</tbody></table>';
  html += `<div class="mt-3 p-3 bg-green-50 rounded text-sm font-medium">Optimal Tenor: <span class="text-green-700">${bestTenor}</span> (lowest annualized cost)</div>`;
  document.getElementById('cp-result').innerHTML = html;
};

// Cost of Funds Tracker (costOfFunds)
function renderCostOfFunds() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('costOfFunds')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Cost of Funds Tracker</h3>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Funding Sources (Source, Amount ₹Cr, Rate %) - one per line</label>
        <textarea id="cof-data" class="w-full border rounded px-3 py-2 h-32">Bank Lines, 2000, 9.5
NCDs, 1500, 10.2
CP, 500, 7.8
Term Loans, 1000, 10.0
ECB, 300, 8.5
Securitisation, 700, 9.0</textarea>
      </div>
      <button onclick="calcCofMix()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate WAC</button>
      <div id="cof-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcCofMix = function() {
  const lines = document.getElementById('cof-data').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Source</th><th class="p-2 text-right">Amount</th><th class="p-2 text-right">Mix %</th><th class="p-2 text-right">Rate</th><th class="p-2 text-right">Contribution</th></tr></thead><tbody>';
  let totalAmt = 0, wac = 0;
  const sources = [];
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const source = parts[0];
      const amt = parseFloat(parts[1]) || 0;
      const rate = parseFloat(parts[2]) || 0;
      totalAmt += amt;
      sources.push({ source, amt, rate });
    }
  });
  sources.forEach(s => {
    const mix = s.amt / totalAmt * 100;
    const contrib = s.rate * mix / 100;
    wac += contrib;
    html += `<tr class="border-b"><td class="p-2">${s.source}</td><td class="p-2 text-right">₹${s.amt} Cr</td><td class="p-2 text-right">${mix.toFixed(1)}%</td><td class="p-2 text-right">${s.rate}%</td><td class="p-2 text-right">${contrib.toFixed(2)}%</td></tr>`;
  });
  html += `<tr class="bg-indigo-50 font-bold"><td class="p-2">Total</td><td class="p-2 text-right">₹${totalAmt} Cr</td><td class="p-2 text-right">100%</td><td class="p-2 text-right font-bold text-indigo-700">${wac.toFixed(2)}%</td><td class="p-2"></td></tr>`;
  html += '</tbody></table>';
  document.getElementById('cof-result').innerHTML = html;
};

// === SECURITISATION TOOLS ===

// CE Sufficiency Backtester (ceBacktest)
function renderCeBacktest() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('ceBacktest')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">CE Sufficiency Back-tester</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Credit Enhancement (%)</label>
        <input type="number" step="0.5" id="ce-pct" class="w-full border rounded px-3 py-2" value="12"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Pool Size (₹ Cr)</label>
        <input type="number" id="ce-pool" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Stress Multiplier</label>
        <input type="number" step="0.1" id="ce-stress" class="w-full border rounded px-3 py-2" value="2"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Historical Losses (Vintage, Loss %) - one per line</label>
        <textarea id="ce-data" class="w-full border rounded px-3 py-2 h-24">2020-Q1, 4.5
2020-Q2, 5.2
2021-Q1, 3.8
2021-Q2, 4.1
2022-Q1, 5.8</textarea>
      </div>
      <button onclick="calcCeBacktest()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Backtest</button>
      <div id="ce-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcCeBacktest = function() {
  const ce = parseFloat(document.getElementById('ce-pct').value) || 0;
  const pool = parseFloat(document.getElementById('ce-pool').value) || 0;
  const stress = parseFloat(document.getElementById('ce-stress').value) || 2;
  const lines = document.getElementById('ce-data').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Vintage</th><th class="p-2 text-right">Loss %</th><th class="p-2 text-right">Stressed</th><th class="p-2 text-right">CE Cover</th><th class="p-2 text-center">Status</th></tr></thead><tbody>';
  let passCount = 0, total = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 2) {
      const vintage = parts[0];
      const loss = parseFloat(parts[1]) || 0;
      const stressed = loss * stress;
      const cover = ce / stressed;
      const pass = ce >= stressed;
      if (pass) passCount++;
      total++;
      html += `<tr class="border-b"><td class="p-2">${vintage}</td><td class="p-2 text-right">${loss}%</td><td class="p-2 text-right">${stressed.toFixed(1)}%</td><td class="p-2 text-right">${cover.toFixed(2)}x</td><td class="p-2 text-center ${pass ? 'text-green-600' : 'text-red-600'}">${pass ? '✓ Sufficient' : '✗ Breach'}</td></tr>`;
    }
  });
  html += '</tbody></table>';
  html += `<div class="mt-3 p-3 ${passCount === total ? 'bg-green-50' : 'bg-yellow-50'} rounded text-sm font-medium">Pass Rate: ${passCount}/${total} vintages | CE @ ${ce}% ${passCount === total ? 'sufficient' : 'needs review'}</div>`;
  document.getElementById('ce-result').innerHTML = html;
};

// Trigger Breach Monitor (triggerMonitor)
function renderTriggerMonitor() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('triggerMonitor')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Trigger Breach Monitor</h3>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Triggers (Name, Limit, Current) - one per line</label>
        <textarea id="tm-data" class="w-full border rounded px-3 py-2 h-32">OC Ratio, 110, 115
Collection Efficiency, 95, 92
60+ DPD, 5, 4.2
90+ DPD, 2, 1.8
Prepayment Rate, 25, 18
Dilution Rate, 3, 2.5</textarea>
      </div>
      <button onclick="calcTriggers()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Check Triggers</button>
      <div id="tm-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcTriggers = function() {
  const lines = document.getElementById('tm-data').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Trigger</th><th class="p-2 text-right">Limit</th><th class="p-2 text-right">Current</th><th class="p-2 text-right">Headroom</th><th class="p-2 text-center">Status</th></tr></thead><tbody>';
  let breaches = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 3) {
      const name = parts[0];
      const limit = parseFloat(parts[1]) || 0;
      const current = parseFloat(parts[2]) || 0;
      // For OC/Collection, higher is better; for DPD/Dilution, lower is better
      const isHigherBetter = name.includes('OC') || name.includes('Collection') || name.includes('Efficiency');
      const breach = isHigherBetter ? current < limit : current > limit;
      const headroom = isHigherBetter ? current - limit : limit - current;
      if (breach) breaches++;
      html += `<tr class="border-b ${breach ? 'bg-red-50' : ''}"><td class="p-2">${name}</td><td class="p-2 text-right">${limit}%</td><td class="p-2 text-right font-medium">${current}%</td><td class="p-2 text-right ${headroom >= 0 ? 'text-green-600' : 'text-red-600'}">${headroom >= 0 ? '+' : ''}${headroom.toFixed(1)}%</td><td class="p-2 text-center ${breach ? 'text-red-600' : 'text-green-600'}">${breach ? '⚠ BREACH' : '✓ OK'}</td></tr>`;
    }
  });
  html += '</tbody></table>';
  html += `<div class="mt-3 p-3 ${breaches === 0 ? 'bg-green-50' : 'bg-red-50'} rounded text-sm font-medium">${breaches === 0 ? '✓ All triggers within limits' : `⚠ ${breaches} trigger breach(es) detected`}</div>`;
  document.getElementById('tm-result').innerHTML = html;
};

// === OPERATIONS TOOLS ===

// Bounce Fee Engine (bounceFee)
function renderBounceFee() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('bounceFee')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Bounce Fee Engine</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Bounces</label>
        <input type="number" id="bf-count" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Fee per Bounce (₹)</label>
        <input type="number" id="bf-fee" class="w-full border rounded px-3 py-2" value="500"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Collection Rate (%)</label>
        <input type="number" id="bf-rate" class="w-full border rounded px-3 py-2" value="60"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">GST Rate (%)</label>
        <input type="number" id="bf-gst" class="w-full border rounded px-3 py-2" value="18"></div>
      </div>
      <button onclick="calcBounceFee()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate</button>
      <div id="bf-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcBounceFee = function() {
  const count = parseInt(document.getElementById('bf-count').value) || 0;
  const fee = parseFloat(document.getElementById('bf-fee').value) || 0;
  const rate = parseFloat(document.getElementById('bf-rate').value) / 100 || 0;
  const gst = parseFloat(document.getElementById('bf-gst').value) / 100 || 0;
  const totalCharged = count * fee;
  const collected = totalCharged * rate;
  const gstPaid = collected * gst / (1 + gst);
  const netRevenue = collected - gstPaid;
  document.getElementById('bf-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Total Charged:</div><div>${moneyFmt.format(totalCharged)}</div>
      <div class="font-medium">Collected (${(rate*100).toFixed(0)}%):</div><div>${moneyFmt.format(collected)}</div>
      <div class="font-medium">GST Payable:</div><div class="text-red-600">${moneyFmt.format(gstPaid)}</div>
      <div class="font-medium border-t pt-2">Net Revenue:</div><div class="font-bold text-lg text-green-600 border-t pt-2">${moneyFmt.format(netRevenue)}</div>
    </div>`;
};

// === COLLECTIONS TOOLS ===

// Agency Payout Calculator (agencyPayout)
function renderAgencyPayout() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('agencyPayout')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Collection Agency Payout Calculator</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Collections (₹ L)</label>
        <input type="number" id="ap-total" class="w-full border rounded px-3 py-2" value="100"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Payout Slabs (Bucket, From₹L, To₹L, Rate%) - one per line</label>
        <textarea id="ap-slabs" class="w-full border rounded px-3 py-2 h-24">SMA, 0, 30, 3
30-60 DPD, 0, 25, 5
60-90 DPD, 0, 20, 8
90+ DPD, 0, 15, 12
NPA, 0, 10, 18</textarea>
      </div>
      <button onclick="calcAgencyPayout()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Calculate Payout</button>
      <div id="ap-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.calcAgencyPayout = function() {
  const lines = document.getElementById('ap-slabs').value.trim().split('\n');
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Bucket</th><th class="p-2 text-right">Collection</th><th class="p-2 text-right">Rate</th><th class="p-2 text-right">Payout</th></tr></thead><tbody>';
  let totalCollection = 0, totalPayout = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 4) {
      const bucket = parts[0];
      const collection = parseFloat(parts[2]) || 0;
      const rate = parseFloat(parts[3]) / 100 || 0;
      const payout = collection * rate;
      totalCollection += collection;
      totalPayout += payout;
      html += `<tr class="border-b"><td class="p-2">${bucket}</td><td class="p-2 text-right">₹${collection}L</td><td class="p-2 text-right">${(rate*100).toFixed(0)}%</td><td class="p-2 text-right font-medium">₹${payout.toFixed(2)}L</td></tr>`;
    }
  });
  const blendedRate = totalCollection > 0 ? totalPayout / totalCollection * 100 : 0;
  html += `<tr class="bg-indigo-50 font-bold"><td class="p-2">Total</td><td class="p-2 text-right">₹${totalCollection}L</td><td class="p-2 text-right">${blendedRate.toFixed(1)}%</td><td class="p-2 text-right text-indigo-700">₹${totalPayout.toFixed(2)}L</td></tr>`;
  html += '</tbody></table>';
  document.getElementById('ap-result').innerHTML = html;
};

// Payment Plan Builder (paymentPlanBuilder)
function renderPaymentPlanBuilder() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('paymentPlanBuilder')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Payment Plan Builder</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Total Overdue (₹)</label>
        <input type="number" id="ppb-total" class="w-full border rounded px-3 py-2" value="100000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Monthly Capacity (₹)</label>
        <input type="number" id="ppb-capacity" class="w-full border rounded px-3 py-2" value="15000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Interest Waiver (%)</label>
        <input type="number" id="ppb-waiver" class="w-full border rounded px-3 py-2" value="50"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Down Payment (%)</label>
        <input type="number" id="ppb-down" class="w-full border rounded px-3 py-2" value="10"></div>
      </div>
      <button onclick="buildPaymentPlan()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Build Plan</button>
      <div id="ppb-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.buildPaymentPlan = function() {
  const total = parseFloat(document.getElementById('ppb-total').value) || 0;
  const capacity = parseFloat(document.getElementById('ppb-capacity').value) || 0;
  const waiver = parseFloat(document.getElementById('ppb-waiver').value) / 100 || 0;
  const downPct = parseFloat(document.getElementById('ppb-down').value) / 100 || 0;
  const reducedAmount = total * (1 - waiver * 0.3); // Assume 30% is interest
  const downPayment = reducedAmount * downPct;
  const balance = reducedAmount - downPayment;
  const months = Math.ceil(balance / capacity);
  document.getElementById('ppb-result').innerHTML = `
    <div class="space-y-3 text-sm">
      <div class="flex justify-between"><span class="font-medium">Original Overdue:</span><span>${moneyFmt.format(total)}</span></div>
      <div class="flex justify-between"><span class="font-medium">Interest Waiver:</span><span class="text-green-600">-${moneyFmt.format(total * waiver * 0.3)}</span></div>
      <div class="flex justify-between border-t pt-2"><span class="font-medium">Settlement Amount:</span><span class="font-bold">${moneyFmt.format(reducedAmount)}</span></div>
      <div class="flex justify-between"><span class="font-medium">Down Payment:</span><span>${moneyFmt.format(downPayment)}</span></div>
      <div class="flex justify-between"><span class="font-medium">Balance to Pay:</span><span>${moneyFmt.format(balance)}</span></div>
      <div class="flex justify-between bg-indigo-100 p-2 rounded"><span class="font-medium">Monthly Installment:</span><span class="font-bold text-indigo-700">${moneyFmt.format(capacity)} x ${months} months</span></div>
    </div>`;
};

// === MIS & REPORTING TOOLS ===

// AUM/OS Rollforward (aumRollforward)
function renderAumRollforward() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('aumRollforward')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">AUM/OS Rollforward Builder</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Opening AUM (₹ Cr)</label>
        <input type="number" id="aum-open" class="w-full border rounded px-3 py-2" value="5000"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Disbursements (₹ Cr)</label>
        <input type="number" id="aum-disb" class="w-full border rounded px-3 py-2" value="800"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Collections (₹ Cr)</label>
        <input type="number" id="aum-coll" class="w-full border rounded px-3 py-2" value="600"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Prepayments (₹ Cr)</label>
        <input type="number" id="aum-prepay" class="w-full border rounded px-3 py-2" value="150"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Write-offs (₹ Cr)</label>
        <input type="number" id="aum-wo" class="w-full border rounded px-3 py-2" value="50"></div>
      </div>
      <button onclick="calcAumRollforward()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Build Rollforward</button>
      <div id="aum-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcAumRollforward = function() {
  const open = parseFloat(document.getElementById('aum-open').value) || 0;
  const disb = parseFloat(document.getElementById('aum-disb').value) || 0;
  const coll = parseFloat(document.getElementById('aum-coll').value) || 0;
  const prepay = parseFloat(document.getElementById('aum-prepay').value) || 0;
  const wo = parseFloat(document.getElementById('aum-wo').value) || 0;
  const close = open + disb - coll - prepay - wo;
  const growth = open > 0 ? ((close - open) / open * 100) : 0;
  document.getElementById('aum-result').innerHTML = `
    <table class="w-full text-sm">
      <tr class="border-b"><td class="p-2 font-medium">Opening AUM</td><td class="p-2 text-right">₹${open} Cr</td></tr>
      <tr class="border-b bg-green-50"><td class="p-2">+ Disbursements</td><td class="p-2 text-right text-green-600">+₹${disb} Cr</td></tr>
      <tr class="border-b bg-red-50"><td class="p-2">- Collections</td><td class="p-2 text-right text-red-600">-₹${coll} Cr</td></tr>
      <tr class="border-b bg-red-50"><td class="p-2">- Prepayments</td><td class="p-2 text-right text-red-600">-₹${prepay} Cr</td></tr>
      <tr class="border-b bg-red-50"><td class="p-2">- Write-offs</td><td class="p-2 text-right text-red-600">-₹${wo} Cr</td></tr>
      <tr class="bg-indigo-50"><td class="p-2 font-bold">Closing AUM</td><td class="p-2 text-right font-bold text-indigo-700">₹${close.toFixed(0)} Cr</td></tr>
      <tr><td class="p-2 font-medium">Period Growth</td><td class="p-2 text-right ${growth >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td></tr>
    </table>`;
};

// NIM Bridge (nimBridge)
function renderNimBridge() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('nimBridge')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">NIM Bridge Analyzer</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Prior NIM (%)</label>
        <input type="number" step="0.1" id="nim-prior" class="w-full border rounded px-3 py-2" value="5.5"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Yield Change (bps)</label>
        <input type="number" id="nim-yield" class="w-full border rounded px-3 py-2" value="20"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">CoF Change (bps)</label>
        <input type="number" id="nim-cof" class="w-full border rounded px-3 py-2" value="-10"></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Mix Impact (bps)</label>
        <input type="number" id="nim-mix" class="w-full border rounded px-3 py-2" value="5"></div>
      </div>
      <button onclick="calcNimBridge()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Build Bridge</button>
      <div id="nim-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.calcNimBridge = function() {
  const prior = parseFloat(document.getElementById('nim-prior').value) || 0;
  const yieldChg = parseFloat(document.getElementById('nim-yield').value) / 100 || 0;
  const cofChg = parseFloat(document.getElementById('nim-cof').value) / 100 || 0;
  const mixChg = parseFloat(document.getElementById('nim-mix').value) / 100 || 0;
  const current = prior + yieldChg - cofChg + mixChg;
  const netChange = current - prior;
  document.getElementById('nim-result').innerHTML = `
    <table class="w-full text-sm">
      <tr class="border-b"><td class="p-2 font-medium">Prior NIM</td><td class="p-2 text-right">${prior.toFixed(2)}%</td></tr>
      <tr class="border-b ${yieldChg >= 0 ? 'bg-green-50' : 'bg-red-50'}"><td class="p-2">Yield Impact</td><td class="p-2 text-right ${yieldChg >= 0 ? 'text-green-600' : 'text-red-600'}">${yieldChg >= 0 ? '+' : ''}${(yieldChg*100).toFixed(0)} bps</td></tr>
      <tr class="border-b ${cofChg <= 0 ? 'bg-green-50' : 'bg-red-50'}"><td class="p-2">CoF Impact</td><td class="p-2 text-right ${cofChg <= 0 ? 'text-green-600' : 'text-red-600'}">${cofChg <= 0 ? '+' : ''}${(-cofChg*100).toFixed(0)} bps</td></tr>
      <tr class="border-b ${mixChg >= 0 ? 'bg-green-50' : 'bg-red-50'}"><td class="p-2">Mix Impact</td><td class="p-2 text-right ${mixChg >= 0 ? 'text-green-600' : 'text-red-600'}">${mixChg >= 0 ? '+' : ''}${(mixChg*100).toFixed(0)} bps</td></tr>
      <tr class="bg-indigo-50"><td class="p-2 font-bold">Current NIM</td><td class="p-2 text-right font-bold text-indigo-700">${current.toFixed(2)}%</td></tr>
      <tr><td class="p-2 font-medium">Net Change</td><td class="p-2 text-right ${netChange >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${netChange >= 0 ? '+' : ''}${(netChange*100).toFixed(0)} bps</td></tr>
    </table>`;
};

// === DATA QUALITY TOOLS ===

// Schema Profiler (schemaProfiler)
function renderSchemaProfiler() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('schemaProfiler')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Schema Profiler</h3>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Paste CSV Data (with headers)</label>
        <textarea id="sp-data" class="w-full border rounded px-3 py-2 h-40 font-mono text-xs">customer_id,name,age,income,email
C001,John Doe,35,50000,john@email.com
C002,Jane Smith,,60000,jane@email.com
C003,Bob Wilson,42,,bob@email
C004,,28,45000,
C005,Alice Brown,33,55000,alice@email.com</textarea>
      </div>
      <button onclick="profileSchema()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Profile Data</button>
      <div id="sp-result" class="mt-4 overflow-auto"></div>
    </div>`;
}
window.profileSchema = function() {
  const data = document.getElementById('sp-data').value.trim();
  const lines = data.split('\n');
  if (lines.length < 2) return;
  const headers = lines[0].split(',').map(h => h.trim());
  const rows = lines.slice(1);
  const stats = headers.map(() => ({ total: 0, missing: 0, numeric: 0, email: 0 }));
  rows.forEach(row => {
    const cells = row.split(',').map(c => c.trim());
    cells.forEach((cell, i) => {
      if (i < stats.length) {
        stats[i].total++;
        if (!cell) stats[i].missing++;
        if (!isNaN(parseFloat(cell)) && cell) stats[i].numeric++;
        if (cell && cell.includes('@')) stats[i].email++;
      }
    });
  });
  let html = '<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2 text-left">Column</th><th class="p-2 text-right">Records</th><th class="p-2 text-right">Missing</th><th class="p-2 text-right">Missing %</th><th class="p-2 text-left">Type Guess</th></tr></thead><tbody>';
  headers.forEach((h, i) => {
    const s = stats[i];
    const missingPct = s.total > 0 ? (s.missing / s.total * 100) : 0;
    const type = s.numeric > s.total * 0.5 ? 'Numeric' : s.email > s.total * 0.3 ? 'Email' : 'Text';
    const status = missingPct > 10 ? 'text-red-600' : missingPct > 0 ? 'text-yellow-600' : 'text-green-600';
    html += `<tr class="border-b"><td class="p-2 font-medium">${h}</td><td class="p-2 text-right">${s.total}</td><td class="p-2 text-right">${s.missing}</td><td class="p-2 text-right ${status}">${missingPct.toFixed(1)}%</td><td class="p-2">${type}</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('sp-result').innerHTML = html;
};

// Outlier Detector (outlierDetector)
function renderOutlierDetector() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('outlierDetector')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Outlier Detector</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Method</label>
        <select id="od-method" class="w-full border rounded px-3 py-2">
          <option value="zscore">Z-Score (±3σ)</option>
          <option value="iqr">IQR (1.5x)</option>
        </select></div>
        <div><label class="block text-xs font-medium text-slate-700 mb-1">Threshold</label>
        <input type="number" step="0.5" id="od-threshold" class="w-full border rounded px-3 py-2" value="3"></div>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-700 mb-1">Values (one per line or comma-separated)</label>
        <textarea id="od-data" class="w-full border rounded px-3 py-2 h-24">25000, 30000, 28000, 32000, 150000, 27000, 31000, 29000, 5000, 28500</textarea>
      </div>
      <button onclick="detectOutliers()" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">Detect Outliers</button>
      <div id="od-result" class="mt-4 p-4 bg-slate-50 rounded border"></div>
    </div>`;
}
window.detectOutliers = function() {
  const method = document.getElementById('od-method').value;
  const threshold = parseFloat(document.getElementById('od-threshold').value) || 3;
  const raw = document.getElementById('od-data').value.replace(/\n/g, ',');
  const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
  if (values.length < 3) return;
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  const std = Math.sqrt(values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length);
  const sorted = [...values].sort((a, b) => a - b);
  const q1 = sorted[Math.floor(sorted.length * 0.25)];
  const q3 = sorted[Math.floor(sorted.length * 0.75)];
  const iqr = q3 - q1;
  let outliers = [];
  if (method === 'zscore') {
    outliers = values.filter(v => Math.abs((v - mean) / std) > threshold);
  } else {
    outliers = values.filter(v => v < q1 - 1.5 * iqr || v > q3 + 1.5 * iqr);
  }
  document.getElementById('od-result').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Mean:</div><div>${mean.toFixed(2)}</div>
      <div class="font-medium">Std Dev:</div><div>${std.toFixed(2)}</div>
      <div class="font-medium">Q1/Q3:</div><div>${q1.toFixed(2)} / ${q3.toFixed(2)}</div>
      <div class="font-medium">IQR:</div><div>${iqr.toFixed(2)}</div>
    </div>
    <div class="p-3 ${outliers.length > 0 ? 'bg-red-50' : 'bg-green-50'} rounded">
      <div class="font-medium">${outliers.length} Outlier(s) Detected</div>
      ${outliers.length > 0 ? `<div class="text-sm mt-1">Values: ${outliers.join(', ')}</div>` : ''}
    </div>`;
};

// ===================== DAILY-USE TOOLS =====================

// Lifetime Loss to Annualized Spread - converts lifetime loss % to annual risk spread (bps)
function renderLifetimeToSpread() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('lifetimeToSpread')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Lifetime Loss to Annualized Spread</h3>
      <p class="text-sm text-slate-600 mb-4">Convert lifetime expected loss to annualized risk spread (bps) for amortizing loans.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Principal (₹)</label>
          <input type="number" id="lts-principal" value="1000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="lts-rate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="lts-tenure" value="36" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Lifetime Loss (%)</label>
          <input type="number" id="lts-loss" value="2.5" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Prepayment Rate (% p.a.)</label>
          <input type="number" id="lts-prepay" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcLifetimeToSpread()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Annualized Spread</button>
      <div id="lts-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcLifetimeToSpread = function() {
  const P = parseFloat(document.getElementById('lts-principal').value) || 0;
  const r = (parseFloat(document.getElementById('lts-rate').value) || 0) / 100 / 12;
  const n = parseInt(document.getElementById('lts-tenure').value) || 36;
  const lifetimeLoss = (parseFloat(document.getElementById('lts-loss').value) || 0) / 100;
  const prepayRate = (parseFloat(document.getElementById('lts-prepay').value) || 0) / 100;

  // Calculate EMI
  const emi = P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);

  // Calculate average outstanding balance (weighted average life)
  let totalPrincipal = 0, weightedSum = 0, balance = P;
  for (let m = 1; m <= n; m++) {
    const interest = balance * r;
    const principal = emi - interest;
    const survivalFactor = Math.pow(1 - prepayRate / 12, m - 1);
    weightedSum += balance * survivalFactor;
    balance -= principal;
    totalPrincipal += principal * survivalFactor;
  }
  const avgBalance = weightedSum / n;
  const effectiveTenure = weightedSum / P;

  // Lifetime loss amount
  const lossAmount = P * lifetimeLoss;

  // Annualized spread = loss / (avg balance * effective tenure in years)
  const annualizedSpread = lossAmount / (avgBalance * (effectiveTenure / 12)) * 100;
  const spreadBps = annualizedSpread * 100;

  const res = document.getElementById('lts-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">EMI:</div><div>₹${emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Avg Outstanding:</div><div>₹${avgBalance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Effective Tenure:</div><div>${effectiveTenure.toFixed(1)} months</div>
      <div class="font-medium">Lifetime Loss Amount:</div><div>₹${lossAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
    </div>
    <div class="mt-4 p-3 bg-indigo-100 rounded text-center">
      <div class="text-2xl font-bold text-indigo-800">${spreadBps.toFixed(0)} bps</div>
      <div class="text-sm text-indigo-600">Annualized Risk Spread (${annualizedSpread.toFixed(2)}% p.a.)</div>
    </div>
    <div class="text-xs text-slate-500 mt-3">Formula: Spread = Lifetime Loss ÷ (Avg Balance × WAL in years)</div>`;
  saveToolState('lifetimeToSpread');
};

// XIRR Calculator - IRR for irregular cash flows
function renderXirrCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('xirrCalculator')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">XIRR Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate Internal Rate of Return for irregular cash flows with specific dates.</p>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-600 mb-1">Cash Flows (Date, Amount - one per line, negative for outflow)</label>
        <textarea id="xirr-flows" rows="8" class="w-full border rounded px-3 py-2 font-mono text-sm" placeholder="2024-01-01, -1000000&#10;2024-04-01, 50000&#10;2024-07-01, 50000&#10;2024-10-01, 50000&#10;2025-01-01, 1050000">2024-01-01, -1000000
2024-04-01, 50000
2024-07-01, 50000
2024-10-01, 50000
2025-01-01, 1050000</textarea>
      </div>
      <button onclick="calcXirr()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate XIRR</button>
      <div id="xirr-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcXirr = function() {
  const text = document.getElementById('xirr-flows').value.trim();
  const lines = text.split('\n').filter(l => l.trim());
  const flows = [];

  for (const line of lines) {
    const parts = line.split(',').map(s => s.trim());
    if (parts.length >= 2) {
      const date = new Date(parts[0]);
      const amount = parseFloat(parts[1]);
      if (!isNaN(date.getTime()) && !isNaN(amount)) {
        flows.push({ date, amount });
      }
    }
  }

  if (flows.length < 2) {
    alert('Need at least 2 cash flows');
    return;
  }

  // Sort by date
  flows.sort((a, b) => a.date - b.date);

  // Newton-Raphson method for XIRR
  const xirr = (flows, guess = 0.1) => {
    const daysInYear = 365;
    const firstDate = flows[0].date;

    let rate = guess;
    for (let iter = 0; iter < 100; iter++) {
      let npv = 0, dnpv = 0;
      for (const f of flows) {
        const days = (f.date - firstDate) / (1000 * 60 * 60 * 24);
        const years = days / daysInYear;
        const factor = Math.pow(1 + rate, years);
        npv += f.amount / factor;
        dnpv -= years * f.amount / (factor * (1 + rate));
      }
      const newRate = rate - npv / dnpv;
      if (Math.abs(newRate - rate) < 1e-10) return newRate;
      rate = newRate;
    }
    return rate;
  };

  const result = xirr(flows);
  const totalIn = flows.filter(f => f.amount < 0).reduce((s, f) => s + Math.abs(f.amount), 0);
  const totalOut = flows.filter(f => f.amount > 0).reduce((s, f) => s + f.amount, 0);

  const res = document.getElementById('xirr-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="text-center mb-4">
      <div class="text-3xl font-bold ${result >= 0 ? 'text-green-600' : 'text-red-600'}">${(result * 100).toFixed(2)}%</div>
      <div class="text-sm text-slate-600">Annualized Return (XIRR)</div>
    </div>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="font-medium">Total Investment:</div><div>₹${totalIn.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Total Returns:</div><div>₹${totalOut.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Net Gain:</div><div class="${totalOut - totalIn >= 0 ? 'text-green-600' : 'text-red-600'}">₹${(totalOut - totalIn).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Cash Flows:</div><div>${flows.length} entries</div>
    </div>`;
  saveToolState('xirrCalculator');
};

// Loan Comparison Tool - compare multiple loan options
function renderLoanComparison() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('loanComparison')}
    <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Loan Comparison Tool</h3>
      <p class="text-sm text-slate-600 mb-4">Compare up to 4 loan options side-by-side.</p>
      <div class="grid grid-cols-4 gap-3 mb-4">
        ${[1,2,3,4].map(i => `
          <div class="border rounded p-3 bg-slate-50">
            <div class="font-medium text-sm mb-2">Option ${i}</div>
            <input type="number" id="lc-amt${i}" placeholder="Amount" class="w-full border rounded px-2 py-1 text-sm mb-1" value="${i <= 2 ? '1000000' : ''}">
            <input type="number" id="lc-rate${i}" placeholder="Rate %" step="0.1" class="w-full border rounded px-2 py-1 text-sm mb-1" value="${i === 1 ? '10' : i === 2 ? '11' : ''}">
            <input type="number" id="lc-tenure${i}" placeholder="Tenure (mo)" class="w-full border rounded px-2 py-1 text-sm mb-1" value="${i <= 2 ? '60' : ''}">
            <input type="number" id="lc-fee${i}" placeholder="Proc Fee" class="w-full border rounded px-2 py-1 text-sm" value="${i === 1 ? '10000' : i === 2 ? '5000' : ''}">
          </div>
        `).join('')}
      </div>
      <button onclick="calcLoanComparison()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Compare Loans</button>
      <div id="lc-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcLoanComparison = function() {
  const loans = [];
  for (let i = 1; i <= 4; i++) {
    const amt = parseFloat(document.getElementById(`lc-amt${i}`).value);
    const rate = parseFloat(document.getElementById(`lc-rate${i}`).value);
    const tenure = parseInt(document.getElementById(`lc-tenure${i}`).value);
    const fee = parseFloat(document.getElementById(`lc-fee${i}`).value) || 0;
    if (amt && rate && tenure) {
      const r = rate / 100 / 12;
      const emi = amt * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
      const totalPay = emi * tenure + fee;
      const totalInt = totalPay - amt;
      const effRate = ((Math.pow(totalPay / amt, 12 / tenure) - 1) * 100).toFixed(2);
      loans.push({ i, amt, rate, tenure, fee, emi, totalPay, totalInt, effRate });
    }
  }

  if (loans.length === 0) {
    alert('Enter at least one loan option');
    return;
  }

  // Find best (lowest total cost)
  const best = loans.reduce((a, b) => a.totalPay < b.totalPay ? a : b);

  const res = document.getElementById('lc-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-${loans.length} gap-3">
      ${loans.map(l => `
        <div class="border rounded p-3 ${l.i === best.i ? 'bg-green-50 border-green-300' : 'bg-white'}">
          <div class="font-bold text-lg mb-2">Option ${l.i} ${l.i === best.i ? '✓ Best' : ''}</div>
          <div class="text-sm space-y-1">
            <div>EMI: <span class="font-medium">₹${l.emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
            <div>Total Payment: <span class="font-medium">₹${l.totalPay.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
            <div>Total Interest: <span class="font-medium text-red-600">₹${l.totalInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
            <div>Cost vs Best: <span class="font-medium ${l.i === best.i ? 'text-green-600' : 'text-orange-600'}">₹${(l.totalPay - best.totalPay).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
          </div>
        </div>
      `).join('')}
    </div>`;
  saveToolState('loanComparison');
};

// Interest Rate Converter - flat to reducing, monthly to annual, etc.
function renderRateConverter() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('rateConverter')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Interest Rate Converter</h3>
      <p class="text-sm text-slate-600 mb-4">Convert between flat/reducing rates and different compounding frequencies.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Input Rate (%)</label>
          <input type="number" id="rc-rate" value="12" step="0.01" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="rc-tenure" value="24" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Input Type</label>
          <select id="rc-type" class="w-full border rounded px-3 py-2">
            <option value="flat">Flat Rate (p.a.)</option>
            <option value="reducing">Reducing Rate (p.a.)</option>
            <option value="monthly">Monthly Rate</option>
            <option value="daily">Daily Rate</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Principal (for IRR calc)</label>
          <input type="number" id="rc-principal" value="100000" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcRateConvert()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Convert Rates</button>
      <div id="rc-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcRateConvert = function() {
  const rate = parseFloat(document.getElementById('rc-rate').value) || 0;
  const tenure = parseInt(document.getElementById('rc-tenure').value) || 12;
  const type = document.getElementById('rc-type').value;
  const principal = parseFloat(document.getElementById('rc-principal').value) || 100000;

  let reducingRate, flatRate, monthlyRate, dailyRate, apr, emi;

  if (type === 'flat') {
    flatRate = rate;
    // Flat to reducing: approximately flat * 1.8 to 2.0 for typical tenures
    const totalInterest = principal * flatRate / 100 * tenure / 12;
    const totalPay = principal + totalInterest;
    emi = totalPay / tenure;
    // Calculate reducing rate using IRR
    const r = rate / 100 / 12;
    // Approximate reducing rate
    reducingRate = flatRate * (1.8 + tenure / 120);
    monthlyRate = reducingRate / 12;
    dailyRate = reducingRate / 365;
    apr = reducingRate;
  } else if (type === 'reducing') {
    reducingRate = rate;
    const r = rate / 100 / 12;
    emi = principal * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
    const totalInterest = emi * tenure - principal;
    flatRate = totalInterest / principal * 12 / tenure * 100;
    monthlyRate = rate / 12;
    dailyRate = rate / 365;
    apr = rate;
  } else if (type === 'monthly') {
    monthlyRate = rate;
    reducingRate = rate * 12;
    apr = (Math.pow(1 + rate / 100, 12) - 1) * 100;
    dailyRate = reducingRate / 365;
    const r = rate / 100;
    emi = principal * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
    const totalInterest = emi * tenure - principal;
    flatRate = totalInterest / principal * 12 / tenure * 100;
  } else {
    dailyRate = rate;
    reducingRate = rate * 365;
    apr = (Math.pow(1 + rate / 100, 365) - 1) * 100;
    monthlyRate = reducingRate / 12;
    const r = monthlyRate / 100;
    emi = principal * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
    const totalInterest = emi * tenure - principal;
    flatRate = totalInterest / principal * 12 / tenure * 100;
  }

  const res = document.getElementById('rc-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Flat Rate:</span> <span class="font-bold">${flatRate.toFixed(2)}% p.a.</span></div>
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Reducing Rate:</span> <span class="font-bold">${reducingRate.toFixed(2)}% p.a.</span></div>
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Monthly Rate:</span> <span class="font-bold">${monthlyRate.toFixed(3)}%</span></div>
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Daily Rate:</span> <span class="font-bold">${dailyRate.toFixed(4)}%</span></div>
      <div class="p-2 bg-indigo-50 rounded border col-span-2"><span class="text-slate-500">APR (Effective):</span> <span class="font-bold text-indigo-700">${apr.toFixed(2)}%</span></div>
    </div>
    <div class="mt-3 text-xs text-slate-500">EMI for ₹${principal.toLocaleString()} over ${tenure} months: ₹${emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>`;
  saveToolState('rateConverter');
};

// Break-Even Spread Calculator
function renderBreakEvenSpread() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('breakEvenSpread')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Break-Even Spread Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate minimum spread needed to cover cost of funds, opex, and credit loss.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Cost of Funds (% p.a.)</label>
          <input type="number" id="bes-cof" value="8.5" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Operating Cost (% of AUM)</label>
          <input type="number" id="bes-opex" value="2.5" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Expected Credit Loss (%)</label>
          <input type="number" id="bes-ecl" value="1.5" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Target ROE (%)</label>
          <input type="number" id="bes-roe" value="15" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Capital Ratio (%)</label>
          <input type="number" id="bes-cap" value="15" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tax Rate (%)</label>
          <input type="number" id="bes-tax" value="25" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcBreakEvenSpread()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Break-Even</button>
      <div id="bes-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcBreakEvenSpread = function() {
  const cof = parseFloat(document.getElementById('bes-cof').value) || 0;
  const opex = parseFloat(document.getElementById('bes-opex').value) || 0;
  const ecl = parseFloat(document.getElementById('bes-ecl').value) || 0;
  const targetRoe = parseFloat(document.getElementById('bes-roe').value) || 0;
  const capRatio = parseFloat(document.getElementById('bes-cap').value) || 15;
  const taxRate = parseFloat(document.getElementById('bes-tax').value) || 25;

  // Required pre-tax ROA = ROE * Capital Ratio
  const preTaxRoa = targetRoe * capRatio / 100;
  const postTaxRoa = preTaxRoa * (1 - taxRate / 100);

  // Break-even spread = CoF + Opex + ECL + Required ROA / (1 - tax)
  const breakEven = cof + opex + ecl;
  const withProfit = breakEven + preTaxRoa / (1 - taxRate / 100);

  const res = document.getElementById('bes-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="font-medium">Cost of Funds:</div><div>${cof.toFixed(2)}%</div>
        <div class="font-medium">Operating Cost:</div><div>${opex.toFixed(2)}%</div>
        <div class="font-medium">Expected Credit Loss:</div><div>${ecl.toFixed(2)}%</div>
        <div class="font-medium">Required Pre-tax ROA:</div><div>${preTaxRoa.toFixed(2)}%</div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div class="p-3 bg-orange-100 rounded text-center">
          <div class="text-2xl font-bold text-orange-800">${breakEven.toFixed(2)}%</div>
          <div class="text-xs text-orange-600">Break-Even Yield</div>
        </div>
        <div class="p-3 bg-green-100 rounded text-center">
          <div class="text-2xl font-bold text-green-800">${withProfit.toFixed(2)}%</div>
          <div class="text-xs text-green-600">Target Yield (${targetRoe}% ROE)</div>
        </div>
      </div>
      <div class="text-xs text-slate-500">NIM required: ${(withProfit - cof).toFixed(2)}% | Spread over CoF: ${(withProfit - cof).toFixed(0)} bps</div>
    </div>`;
  saveToolState('breakEvenSpread');
};

// Effective Interest Rate (EIR) Calculator
function renderEffectiveRate() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('effectiveRate')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Effective Interest Rate (EIR) Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate true cost of loan including fees, insurance, and other charges (Ind AS 109 compliant).</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Loan Amount (₹)</label>
          <input type="number" id="eir-amt" value="1000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Stated Rate (% p.a.)</label>
          <input type="number" id="eir-rate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="eir-tenure" value="36" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Processing Fee (₹)</label>
          <input type="number" id="eir-proc" value="15000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Insurance Premium (₹)</label>
          <input type="number" id="eir-ins" value="5000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Other Upfront Fees (₹)</label>
          <input type="number" id="eir-other" value="2000" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcEffectiveRate()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate EIR</button>
      <div id="eir-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcEffectiveRate = function() {
  const amt = parseFloat(document.getElementById('eir-amt').value) || 0;
  const rate = parseFloat(document.getElementById('eir-rate').value) || 0;
  const tenure = parseInt(document.getElementById('eir-tenure').value) || 36;
  const proc = parseFloat(document.getElementById('eir-proc').value) || 0;
  const ins = parseFloat(document.getElementById('eir-ins').value) || 0;
  const other = parseFloat(document.getElementById('eir-other').value) || 0;

  const totalFees = proc + ins + other;
  const netDisbursement = amt - totalFees;
  const r = rate / 100 / 12;
  const emi = amt * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);

  // Calculate EIR using Newton-Raphson (IRR of net cash flows)
  const flows = [{ m: 0, cf: -netDisbursement }];
  for (let m = 1; m <= tenure; m++) {
    flows.push({ m, cf: emi });
  }

  let eir = rate / 100 / 12; // Start with stated rate
  for (let iter = 0; iter < 100; iter++) {
    let npv = 0, dnpv = 0;
    for (const f of flows) {
      npv += f.cf / Math.pow(1 + eir, f.m);
      dnpv -= f.m * f.cf / Math.pow(1 + eir, f.m + 1);
    }
    const newEir = eir - npv / dnpv;
    if (Math.abs(newEir - eir) < 1e-10) break;
    eir = newEir;
  }
  const annualEir = eir * 12 * 100;
  const spreadVsStated = annualEir - rate;

  const res = document.getElementById('eir-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Gross Loan:</div><div>₹${amt.toLocaleString()}</div>
      <div class="font-medium">Total Fees:</div><div>₹${totalFees.toLocaleString()}</div>
      <div class="font-medium">Net Disbursement:</div><div>₹${netDisbursement.toLocaleString()}</div>
      <div class="font-medium">EMI:</div><div>₹${emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">${rate.toFixed(2)}%</div>
        <div class="text-xs text-slate-500">Stated Rate</div>
      </div>
      <div class="p-3 bg-red-100 rounded text-center">
        <div class="text-xl font-bold text-red-700">${annualEir.toFixed(2)}%</div>
        <div class="text-xs text-red-600">Effective Rate (EIR)</div>
      </div>
    </div>
    <div class="mt-3 text-center text-sm text-orange-600 font-medium">Hidden cost: +${spreadVsStated.toFixed(2)}% above stated rate</div>`;
  saveToolState('effectiveRate');
};

// Tenure Optimizer - find optimal tenure for target EMI/affordability
function renderTenureOptimizer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('tenureOptimizer')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Tenure Optimizer</h3>
      <p class="text-sm text-slate-600 mb-4">Find optimal loan tenure based on EMI affordability and total interest cost.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Loan Amount (₹)</label>
          <input type="number" id="to-amt" value="5000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="to-rate" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Monthly Income (₹)</label>
          <input type="number" id="to-income" value="150000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Max FOIR (%)</label>
          <input type="number" id="to-foir" value="50" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcTenureOptimizer()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Analyze Tenures</button>
      <div id="to-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcTenureOptimizer = function() {
  const amt = parseFloat(document.getElementById('to-amt').value) || 0;
  const rate = parseFloat(document.getElementById('to-rate').value) || 0;
  const income = parseFloat(document.getElementById('to-income').value) || 0;
  const maxFoir = parseFloat(document.getElementById('to-foir').value) || 50;

  const maxEmi = income * maxFoir / 100;
  const r = rate / 100 / 12;
  const tenures = [12, 24, 36, 48, 60, 84, 120, 180, 240];
  const results = [];

  for (const n of tenures) {
    const emi = amt * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
    const totalInt = emi * n - amt;
    const affordable = emi <= maxEmi;
    results.push({ n, emi, totalInt, affordable, foir: emi / income * 100 });
  }

  const optimal = results.filter(r => r.affordable).sort((a, b) => a.totalInt - b.totalInt)[0];

  const res = document.getElementById('to-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="mb-3 p-3 ${optimal ? 'bg-green-100' : 'bg-red-100'} rounded">
      <div class="font-bold">${optimal ? `Optimal: ${optimal.n} months | EMI: ₹${optimal.emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}` : 'No affordable tenure found - reduce loan amount or increase income'}</div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-100"><tr><th class="p-2">Tenure</th><th class="p-2">EMI</th><th class="p-2">Total Interest</th><th class="p-2">FOIR</th><th class="p-2">Status</th></tr></thead>
        <tbody>
          ${results.map(r => `
            <tr class="${r.affordable ? '' : 'bg-red-50 text-slate-400'}">
              <td class="p-2 text-center">${r.n} mo</td>
              <td class="p-2 text-right">₹${r.emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
              <td class="p-2 text-right">₹${r.totalInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
              <td class="p-2 text-center">${r.foir.toFixed(1)}%</td>
              <td class="p-2 text-center">${r.affordable ? '✓' : '✗'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
  saveToolState('tenureOptimizer');
};

// Moratorium Impact Calculator
function renderMoratoriumImpact() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('moratoriumImpact')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Moratorium Impact Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate additional interest and tenure extension from EMI moratorium.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Outstanding Principal (₹)</label>
          <input type="number" id="mi-os" value="2000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="mi-rate" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current EMI (₹)</label>
          <input type="number" id="mi-emi" value="45000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Remaining Tenure (months)</label>
          <input type="number" id="mi-tenure" value="48" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Moratorium Period (months)</label>
          <input type="number" id="mi-mora" value="3" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Treatment</label>
          <select id="mi-treatment" class="w-full border rounded px-3 py-2">
            <option value="tenure">Extend Tenure (same EMI)</option>
            <option value="emi">Increase EMI (same tenure)</option>
          </select>
        </div>
      </div>
      <button onclick="calcMoratoriumImpact()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Impact</button>
      <div id="mi-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcMoratoriumImpact = function() {
  const os = parseFloat(document.getElementById('mi-os').value) || 0;
  const rate = parseFloat(document.getElementById('mi-rate').value) || 0;
  const emi = parseFloat(document.getElementById('mi-emi').value) || 0;
  const remainTenure = parseInt(document.getElementById('mi-tenure').value) || 0;
  const mora = parseInt(document.getElementById('mi-mora').value) || 0;
  const treatment = document.getElementById('mi-treatment').value;

  const r = rate / 100 / 12;

  // Interest accrued during moratorium
  let accruedInt = 0;
  let balance = os;
  for (let m = 0; m < mora; m++) {
    accruedInt += balance * r;
    balance += balance * r; // Compound interest
  }

  const newPrincipal = os + accruedInt;

  let newEmi, newTenure, extraCost;
  if (treatment === 'tenure') {
    newEmi = emi;
    // Calculate new tenure to pay off newPrincipal at same EMI
    newTenure = Math.ceil(Math.log(emi / (emi - newPrincipal * r)) / Math.log(1 + r));
    extraCost = newEmi * newTenure - emi * remainTenure;
  } else {
    newTenure = remainTenure;
    newEmi = newPrincipal * r * Math.pow(1 + r, newTenure) / (Math.pow(1 + r, newTenure) - 1);
    extraCost = newEmi * newTenure - emi * remainTenure;
  }

  const res = document.getElementById('mi-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Original Principal:</div><div>₹${os.toLocaleString()}</div>
      <div class="font-medium">Interest During Moratorium:</div><div class="text-red-600">₹${accruedInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">New Principal:</div><div>₹${newPrincipal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
    </div>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="p-3 bg-slate-100 rounded">
        <div class="text-xs text-slate-500">Before</div>
        <div>EMI: ₹${emi.toLocaleString()}</div>
        <div>Tenure: ${remainTenure} mo</div>
      </div>
      <div class="p-3 bg-orange-100 rounded">
        <div class="text-xs text-orange-600">After</div>
        <div>EMI: ₹${newEmi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
        <div>Tenure: ${newTenure} mo</div>
      </div>
    </div>
    <div class="mt-3 p-2 bg-red-100 rounded text-center text-sm text-red-700 font-medium">
      Additional Cost: ₹${extraCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
    </div>`;
  saveToolState('moratoriumImpact');
};

// Floating Rate Risk Analyzer
function renderFloatRateRisk() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('floatRateRisk')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Floating Rate Risk Analyzer</h3>
      <p class="text-sm text-slate-600 mb-4">Analyze EMI/tenure impact of rate changes on floating rate loans.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Outstanding Principal (₹)</label>
          <input type="number" id="frr-os" value="3000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current Rate (% p.a.)</label>
          <input type="number" id="frr-rate" value="9" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Remaining Tenure (months)</label>
          <input type="number" id="frr-tenure" value="180" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Rate Change Scenario (bps)</label>
          <input type="text" id="frr-scenarios" value="-50, -25, 0, +25, +50, +100" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcFloatRateRisk()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Analyze Scenarios</button>
      <div id="frr-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcFloatRateRisk = function() {
  const os = parseFloat(document.getElementById('frr-os').value) || 0;
  const rate = parseFloat(document.getElementById('frr-rate').value) || 0;
  const tenure = parseInt(document.getElementById('frr-tenure').value) || 0;
  const scenariosText = document.getElementById('frr-scenarios').value;
  const scenarios = scenariosText.split(',').map(s => parseInt(s.trim().replace('+', '')));

  const results = scenarios.map(bps => {
    const newRate = rate + bps / 100;
    const r = newRate / 100 / 12;
    const rOld = rate / 100 / 12;
    const emiOld = os * rOld * Math.pow(1 + rOld, tenure) / (Math.pow(1 + rOld, tenure) - 1);
    const emiNew = os * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
    const emiChange = emiNew - emiOld;
    const emiChangePct = emiChange / emiOld * 100;
    const totalIntOld = emiOld * tenure - os;
    const totalIntNew = emiNew * tenure - os;
    const intChange = totalIntNew - totalIntOld;
    return { bps, newRate, emiNew, emiChange, emiChangePct, totalIntNew, intChange };
  });

  const res = document.getElementById('frr-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-100"><tr><th class="p-2">Δ Rate</th><th class="p-2">New Rate</th><th class="p-2">New EMI</th><th class="p-2">EMI Δ</th><th class="p-2">Total Int Δ</th></tr></thead>
        <tbody>
          ${results.map(r => `
            <tr class="${r.bps === 0 ? 'bg-blue-50 font-medium' : r.bps > 0 ? 'bg-red-50' : 'bg-green-50'}">
              <td class="p-2 text-center">${r.bps >= 0 ? '+' : ''}${r.bps} bps</td>
              <td class="p-2 text-center">${r.newRate.toFixed(2)}%</td>
              <td class="p-2 text-right">₹${r.emiNew.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
              <td class="p-2 text-right ${r.emiChange > 0 ? 'text-red-600' : 'text-green-600'}">${r.emiChange >= 0 ? '+' : ''}₹${r.emiChange.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
              <td class="p-2 text-right ${r.intChange > 0 ? 'text-red-600' : 'text-green-600'}">${r.intChange >= 0 ? '+' : ''}₹${(r.intChange / 100000).toFixed(1)}L</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
  saveToolState('floatRateRisk');
};

// LTV Calculator & Analyzer
function renderLoanToValue() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('loanToValue')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">LTV Calculator & Analyzer</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate Loan-to-Value ratio and max eligible loan based on collateral.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Property/Asset Value (₹)</label>
          <input type="number" id="ltv-value" value="10000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Loan Type</label>
          <select id="ltv-type" class="w-full border rounded px-3 py-2">
            <option value="home">Home Loan (max 80%)</option>
            <option value="lap">LAP (max 65%)</option>
            <option value="gold">Gold Loan (max 75%)</option>
            <option value="vehicle">Vehicle Loan (max 85%)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Requested Loan (₹)</label>
          <input type="number" id="ltv-loan" value="7500000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Custom Max LTV (%) - if applicable</label>
          <input type="number" id="ltv-custom" value="80" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcLoanToValue()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate LTV</button>
      <div id="ltv-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcLoanToValue = function() {
  const value = parseFloat(document.getElementById('ltv-value').value) || 0;
  const loan = parseFloat(document.getElementById('ltv-loan').value) || 0;
  const type = document.getElementById('ltv-type').value;
  const customLtv = parseFloat(document.getElementById('ltv-custom').value) || 80;

  const maxLtvMap = { home: 80, lap: 65, gold: 75, vehicle: 85, custom: customLtv };
  const maxLtv = maxLtvMap[type];
  const actualLtv = (loan / value) * 100;
  const maxLoan = value * maxLtv / 100;
  const margin = value - loan;
  const eligible = actualLtv <= maxLtv;

  const res = document.getElementById('ltv-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Asset Value:</div><div>₹${value.toLocaleString()}</div>
      <div class="font-medium">Requested Loan:</div><div>₹${loan.toLocaleString()}</div>
      <div class="font-medium">Margin Money:</div><div>₹${margin.toLocaleString()}</div>
      <div class="font-medium">Max LTV (${type}):</div><div>${maxLtv}%</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 ${eligible ? 'bg-green-100' : 'bg-red-100'} rounded text-center">
        <div class="text-2xl font-bold ${eligible ? 'text-green-700' : 'text-red-700'}">${actualLtv.toFixed(1)}%</div>
        <div class="text-xs ${eligible ? 'text-green-600' : 'text-red-600'}">Current LTV ${eligible ? '✓' : '✗'}</div>
      </div>
      <div class="p-3 bg-blue-100 rounded text-center">
        <div class="text-2xl font-bold text-blue-700">₹${(maxLoan / 100000).toFixed(1)}L</div>
        <div class="text-xs text-blue-600">Max Eligible Loan</div>
      </div>
    </div>
    ${!eligible ? `<div class="mt-3 text-sm text-red-600 font-medium text-center">Reduce loan by ₹${((loan - maxLoan)).toLocaleString()} to meet LTV cap</div>` : ''}`;
  saveToolState('loanToValue');
};

// Stamp Duty & Registration Calculator
function renderStampDutyCalc() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('stampDutyCalc')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Stamp Duty & Registration Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate stamp duty, registration charges, and total acquisition cost by state.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Property Value (₹)</label>
          <input type="number" id="sd-value" value="5000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">State</label>
          <select id="sd-state" class="w-full border rounded px-3 py-2">
            <option value="MH">Maharashtra</option>
            <option value="KA">Karnataka</option>
            <option value="TN">Tamil Nadu</option>
            <option value="DL">Delhi</option>
            <option value="GJ">Gujarat</option>
            <option value="RJ">Rajasthan</option>
            <option value="UP">Uttar Pradesh</option>
            <option value="WB">West Bengal</option>
            <option value="custom">Custom Rates</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Buyer Gender</label>
          <select id="sd-gender" class="w-full border rounded px-3 py-2">
            <option value="male">Male</option>
            <option value="female">Female (discount in some states)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Custom Stamp Duty (%)</label>
          <input type="number" id="sd-custom" value="5" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcStampDuty()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Costs</button>
      <div id="sd-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcStampDuty = function() {
  const value = parseFloat(document.getElementById('sd-value').value) || 0;
  const state = document.getElementById('sd-state').value;
  const gender = document.getElementById('sd-gender').value;
  const customRate = parseFloat(document.getElementById('sd-custom').value) || 5;

  // State-wise rates (simplified)
  const rates = {
    MH: { stamp: gender === 'female' ? 5 : 6, reg: 1, metro: true },
    KA: { stamp: 5, reg: 1, metro: false },
    TN: { stamp: 7, reg: 1, metro: false },
    DL: { stamp: gender === 'female' ? 4 : 6, reg: 1, metro: true },
    GJ: { stamp: 4.9, reg: 1, metro: false },
    RJ: { stamp: 5, reg: 1, metro: false },
    UP: { stamp: gender === 'female' ? 6 : 7, reg: 1, metro: false },
    WB: { stamp: 6, reg: 1, metro: false },
    custom: { stamp: customRate, reg: 1, metro: false }
  };

  const r = rates[state];
  const stampDuty = value * r.stamp / 100;
  const regFee = value * r.reg / 100;
  const gst = 0; // Assuming resale property (no GST)
  const totalAcq = value + stampDuty + regFee;
  const onCost = stampDuty + regFee;
  const onCostPct = onCost / value * 100;

  const res = document.getElementById('sd-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Property Value:</div><div>₹${value.toLocaleString()}</div>
      <div class="font-medium">Stamp Duty (${r.stamp}%):</div><div>₹${stampDuty.toLocaleString()}</div>
      <div class="font-medium">Registration (${r.reg}%):</div><div>₹${regFee.toLocaleString()}</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-orange-100 rounded text-center">
        <div class="text-xl font-bold text-orange-700">₹${onCost.toLocaleString()}</div>
        <div class="text-xs text-orange-600">Total On-Costs (${onCostPct.toFixed(1)}%)</div>
      </div>
      <div class="p-3 bg-blue-100 rounded text-center">
        <div class="text-xl font-bold text-blue-700">₹${totalAcq.toLocaleString()}</div>
        <div class="text-xs text-blue-600">Total Acquisition Cost</div>
      </div>
    </div>
    <div class="mt-3 text-xs text-slate-500">Note: Rates are indicative. Check state govt portals for exact current rates.</div>`;
  saveToolState('stampDutyCalc');
};

// Penal Interest Calculator
function renderPenalInterest() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('penalInterest')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Penal Interest Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate penal interest on overdue EMIs as per RBI guidelines.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Overdue EMI Amount (₹)</label>
          <input type="number" id="pi-emi" value="50000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Days Past Due</label>
          <input type="number" id="pi-dpd" value="45" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Penal Rate (% p.a.)</label>
          <input type="number" id="pi-rate" value="24" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Calculation Method</label>
          <select id="pi-method" class="w-full border rounded px-3 py-2">
            <option value="simple">Simple Interest</option>
            <option value="compound">Compound (monthly)</option>
          </select>
        </div>
      </div>
      <button onclick="calcPenalInterest()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Penal Interest</button>
      <div id="pi-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcPenalInterest = function() {
  const emi = parseFloat(document.getElementById('pi-emi').value) || 0;
  const dpd = parseInt(document.getElementById('pi-dpd').value) || 0;
  const rate = parseFloat(document.getElementById('pi-rate').value) || 0;
  const method = document.getElementById('pi-method').value;

  let penal;
  if (method === 'simple') {
    penal = emi * (rate / 100) * (dpd / 365);
  } else {
    const months = dpd / 30;
    const monthlyRate = rate / 100 / 12;
    penal = emi * (Math.pow(1 + monthlyRate, months) - 1);
  }

  const totalDue = emi + penal;
  const effectiveRate = (penal / emi) * (365 / dpd) * 100;

  const res = document.getElementById('pi-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Overdue EMI:</div><div>₹${emi.toLocaleString()}</div>
      <div class="font-medium">Days Past Due:</div><div>${dpd} days</div>
      <div class="font-medium">Penal Rate:</div><div>${rate}% p.a.</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-red-100 rounded text-center">
        <div class="text-xl font-bold text-red-700">₹${penal.toFixed(0)}</div>
        <div class="text-xs text-red-600">Penal Interest</div>
      </div>
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">₹${totalDue.toFixed(0)}</div>
        <div class="text-xs text-slate-600">Total Amount Due</div>
      </div>
    </div>
    <div class="mt-3 text-xs text-slate-500">Annualized cost: ${effectiveRate.toFixed(1)}% p.a. | As per RBI 2023 circular, penal charges should be reasonable.</div>`;
  saveToolState('penalInterest');
};

// Penal Interest Waiver Impact on Yield
function renderPenalWaiverImpact() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('penalWaiverImpact')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Penal Interest Waiver Impact on Yield</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate how penal interest waiver affects total yield/IRR on a loan account.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Original Principal (₹)</label>
          <input type="number" id="pwi-principal" value="1000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="pwi-rate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="pwi-tenure" value="36" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Total Penal Accrued (₹)</label>
          <input type="number" id="pwi-penal" value="15000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Waiver Amount (₹)</label>
          <input type="number" id="pwi-waiver" value="15000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Loan Age (months)</label>
          <input type="number" id="pwi-age" value="24" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcPenalWaiverImpact()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Yield Impact</button>
      <div id="pwi-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcPenalWaiverImpact = function() {
  const principal = parseFloat(document.getElementById('pwi-principal').value) || 0;
  const rate = parseFloat(document.getElementById('pwi-rate').value) || 0;
  const tenure = parseInt(document.getElementById('pwi-tenure').value) || 36;
  const penalAccrued = parseFloat(document.getElementById('pwi-penal').value) || 0;
  const waiver = parseFloat(document.getElementById('pwi-waiver').value) || 0;
  const age = parseInt(document.getElementById('pwi-age').value) || 0;

  const r = rate / 100 / 12;
  const emi = principal * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
  const totalInterest = emi * tenure - principal;

  // Without waiver
  const totalIncomeNoWaiver = totalInterest + penalAccrued;
  const yieldNoWaiver = (totalIncomeNoWaiver / principal) / (tenure / 12) * 100;

  // With waiver
  const totalIncomeWithWaiver = totalInterest + penalAccrued - waiver;
  const yieldWithWaiver = (totalIncomeWithWaiver / principal) / (tenure / 12) * 100;

  // Yield reduction
  const yieldDrop = yieldNoWaiver - yieldWithWaiver;
  const yieldDropBps = yieldDrop * 100;

  // Cost to P&L
  const costToPnl = waiver;

  // IRR impact (approximate)
  const irrWithPenal = rate + (penalAccrued / principal / (age / 12) * 100);
  const irrWithWaiver = rate + ((penalAccrued - waiver) / principal / (age / 12) * 100);

  const res = document.getElementById('pwi-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Principal:</div><div>₹${principal.toLocaleString()}</div>
      <div class="font-medium">EMI:</div><div>₹${emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Base Interest Income:</div><div>₹${totalInterest.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Penal Accrued:</div><div>₹${penalAccrued.toLocaleString()}</div>
      <div class="font-medium">Waiver Given:</div><div class="text-red-600">₹${waiver.toLocaleString()}</div>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-lg font-bold text-slate-700">${yieldNoWaiver.toFixed(2)}%</div>
        <div class="text-xs text-slate-500">Yield Without Waiver</div>
      </div>
      <div class="p-3 bg-orange-100 rounded text-center">
        <div class="text-lg font-bold text-orange-700">${yieldWithWaiver.toFixed(2)}%</div>
        <div class="text-xs text-orange-600">Yield With Waiver</div>
      </div>
    </div>
    <div class="p-3 bg-red-100 rounded text-center">
      <div class="text-xl font-bold text-red-700">-${yieldDropBps.toFixed(0)} bps</div>
      <div class="text-sm text-red-600">Yield Impact from Waiver</div>
    </div>
    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Approx IRR (pre-waiver):</span> <span class="font-medium">${irrWithPenal.toFixed(2)}%</span></div>
      <div class="p-2 bg-white rounded border"><span class="text-slate-500">Approx IRR (post-waiver):</span> <span class="font-medium">${irrWithWaiver.toFixed(2)}%</span></div>
    </div>`;
  saveToolState('penalWaiverImpact');
};

// Interest on Interest Calculator
function renderInterestOnInterest() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('interestOnInterest')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Interest on Interest Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate compound interest on unpaid interest (as per SC moratorium guidelines).</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Outstanding Principal (₹)</label>
          <input type="number" id="ioi-principal" value="500000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="ioi-rate" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Period (months)</label>
          <input type="number" id="ioi-period" value="6" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Compounding</label>
          <select id="ioi-compound" class="w-full border rounded px-3 py-2">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="simple">Simple (no compounding)</option>
          </select>
        </div>
      </div>
      <button onclick="calcInterestOnInterest()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate</button>
      <div id="ioi-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcInterestOnInterest = function() {
  const principal = parseFloat(document.getElementById('ioi-principal').value) || 0;
  const rate = parseFloat(document.getElementById('ioi-rate').value) || 0;
  const period = parseInt(document.getElementById('ioi-period').value) || 0;
  const compound = document.getElementById('ioi-compound').value;

  // Simple interest (what should be charged)
  const simpleInt = principal * (rate / 100) * (period / 12);

  // Compound interest
  let compoundInt;
  if (compound === 'monthly') {
    const monthlyRate = rate / 100 / 12;
    compoundInt = principal * (Math.pow(1 + monthlyRate, period) - 1);
  } else if (compound === 'quarterly') {
    const qtrRate = rate / 100 / 4;
    const qtrs = period / 3;
    compoundInt = principal * (Math.pow(1 + qtrRate, qtrs) - 1);
  } else {
    compoundInt = simpleInt;
  }

  const ioi = compoundInt - simpleInt;
  const ioiPct = (ioi / principal) * 100;

  const res = document.getElementById('ioi-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Principal:</div><div>₹${principal.toLocaleString()}</div>
      <div class="font-medium">Period:</div><div>${period} months</div>
      <div class="font-medium">Simple Interest:</div><div>₹${simpleInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Compound Interest:</div><div>₹${compoundInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
    </div>
    <div class="p-3 bg-orange-100 rounded text-center">
      <div class="text-xl font-bold text-orange-700">₹${ioi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="text-sm text-orange-600">Interest on Interest (${ioiPct.toFixed(2)}% of principal)</div>
    </div>
    <div class="mt-3 text-xs text-slate-500">As per SC order, IoI during moratorium should be waived. This represents the excess charged.</div>`;
  saveToolState('interestOnInterest');
};

// Pool Yield Calculator
function renderPoolYield() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('poolYield')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Pool Yield Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate weighted average yield of a loan pool for securitisation/assignment.</p>
      <div class="mb-4">
        <label class="block text-xs font-medium text-slate-600 mb-1">Pool Data (Outstanding, Rate % - one per line)</label>
        <textarea id="py-data" rows="6" class="w-full border rounded px-3 py-2 font-mono text-sm" placeholder="1000000, 12&#10;500000, 14&#10;750000, 11.5">1000000, 12
500000, 14
750000, 11.5
300000, 13
450000, 12.5</textarea>
      </div>
      <button onclick="calcPoolYield()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Pool Yield</button>
      <div id="py-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcPoolYield = function() {
  const text = document.getElementById('py-data').value.trim();
  const lines = text.split('\n').filter(l => l.trim());
  const loans = [];
  let totalOs = 0, weightedRate = 0;

  for (const line of lines) {
    const parts = line.split(',').map(s => parseFloat(s.trim()));
    if (parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
      const os = parts[0];
      const rate = parts[1];
      loans.push({ os, rate });
      totalOs += os;
      weightedRate += os * rate;
    }
  }

  if (loans.length === 0) {
    alert('Enter valid pool data');
    return;
  }

  const waYield = weightedRate / totalOs;
  const minRate = Math.min(...loans.map(l => l.rate));
  const maxRate = Math.max(...loans.map(l => l.rate));
  const avgTicket = totalOs / loans.length;

  const res = document.getElementById('py-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Pool Size:</div><div>₹${(totalOs / 10000000).toFixed(2)} Cr</div>
      <div class="font-medium">Loan Count:</div><div>${loans.length}</div>
      <div class="font-medium">Avg Ticket:</div><div>₹${avgTicket.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Rate Range:</div><div>${minRate.toFixed(2)}% - ${maxRate.toFixed(2)}%</div>
    </div>
    <div class="p-3 bg-indigo-100 rounded text-center">
      <div class="text-2xl font-bold text-indigo-700">${waYield.toFixed(2)}%</div>
      <div class="text-sm text-indigo-600">Weighted Average Pool Yield</div>
    </div>`;
  saveToolState('poolYield');
};

// Collection Efficiency Calculator
function renderCollectionEfficiency() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('collectionEfficiency')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Collection Efficiency Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate collection efficiency ratio (CER) as per RBI norms.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Total Demand (₹)</label>
          <input type="number" id="ce-demand" value="10000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Arrears Brought Forward (₹)</label>
          <input type="number" id="ce-arrears" value="500000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Total Collection (₹)</label>
          <input type="number" id="ce-collection" value="9800000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Prepayments (₹)</label>
          <input type="number" id="ce-prepay" value="200000" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcCollectionEfficiency()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate CER</button>
      <div id="ce-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcCollectionEfficiency = function() {
  const demand = parseFloat(document.getElementById('ce-demand').value) || 0;
  const arrears = parseFloat(document.getElementById('ce-arrears').value) || 0;
  const collection = parseFloat(document.getElementById('ce-collection').value) || 0;
  const prepay = parseFloat(document.getElementById('ce-prepay').value) || 0;

  // CER = Collection / (Demand + Arrears) * 100
  const totalDue = demand + arrears;
  const cer = (collection / totalDue) * 100;

  // Adjusted CER (excluding prepayments from collection)
  const adjCollection = collection - prepay;
  const adjCer = (adjCollection / totalDue) * 100;

  // Shortfall
  const shortfall = totalDue - collection;

  const getColor = (val) => val >= 95 ? 'green' : val >= 85 ? 'yellow' : 'red';
  const color = getColor(cer);

  const res = document.getElementById('ce-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Current Demand:</div><div>₹${demand.toLocaleString()}</div>
      <div class="font-medium">Arrears B/F:</div><div>₹${arrears.toLocaleString()}</div>
      <div class="font-medium">Total Due:</div><div>₹${totalDue.toLocaleString()}</div>
      <div class="font-medium">Total Collection:</div><div>₹${collection.toLocaleString()}</div>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="p-3 bg-${color}-100 rounded text-center">
        <div class="text-2xl font-bold text-${color}-700">${cer.toFixed(1)}%</div>
        <div class="text-xs text-${color}-600">Collection Efficiency</div>
      </div>
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">${adjCer.toFixed(1)}%</div>
        <div class="text-xs text-slate-600">Adjusted CER (excl. prepay)</div>
      </div>
    </div>
    ${shortfall > 0 ? `<div class="text-sm text-red-600 text-center">Shortfall: ₹${shortfall.toLocaleString()}</div>` : '<div class="text-sm text-green-600 text-center">Surplus collected!</div>'}`;
  saveToolState('collectionEfficiency');
};

// Disbursal Pacing Calculator
function renderDisbursalPacing() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('disbursalPacing')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Disbursal Pacing Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate required monthly disbursals to achieve annual target.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Annual Target (₹ Cr)</label>
          <input type="number" id="dp-target" value="500" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">YTD Disbursal (₹ Cr)</label>
          <input type="number" id="dp-ytd" value="200" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current Month</label>
          <select id="dp-month" class="w-full border rounded px-3 py-2">
            ${[...Array(12)].map((_, i) => `<option value="${i+1}" ${i === 5 ? 'selected' : ''}>${['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'][i]}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Max Monthly Capacity (₹ Cr)</label>
          <input type="number" id="dp-capacity" value="60" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcDisbursalPacing()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Run Rate</button>
      <div id="dp-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcDisbursalPacing = function() {
  const target = parseFloat(document.getElementById('dp-target').value) || 0;
  const ytd = parseFloat(document.getElementById('dp-ytd').value) || 0;
  const month = parseInt(document.getElementById('dp-month').value) || 1;
  const capacity = parseFloat(document.getElementById('dp-capacity').value) || 0;

  const remaining = target - ytd;
  const monthsLeft = 12 - month + 1;
  const runRate = remaining / monthsLeft;
  const utilizationNeeded = (runRate / capacity) * 100;
  const achievable = runRate <= capacity;
  const ytdPct = (ytd / target) * 100;

  const res = document.getElementById('dp-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Target:</div><div>₹${target} Cr</div>
      <div class="font-medium">YTD Achievement:</div><div>₹${ytd} Cr (${ytdPct.toFixed(1)}%)</div>
      <div class="font-medium">Remaining:</div><div>₹${remaining.toFixed(1)} Cr</div>
      <div class="font-medium">Months Left:</div><div>${monthsLeft}</div>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="p-3 ${achievable ? 'bg-green-100' : 'bg-red-100'} rounded text-center">
        <div class="text-2xl font-bold ${achievable ? 'text-green-700' : 'text-red-700'}">₹${runRate.toFixed(1)} Cr</div>
        <div class="text-xs ${achievable ? 'text-green-600' : 'text-red-600'}">Required Monthly Run Rate</div>
      </div>
      <div class="p-3 bg-blue-100 rounded text-center">
        <div class="text-2xl font-bold text-blue-700">${utilizationNeeded.toFixed(0)}%</div>
        <div class="text-xs text-blue-600">Capacity Utilization Needed</div>
      </div>
    </div>
    ${!achievable ? `<div class="text-sm text-red-600 text-center">Target at risk - run rate exceeds capacity by ₹${(runRate - capacity).toFixed(1)} Cr/month</div>` : '<div class="text-sm text-green-600 text-center">Target achievable within capacity</div>'}`;
  saveToolState('disbursalPacing');
};

// Margin Money Calculator
function renderMarginMoney() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('marginMoney')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Margin Money Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate required margin contribution based on product and LTV norms.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Asset Value (₹)</label>
          <input type="number" id="mm-asset" value="5000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Product Type</label>
          <select id="mm-product" class="w-full border rounded px-3 py-2">
            <option value="80">Home Loan (LTV 80%)</option>
            <option value="75">LAP (LTV 75%)</option>
            <option value="85">Vehicle Loan (LTV 85%)</option>
            <option value="70">Commercial Vehicle (LTV 70%)</option>
            <option value="75">Gold Loan (LTV 75%)</option>
            <option value="custom">Custom LTV</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Custom LTV (%)</label>
          <input type="number" id="mm-ltv" value="80" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Requested Loan (₹)</label>
          <input type="number" id="mm-loan" value="4000000" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcMarginMoney()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Margin</button>
      <div id="mm-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcMarginMoney = function() {
  const asset = parseFloat(document.getElementById('mm-asset').value) || 0;
  const product = document.getElementById('mm-product').value;
  const customLtv = parseFloat(document.getElementById('mm-ltv').value) || 80;
  const requestedLoan = parseFloat(document.getElementById('mm-loan').value) || 0;

  const ltv = product === 'custom' ? customLtv : parseInt(product);
  const maxLoan = asset * ltv / 100;
  const minMargin = asset - maxLoan;
  const actualMargin = asset - requestedLoan;
  const actualLtv = (requestedLoan / asset) * 100;
  const marginShortfall = minMargin - actualMargin;
  const eligible = actualLtv <= ltv;

  const res = document.getElementById('mm-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Asset Value:</div><div>₹${asset.toLocaleString()}</div>
      <div class="font-medium">Max LTV:</div><div>${ltv}%</div>
      <div class="font-medium">Max Loan Eligible:</div><div>₹${maxLoan.toLocaleString()}</div>
      <div class="font-medium">Min Margin Required:</div><div>₹${minMargin.toLocaleString()}</div>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="p-3 ${eligible ? 'bg-green-100' : 'bg-red-100'} rounded text-center">
        <div class="text-xl font-bold ${eligible ? 'text-green-700' : 'text-red-700'}">₹${actualMargin.toLocaleString()}</div>
        <div class="text-xs ${eligible ? 'text-green-600' : 'text-red-600'}">Actual Margin (${(100 - actualLtv).toFixed(1)}%)</div>
      </div>
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">${actualLtv.toFixed(1)}%</div>
        <div class="text-xs text-slate-600">Actual LTV</div>
      </div>
    </div>
    ${!eligible ? `<div class="text-sm text-red-600 text-center">Need additional margin: ₹${marginShortfall.toLocaleString()}</div>` : '<div class="text-sm text-green-600 text-center">Margin requirement met</div>'}`;
  saveToolState('marginMoney');
};

// PDC/RPDC Cheque Calculator
function renderChequeCalculator() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('chequeCalculator')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">PDC/RPDC Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Generate post-dated cheque schedule for EMI collection.</p>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">EMI Amount (₹)</label>
          <input type="number" id="pdc-emi" value="35000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">First EMI Date</label>
          <input type="date" id="pdc-start" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Number of Cheques</label>
          <input type="number" id="pdc-count" value="24" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcChequeSchedule()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Generate Schedule</button>
      <div id="pdc-result" class="mt-4 hidden"></div>
    </div>`;
  // Set default start date to next month
  const today = new Date();
  const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 5);
  document.getElementById('pdc-start').value = nextMonth.toISOString().split('T')[0];
}
window.calcChequeSchedule = function() {
  const emi = parseFloat(document.getElementById('pdc-emi').value) || 0;
  const startDate = new Date(document.getElementById('pdc-start').value);
  const count = parseInt(document.getElementById('pdc-count').value) || 0;

  if (!startDate || isNaN(startDate.getTime())) {
    alert('Enter valid start date');
    return;
  }

  const cheques = [];
  for (let i = 0; i < count; i++) {
    const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, startDate.getDate());
    cheques.push({ num: i + 1, date: date.toLocaleDateString('en-IN'), amount: emi });
  }

  const totalValue = emi * count;

  const res = document.getElementById('pdc-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="mb-3 p-3 bg-indigo-50 rounded">
      <div class="grid grid-cols-3 gap-3 text-sm">
        <div><span class="text-slate-500">Cheques:</span> <span class="font-bold">${count}</span></div>
        <div><span class="text-slate-500">EMI:</span> <span class="font-bold">₹${emi.toLocaleString()}</span></div>
        <div><span class="text-slate-500">Total:</span> <span class="font-bold">₹${totalValue.toLocaleString()}</span></div>
      </div>
    </div>
    <div class="overflow-y-auto max-h-64">
      <table class="w-full text-sm">
        <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2 text-left">Sr</th><th class="p-2 text-left">Due Date</th><th class="p-2 text-right">Amount</th></tr></thead>
        <tbody>
          ${cheques.map(c => `<tr class="border-b"><td class="p-2">${c.num}</td><td class="p-2">${c.date}</td><td class="p-2 text-right">₹${c.amount.toLocaleString()}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  saveToolState('chequeCalculator');
};

// Grace Period Interest Calculator
function renderGracePeriodCalc() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('gracePeriodCalc')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Grace Period Interest Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate interest accrued during pre-EMI/grace period.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Disbursed Amount (₹)</label>
          <input type="number" id="gp-amt" value="3000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="gp-rate" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Grace Period (days)</label>
          <input type="number" id="gp-days" value="30" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Calculation Basis</label>
          <select id="gp-basis" class="w-full border rounded px-3 py-2">
            <option value="365">365 days</option>
            <option value="360">360 days</option>
            <option value="actual">Actual/Actual</option>
          </select>
        </div>
      </div>
      <button onclick="calcGracePeriod()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Interest</button>
      <div id="gp-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcGracePeriod = function() {
  const amt = parseFloat(document.getElementById('gp-amt').value) || 0;
  const rate = parseFloat(document.getElementById('gp-rate').value) || 0;
  const days = parseInt(document.getElementById('gp-days').value) || 0;
  const basis = document.getElementById('gp-basis').value;

  const daysInYear = basis === 'actual' ? 365 : parseInt(basis);
  const interest = amt * (rate / 100) * (days / daysInYear);
  const dailyInt = amt * (rate / 100) / daysInYear;

  const res = document.getElementById('gp-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Principal:</div><div>₹${amt.toLocaleString()}</div>
      <div class="font-medium">Rate:</div><div>${rate}% p.a.</div>
      <div class="font-medium">Grace Days:</div><div>${days} days</div>
      <div class="font-medium">Day Count:</div><div>${daysInYear} days/year</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-orange-100 rounded text-center">
        <div class="text-xl font-bold text-orange-700">₹${interest.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
        <div class="text-xs text-orange-600">Pre-EMI Interest</div>
      </div>
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">₹${dailyInt.toFixed(0)}/day</div>
        <div class="text-xs text-slate-600">Daily Interest</div>
      </div>
    </div>`;
  saveToolState('gracePeriodCalc');
};

// Subvention Calculator
function renderSubventionCalc() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('subventionCalc')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Subvention Calculator</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate dealer/manufacturer subvention and effective rate to customer.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Loan Amount (₹)</label>
          <input type="number" id="sub-amt" value="1000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="sub-tenure" value="36" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Bank Rate (% p.a.)</label>
          <input type="number" id="sub-bankrate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Customer Rate (% p.a.)</label>
          <input type="number" id="sub-custrate" value="7" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Subvention Type</label>
          <select id="sub-type" class="w-full border rounded px-3 py-2">
            <option value="upfront">Upfront (discounted)</option>
            <option value="monthly">Monthly (arrears)</option>
          </select>
        </div>
      </div>
      <button onclick="calcSubvention()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate Subvention</button>
      <div id="sub-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcSubvention = function() {
  const amt = parseFloat(document.getElementById('sub-amt').value) || 0;
  const tenure = parseInt(document.getElementById('sub-tenure').value) || 0;
  const bankRate = parseFloat(document.getElementById('sub-bankrate').value) || 0;
  const custRate = parseFloat(document.getElementById('sub-custrate').value) || 0;
  const type = document.getElementById('sub-type').value;

  const rBank = bankRate / 100 / 12;
  const rCust = custRate / 100 / 12;

  // EMI at bank rate (what bank needs)
  const emiBankRate = amt * rBank * Math.pow(1 + rBank, tenure) / (Math.pow(1 + rBank, tenure) - 1);
  // EMI at customer rate (what customer pays)
  const emiCustRate = amt * rCust * Math.pow(1 + rCust, tenure) / (Math.pow(1 + rCust, tenure) - 1);

  // Subvention per month
  const monthlySubvention = emiBankRate - emiCustRate;
  const totalSubvention = monthlySubvention * tenure;

  // Upfront subvention (present value)
  let upfrontSubvention = 0;
  for (let i = 1; i <= tenure; i++) {
    upfrontSubvention += monthlySubvention / Math.pow(1 + rBank, i);
  }

  const subventionPct = (upfrontSubvention / amt) * 100;

  const res = document.getElementById('sub-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">EMI at Bank Rate:</div><div>₹${emiBankRate.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">EMI to Customer:</div><div>₹${emiCustRate.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Monthly Subvention:</div><div>₹${monthlySubvention.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
      <div class="font-medium">Rate Spread:</div><div>${(bankRate - custRate).toFixed(1)}%</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-indigo-100 rounded text-center">
        <div class="text-xl font-bold text-indigo-700">₹${upfrontSubvention.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
        <div class="text-xs text-indigo-600">Upfront Subvention (PV)</div>
      </div>
      <div class="p-3 bg-orange-100 rounded text-center">
        <div class="text-xl font-bold text-orange-700">${subventionPct.toFixed(2)}%</div>
        <div class="text-xs text-orange-600">% of Loan Amount</div>
      </div>
    </div>
    <div class="mt-3 text-xs text-slate-500">Total nominal subvention over tenure: ₹${totalSubvention.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>`;
  saveToolState('subventionCalc');
};

// Portfolio Yield to Maturity
function renderYieldToMaturity() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('yieldToMaturity')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Portfolio Yield to Maturity</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate expected YTM of loan portfolio with prepayment assumptions.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Portfolio Outstanding (₹ Cr)</label>
          <input type="number" id="ytm-os" value="100" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Weighted Avg Rate (%)</label>
          <input type="number" id="ytm-rate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Avg Remaining Tenure (mo)</label>
          <input type="number" id="ytm-tenure" value="36" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Annual Prepay Rate (%)</label>
          <input type="number" id="ytm-prepay" value="15" step="1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Processing Fee (%)</label>
          <input type="number" id="ytm-fee" value="2" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Foreclosure Charges (%)</label>
          <input type="number" id="ytm-fc" value="2" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcYieldToMaturity()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate YTM</button>
      <div id="ytm-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcYieldToMaturity = function() {
  const os = parseFloat(document.getElementById('ytm-os').value) * 10000000 || 0;
  const rate = parseFloat(document.getElementById('ytm-rate').value) || 0;
  const tenure = parseInt(document.getElementById('ytm-tenure').value) || 36;
  const prepayRate = parseFloat(document.getElementById('ytm-prepay').value) / 100 || 0;
  const procFee = parseFloat(document.getElementById('ytm-fee').value) / 100 || 0;
  const fcCharges = parseFloat(document.getElementById('ytm-fc').value) / 100 || 0;

  const r = rate / 100 / 12;
  const monthlyPrepay = prepayRate / 12;

  // Calculate cash flows with prepayment
  let balance = os;
  let totalCF = 0;
  let weightedCF = 0;
  const emi = os * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);

  // Add processing fee as Day 0 income (amortized)
  const procFeeIncome = os * procFee;

  for (let m = 1; m <= tenure && balance > 0; m++) {
    const interest = balance * r;
    const schedPrincipal = emi - interest;
    const prepay = balance * monthlyPrepay;
    const fcIncome = prepay * fcCharges;
    const cf = emi + prepay + fcIncome;
    totalCF += cf;
    weightedCF += cf * m;
    balance -= (schedPrincipal + prepay);
    if (balance < 0) balance = 0;
  }

  const totalIncome = totalCF - os + procFeeIncome;
  const avgLife = weightedCF / totalCF;
  const simpleYield = (totalIncome / os) / (avgLife / 12) * 100;

  // Approximate IRR/YTM
  const ytm = rate + (procFee + fcCharges * prepayRate) / (avgLife / 12) * 100 / (100 + procFee * 100);

  const res = document.getElementById('ytm-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Portfolio Outstanding:</div><div>₹${(os / 10000000).toFixed(1)} Cr</div>
      <div class="font-medium">Monthly EMI (sched):</div><div>₹${(emi / 100000).toFixed(2)} L</div>
      <div class="font-medium">Weighted Avg Life:</div><div>${avgLife.toFixed(1)} months</div>
      <div class="font-medium">Proc Fee Income:</div><div>₹${(procFeeIncome / 100000).toFixed(2)} L</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">${rate.toFixed(2)}%</div>
        <div class="text-xs text-slate-600">Contracted Rate</div>
      </div>
      <div class="p-3 bg-green-100 rounded text-center">
        <div class="text-xl font-bold text-green-700">${ytm.toFixed(2)}%</div>
        <div class="text-xs text-green-600">Effective YTM</div>
      </div>
    </div>
    <div class="mt-3 text-xs text-slate-500">YTM boost from fees: +${(ytm - rate).toFixed(0)} bps</div>`;
  saveToolState('yieldToMaturity');
};

// Risk-Adjusted Return (RAROC) Calculator
function renderRiskAdjustedReturn() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('riskAdjustedReturn')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Risk-Adjusted Return (RAROC)</h3>
      <p class="text-sm text-slate-600 mb-4">Calculate RAROC for product/segment profitability analysis.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Net Interest Income (₹ L)</label>
          <input type="number" id="rar-nii" value="50" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Fee Income (₹ L)</label>
          <input type="number" id="rar-fee" value="10" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Operating Expenses (₹ L)</label>
          <input type="number" id="rar-opex" value="15" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Expected Loss (₹ L)</label>
          <input type="number" id="rar-el" value="8" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Economic Capital (₹ L)</label>
          <input type="number" id="rar-ec" value="100" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tax Rate (%)</label>
          <input type="number" id="rar-tax" value="25" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcRaroc()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate RAROC</button>
      <div id="rar-result" class="mt-4 p-4 bg-slate-50 rounded border hidden"></div>
    </div>`;
}
window.calcRaroc = function() {
  const nii = parseFloat(document.getElementById('rar-nii').value) * 100000 || 0;
  const fee = parseFloat(document.getElementById('rar-fee').value) * 100000 || 0;
  const opex = parseFloat(document.getElementById('rar-opex').value) * 100000 || 0;
  const el = parseFloat(document.getElementById('rar-el').value) * 100000 || 0;
  const ec = parseFloat(document.getElementById('rar-ec').value) * 100000 || 0;
  const taxRate = parseFloat(document.getElementById('rar-tax').value) / 100 || 0.25;

  const grossIncome = nii + fee;
  const riskAdjProfit = grossIncome - opex - el;
  const taxAdjProfit = riskAdjProfit * (1 - taxRate);
  const raroc = (taxAdjProfit / ec) * 100;

  // Hurdle rate comparison
  const hurdleRate = 15; // Typical CoE
  const economicProfit = taxAdjProfit - (ec * hurdleRate / 100);

  const res = document.getElementById('rar-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
      <div class="font-medium">Gross Income:</div><div>₹${(grossIncome / 100000).toFixed(1)} L</div>
      <div class="font-medium">Less: Opex:</div><div>₹${(opex / 100000).toFixed(1)} L</div>
      <div class="font-medium">Less: Expected Loss:</div><div>₹${(el / 100000).toFixed(1)} L</div>
      <div class="font-medium">Risk-Adj Profit (pre-tax):</div><div>₹${(riskAdjProfit / 100000).toFixed(1)} L</div>
      <div class="font-medium">After Tax:</div><div>₹${(taxAdjProfit / 100000).toFixed(1)} L</div>
      <div class="font-medium">Economic Capital:</div><div>₹${(ec / 100000).toFixed(1)} L</div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 ${raroc >= hurdleRate ? 'bg-green-100' : 'bg-red-100'} rounded text-center">
        <div class="text-2xl font-bold ${raroc >= hurdleRate ? 'text-green-700' : 'text-red-700'}">${raroc.toFixed(1)}%</div>
        <div class="text-xs ${raroc >= hurdleRate ? 'text-green-600' : 'text-red-600'}">RAROC</div>
      </div>
      <div class="p-3 bg-slate-100 rounded text-center">
        <div class="text-xl font-bold text-slate-700">${hurdleRate}%</div>
        <div class="text-xs text-slate-600">Hurdle Rate (CoE)</div>
      </div>
    </div>
    <div class="mt-3 text-center text-sm ${economicProfit >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
      Economic Profit: ₹${(economicProfit / 100000).toFixed(1)} L ${economicProfit >= 0 ? '(Value Creating)' : '(Value Destroying)'}
    </div>`;
  saveToolState('riskAdjustedReturn');
};

// Quick Financial Ratios Calculator
function renderQuickRatios() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('quickRatios')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Quick Financial Ratios</h3>
      <p class="text-sm text-slate-600 mb-4">Enter basic financials to get key ratios for MSME/corporate assessment.</p>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Revenue (₹ L)</label>
          <input type="number" id="qr-rev" value="500" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">EBITDA (₹ L)</label>
          <input type="number" id="qr-ebitda" value="75" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">PAT (₹ L)</label>
          <input type="number" id="qr-pat" value="40" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Total Assets (₹ L)</label>
          <input type="number" id="qr-assets" value="400" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Net Worth (₹ L)</label>
          <input type="number" id="qr-nw" value="150" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Total Debt (₹ L)</label>
          <input type="number" id="qr-debt" value="200" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current Assets (₹ L)</label>
          <input type="number" id="qr-ca" value="180" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current Liabilities (₹ L)</label>
          <input type="number" id="qr-cl" value="120" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Expense (₹ L)</label>
          <input type="number" id="qr-int" value="20" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcQuickRatios()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Calculate All Ratios</button>
      <div id="qr-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcQuickRatios = function() {
  const rev = parseFloat(document.getElementById('qr-rev').value) || 0;
  const ebitda = parseFloat(document.getElementById('qr-ebitda').value) || 0;
  const pat = parseFloat(document.getElementById('qr-pat').value) || 0;
  const assets = parseFloat(document.getElementById('qr-assets').value) || 0;
  const nw = parseFloat(document.getElementById('qr-nw').value) || 0;
  const debt = parseFloat(document.getElementById('qr-debt').value) || 0;
  const ca = parseFloat(document.getElementById('qr-ca').value) || 0;
  const cl = parseFloat(document.getElementById('qr-cl').value) || 0;
  const interest = parseFloat(document.getElementById('qr-int').value) || 0;

  const ratios = [
    { name: 'EBITDA Margin', value: (ebitda / rev * 100).toFixed(1) + '%', benchmark: '>15%', good: ebitda / rev > 0.15 },
    { name: 'PAT Margin', value: (pat / rev * 100).toFixed(1) + '%', benchmark: '>5%', good: pat / rev > 0.05 },
    { name: 'ROE', value: (pat / nw * 100).toFixed(1) + '%', benchmark: '>15%', good: pat / nw > 0.15 },
    { name: 'ROA', value: (pat / assets * 100).toFixed(1) + '%', benchmark: '>5%', good: pat / assets > 0.05 },
    { name: 'Debt/Equity', value: (debt / nw).toFixed(2) + 'x', benchmark: '<2x', good: debt / nw < 2 },
    { name: 'Debt/EBITDA', value: (debt / ebitda).toFixed(2) + 'x', benchmark: '<3x', good: debt / ebitda < 3 },
    { name: 'Interest Cover', value: (ebitda / interest).toFixed(2) + 'x', benchmark: '>3x', good: ebitda / interest > 3 },
    { name: 'Current Ratio', value: (ca / cl).toFixed(2) + 'x', benchmark: '>1.2x', good: ca / cl > 1.2 },
    { name: 'Asset Turnover', value: (rev / assets).toFixed(2) + 'x', benchmark: '>1x', good: rev / assets > 1 },
    { name: 'DSCR (approx)', value: ((ebitda - pat * 0.3) / (interest + debt / 5)).toFixed(2) + 'x', benchmark: '>1.25x', good: (ebitda - pat * 0.3) / (interest + debt / 5) > 1.25 }
  ];

  const res = document.getElementById('qr-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="grid grid-cols-2 gap-3">
      ${ratios.map(r => `
        <div class="p-3 ${r.good ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded">
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium text-slate-700">${r.name}</span>
            <span class="text-sm ${r.good ? 'text-green-600' : 'text-red-600'}">${r.good ? '✓' : '✗'}</span>
          </div>
          <div class="text-lg font-bold ${r.good ? 'text-green-700' : 'text-red-700'}">${r.value}</div>
          <div class="text-xs text-slate-500">Benchmark: ${r.benchmark}</div>
        </div>
      `).join('')}
    </div>`;
  saveToolState('quickRatios');
};

// Amortization Schedule Analyzer
function renderAmortScheduleAnalyzer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('amortScheduleAnalyzer')}
    <div class="max-w-3xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Amortization Schedule Analyzer</h3>
      <p class="text-sm text-slate-600 mb-4">Generate and analyze EMI amortization schedule with principal/interest split.</p>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Principal (₹)</label>
          <input type="number" id="as-principal" value="1000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Rate (% p.a.)</label>
          <input type="number" id="as-rate" value="12" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Tenure (months)</label>
          <input type="number" id="as-tenure" value="24" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcAmortSchedule()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Generate Schedule</button>
      <div id="as-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcAmortSchedule = function() {
  const P = parseFloat(document.getElementById('as-principal').value) || 0;
  const rate = parseFloat(document.getElementById('as-rate').value) || 0;
  const n = parseInt(document.getElementById('as-tenure').value) || 0;

  const r = rate / 100 / 12;
  const emi = P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);

  let balance = P;
  const schedule = [];
  let totalInt = 0, totalPrin = 0;

  for (let m = 1; m <= n; m++) {
    const interest = balance * r;
    const principal = emi - interest;
    balance -= principal;
    totalInt += interest;
    totalPrin += principal;
    schedule.push({ m, emi, principal, interest, balance: Math.max(0, balance) });
  }

  // Yearly summary
  const yearly = [];
  for (let y = 0; y < Math.ceil(n / 12); y++) {
    const start = y * 12;
    const end = Math.min((y + 1) * 12, n);
    const yearData = schedule.slice(start, end);
    const yInt = yearData.reduce((s, r) => s + r.interest, 0);
    const yPrin = yearData.reduce((s, r) => s + r.principal, 0);
    yearly.push({ year: y + 1, interest: yInt, principal: yPrin });
  }

  const res = document.getElementById('as-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="mb-4 p-3 bg-indigo-50 rounded">
      <div class="grid grid-cols-4 gap-3 text-sm">
        <div><span class="text-slate-500">EMI:</span> <span class="font-bold">₹${emi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
        <div><span class="text-slate-500">Total Interest:</span> <span class="font-bold text-red-600">₹${totalInt.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
        <div><span class="text-slate-500">Total Payment:</span> <span class="font-bold">₹${(emi * n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
        <div><span class="text-slate-500">Int/Principal:</span> <span class="font-bold">${(totalInt / P * 100).toFixed(1)}%</span></div>
      </div>
    </div>
    <div class="mb-4">
      <div class="text-sm font-medium text-slate-700 mb-2">Yearly Summary</div>
      <div class="grid grid-cols-${Math.min(yearly.length, 5)} gap-2">
        ${yearly.slice(0, 5).map(y => `
          <div class="p-2 bg-slate-50 rounded text-center text-xs">
            <div class="font-medium">Year ${y.year}</div>
            <div class="text-green-600">P: ₹${(y.principal / 1000).toFixed(0)}K</div>
            <div class="text-red-600">I: ₹${(y.interest / 1000).toFixed(0)}K</div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="overflow-y-auto max-h-48">
      <table class="w-full text-xs">
        <thead class="bg-slate-100 sticky top-0"><tr><th class="p-1">Mo</th><th class="p-1 text-right">EMI</th><th class="p-1 text-right">Principal</th><th class="p-1 text-right">Interest</th><th class="p-1 text-right">Balance</th></tr></thead>
        <tbody>
          ${schedule.map(s => `<tr class="border-b"><td class="p-1">${s.m}</td><td class="p-1 text-right">₹${s.emi.toFixed(0)}</td><td class="p-1 text-right text-green-600">₹${s.principal.toFixed(0)}</td><td class="p-1 text-right text-red-600">₹${s.interest.toFixed(0)}</td><td class="p-1 text-right">₹${s.balance.toFixed(0)}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  saveToolState('amortScheduleAnalyzer');
};

// Prepayment Impact Analyzer
function renderPrepaymentAnalyzer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    ${renderSaveToolbar('prepaymentAnalyzer')}
    <div class="max-w-2xl mx-auto bg-white border rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Prepayment Impact Analyzer</h3>
      <p class="text-sm text-slate-600 mb-4">Compare reduce-EMI vs reduce-tenure prepayment options.</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Outstanding Principal (₹)</label>
          <input type="number" id="pp-os" value="2000000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Current EMI (₹)</label>
          <input type="number" id="pp-emi" value="50000" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Interest Rate (% p.a.)</label>
          <input type="number" id="pp-rate" value="10" step="0.1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Remaining Tenure (months)</label>
          <input type="number" id="pp-tenure" value="48" class="w-full border rounded px-3 py-2">
        </div>
        <div class="col-span-2">
          <label class="block text-xs font-medium text-slate-600 mb-1">Prepayment Amount (₹)</label>
          <input type="number" id="pp-prepay" value="300000" class="w-full border rounded px-3 py-2">
        </div>
      </div>
      <button onclick="calcPrepaymentImpact()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700">Compare Options</button>
      <div id="pp-result" class="mt-4 hidden"></div>
    </div>`;
}
window.calcPrepaymentImpact = function() {
  const os = parseFloat(document.getElementById('pp-os').value) || 0;
  const emi = parseFloat(document.getElementById('pp-emi').value) || 0;
  const rate = parseFloat(document.getElementById('pp-rate').value) || 0;
  const tenure = parseInt(document.getElementById('pp-tenure').value) || 0;
  const prepay = parseFloat(document.getElementById('pp-prepay').value) || 0;

  const r = rate / 100 / 12;
  const newOs = os - prepay;

  // Current scenario (no prepay)
  const totalPayNoPrep = emi * tenure;
  const intNoPrep = totalPayNoPrep - os;

  // Option 1: Reduce EMI (same tenure)
  const newEmi = newOs * r * Math.pow(1 + r, tenure) / (Math.pow(1 + r, tenure) - 1);
  const totalPayReduceEmi = newEmi * tenure + prepay;
  const intReduceEmi = totalPayReduceEmi - os;
  const savingsReduceEmi = intNoPrep - intReduceEmi;
  const emiSaving = emi - newEmi;

  // Option 2: Reduce Tenure (same EMI)
  const newTenure = Math.ceil(Math.log(emi / (emi - newOs * r)) / Math.log(1 + r));
  const totalPayReduceTenure = emi * newTenure + prepay;
  const intReduceTenure = totalPayReduceTenure - os;
  const savingsReduceTenure = intNoPrep - intReduceTenure;
  const tenureSaving = tenure - newTenure;

  const better = savingsReduceTenure > savingsReduceEmi ? 'tenure' : 'emi';

  const res = document.getElementById('pp-result');
  res.classList.remove('hidden');
  res.innerHTML = `
    <div class="mb-4 p-3 bg-slate-100 rounded">
      <div class="grid grid-cols-3 gap-3 text-sm">
        <div><span class="text-slate-500">Current Total:</span> <span class="font-bold">₹${totalPayNoPrep.toLocaleString()}</span></div>
        <div><span class="text-slate-500">Current Interest:</span> <span class="font-bold text-red-600">₹${intNoPrep.toLocaleString()}</span></div>
        <div><span class="text-slate-500">Prepayment:</span> <span class="font-bold">₹${prepay.toLocaleString()}</span></div>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div class="p-4 ${better === 'emi' ? 'bg-green-50 border-green-300' : 'bg-slate-50'} border rounded">
        <div class="font-bold text-lg mb-2">Reduce EMI ${better === 'emi' ? '✓ Better' : ''}</div>
        <div class="text-sm space-y-1">
          <div>New EMI: <span class="font-medium">₹${newEmi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
          <div>EMI Savings: <span class="font-medium text-green-600">₹${emiSaving.toFixed(0)}/mo</span></div>
          <div>Interest Saved: <span class="font-medium text-green-600">₹${savingsReduceEmi.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
          <div>Tenure: <span class="font-medium">${tenure} mo (unchanged)</span></div>
        </div>
      </div>
      <div class="p-4 ${better === 'tenure' ? 'bg-green-50 border-green-300' : 'bg-slate-50'} border rounded">
        <div class="font-bold text-lg mb-2">Reduce Tenure ${better === 'tenure' ? '✓ Better' : ''}</div>
        <div class="text-sm space-y-1">
          <div>EMI: <span class="font-medium">₹${emi.toLocaleString()} (unchanged)</span></div>
          <div>New Tenure: <span class="font-medium">${newTenure} mo</span></div>
          <div>Tenure Saved: <span class="font-medium text-green-600">${tenureSaving} months</span></div>
          <div>Interest Saved: <span class="font-medium text-green-600">₹${savingsReduceTenure.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span></div>
        </div>
      </div>
    </div>
    <div class="mt-3 text-center text-sm font-medium ${better === 'tenure' ? 'text-green-600' : 'text-blue-600'}">
      ${better === 'tenure' ? `Reduce Tenure saves ₹${(savingsReduceTenure - savingsReduceEmi).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} more in interest` : 'Reduce EMI improves cash flow while still saving interest'}
    </div>`;
  saveToolState('prepaymentAnalyzer');
};

// Generic Prototype Renderer (for catalog apps)
function renderPrototype(meta) {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
      <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow-sm p-6 space-y-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Prototype</div>
            <h3 class="text-xl font-bold text-slate-900">${meta.title}</h3>
            <p class="text-sm text-slate-600">${meta.shortDescription || ''}</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 text-xs font-semibold px-3 py-1">Coming Soon</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <div class="text-xs font-semibold text-slate-500 mb-2">What it will do</div>
            <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
              ${(meta.usageNotes||[]).map(n => `<li>${n}</li>`).join('') || '<li>Feature list coming soon.</li>'}
            </ul>
          </div>
          <div class="bg-white border border-dashed border-slate-300 rounded-lg p-4">
            <div class="text-xs font-semibold text-slate-500 mb-2">Planned Inputs</div>
            <p class="text-sm text-slate-700">CSV/Manual inputs will mirror the pattern used across other tools (columns, validation, quick summary).</p>
            <div class="mt-3">
              <button class="px-3 py-2 text-xs rounded bg-slate-800 text-white">Design Spec Placeholder</button>
            </div>
          </div>
        </div>
        <div class="text-xs text-slate-500">Note: This is a UX placeholder to reserve the slot as we scale to 100 apps. Full logic will follow the same self-contained pattern.</div>
      </div>
    `;
}
</script>
</body>
</html>
