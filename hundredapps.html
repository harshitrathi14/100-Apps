<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBFC Quant Toolbox (Monolith v3.1)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif; background-color: #f8fafc; }
    .scroll-table { max-height: 25rem; overflow: auto; }
    .tab-btn.active { background-color: #eef2ff; color: #4338ca; border-color: #6366f1; }
    .file-input {
      display: block;
      width: 100%;
      font-size: 0.875rem;
      color: #4b5563;
      cursor: pointer;
    }
    .file-input::file-selector-button {
      margin-right: 1rem;
      border: 0;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      background-color: #e0e7ff;
      color: #3730a3;
      cursor: pointer;
    }
    .file-input::file-selector-button:hover { background-color: #c7d2fe; }
    /* Securitisation Suite Specifics */
    .sec-input { @apply w-full border rounded p-2 text-sm font-mono; }
    .panel-hidden { display: none; }
  </style>
</head>
<body class="text-slate-900">
  <div class="min-h-screen flex flex-col">
    <header class="bg-slate-900 text-slate-50 shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">NBFC Quant Toolbox</h1>
          <p class="text-xs text-slate-400">17+ Tools: Treasury, Risk, Securitisation & Lending</p>
        </div>
        <div class="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full">v3.1 · Monolith</div>
      </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6 space-y-6">
      <!-- Tool Selector -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200">
        <label class="block text-sm font-medium text-slate-700 mb-2">Select Application</label>
        <select id="tool-select" class="block w-full sm:w-96 rounded-lg border-slate-300 border py-2 px-3 text-sm shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></select>
      </section>

      <!-- Tool Header -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200 space-y-2">
        <h2 id="tool-title" class="text-xl font-bold text-slate-800"></h2>
        <p id="tool-desc" class="text-sm text-slate-600"></p>
      </section>

      <!-- Input Format Guide -->
      <section class="bg-white shadow-sm rounded-xl p-5 border border-slate-200">
        <details>
          <summary class="cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-800">View Input Requirements & Usage Guide</summary>
          <div class="mt-4 space-y-4">
            <div>
              <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">CSV Columns Required</h3>
              <div class="overflow-x-auto border rounded-lg">
                <table class="min-w-full text-xs">
                  <thead class="bg-slate-100">
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold border-b">Column</th>
                      <th class="px-3 py-2 text-left font-semibold border-b">Description</th>
                      <th class="px-3 py-2 text-center font-semibold border-b w-16">Req</th>
                    </tr>
                  </thead>
                  <tbody id="input-format-body"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">How to Use</h3>
              <ul id="usage-list" class="list-disc list-inside text-xs text-slate-700 space-y-1"></ul>
            </div>
          </div>
        </details>
      </section>

      <!-- Main Tool Container -->
      <section class="bg-white shadow-lg rounded-xl p-1 border border-slate-200 min-h-[600px]">
        <div id="tool-container" class="p-4"></div>
      </section>
    </main>

    <footer class="border-t border-slate-200 text-xs text-slate-500 py-6 bg-white mt-8">
      <div class="max-w-7xl mx-auto px-4 flex justify-between">
        <span>Runs 100% locally in browser. No server uploads.</span>
        <span>Generated by Gemini</span>
      </div>
    </footer>
  </div>

<script>
/**
 * CENTRAL CONFIGURATION & METADATA
 */
const TOOL_METADATA = [
  // --- MAJOR SUITE ---
  { id: 'securitisationSuite', title: 'Indian Securitisation AI Suite', shortDescription: 'End-to-end PTC modeling: Waterfall, Gaussian Copula LE, Pricing, Term Sheet.', type: 'securitisationSuite',
    inputColumns: [
      { name: 'period', description: 'YYYY-MM-DD', required: true },
      { name: 'pool_principal', description: 'Collection Amount', required: true },
      { name: 'pool_interest', description: 'Collection Amount', required: true },
    ],
    usageNotes: ['Complete suite for PTC transactions.', '1. Waterfall: Define structure & run flow.', '2. LE: Run simulation for Credit Enhancement.', '3. Docs: Generate Term Sheet.']
  },
  // --- NEW LENDING APPS ---
  { id: 'retailEligibility', title: 'Retail Eligibility (FOIR)', shortDescription: 'Max loan calculator based on Income & Obligations.', type: 'retailEligibility', inputColumns: [], usageNotes: ['Enter Net Income & EMIs to get Max Loan.'] },
  { id: 'lapCalculator', title: 'Loan Against Property (LAP)', shortDescription: 'LTV vs FOIR eligibility check.', type: 'lapCalculator', inputColumns: [], usageNotes: ['Compares Property-based vs Income-based limits.'] },
  { id: 'educationLoan', title: 'Education Loan Structurer', shortDescription: 'Moratorium interest & capitalization.', type: 'educationLoan', inputColumns: [], usageNotes: ['Structures loan with study-period interest logic.'] },
  { id: 'scfDiscounting', title: 'Supply Chain / Invoice Discounting', shortDescription: 'Net disbursement & yield calculator.', type: 'scfDiscounting', inputColumns: [], usageNotes: ['Calculates upfront discount and effective yield.'] },
  { id: 'wholesaleRatios', title: 'Corporate Financial Analysis', shortDescription: 'Financial statement spreading & ratio analysis.', type: 'wholesaleRatios', inputColumns: [], usageNotes: ['Enter financials to get DSCR, DE, Current Ratio.'] },
  // --- RISK & OPS ---
  { id: 'npaProvisioning', title: 'NPA & Provisioning (IRAC)', shortDescription: 'Asset classification & provisioning per RBI norms.', type: 'npaProvisioning',
    inputColumns: [{ name: 'loan_id', description: 'ID', required: true }, { name: 'os_balance', description: 'OS', required: true }, { name: 'dpd', description: 'DPD', required: true }], usageNotes: ['Calculates provisions: 0.4% (Std), 15/25% (SS), etc.']
  },
  { id: 'coLending', title: 'Co-Lending Structurer', shortDescription: 'Blended rate & spread calculator for 80:20 deals.', type: 'coLending', inputColumns: [], usageNotes: ['Input Bank/NBFC share to get Blended Rate.'] },
  { id: 'staticPool', title: 'Static Pool Analyzer', shortDescription: 'Vintage analysis heatmap (Triangular View).', type: 'staticPool',
    inputColumns: [{ name: 'vintage', description: 'YYYY-MM', required: true }, { name: 'mob', description: 'Month', required: true }, { name: 'value', description: 'Metric', required: true }], usageNotes: ['Generates cohort analysis table.']
  },
  // --- LEGACY & TREASURY ---
  { id: 'xirr', title: 'XIRR & Cashflow Analyzer', shortDescription: 'Account-wise and portfolio XIRR.', type: 'xirr',
    inputColumns: [{ name: 'account_id', description: 'ID', required: true }, { name: 'date', description: 'YYYY-MM-DD', required: true }, { name: 'amount', description: 'Cashflow', required: true }], usageNotes: ['Upload raw cashflows. Negative=disbursal.']
  },
  { id: 'hpr', title: 'HPR & Annualised Return', shortDescription: 'Holding period returns for securities.', type: 'hpr',
    inputColumns: [{ name: 'instrument_id', description: 'ID', required: true }, { name: 'purchase_date', description: 'Date', required: true }, { name: 'sale_date', description: 'Date', required: true }, { name: 'purchase_value', description: 'Price', required: true }, { name: 'sale_value', description: 'Price', required: true }], usageNotes: ['Upload instrument ledger.']
  },
  { id: 'geoPerformance', title: 'Geo Performance Visualiser', shortDescription: 'State/district AUM & PAR view.', type: 'geo',
    inputColumns: [{ name: 'state', description: 'Region', required: true }, { name: 'aum', description: 'OS', required: true }], usageNotes: ['Visualise geographic risk.']
  },
  { id: 'almStress', title: 'ALM Stress & Duration Lab', shortDescription: 'Parallel + twist scenarios.', type: 'alm',
    inputColumns: [{ name: 'bucket_months', description: 'Tenor', required: true }, { name: 'cashflow', description: 'Amount', required: true }, { name: 'yield_pct', description: 'Yield %', required: true }], usageNotes: ['Duration/Convexity analysis.']
  },
  { id: 'macro', title: 'Macro / CMIE Dashboard', shortDescription: 'GDP & CPI quick view.', type: 'macro', inputColumns: [], usageNotes: ['Pre-loaded macro indicators.'] },
  { id: 'daCalculator', title: 'DA Upfront Income Calculator', shortDescription: 'Manual + pool CSV calc.', type: 'da',
    inputColumns: [{ name: 'POS', description: 'Principal', required: true }, { name: 'End borrower Rate', description: 'Yield', required: true }, { name: 'Residual Tenure', description: 'Mths', required: true }], usageNotes: ['Calculate IO strip value.']
  },
  { id: 'regValidator', title: 'Regulatory Return Validator', shortDescription: 'CRILC / RBI schema QC.', type: 'regValidator', inputColumns: [], usageNotes: ['Checks CSV schema.'] },
  { id: 'ews', title: 'Early Warning Scorecard', shortDescription: 'DPD + bureau + bounce triggers.', type: 'ews', inputColumns: [{ name: 'loan_id', description: 'ID', required: true }, { name: 'dpd', description: 'DPD', required: true }], usageNotes: ['Classifies risk categories.'] }
];

const PROTOTYPE_APPS = [
  // Retail Lending
  { id: 'homeLoanEligibility', title: 'Home Loan Eligibility', shortDescription: 'FOIR + LTV with stamp duty and insurance adders.', usageNotes: ['Input income, property value, duties, existing EMIs.'], type: 'homeLoanEligibility',
    inputColumns: [{ name: 'income', description: 'Monthly net income', required: true }, { name: 'existing_emi', description: 'Current EMIs', required: true }, { name: 'property_value', description: 'Property value', required: true }] },
  { id: 'autoLoanStructurer', title: 'Auto Loan On-Road Structurer', shortDescription: 'On-road price breakup, margin, FOIR & tenure.', usageNotes: ['Enter ex-showroom, taxes, accessories, and income.'], type: 'autoLoanStructurer',
    inputColumns: [{ name: 'income', description: 'Monthly net income', required: true }, { name: 'existing_emi', description: 'Other EMIs', required: true }] },
  { id: 'goldLoanLtv', title: 'Gold Loan LTV Optimizer', shortDescription: 'LTV vs per-gram price and auction buffer.', usageNotes: ['Enter karat, grams, market price, and margin.'], type: 'goldLoanLtv',
    inputColumns: [{ name: 'karat', description: 'Purity (K)', required: true }, { name: 'grams', description: 'Gold weight', required: true }, { name: 'price_per_gram', description: 'INR/gram', required: true }] },
  { id: 'plTopUp', title: 'Personal Loan Top-Up Calculator', shortDescription: 'Top-up eligibility net of foreclosure and charges.', usageNotes: ['Enter OS balance, rate, remaining tenor, new rate.'], type: 'plTopUp',
    inputColumns: [{ name: 'os_balance', description: 'Outstanding', required: true }, { name: 'remaining_tenor_m', description: 'Months left', required: true }, { name: 'income', description: 'Monthly income', required: true }] },
  { id: 'btSavings', title: 'Balance Transfer Savings Estimator', shortDescription: 'EMI and interest savings after BT with fees.', usageNotes: ['Compare current EMI vs proposed EMI and one-time fees.'], type: 'btSavings',
    inputColumns: [{ name: 'os_balance', description: 'Outstanding', required: true }, { name: 'remaining_tenor_m', description: 'Months left', required: true }] },
  { id: 'mfiGroupSplitter', title: 'Microfinance Group Loan Splitter', shortDescription: 'Group-level and member-level ticket sizing.', usageNotes: ['Enter group income, member list, and repeat vs new.'], type: 'mfiGroupSplitter',
    inputColumns: [{ name: 'name', description: 'Member name', required: true }, { name: 'income', description: 'Monthly income', required: true }, { name: 'status', description: 'repeat/new', required: true }] },
  // MSME / Corporate
  { id: 'wcGap', title: 'Working Capital Gap Analyzer', shortDescription: 'Net working capital vs drawing power.', usageNotes: ['Enter inventory, receivables, payables, bank margins.'], type: 'prototype' },
  { id: 'ccDp', title: 'Cash-Credit DP Calculator', shortDescription: 'Stock and book debts net of margins and ineligibles.', usageNotes: ['Upload stock & debtor aging; set margin %.'], type: 'prototype' },
  { id: 'billDiscountLimit', title: 'Bill Discounting Limit Setter', shortDescription: 'Limit sizing from turnover, acceptances, and tenor.', usageNotes: ['Enter turnover, average acceptance days, dilution %.'], type: 'prototype' },
  { id: 'projFinanceDscr', title: 'Project Finance DSCR Builder', shortDescription: 'DSCR timeline with moratorium and ballooning.', usageNotes: ['Upload project cash flows; set debt profile.'], type: 'prototype' },
  { id: 'consortiumAllocator', title: 'Consortium Share Allocator', shortDescription: 'Bank-wise share, security, and rate splits.', usageNotes: ['Enter facility amount and bank participation %.'], type: 'prototype' },
  { id: 'fxCoverage', title: 'FX Forward Coverage Planner', shortDescription: 'Coverage ladder vs payable schedule.', usageNotes: ['Upload currency payables; set hedge ratio and tenor.'], type: 'prototype' },
  // Cards & BNPL
  { id: 'cardLimitEngine', title: 'Credit Card Limit Engine', shortDescription: 'Limit setting using income, bureau, and utilization.', usageNotes: ['Enter income, bureau score, utilization bands.'], type: 'prototype' },
  { id: 'revolverProfit', title: 'Revolver vs Transactor Profitability', shortDescription: 'Profit bridge by revolve share and costs.', usageNotes: ['Input revolve rate, MDR, funding cost, rewards %.'], type: 'prototype' },
  { id: 'bnplTenorPricing', title: 'BNPL Tenor Pricing Tool', shortDescription: 'Tenor-wise MDR, subvention, and NPV.', usageNotes: ['Enter ticket size, MDR/subvention %, loss %, CoF.'], type: 'prototype' },
  { id: 'mdrSimulator', title: 'MDR & Interchange Simulator', shortDescription: 'Take rate decomposition and net yield.', usageNotes: ['Enter scheme fees, issuer/acquirer splits, FX fees.'], type: 'prototype' },
  { id: 'emiConversionPicker', title: 'EMI Conversion Offer Picker', shortDescription: 'Best plan given fee, tenure, and uptake.', usageNotes: ['Input fee %, tenure options, expected adoption.'], type: 'prototype' },
  { id: 'rewardsLiability', title: 'Rewards Liability Forecaster', shortDescription: 'Accrual vs redemption and breakage.', usageNotes: ['Enter earn/burn rates, avg points value, expiry.'], type: 'prototype' },
  // Collections & Recovery
  { id: 'ptpTracker', category: 'Collections & Recovery', title: 'Promise-to-Pay Tracker', shortDescription: 'PTP capture, hit-rate, and slippage monitor.', usageNotes: ['Upload PTP log with dates, amounts, status.'], type: 'ptpTracker' },
  { id: 'settlementOptimizer', category: 'Collections & Recovery', title: 'Settlement Offer Optimizer', shortDescription: 'Optimal settlement curves by bucket.', usageNotes: ['Set bucket-wise min %, cost-to-collect, recoveries.'], type: 'settlementOptimizer' },
  { id: 'rollRateCube', category: 'Collections & Recovery', title: 'Roll-Rate Cube Visualizer', shortDescription: 'DPD migration matrix over time.', usageNotes: ['Upload DPD snapshots; see heatmap and stability.'], type: 'rollRateCube' },
  { id: 'cureForecast', category: 'Collections & Recovery', title: 'Cure Rate Forecast', shortDescription: 'Forecast cures using logistic fit.', usageNotes: ['Upload bucketed cures; tool fits curve for outlook.'], type: 'cureForecast' },
  { id: 'fieldRoute', category: 'Collections & Recovery', title: 'Field Ops Route Planner', shortDescription: 'Route prioritisation by amount and proximity.', usageNotes: ['Upload address+amount; set max visits/day.'], type: 'fieldRoute' },
  { id: 'legalRoi', category: 'Collections & Recovery', title: 'Legal Bucket ROI Calculator', shortDescription: 'Compare legal costs vs expected recoveries.', usageNotes: ['Enter claim amount, fees, win rate, timeline.'], type: 'legalRoi' },
  // Credit Policy & Scoring
  { id: 'policyMatrix', title: 'Policy Matrix Validator', shortDescription: 'Rules vs portfolio hit-rate.', usageNotes: ['Upload rules and portfolio; see pass/fail % and overrides.'], type: 'prototype' },
  { id: 'thinFileScore', title: 'Thin File Surrogate Score', shortDescription: 'Alternate data weights for thin files.', usageNotes: ['Enter bureau flags, bank statements, device signals.'], type: 'prototype' },
  { id: 'bureauCutoff', title: 'Bureau Score Cutoff Optimizer', shortDescription: 'Cutoff vs approval and loss trade-off.', usageNotes: ['Upload score vs loss; get KS/Gini and max profit.'], type: 'prototype' },
  { id: 'incomeUplift', title: 'Income Surrogate Uplift Analyzer', shortDescription: 'Incremental approvals from surrogate income.', usageNotes: ['Upload declared vs surrogate income; see lift.'], type: 'prototype' },
  { id: 'fraudRules', title: 'Fraud Rule Hit-Rate Tracker', shortDescription: 'Rule-wise hit, precision, and recall.', usageNotes: ['Upload rule hits and confirmed fraud tags.'], type: 'prototype' },
  { id: 'riskPricingGrid', title: 'Risk-Based Pricing Grid Builder', shortDescription: 'Price grid by risk bands and LTV/FOIR.', usageNotes: ['Define bands; export pricing matrix.'], type: 'prototype' },
  // Risk Analytics
  { id: 'pdLgdEad', title: 'PD/LGD/EAD Calibrator', shortDescription: 'Binning + WoE and calibration.', usageNotes: ['Upload defaults/non-defaults; set binning strategy.'], type: 'prototype' },
  { id: 'vintageCnl', title: 'Vintage CNL & NCL Tracker', shortDescription: 'Cumulative loss tracking by vintage.', usageNotes: ['Upload vintage loss data; view CNL/NCL curves.'], type: 'prototype' },
  { id: 'parTriangle', title: 'PAR/DPD Triangle Explorer', shortDescription: 'PAR matrix across MOB and vintages.', usageNotes: ['Upload PAR by MOB; see heatmap and peaks.'], type: 'prototype' },
  { id: 'ccfCalc', title: 'CCF Calculator for Unused Limits', shortDescription: 'CCF by product, utilisation, and behavior.', usageNotes: ['Upload limit/utilisation; set product CCFs.'], type: 'prototype' },
  { id: 'stressLoss', title: 'Stress Loss Attribution', shortDescription: 'Impact of PD/LGD shocks separately.', usageNotes: ['Set PD/LGD shocks; tool decomposes loss lift.'], type: 'prototype' },
  { id: 'giniKs', title: 'Gini/KS Model Validation', shortDescription: 'Scorecard validation metrics.', usageNotes: ['Upload scores with good/bad; get KS/Gini/Lift.'], type: 'prototype' },
  { id: 'delinqLadder', category: 'Collections & Recovery', title: 'Delinquency Ladder Converter', shortDescription: 'Map PAR/DPD ladder to lifetime loss and annualised spread.', usageNotes: ['Input PAR30/60/90, cure rates, LGD, WAL to get implied loss and bps.'], type: 'delinqLadder' },
  { id: 'productMixRisk', category: 'Risk & Pricing', title: 'Product Mix Risk Uplift', shortDescription: 'Weighted risk premium by product PD/LGD and prepay.', usageNotes: ['Enter product share, PD, LGD, prepay to get weighted spread.'], type: 'productMixRisk' },
  { id: 'severityFrequency', category: 'Risk & Pricing', title: 'Severity vs Frequency Decomposer', shortDescription: 'Split lifetime loss into PD and LGD levers; price each.', usageNotes: ['Enter PD, LGD, WAL, add-ons to see total spread and lever impact.'], type: 'severityFrequency' },
  // Treasury & Markets
  { id: 'cpPlanner', title: 'CP/CD Issuance Planner', shortDescription: 'Optimal size/tenor vs ALM and investors.', usageNotes: ['Enter cash need, tenor options, investor rates.'], type: 'prototype' },
  { id: 'ytwTool', title: 'Bond Yield-to-Worst Tool', shortDescription: 'YTW across call/put schedules.', usageNotes: ['Upload cashflows and call/put dates.'], type: 'prototype' },
  { id: 'durationMatch', title: 'Duration Matching Optimizer', shortDescription: 'Match asset/liability duration.', usageNotes: ['Upload buckets; tool suggests rebalancing.'], type: 'prototype' },
  { id: 'liqGapBehavioral', title: 'Liquidity Gap (Behavioral)', shortDescription: 'ALM with decay and prepayment assumptions.', usageNotes: ['Upload gaps; set decay/prepay multipliers.'], type: 'prototype' },
  { id: 'fxArb', title: 'FX Swap vs Forward Arbitrage Checker', shortDescription: 'Checks covered interest parity.', usageNotes: ['Enter spot, forward, swap points, rates.'], type: 'prototype' },
  { id: 'ftpCurve', title: 'FTP Curve Builder', shortDescription: 'Funds transfer pricing term structure.', usageNotes: ['Input market curves; add liquidity and op-cost spreads.'], type: 'prototype' },
  // Securitisation & Structured
  { id: 'ceBacktest', title: 'CE Sufficiency Back-tester', shortDescription: 'Back-test CE vs historical losses.', usageNotes: ['Upload pool loss curves; test CE % sufficiency.'], type: 'prototype' },
  { id: 'triggerMonitor', title: 'Trigger Breach Monitor', shortDescription: 'Track OC/CC/DR triggers.', usageNotes: ['Upload monthly pool metrics; flag breaches.'], type: 'prototype' },
  { id: 'replQc', title: 'Replenishment Pool QC', shortDescription: 'QC checklist for replenishment criteria.', usageNotes: ['Upload candidate pool; see pass/fail.'], type: 'prototype' },
  { id: 'delinqDiversion', title: 'Delinquency Diversion Scenario', shortDescription: 'Simulate diversion of delinq collections.', usageNotes: ['Set diversion %, stress delinq path.'], type: 'prototype' },
  { id: 'collateralStrat', title: 'Collateral Stratification Dashboard', shortDescription: 'Strats by LTV, bureau, geography.', usageNotes: ['Upload pool tape; view stratified charts.'], type: 'prototype' },
  { id: 'waterfallComparator', title: 'Waterfall Comparator', shortDescription: 'Compare structure A vs B outputs.', usageNotes: ['Upload two structures and pools; view diff.'], type: 'prototype' },
  // Funding & Capital
  { id: 'costOfFunds', title: 'Cost of Funds Tracker', shortDescription: 'Weighted cost by source mix.', usageNotes: ['Enter mix and rate per source; view WAC trend.'], type: 'prototype' },
  { id: 'capitalAdequacy', title: 'Capital Adequacy Calculator', shortDescription: 'RWA, CAR, Tier-1 buffers.', usageNotes: ['Upload exposures with risk weights; compute CAR.'], type: 'prototype' },
  { id: 'leverageRatio', title: 'Leverage Ratio Monitor', shortDescription: 'Tier-1 capital vs exposure measure.', usageNotes: ['Enter Tier-1 and total exposure; track trend.'], type: 'prototype' },
  { id: 'icaapSheet', title: 'ICAAP Scenario Worksheet', shortDescription: 'Scenario-wise capital consumption.', usageNotes: ['Define scenarios; map to RWA and capital.'], type: 'prototype' },
  { id: 'ecbVsNcd', title: 'ECB vs NCD Funding Choice', shortDescription: 'Compare all-in cost and covenants.', usageNotes: ['Enter spreads, fees, hedge cost, covenants.'], type: 'prototype' },
  { id: 'callableLadder', title: 'Callable vs Non-Callable Ladder', shortDescription: 'Ladder planner for callable paper.', usageNotes: ['Define maturities; view cashflow ladder.'], type: 'prototype' },
  // Regulatory & Compliance
  { id: 'iracEngine', title: 'IRAC Rule Engine', shortDescription: 'Multi-product IRAC classification.', usageNotes: ['Upload account DPD; get IRAC class & provision.'], type: 'prototype' },
  { id: 'indasEcl', title: 'IND-AS ECL Calculator', shortDescription: 'Stage migration and lifetime ECL.', usageNotes: ['Upload stage data, PD/LGD, EAD; compute ECL.'], type: 'prototype' },
  { id: 'rbiForms', title: 'RLNG/ALM Form Pack Validator', shortDescription: 'Schema QC for regulatory forms.', usageNotes: ['Upload CSV/XML; get missing/format errors.'], type: 'prototype' },
  { id: 'kycCompleteness', title: 'KYC Completeness Checker', shortDescription: 'KYC field gap analysis.', usageNotes: ['Upload KYC dataset; see missing/expired items.'], type: 'prototype' },
  { id: 'fatcaCrs', title: 'FATCA/CRS Flagger', shortDescription: 'Flags reportable accounts.', usageNotes: ['Upload customer profile; flag indicia.'], type: 'prototype' },
  { id: 'udyamGst', title: 'Udyam/GST Mismatch Detector', shortDescription: 'Cross-check Udyam vs GST data.', usageNotes: ['Upload Udyam and GST extracts; see mismatches.'], type: 'prototype' },
  // Ops & Servicing
  { id: 'tatMonitor', title: 'Disbursement TAT Monitor', shortDescription: 'Stage-wise TAT and bottleneck finder.', usageNotes: ['Upload application timestamps; view SLA hits.'], type: 'prototype' },
  { id: 'enachForecast', title: 'E-NACH Success Forecaster', shortDescription: 'Predicts success by bank and time.', usageNotes: ['Upload NACH attempts with bank/time; get success lift.'], type: 'prototype' },
  { id: 'bounceFee', title: 'Bounce Fee Engine', shortDescription: 'Bounce fee rules and realized collections.', usageNotes: ['Enter product-wise fee rules and bounce counts.'], type: 'prototype' },
  { id: 'escrowReco', title: 'Escrow Reconciliation Tool', shortDescription: 'Match escrow credits to loans.', usageNotes: ['Upload bank statement and loan ledger; auto-match.'], type: 'prototype' },
  { id: 'pdcTracker', title: 'PDC Inventory Tracker', shortDescription: 'Track PDC status and expiries.', usageNotes: ['Upload PDC register; see expiries and gaps.'], type: 'prototype' },
  { id: 'slaDashboard', title: 'Service Request SLA Dashboard', shortDescription: 'SLA adherence for service tickets.', usageNotes: ['Upload SR log with timestamps; see SLA % and breaches.'], type: 'prototype' },
  // Pricing & Profitability
  { id: 'nimBridge', title: 'NIM Bridge Analyzer', shortDescription: 'Drivers of NIM movement.', usageNotes: ['Enter asset yield, CoF, OPEX, LLP changes.'], type: 'prototype' },
  { id: 'netYield', title: 'Net Yield after Costs', shortDescription: 'Product net yield after all costs.', usageNotes: ['Enter rates, fees, CoF, opex, credit cost.'], type: 'netYield' },
  { id: 'feeImpact', title: 'Upfront vs Amortized Fee Impact', shortDescription: 'PV and accrual impact of fees.', usageNotes: ['Enter upfront fee %, tenure, amortization method.'], type: 'feeImpact' },
  { id: 'crossSell', title: 'Cross-Sell Take-Rate Forecaster', shortDescription: 'Forecast take-rate and margin.', usageNotes: ['Enter base conversion, uplift factors, margin.'], type: 'crossSell' },
  { id: 'prepayPenalty', title: 'Prepayment Penalty Optimizer', shortDescription: 'Optimal prepay charges vs attrition.', usageNotes: ['Input churn sensitivity; see revenue vs retention.'], type: 'prepayPenalty' },
  { id: 'lossLeader', title: 'Loss-Leader Payback Calculator', shortDescription: 'Payback period for promo offers.', usageNotes: ['Enter CAC, promo loss, LTV uplift assumptions.'], type: 'lossLeader' },
  { id: 'annualLossRate', title: 'Annualised Loss Rate (Risk Premium)', shortDescription: 'Convert lifetime loss to annualised credit spread on amortising loans.', usageNotes: ['Enter principal, coupon, tenor, frequency, prepay %, and lifetime loss % to get annualised risk premium (bps).'], type: 'annualLossRate',
    inputColumns: [{ name: 'principal', description: 'Loan amount', required: true }, { name: 'rate', description: 'Annual interest %', required: true }, { name: 'tenor_months', description: 'Months', required: true }, { name: 'freq', description: 'monthly/quarterly', required: false }, { name: 'prepay_rate', description: '% per period', required: false }, { name: 'lifetime_loss_pct', description: '% of orig', required: true }] },
  { id: 'vintageLossForecaster', title: 'Vintage Loss Forecaster', shortDescription: 'Extrapolate partial vintage losses to full lifetime with bands and cushion.', usageNotes: ['Paste MOB, cum loss% data; set horizon; tool projects tail and bps cushion.'], type: 'vintageLossForecaster',
    inputColumns: [{ name: 'mob', description: 'Month-on-book', required: true }, { name: 'cum_loss_pct', description: '% cumulative', required: true }] },
  { id: 'stressUplift', title: 'Stress Uplift Recommender', shortDescription: 'Scenario add-ons (bps) for GDP, inflation, and rate shocks.', usageNotes: ['Input base spread and macro shocks to get uplift grid.'], type: 'stressUplift' },
  { id: 'coLendFls', title: 'Co-Lending First-Loss Splitter', shortDescription: 'Spread split given FLDG/first-loss share and PD/LGD.', usageNotes: ['Enter pool loss, first-loss %, and share to allocate spread.'], type: 'coLendFls' },
  { id: 'bureauPricing', title: 'Bureau Score Cutoff Pricing', shortDescription: 'Discount/premium by score band to hold target ROE.', usageNotes: ['Enter band loss %, CoF, opex, ROE target, base rate.'], type: 'bureauPricing' },
  { id: 'excelToolkit', title: 'Excel Daily Toolkit', shortDescription: 'Quick CAGR, % change, EMI utilities.', usageNotes: ['Use mini-calculators that mirror day-to-day Excel tasks.'], type: 'excelToolkit' },
  // Data Quality & Utilities
  { id: 'schemaProfiler', title: 'Schema Profiler', shortDescription: 'Missingness, type, and format scan.', usageNotes: ['Upload CSV; get missing %, invalid formats.'], type: 'prototype' },
  { id: 'dedupeResolver', title: 'Duplicate Entity Resolver', shortDescription: 'Fuzzy matching for duplicates.', usageNotes: ['Upload master data; configure match keys.'], type: 'prototype' },
  { id: 'outlierDetector', title: 'Outlier Detector', shortDescription: 'Z-score and IQR outlier flags.', usageNotes: ['Upload numeric columns; pick method and threshold.'], type: 'prototype' },
  { id: 'dateAmountSanitizer', title: 'Date/Amount Sanitizer', shortDescription: 'Fix date formats and sign flips.', usageNotes: ['Upload raw extract; choose date format; sign rules.'], type: 'prototype' },
  { id: 'currencyNormalizer', title: 'Currency/Unit Normalizer', shortDescription: 'Normalize units and FX rates.', usageNotes: ['Upload amounts with units; set FX and unit map.'], type: 'prototype' },
  { id: 'masterDiff', title: 'Master Data Diff Tool', shortDescription: 'Diff two masters and highlight changes.', usageNotes: ['Upload old vs new master; see adds/drops/changes.'], type: 'prototype' },
  // Portfolio Monitoring & Dashboards
  { id: 'aumRollforward', title: 'AUM/OS Rollforward Builder', shortDescription: 'Open, disb, collection, prepay, close.', usageNotes: ['Upload monthly flows; tool builds rollforward.'], type: 'prototype' },
  { id: 'cohortRetention', title: 'Cohort Retention Dashboard', shortDescription: 'Retention curves by cohort.', usageNotes: ['Upload cohort-months; view survival curves.'], type: 'prototype' },
  { id: 'rbiGeoHeatmap', title: 'Geo Heatmap (RBI Districts)', shortDescription: 'District-level AUM and PAR.', usageNotes: ['Upload district codes and metrics; see map/heat.'], type: 'prototype' },
  { id: 'segmentProfitTree', title: 'Segment Profitability Tree', shortDescription: 'Waterfall of revenue to PAT by segment.', usageNotes: ['Upload segment P&L; view waterfall.'], type: 'prototype' },
  { id: 'earlyDelinqPulse', title: 'Early Delinquency Pulse (0–30)', shortDescription: 'Early bucket monitoring.', usageNotes: ['Upload early DPD counts and amounts; view trend.'], type: 'prototype' },
  { id: 'ntcPerformance', title: 'New-to-Credit Performance Tracker', shortDescription: 'NTC vs existing borrower performance.', usageNotes: ['Upload NTC flag with losses; compare metrics.'], type: 'prototype' },
];

const ALL_TOOLS = [...TOOL_METADATA, ...PROTOTYPE_APPS];

let selectedToolId = 'securitisationSuite';
const moneyFmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });
const pct = v => isFinite(v) ? (v * 100).toFixed(2) + '%' : '-';

// --- GLOBAL HELPERS ---
function formatDateFlexible(v) {
  if (!v) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const parts = String(v).split(/[\/\-]/);
  if (parts.length === 3) {
    const a = parseInt(parts[0], 10);
    const b = parseInt(parts[1], 10) - 1;
    const c = parseInt(parts[2], 10);
    return new Date(c, b, a);
  }
  return null;
}

function downloadCSV(rows, filename) {
    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Normal Distribution Helpers
const normCdf = (x) => jStat.normal.cdf(x, 0, 1);
const normInv = (p) => jStat.normal.inv(p, 0, 1);

// Loan math helpers
function calcEmi(principal, annualRatePct, months) {
  const r = annualRatePct / 1200;
  if (!principal || !months) return 0;
  if (r === 0) return principal / months;
  const pow = Math.pow(1 + r, months);
  return principal * r * pow / (pow - 1);
}
function loanFromEmi(emi, annualRatePct, months) {
  const r = annualRatePct / 1200;
  if (!emi || !months) return 0;
  if (r === 0) return emi * months;
  const pow = Math.pow(1 + r, months);
  return emi * (pow - 1) / (r * pow);
}

// --- CORE APP LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
  renderSelector();
  renderMeta();
  renderToolBody();
});

function getMeta(id) { return ALL_TOOLS.find(t => t.id === id); }

function renderSelector() {
  const sel = document.getElementById('tool-select');
  sel.innerHTML = '';
  const byCat = {};
  ALL_TOOLS.forEach(t => {
    const cat = t.category || 'General';
    if (!byCat[cat]) byCat[cat] = [];
    byCat[cat].push(t);
  });
  Object.keys(byCat).sort().forEach(cat => {
    const og = document.createElement('optgroup');
    og.label = cat;
    byCat[cat].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.title;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  });
  sel.value = selectedToolId;
  sel.addEventListener('change', e => {
    selectedToolId = e.target.value;
    renderMeta();
    renderToolBody();
  });
}

function renderMeta() {
  const meta = getMeta(selectedToolId);
  if (!meta) return;
  document.getElementById('tool-title').textContent = meta.title;
  document.getElementById('tool-desc').textContent = meta.shortDescription;
  const tbody = document.getElementById('input-format-body');
  tbody.innerHTML = '';
  (meta.inputColumns || []).forEach(col => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-3 py-2 border-t font-mono text-xs">${col.name}</td><td class="px-3 py-2 border-t text-xs">${col.description}</td><td class="px-3 py-2 border-t text-center text-xs">${col.required ? 'Yes' : ''}</td>`;
    tbody.appendChild(tr);
  });
  const usage = document.getElementById('usage-list');
  usage.innerHTML = '';
  meta.usageNotes.forEach(note => {
    const li = document.createElement('li');
    li.textContent = note;
    usage.appendChild(li);
  });
}

function renderToolBody() {
  const meta = getMeta(selectedToolId);
  const container = document.getElementById('tool-container');
  container.innerHTML = '';
  
  const map = {
    securitisationSuite: renderSecuritisationSuite,
    retailEligibility: renderRetailEligibility,
    lapCalculator: renderLAPCalculator,
    educationLoan: renderEducationLoan,
    scfDiscounting: renderSCFDiscounting,
    wholesaleRatios: renderWholesaleRatios,
    xirr: renderXirr,
    hpr: renderHpr,
    staticPool: renderStaticPool,
    geo: renderGeo,
    alm: renderAlm,
    macro: renderMacro,
    da: renderDa,
    regValidator: renderRegValidator,
    ews: renderEws,
    npaProvisioning: renderNpaProvisioning,
    coLending: renderCoLending,
    annualLossRate: renderAnnualLossRate,
    delinqLadder: renderDelinqLadder,
    productMixRisk: renderProductMixRisk,
    netYield: renderNetYield,
    feeImpact: renderFeeImpact,
    crossSell: renderCrossSell,
    prepayPenalty: renderPrepayPenalty,
    lossLeader: renderLossLeader,
    vintageLossForecaster: renderVintageLossForecaster,
    stressUplift: renderStressUplift,
    coLendFls: renderCoLendFls,
    bureauPricing: renderBureauPricing,
    excelToolkit: renderExcelToolkit,
    delinqLadder: renderDelinqLadder,
    productMixRisk: renderProductMixRisk,
    severityFrequency: renderSeverityFrequency,
    ptpTracker: renderPtpTracker,
    settlementOptimizer: renderSettlementOptimizer,
    rollRateCube: renderRollRateCube,
    cureForecast: renderCureForecast,
    fieldRoute: renderFieldRoute,
    legalRoi: renderLegalRoi,
    homeLoanEligibility: renderHomeLoanEligibility,
    autoLoanStructurer: renderAutoLoanStructurer,
    goldLoanLtv: renderGoldLoanLtv,
    plTopUp: renderPlTopUp,
    btSavings: renderBtSavings,
    mfiGroupSplitter: renderMfiGroupSplitter,
    prototype: renderPrototype,
  };
  
  if (map[meta.type]) map[meta.type](meta);
  else container.innerHTML = '<div class="text-gray-500 text-center mt-10">Tool logic loading...</div>';
}

/* ==========================================================================
   1. SECURITISATION AI SUITE (FULL)
   ========================================================================== */
let WF_RES = null, LE_SUMMARY = null, LE_VEC = null;

function renderSecuritisationSuite() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="space-y-6">
        <div class="flex flex-wrap gap-2 border-b border-slate-200 pb-2">
            <button data-tab="waterfall" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50 active">Waterfall</button>
            <button data-tab="le" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">LE & CE</button>
            <button data-tab="pricing" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Pricing</button>
            <button data-tab="termsheet" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Term Sheet</button>
            <button data-tab="diagnostics" class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white border border-slate-200 hover:bg-slate-50">Diagnostics</button>
        </div>

        <div id="sec-panels">
            <!-- Waterfall Panel -->
            <div id="panel-waterfall" class="sec-panel block">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 class="font-bold text-sm mb-3">Pool & Structure Inputs</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <div><label class="text-xs text-gray-500">Pool Principal (₹)</label><input id="wf-pool" type="number" value="523651962" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">A1 %</label><input id="wf-a1pct" type="number" step="0.0001" value="0.84" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">A2 %</label><input id="wf-a2pct" type="number" step="0.0001" value="0.03" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">OC %</label><input id="wf-ocpct" type="number" step="0.0001" value="0.13" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">CC %</label><input id="wf-ccpct" type="number" step="0.0001" value="0.08" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Pool WAC</label><input id="wf-wac" type="number" step="0.0001" value="0.24" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Tenor (M)</label><input id="wf-tenor" type="number" value="18" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Payout Start</label><input id="wf-start" type="date" value="2025-09-20" class="w-full border rounded p-1 text-sm"></div>
                                <div><label class="text-xs text-gray-500">Loss Rate (Est)</label><input id="wf-loss-rate" type="number" step="0.0001" value="0.05" class="w-full border rounded p-1 text-sm font-mono bg-gray-100"></div>
                            </div>
                        </div>
                        <div>
                             <div class="flex justify-between items-end mb-1">
                                <label class="font-bold text-sm">Collection Schedule</label>
                                <div class="space-x-1">
                                    <button id="wf-gen-schedule" class="px-2 py-1 bg-slate-700 text-white text-xs rounded">Auto-Gen</button>
                                    <button id="wf-clear" class="px-2 py-1 bg-red-600 text-white text-xs rounded">Clear</button>
                                </div>
                             </div>
                             <div class="border rounded h-48 overflow-auto">
                                <table class="w-full text-xs text-left">
                                    <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2">Date</th><th class="p-2">Prin</th><th class="p-2">Int</th><th class="p-2">Prepay</th></tr></thead>
                                    <tbody id="wf-body"></tbody>
                                </table>
                             </div>
                        </div>
                        <button id="wf-run" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-semibold shadow hover:bg-indigo-700">Run Waterfall Model</button>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-sm mb-2">Results Output</h3>
                        <div id="wf-out" class="text-sm space-y-2 p-3 bg-slate-50 rounded mb-4 border border-slate-200 min-h-[80px]">Results will appear here...</div>
                        <canvas id="wf-chart" class="w-full h-48"></canvas>
                        <button id="wf-export-model" class="text-xs text-indigo-600 underline mt-2">Export CSV</button>
                    </div>
                </div>
            </div>

            <!-- LE Panel -->
            <div id="panel-le" class="sec-panel hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 class="font-bold text-sm mb-3">Simulation Config</h3>
                            <div class="space-y-2">
                                <div><label class="text-xs text-gray-500">Simulations (N)</label><input id="le-n" type="number" value="5000" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">Target Rating</label><select id="le-rating" class="w-full border rounded p-1 text-sm"><option value="A" selected data-percentile="0.965">A</option></select></div>
                                <div><label class="text-xs text-gray-500">Target Percentile</label><input id="le-percentile" type="number" step="0.001" value="0.965" class="w-full border rounded p-1 text-sm font-mono"></div>
                                <div><label class="text-xs text-gray-500">EIS Buffer</label><input id="le-eis" type="number" step="0.0001" value="0.05" readonly class="w-full border rounded p-1 text-sm font-mono bg-gray-100"></div>
                            </div>
                        </div>
                        <button id="le-run" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-semibold shadow hover:bg-indigo-700">Run Monte Carlo LE</button>
                    </div>
                    <div class="col-span-2 space-y-4">
                        <div class="bg-white border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm">Portfolio Concentration</h3>
                                <button id="le-seed" class="text-xs bg-slate-200 px-2 py-1 rounded">Load Default</button>
                            </div>
                            <table class="w-full text-xs text-left">
                                <thead class="bg-slate-100"><tr><th class="p-2">Bucket Name</th><th class="p-2">Weight</th><th class="p-2">PD</th><th class="p-2">LGD</th></tr></thead>
                                <tbody id="le-body"></tbody>
                            </table>
                            <button id="le-add" class="mt-2 text-xs text-indigo-600">+ Add Bucket</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded border">
                                <h4 class="font-bold text-xs text-slate-500 uppercase">Results</h4>
                                <div id="le-out" class="text-sm mt-2 space-y-1">Run simulation...</div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded border">
                                <h4 class="font-bold text-xs text-slate-500 uppercase">Sufficiency</h4>
                                <div id="ce-out" class="text-sm mt-2 space-y-1">Waiting for results...</div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Pricing Panel -->
            <div id="panel-pricing" class="sec-panel hidden">
                <div class="bg-white p-6 rounded-lg border border-slate-200 text-center space-y-4 max-w-2xl mx-auto">
                     <h3 class="font-bold">Tranche Pricing</h3>
                     <div class="grid grid-cols-2 gap-4 text-left">
                        <div><label class="text-xs text-gray-500">A1 Base Rate</label><input id="pr-base-rate-a1" type="number" step="0.01" value="0.09" class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="text-xs text-gray-500">A2 Base Rate</label><input id="pr-base-rate-a2" type="number" step="0.01" value="0.12" class="w-full border rounded p-2 text-sm"></div>
                     </div>
                     <button id="pr-run" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Calculate Spreads</button>
                     <div id="pr-out" class="text-left bg-slate-50 p-4 rounded border mt-4"></div>
                </div>
            </div>

            <!-- Term Sheet -->
            <div id="panel-termsheet" class="sec-panel hidden">
                 <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <h3 class="font-bold text-sm">Term Sheet Parameters</h3>
                        <div><label class="text-xs">Issuer Name</label><input id="ts-issuer" value="Newton 08 2025" class="sec-input"></div>
                        <div><label class="text-xs">Originator</label><input id="ts-originator" value="Midland Microfin" class="sec-input"></div>
                        <button id="ts-generate" class="w-full py-2 bg-indigo-600 text-white rounded mt-4">Download DOCX Term Sheet</button>
                    </div>
                 </div>
            </div>

            <!-- Diagnostics -->
            <div id="panel-diagnostics" class="sec-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">CE Sufficiency Back-tester</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-ce" type="number" value="15" class="border rounded p-2" placeholder="CE %">
                            <input id="diag-hor" type="number" value="36" class="border rounded p-2" placeholder="Horizon MOB">
                            <input id="diag-tail" type="number" value="75" class="border rounded p-2" placeholder="Tail decay %">
                        </div>
                        <textarea id="diag-loss" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="mob,cum_loss% (e.g. 1,0.2)">1,0.2
3,0.4
6,0.7
9,0.9
12,1.0</textarea>
                        <div id="diag-ce-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Run to see sufficiency.</div>
                        <button id="diag-ce-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run CE Back-test</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Trigger Breach Monitor</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-oc" type="number" value="14" class="border rounded p-2" placeholder="OC %">
                            <input id="diag-cc" type="number" value="8" class="border rounded p-2" placeholder="CC %">
                            <input id="diag-dr" type="number" value="2.1" class="border rounded p-2" placeholder="DR %">
                            <input id="diag-oc-min" type="number" value="12" class="border rounded p-2" placeholder="OC Min %">
                            <input id="diag-cc-min" type="number" value="6" class="border rounded p-2" placeholder="CC Min %">
                            <input id="diag-dr-max" type="number" value="3" class="border rounded p-2" placeholder="DR Max %">
                        </div>
                        <div id="diag-trig-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Status will appear here.</div>
                        <button id="diag-trig-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Check Triggers</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Replenishment Pool QC</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <input id="diag-max-ltv" type="number" value="85" class="border rounded p-2" placeholder="Max LTV %">
                            <input id="diag-max-dpd" type="number" value="0" class="border rounded p-2" placeholder="Max DPD">
                        </div>
                        <textarea id="diag-pool" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="id,ltv,dpd">A1,72,0
A2,81,10
A3,65,0</textarea>
                        <div id="diag-qc-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">QC summary will show here.</div>
                        <button id="diag-qc-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run QC</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Delinquency Diversion Scenario</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <input id="diag-coll" type="number" value="8000000" class="border rounded p-2" placeholder="Monthly Collections">
                            <input id="diag-delinq" type="number" value="12" class="border rounded p-2" placeholder="Delinq % of coll">
                            <input id="diag-divert" type="number" value="50" class="border rounded p-2" placeholder="Divert % of delinq">
                        </div>
                        <div id="diag-div-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Diversion impact will appear here.</div>
                        <button id="diag-div-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Run Diversion</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Collateral Stratification Dashboard</div>
                        <textarea id="diag-strat" rows="4" class="w-full border rounded p-2 font-mono text-xs" placeholder="ltv,score,amt">70,750,1000000
80,720,800000
65,780,1200000
90,690,600000</textarea>
                        <div id="diag-strat-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Strat summary will appear here.</div>
                        <button id="diag-strat-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Summarize</button>
                    </div>

                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div class="font-semibold text-sm text-slate-800">Waterfall Comparator (A vs B)</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <input id="diag-a-wac" type="number" value="9.5" class="border rounded p-2" placeholder="A WAC %">
                            <input id="diag-b-wac" type="number" value="10.2" class="border rounded p-2" placeholder="B WAC %">
                            <input id="diag-a-ce" type="number" value="14" class="border rounded p-2" placeholder="A CE %">
                            <input id="diag-b-ce" type="number" value="12" class="border rounded p-2" placeholder="B CE %">
                        </div>
                        <div id="diag-comp-res" class="text-sm text-slate-700 bg-slate-50 border rounded p-2">Compare structures to see delta.</div>
                        <button id="diag-comp-run" class="px-3 py-2 bg-indigo-600 text-white text-xs rounded">Compare</button>
                    </div>
                </div>
            </div>
        </div>
    </div>`;

    // Securitisation: Tab Logic
    const tabs = c.querySelectorAll('.tab-btn');
    const panels = c.querySelectorAll('.sec-panel');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            panels.forEach(p => p.classList.add('hidden'));
            document.getElementById(`panel-${btn.dataset.tab}`).classList.remove('hidden');
        });
    });
    tabs[0].classList.add('active');

    // Securitisation: Waterfall Logic
    const generateSchedule = () => {
        const p = +document.getElementById('wf-pool').value;
        const wac = +document.getElementById('wf-wac').value;
        const tenor = +document.getElementById('wf-tenor').value;
        const start = new Date(document.getElementById('wf-start').value);
        const tbody = document.getElementById('wf-body');
        tbody.innerHTML = '';
        const prinPerMonth = p / tenor;
        let bal = p;
        for(let i=1; i<=tenor; i++) {
            const date = new Date(start);
            date.setMonth(start.getMonth() + i);
            const int = bal * (wac/12);
            const prin = Math.min(bal, prinPerMonth);
            bal -= prin;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-1"><input type="date" value="${date.toISOString().split('T')[0]}" class="w-full border text-xs"></td><td class="p-1"><input type="number" value="${prin.toFixed(0)}" class="w-full border text-xs font-mono"></td><td class="p-1"><input type="number" value="${int.toFixed(0)}" class="w-full border text-xs font-mono"></td><td class="p-1"><input type="number" value="0" class="w-full border text-xs font-mono"></td>`;
            tbody.appendChild(tr);
        }
    };

    document.getElementById('wf-gen-schedule').addEventListener('click', generateSchedule);
    document.getElementById('wf-clear').addEventListener('click', () => document.getElementById('wf-body').innerHTML = '');
    document.getElementById('wf-run').addEventListener('click', runWaterfallModel);
    document.getElementById('wf-export-model').addEventListener('click', () => {
        if(WF_RES) downloadCSV(WF_RES.map(r => Object.values(r)), 'waterfall_model.csv');
    });

    // Securitisation: LE Logic
    document.getElementById('le-seed').addEventListener('click', () => {
        const tbody = document.getElementById('le-body');
        tbody.innerHTML = '';
        [['Agri', 0.4, 0.08, 0.6], ['MSME', 0.3, 0.12, 0.7], ['Personal', 0.3, 0.15, 0.8]].forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-1"><input value="${row[0]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[1]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[2]}" class="border w-full text-xs"></td><td class="p-1"><input type="number" value="${row[3]}" class="border w-full text-xs"></td>`;
            tbody.appendChild(tr);
        });
    });
    document.getElementById('le-add').addEventListener('click', () => {
         const tr = document.createElement('tr');
         tr.innerHTML = `<td class="p-1"><input class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td><td class="p-1"><input type="number" class="border w-full text-xs"></td>`;
         document.getElementById('le-body').appendChild(tr);
    });
    document.getElementById('le-run').addEventListener('click', runLEModel);
    document.getElementById('pr-run').addEventListener('click', runPricing);
    document.getElementById('ts-generate').addEventListener('click', generateDocx);

    // Diagnostics: CE back-test
    document.getElementById('diag-ce-run').addEventListener('click', () => {
        const hor = +document.getElementById('diag-hor').value;
        const tail = +document.getElementById('diag-tail').value / 100;
        const ce = +document.getElementById('diag-ce').value;
        const lines = document.getElementById('diag-loss').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        let pts = lines.map(l=>{ const p=l.split(','); return { mob:+p[0], loss:+p[1] }; }).filter(p=>p.mob>0 && p.loss>=0).sort((a,b)=>a.mob-b.mob);
        if(!pts.length) { document.getElementById('diag-ce-res').innerText = 'No data.'; return; }
        const data=[];
        for(let i=0;i<pts.length-1;i++){ const a=pts[i],b=pts[i+1]; data.push(a); const gap=b.mob-a.mob; if(gap>1){ const step=(b.loss-a.loss)/gap; for(let g=1; g<gap; g++) data.push({mob:a.mob+g, loss:a.loss+step*g}); }}
        data.push(pts[pts.length-1]);
        let lastDelta = data.length>1 ? data[data.length-1].loss - data[data.length-2].loss : 0;
        let lastLoss = data[data.length-1].loss;
        for(let m=data[data.length-1].mob+1; m<=hor; m++){ lastDelta*=tail; lastLoss+=lastDelta; data.push({mob:m, loss:lastLoss}); }
        const finalLoss = data[data.length-1].loss;
        const suff = ce - finalLoss;
        document.getElementById('diag-ce-res').innerHTML = `Lifetime loss ~ <b>${finalLoss.toFixed(2)}%</b>. CE ${ce.toFixed(1)}% → ${suff>=0?'<span class="text-green-700">Sufficient</span>':'<span class="text-red-600">Shortfall</span>'} (${suff.toFixed(2)}%)`;
    });

    // Diagnostics: Triggers
    document.getElementById('diag-trig-run').addEventListener('click', () => {
        const oc=+document.getElementById('diag-oc').value, cc=+document.getElementById('diag-cc').value, dr=+document.getElementById('diag-dr').value;
        const ocMin=+document.getElementById('diag-oc-min').value, ccMin=+document.getElementById('diag-cc-min').value, drMax=+document.getElementById('diag-dr-max').value;
        const breaches=[];
        if(oc < ocMin) breaches.push(`OC ${oc}% < ${ocMin}%`);
        if(cc < ccMin) breaches.push(`CC ${cc}% < ${ccMin}%`);
        if(dr > drMax) breaches.push(`DR ${dr}% > ${drMax}%`);
        document.getElementById('diag-trig-res').innerHTML = breaches.length ? `<span class="text-red-600 font-semibold">Breach:</span> ${breaches.join('; ')}` : `<span class="text-green-700 font-semibold">All triggers OK</span>`;
    });

    // Diagnostics: Replenishment QC
    document.getElementById('diag-qc-run').addEventListener('click', () => {
        const maxLtv = +document.getElementById('diag-max-ltv').value;
        const maxDpd = +document.getElementById('diag-max-dpd').value;
        const lines = document.getElementById('diag-pool').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        const fails=[]; let total=0;
        lines.forEach(l=>{
            const p=l.split(','); if(p.length<3) return;
            const id=p[0], ltv=+p[1], dpd=+p[2]; total++;
            if(ltv>maxLtv || dpd>maxDpd) fails.push(`${id} (LTV ${ltv} / DPD ${dpd})`);
        });
        document.getElementById('diag-qc-res').innerHTML = fails.length ? `<span class="text-red-600 font-semibold">${fails.length} fails</span> / ${total}: ${fails.join(', ')}` : `<span class="text-green-700 font-semibold">All ${total} loans pass</span>`;
    });

    // Diagnostics: Delinquency Diversion
    document.getElementById('diag-div-run').addEventListener('click', () => {
        const coll=+document.getElementById('diag-coll').value;
        const del=+document.getElementById('diag-delinq').value/100;
        const div=+document.getElementById('diag-divert').value/100;
        const delAmt = coll * del;
        const diverted = delAmt * div;
        const toSenior = coll - diverted;
        document.getElementById('diag-div-res').innerHTML = `Delinq ${moneyFmt.format(delAmt)} → Diverted ${moneyFmt.format(diverted)}. Residual to waterfall ${moneyFmt.format(toSenior)}.`;
    });

    // Diagnostics: Stratification
    document.getElementById('diag-strat-run').addEventListener('click', () => {
        const lines = document.getElementById('diag-strat').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
        let totAmt=0, ltvSum=0, scoreSum=0, n=0;
        lines.forEach(l=>{
            const p=l.split(','); if(p.length<3) return;
            const ltv=+p[0], score=+p[1], amt=+p[2]; if(!amt) return;
            totAmt += amt; ltvSum += ltv*amt; scoreSum += score*amt; n++;
        });
        const wtdLtv = totAmt? ltvSum/totAmt : 0;
        const wtdScore = totAmt? scoreSum/totAmt : 0;
        document.getElementById('diag-strat-res').innerHTML = `Pools: ${n} | AUM ${moneyFmt.format(totAmt)} | Wtd LTV ${wtdLtv.toFixed(1)}% | Wtd Score ${wtdScore.toFixed(0)}`;
    });

    // Diagnostics: Waterfall Comparator
    document.getElementById('diag-comp-run').addEventListener('click', () => {
        const aw = +document.getElementById('diag-a-wac').value;
        const bw = +document.getElementById('diag-b-wac').value;
        const ac = +document.getElementById('diag-a-ce').value;
        const bc = +document.getElementById('diag-b-ce').value;
        const wacDelta = bw - aw;
        const ceDelta = bc - ac;
        document.getElementById('diag-comp-res').innerHTML = `WAC Δ ${wacDelta.toFixed(2)}% | CE Δ ${ceDelta.toFixed(2)}% → ${wacDelta<=0 && ceDelta<=0 ? '<span class="text-green-700">Structure B cheaper/riskier trade-off</span>' : 'Assess yield vs protection'}`;
    });
    
    generateSchedule(); 
    document.getElementById('le-seed').click();
}

function runWaterfallModel() {
    const rows = Array.from(document.querySelectorAll('#wf-body tr')).map(tr => {
        const inps = tr.querySelectorAll('input');
        return { date: inps[0].value, prin: +inps[1].value, int: +inps[2].value, prepay: +inps[3].value };
    });
    if(rows.length === 0) return alert("Please generate schedule first.");

    const pool_prin = +document.getElementById('wf-pool').value;
    let a1_bal = pool_prin * +document.getElementById('wf-a1pct').value;
    let result = [];
    let total_eis = 0;

    rows.forEach(r => {
        let avail = r.prin + r.int + r.prepay - 5000;
        let a1_int = a1_bal * (0.09 / 12);
        let pay_a1_int = Math.min(avail, a1_int);
        avail -= pay_a1_int;
        let pay_a1_prin = Math.min(avail, a1_bal);
        avail -= pay_a1_prin;
        a1_bal -= pay_a1_prin;
        total_eis += avail;

        result.push({ date: r.date, coll: r.prin + r.int, a1_pay: pay_a1_int + pay_a1_prin, a1_bal: a1_bal, eis: avail });
    });

    WF_RES = result;
    document.getElementById('wf-out').innerHTML = `<div><b>Total Collections:</b> ${moneyFmt.format(rows.reduce((a,b)=>a+b.prin+b.int,0))}</div><div><b>A1 Principal Paid:</b> ${pct(1 - a1_bal/(pool_prin * +document.getElementById('wf-a1pct').value))}</div><div><b>Total EIS Generated:</b> ${moneyFmt.format(total_eis)}</div>`;
    document.getElementById('le-eis').value = (total_eis / pool_prin).toFixed(4);
    
    const ctx = document.getElementById('wf-chart').getContext('2d');
    if(window.wfChart) window.wfChart.destroy();
    window.wfChart = new Chart(ctx, { type: 'line', data: { labels: result.map(r => r.date), datasets: [ { label: 'Collections', data: result.map(r => r.coll), borderColor: 'blue', fill: false }, { label: 'A1 Payment', data: result.map(r => r.a1_pay), borderColor: 'green', fill: false } ] }, options: { responsive: true, maintainAspectRatio: false } });
}

function runLEModel() {
    const n = +document.getElementById('le-n').value;
    const buckets = Array.from(document.querySelectorAll('#le-body tr')).map(tr => {
        const i = tr.querySelectorAll('input');
        return { w: +i[1].value, pd: +i[2].value, lgd: +i[3].value };
    });
    const rho = 0.15;
    let losses = [];
    for(let i=0; i<n; i++) {
        const sys = jStat.normal.sample(0, 1);
        let l = 0;
        buckets.forEach(b => {
            const thresh = jStat.normal.inv(b.pd, 0, 1);
            const condPD = jStat.normal.cdf((thresh - Math.sqrt(rho)*sys) / Math.sqrt(1-rho), 0, 1);
            l += b.w * condPD * b.lgd;
        });
        losses.push(l);
    }
    losses.sort((a,b)=>a-b);
    const pctl = +document.getElementById('le-percentile').value;
    const lossAtPctl = losses[Math.floor(n * pctl)];
    const eis = +document.getElementById('le-eis').value;
    const ceReq = Math.max(0, lossAtPctl - eis);
    const ceAvail = +document.getElementById('wf-ocpct').value + +document.getElementById('wf-ccpct').value;
    LE_VEC = losses;
    document.getElementById('le-out').innerHTML = `<div><b>Mean Loss:</b> ${pct(losses.reduce((a,b)=>a+b,0)/n)}</div><div><b>Loss @ ${(pctl*100).toFixed(1)}%:</b> <span class="font-bold text-red-600">${pct(lossAtPctl)}</span></div>`;
    const isSafe = ceAvail >= ceReq;
    document.getElementById('ce-out').innerHTML = `<div>Available Hard CE: ${pct(ceAvail)}</div><div>Less: Req after EIS: ${pct(ceReq)}</div><div class="mt-2 font-bold ${isSafe ? 'text-green-600' : 'text-red-600'}">${isSafe ? 'SUFFICIENT' : 'SHORTFALL'}</div>`;
}

function runPricing() {
    if(!LE_VEC) return alert("Run LE Model first");
    const baseA1 = +document.getElementById('pr-base-rate-a1').value;
    const creditSupportA1 = +document.getElementById('wf-a2pct').value + +document.getElementById('wf-ocpct').value + +document.getElementById('wf-ccpct').value + +document.getElementById('le-eis').value;
    let a1LossSum = 0;
    LE_VEC.forEach(l => { a1LossSum += Math.max(0, l - creditSupportA1); });
    const expLossA1 = a1LossSum / LE_VEC.length;
    document.getElementById('pr-out').innerHTML = `<div class="grid grid-cols-2 gap-2"><div>A1 Expected Loss:</div><div class="font-mono">${(expLossA1*10000).toFixed(1)} bps</div><div>A1 Fair Yield:</div><div class="font-bold text-indigo-700">${pct(baseA1 + expLossA1)}</div></div>`;
}

async function generateDocx() {
    if(!window.docx) return alert("DOCX lib not loaded");
    const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
    const issuer = document.getElementById('ts-issuer').value;
    const doc = new Document({ sections: [{ children: [ new Paragraph({ text: `Term Sheet: ${issuer}`, heading: HeadingLevel.HEADING_1 }), new Paragraph({ text: `Generated via NBFC Quant Toolbox`, spacing: { after: 200 } }), new Paragraph({ text: `Principal: ${moneyFmt.format(document.getElementById('wf-pool').value)}` }), new Paragraph({ text: `Structure: A1 (${document.getElementById('wf-a1pct').value*100}%) / A2 (${document.getElementById('wf-a2pct').value*100}%)` }) ] }] });
    const blob = await Packer.toBlob(doc);
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${issuer}_TermSheet.docx`;
    link.click();
}

/* ==========================================================================
   2. NEW RETAIL/LENDING TOOLS
   ========================================================================== */

function renderRetailEligibility() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Net Income</label><input id="ret-inc" type="number" value="50000" class="border rounded p-1">
            <label>Existing EMI</label><input id="ret-obl" type="number" value="5000" class="border rounded p-1">
            <label>FOIR %</label><input id="ret-foir" type="number" value="50" class="border rounded p-1">
            <label>ROI %</label><input id="ret-roi" type="number" value="12" class="border rounded p-1">
            <label>Tenure (M)</label><input id="ret-ten" type="number" value="60" class="border rounded p-1">
        </div>
        <button id="ret-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Calculate</button>
        <div id="ret-res" class="hidden text-center pt-4 border-t"><div class="text-xs text-gray-500">Max Loan Eligibility</div><div class="text-2xl font-bold text-green-600" id="ret-val"></div></div>
    </div>`;
    document.getElementById('ret-calc').onclick = () => {
        const inc=+document.getElementById('ret-inc').value, obl=+document.getElementById('ret-obl').value, foir=+document.getElementById('ret-foir').value/100;
        const r=+document.getElementById('ret-roi').value/1200, n=+document.getElementById('ret-ten').value;
        const maxEmi = Math.max(0, inc*foir - obl);
        const loan = maxEmi * (1 - Math.pow(1+r, -n)) / r;
        document.getElementById('ret-val').innerText = moneyFmt.format(loan);
        document.getElementById('ret-res').classList.remove('hidden');
    };
}

function renderLAPCalculator() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Property Value</label><input id="lap-prop" type="number" value="10000000" class="border rounded p-1">
            <label>Max LTV %</label><input id="lap-ltv" type="number" value="60" class="border rounded p-1">
            <label>Net Income</label><input id="lap-inc" type="number" value="100000" class="border rounded p-1">
            <label>FOIR %</label><input id="lap-foir" type="number" value="60" class="border rounded p-1">
            <label>ROI %</label><input id="lap-roi" type="number" value="10" class="border rounded p-1">
            <label>Tenure (Y)</label><input id="lap-ten" type="number" value="15" class="border rounded p-1">
        </div>
        <button id="lap-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Check</button>
        <div id="lap-res" class="hidden space-y-2 pt-4 border-t text-sm">
            <div class="flex justify-between"><span>LTV Limit:</span><span id="lap-res-ltv" class="font-bold"></span></div>
            <div class="flex justify-between"><span>Income Limit:</span><span id="lap-res-inc" class="font-bold"></span></div>
            <div class="flex justify-between bg-green-50 p-2 rounded text-green-800 font-bold"><span>Final Eligibility:</span><span id="lap-res-fin"></span></div>
        </div>
    </div>`;
    document.getElementById('lap-calc').onclick = () => {
        const prop=+document.getElementById('lap-prop').value, ltv=+document.getElementById('lap-ltv').value/100;
        const inc=+document.getElementById('lap-inc').value, foir=+document.getElementById('lap-foir').value/100;
        const r=+document.getElementById('lap-roi').value/1200, n=+document.getElementById('lap-ten').value*12;
        
        const ltvLim = prop * ltv;
        const emiCap = inc * foir;
        const incLim = emiCap * (1 - Math.pow(1+r, -n)) / r;
        
        document.getElementById('lap-res-ltv').innerText = moneyFmt.format(ltvLim);
        document.getElementById('lap-res-inc').innerText = moneyFmt.format(incLim);
        document.getElementById('lap-res-fin').innerText = moneyFmt.format(Math.min(ltvLim, incLim));
        document.getElementById('lap-res').classList.remove('hidden');
    };
}

function renderEducationLoan() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4 bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Loan Amt</label><input id="edu-amt" type="number" value="2000000" class="border rounded p-1">
            <label>Moratorium (M)</label><input id="edu-mor" type="number" value="24" class="border rounded p-1">
            <label>ROI %</label><input id="edu-roi" type="number" value="11" class="border rounded p-1">
            <label>Repay Tenure (M)</label><input id="edu-ten" type="number" value="84" class="border rounded p-1">
            <div class="col-span-2"><label class="inline-flex items-center"><input id="edu-cap" type="checkbox" checked> Capitalize Interest?</label></div>
        </div>
        <button id="edu-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Structurer</button>
        <div id="edu-res" class="hidden pt-4 border-t text-sm space-y-2">
             <div>Accrued Int: <span id="edu-acc" class="font-bold"></span></div>
             <div>Final Principal: <span id="edu-fin" class="font-bold"></span></div>
             <div>EMI: <span id="edu-emi" class="font-bold text-green-600 text-lg"></span></div>
        </div>
    </div>`;
    document.getElementById('edu-calc').onclick = () => {
        const p=+document.getElementById('edu-amt').value, mor=+document.getElementById('edu-mor').value;
        const r=+document.getElementById('edu-roi').value/1200, n=+document.getElementById('edu-ten').value;
        const cap = document.getElementById('edu-cap').checked;
        
        const intAcc = p * r * mor;
        const finalP = cap ? p + intAcc : p;
        const emi = finalP * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
        
        document.getElementById('edu-acc').innerText = moneyFmt.format(intAcc);
        document.getElementById('edu-fin').innerText = moneyFmt.format(finalP);
        document.getElementById('edu-emi').innerText = moneyFmt.format(emi);
        document.getElementById('edu-res').classList.remove('hidden');
    };
}

function renderSCFDiscounting() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl border space-y-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <label>Invoice Value</label><input id="scf-val" type="number" value="500000" class="border rounded p-1">
            <label>Tenor (Days)</label><input id="scf-days" type="number" value="90" class="border rounded p-1">
            <label>Rate % p.a.</label><input id="scf-rate" type="number" value="14" class="border rounded p-1">
            <label>Fee %</label><input id="scf-fee" type="number" value="0.5" class="border rounded p-1">
        </div>
        <button id="scf-calc" class="w-full bg-indigo-600 text-white py-2 rounded">Calculate</button>
        <div id="scf-res" class="hidden pt-4 border-t space-y-2 text-sm">
            <div class="flex justify-between"><span>Interest:</span><span id="scf-int" class="text-red-600"></span></div>
            <div class="flex justify-between"><span>Fee:</span><span id="scf-fee-amt" class="text-red-600"></span></div>
            <div class="flex justify-between font-bold text-lg"><span>Net Disb:</span><span id="scf-net" class="text-green-600"></span></div>
            <div class="text-center text-xs text-gray-500 mt-2">Effective Yield: <span id="scf-yld"></span></div>
        </div>
    </div>`;
    document.getElementById('scf-calc').onclick = () => {
        const val=+document.getElementById('scf-val').value, d=+document.getElementById('scf-days').value;
        const r=+document.getElementById('scf-rate').value/100, f=+document.getElementById('scf-fee').value/100;
        const int = val * r * (d/365);
        const fee = val * f;
        const net = val - int - fee;
        const yieldVal = ((int+fee)/net) * (365/d);
        document.getElementById('scf-int').innerText = moneyFmt.format(int);
        document.getElementById('scf-fee-amt').innerText = moneyFmt.format(fee);
        document.getElementById('scf-net').innerText = moneyFmt.format(net);
        document.getElementById('scf-yld').innerText = pct(yieldVal);
        document.getElementById('scf-res').classList.remove('hidden');
    };
}

function renderWholesaleRatios() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl border">
        <div class="grid grid-cols-3 gap-3 text-xs mb-4">
            <div><label>EBITDA</label><input id="ws-ebitda" type="number" value="50" class="w-full border rounded p-1"></div>
            <div><label>Debt Service</label><input id="ws-ds" type="number" value="35" class="w-full border rounded p-1"></div>
            <div><label>Total Debt</label><input id="ws-debt" type="number" value="200" class="w-full border rounded p-1"></div>
            <div><label>Net Worth</label><input id="ws-nw" type="number" value="80" class="w-full border rounded p-1"></div>
            <div><label>Curr Assets</label><input id="ws-ca" type="number" value="100" class="w-full border rounded p-1"></div>
            <div><label>Curr Liab</label><input id="ws-cl" type="number" value="80" class="w-full border rounded p-1"></div>
        </div>
        <button id="ws-calc" class="w-full bg-gray-800 text-white py-2 rounded mb-4">Analyze</button>
        <div id="ws-res" class="grid grid-cols-3 gap-4 text-center"></div>
    </div>`;
    document.getElementById('ws-calc').onclick = () => {
        const d = { e: +document.getElementById('ws-ebitda').value, ds: +document.getElementById('ws-ds').value, dt: +document.getElementById('ws-debt').value, nw: +document.getElementById('ws-nw').value, ca: +document.getElementById('ws-ca').value, cl: +document.getElementById('ws-cl').value };
        const res = document.getElementById('ws-res');
        res.innerHTML = `
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">DSCR</div><div class="font-bold text-lg ${(d.e/d.ds)>1.2?'text-green-600':'text-red-600'}">${(d.e/d.ds).toFixed(2)}x</div></div>
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">Debt/Equity</div><div class="font-bold text-lg ${(d.dt/d.nw)<3?'text-green-600':'text-red-600'}">${(d.dt/d.nw).toFixed(2)}x</div></div>
            <div class="p-2 border rounded bg-slate-50"><div class="text-xs text-gray-500">Current Ratio</div><div class="font-bold text-lg ${(d.ca/d.cl)>1.1?'text-green-600':'text-red-600'}">${(d.ca/d.cl).toFixed(2)}x</div></div>
        `;
    };
}

/* ==========================================================================
   RETAIL LENDING APPS
   ========================================================================== */
function renderHomeLoanEligibility() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="hle-inc" type="number" value="120000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Existing EMIs</label><input id="hle-emi" type="number" value="20000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="hle-foir" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Property Value</label><input id="hle-prop" type="number" value="7500000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Stamp Duty %</label><input id="hle-stamp" type="number" value="7" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Insurance %</label><input id="hle-ins" type="number" value="1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV % Cap</label><input id="hle-ltv" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate % (Annual)</label><input id="hle-rate" type="number" value="8.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="hle-tenor" type="number" value="240" class="w-full border rounded p-2"></div>
      </div>
      <button id="hle-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Eligibility</button>
      <div id="hle-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-sm"></div>
    </div>
  `;
  document.getElementById('hle-run').onclick = () => {
    const inc = +document.getElementById('hle-inc').value;
    const foir = +document.getElementById('hle-foir').value / 100;
    const existEmi = +document.getElementById('hle-emi').value;
    const prop = +document.getElementById('hle-prop').value;
    const stamp = +document.getElementById('hle-stamp').value / 100;
    const ins = +document.getElementById('hle-ins').value / 100;
    const ltv = +document.getElementById('hle-ltv').value / 100;
    const rate = +document.getElementById('hle-rate').value;
    const ten = +document.getElementById('hle-tenor').value;

    const onRoad = prop * (1 + stamp + ins);
    const emiCap = Math.max(0, inc * foir - existEmi);
    const loanByFoir = loanFromEmi(emiCap, rate, ten);
    const loanByLtv = prop * ltv;
    const elig = Math.max(0, Math.min(loanByFoir, loanByLtv));
    const emiElig = calcEmi(elig, rate, ten);
    const down = Math.max(0, onRoad - elig);

    document.getElementById('hle-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">EMI Cap (FOIR)</div><div class="font-bold text-lg">${moneyFmt.format(emiCap)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Eligible Loan</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(elig)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emiElig)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">LTV Limit</div><div class="font-bold text-lg">${moneyFmt.format(loanByLtv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Required Down Payment</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(down)}</div><div class="text-xs text-slate-500">On-road ${moneyFmt.format(onRoad)}</div></div>
    `;
  };
}

function renderAutoLoanStructurer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Ex-Showroom</label><input id="auto-ex" type="number" value="800000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Road Tax %</label><input id="auto-tax" type="number" value="10" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Insurance</label><input id="auto-ins" type="number" value="32000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Accessories</label><input id="auto-acc" type="number" value="15000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other Charges</label><input id="auto-oth" type="number" value="5000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Customer Margin %</label><input id="auto-margin" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="auto-inc" type="number" value="70000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Existing EMIs</label><input id="auto-emi" type="number" value="8000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="auto-foir" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate %</label><input id="auto-rate" type="number" value="11" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="auto-tenor" type="number" value="60" class="w-full border rounded p-2"></div>
      </div>
      <button id="auto-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Structure</button>
      <div id="auto-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('auto-run').onclick = () => {
    const ex = +document.getElementById('auto-ex').value;
    const tax = +document.getElementById('auto-tax').value / 100;
    const ins = +document.getElementById('auto-ins').value;
    const acc = +document.getElementById('auto-acc').value;
    const oth = +document.getElementById('auto-oth').value;
    const margin = +document.getElementById('auto-margin').value / 100;
    const inc = +document.getElementById('auto-inc').value;
    const existEmi = +document.getElementById('auto-emi').value;
    const foir = +document.getElementById('auto-foir').value / 100;
    const rate = +document.getElementById('auto-rate').value;
    const ten = +document.getElementById('auto-tenor').value;

    const onRoad = ex * (1 + tax) + ins + acc + oth;
    const customerContribution = onRoad * margin;
    const loanNeed = Math.max(0, onRoad - customerContribution);
    const emiCap = Math.max(0, inc * foir - existEmi);
    const loanByFoir = loanFromEmi(emiCap, rate, ten);
    const sanctioned = Math.min(loanNeed, loanByFoir);
    const emiSanctioned = calcEmi(sanctioned, rate, ten);
    const extraDown = Math.max(0, onRoad - sanctioned);

    document.getElementById('auto-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">On-road Price</div><div class="font-bold text-lg">${moneyFmt.format(onRoad)}</div><div class="text-xs text-slate-500">Margin ${moneyFmt.format(customerContribution)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Loan Needed</div><div class="font-bold text-lg">${moneyFmt.format(loanNeed)}</div><div class="text-xs text-slate-500">FOIR Caps at ${moneyFmt.format(loanByFoir)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Sanctioned (FOIR bound)</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(sanctioned)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emiSanctioned)}</div><div class="text-xs text-amber-700">${extraDown>0 ? 'Additional down '+moneyFmt.format(extraDown) : 'FOIR OK'}</div></div>
    `;
  };
}

function renderGoldLoanLtv() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Karat</label><input id="gold-karat" type="number" value="22" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Grams</label><input id="gold-grams" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Price / Gram</label><input id="gold-ppg" type="number" value="6000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV % Cap</label><input id="gold-ltv" type="number" value="75" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Auction Buffer %</label><input id="gold-buf" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Safety Margin %</label><input id="gold-safety" type="number" value="2" class="w-full border rounded p-2"></div>
      </div>
      <button id="gold-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute</button>
      <div id="gold-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('gold-run').onclick = () => {
    const karat = +document.getElementById('gold-karat').value;
    const grams = +document.getElementById('gold-grams').value;
    const ppg = +document.getElementById('gold-ppg').value;
    const ltv = +document.getElementById('gold-ltv').value / 100;
    const buf = +document.getElementById('gold-buf').value / 100;
    const safety = +document.getElementById('gold-safety').value / 100;

    const purity = Math.min(1, karat / 24);
    const baseValue = grams * ppg * purity;
    const disbursable = baseValue * ltv * (1 - buf - safety);
    const actualLtv = baseValue ? (disbursable / baseValue) * 100 : 0;

    document.getElementById('gold-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Assessed Value</div><div class="font-bold text-lg">${moneyFmt.format(baseValue)}</div><div class="text-xs text-slate-500">Purity ${(purity*100).toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Disbursable</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(disbursable)}</div><div class="text-xs text-slate-500">Actual LTV ${actualLtv.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Buffer Applied</div><div class="font-bold text-lg text-amber-700">${((buf+safety)*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Headroom ${moneyFmt.format(baseValue - disbursable)}</div></div>
    `;
  };
}

function renderPlTopUp() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Outstanding Loan</label><input id="pl-os" type="number" value="350000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Foreclosure %</label><input id="pl-fc" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Processing Fee %</label><input id="pl-pf" type="number" value="1.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Rate %</label><input id="pl-rate" type="number" value="14" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="pl-ten" type="number" value="48" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Income</label><input id="pl-inc" type="number" value="90000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other EMIs</label><input id="pl-emi" type="number" value="12000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">FOIR %</label><input id="pl-foir" type="number" value="45" class="w-full border rounded p-2"></div>
      </div>
      <button id="pl-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Top-Up</button>
      <div id="pl-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('pl-run').onclick = () => {
    const os = +document.getElementById('pl-os').value;
    const fc = +document.getElementById('pl-fc').value / 100;
    const pf = +document.getElementById('pl-pf').value / 100;
    const rate = +document.getElementById('pl-rate').value;
    const ten = +document.getElementById('pl-ten').value;
    const inc = +document.getElementById('pl-inc').value;
    const otherEmi = +document.getElementById('pl-emi').value;
    const foir = +document.getElementById('pl-foir').value / 100;

    const emiCap = Math.max(0, inc * foir - otherEmi);
    const maxLoan = loanFromEmi(emiCap, rate, ten);
    const foreclosure = os * fc;
    const proc = maxLoan * pf;
    const netTopUp = maxLoan - os - foreclosure - proc;
    const newEmi = calcEmi(maxLoan, rate, ten);

    document.getElementById('pl-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Loan (FOIR)</div><div class="font-bold text-lg">${moneyFmt.format(maxLoan)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(newEmi)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Payout / Charges</div><div class="font-bold text-lg text-amber-700">FC ${moneyFmt.format(foreclosure)} | PF ${moneyFmt.format(proc)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Top-Up</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(netTopUp)}</div><div class="text-xs text-slate-500">${netTopUp<0?'Insufficient eligibility':'After closing old loan'}</div></div>
    `;
  };
}

function renderBtSavings() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Outstanding</label><input id="bt-os" type="number" value="800000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Current Rate %</label><input id="bt-crate" type="number" value="17" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Remaining Tenor (M)</label><input id="bt-cten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Rate %</label><input id="bt-prate" type="number" value="12" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Proposed Tenor (M)</label><input id="bt-pten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Processing Fee</label><input id="bt-pf" type="number" value="5000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Other Fees</label><input id="bt-oth" type="number" value="2500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Prepay Penalty %</label><input id="bt-pen" type="number" value="2" class="w-full border rounded p-2"></div>
      </div>
      <button id="bt-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Estimate Savings</button>
      <div id="bt-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
    </div>
  `;
  document.getElementById('bt-run').onclick = () => {
    const os = +document.getElementById('bt-os').value;
    const cr = +document.getElementById('bt-crate').value;
    const ct = +document.getElementById('bt-cten').value;
    const pr = +document.getElementById('bt-prate').value;
    const pt = +document.getElementById('bt-pten').value;
    const pf = +document.getElementById('bt-pf').value;
    const oth = +document.getElementById('bt-oth').value;
    const pen = +document.getElementById('bt-pen').value / 100;

    const curEmi = calcEmi(os, cr, ct);
    const curInt = curEmi * ct - os;
    const newEmi = calcEmi(os, pr, pt);
    const newInt = newEmi * pt - os;
    const totalFees = pf + oth + os * pen;
    const netSavings = curInt - (newInt + totalFees);
    const monthlySave = curEmi - newEmi;
    const payback = (monthlySave > 0 && totalFees > 0) ? (totalFees / monthlySave) : null;

    document.getElementById('bt-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Current EMI</div><div class="font-bold text-lg">${moneyFmt.format(curEmi)}</div><div class="text-xs text-slate-500">Interest ${moneyFmt.format(curInt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Proposed EMI</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(newEmi)}</div><div class="text-xs text-slate-500">Interest ${moneyFmt.format(newInt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">One-time Fees</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(totalFees)}</div><div class="text-xs text-slate-500">Penalty + PF + Other</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Savings</div><div class="font-bold text-lg ${netSavings>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(netSavings)}</div><div class="text-xs text-slate-500">${payback?`Payback ~${payback.toFixed(1)} months`:'-'}</div></div>
    `;
  };
}

function renderMfiGroupSplitter() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Ticket Multiplier (x monthly income)</label><input id="mfi-mult" type="number" value="6" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Repeat Uplift %</label><input id="mfi-uplift" type="number" value="10" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cap per Member</label><input id="mfi-cap" type="number" value="80000" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Members (name,income,status)</label>
        <textarea id="mfi-rows" class="w-full border rounded p-3 font-mono text-xs" rows="6">Asha,12000,repeat
Meena,10000,new
Kiran,9000,new
Sunita,11000,repeat
Radha,9500,new</textarea>
      </div>
      <button id="mfi-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Allocate</button>
      <div id="mfi-res" class="space-y-3"></div>
    </div>
  `;
  document.getElementById('mfi-run').onclick = () => {
    const mult = +document.getElementById('mfi-mult').value;
    const uplift = +document.getElementById('mfi-uplift').value / 100;
    const cap = +document.getElementById('mfi-cap').value;
    const lines = document.getElementById('mfi-rows').value.split(/\n+/).map(l => l.trim()).filter(Boolean);
    const members = lines.map(l => {
      const parts = l.split(',').map(p => p.trim());
      return { name: parts[0] || 'Member', income: +parts[1] || 0, status: (parts[2] || 'new').toLowerCase() };
    }).filter(m => m.income > 0);
    if (!members.length) {
      document.getElementById('mfi-res').innerHTML = `<div class="text-red-600 text-sm">No valid members found.</div>`;
      return;
    }
    const totalIncome = members.reduce((s,m)=>s+m.income,0);
    const groupLimit = totalIncome * mult;
    let totalWeight = 0;
    members.forEach(m => {
      const w = m.income * (m.status==='repeat' ? (1+uplift) : 1);
      m.weight = w;
      totalWeight += w;
    });
    members.forEach(m => {
      const alloc = groupLimit * (m.weight / totalWeight);
      m.allocation = Math.min(cap, alloc);
    });
    const netGroup = members.reduce((s,m)=>s+m.allocation,0);
    const rows = members.map(m => `<tr><td class="p-2 border">${m.name}</td><td class="p-2 border text-right">${moneyFmt.format(m.income)}</td><td class="p-2 border text-center">${m.status}</td><td class="p-2 border text-right font-semibold">${moneyFmt.format(m.allocation)}</td></tr>`).join('');
    document.getElementById('mfi-res').innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Group Income</div><div class="font-bold text-lg">${moneyFmt.format(totalIncome)}</div></div>
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Group Ticket (x${mult})</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(groupLimit)}</div></div>
        <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Allocated (after caps)</div><div class="font-bold text-lg text-green-700">${moneyFmt.format(netGroup)}</div></div>
      </div>
      <div class="overflow-auto max-h-64 border rounded">
        <table class="w-full text-xs">
          <thead class="bg-slate-100"><tr><th class="p-2 border text-left">Member</th><th class="p-2 border text-right">Income</th><th class="p-2 border text-center">Status</th><th class="p-2 border text-right">Allocation</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  };
}

/* ==========================================================================
   3. RESTORED LEGACY TOOLS
   ========================================================================== */

// XIRR
function renderXirr() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `<div class="space-y-3"><input id="xirr-file" type="file" accept=".csv" class="file-input"><div id="xirr-res" class="bg-green-50 p-4 border rounded text-green-800 font-bold hidden">Portfolio XIRR: <span id="xirr-val"></span></div></div>`;
  document.getElementById('xirr-file').addEventListener('change', e => {
    Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: res => {
        const rows = [];
        res.data.forEach(r => {
           const amt = Number(r.amount), dt = formatDateFlexible(r.date);
           if(r.account_id && dt && isFinite(amt)) rows.push({ account: r.account_id, date: dt, amount: amt });
        });
        const portXirr = xnpv(rows);
        document.getElementById('xirr-val').textContent = pct(portXirr);
        document.getElementById('xirr-res').classList.remove('hidden');
    }});
  });
}
function xnpv(cfs) {
  if (!cfs.length) return 0;
  const sorted = cfs.slice().sort((a, b) => a.date - b.date);
  const t0 = sorted[0].date.getTime();
  const calc = (r) => sorted.reduce((acc, cf) => acc + cf.amount / Math.pow(1+r, (cf.date-t0)/(365*24*3600*1000)), 0);
  let r = 0.1; for(let i=0; i<50; i++) { let v = calc(r); if(Math.abs(v)<1) break; r += v > 0 ? 0.01 : -0.01; }
  return r;
}

// HPR
function renderHpr() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `<div class="space-y-3"><input id="hpr-file" type="file" accept=".csv" class="file-input"><div id="hpr-res" class="hidden text-sm"></div></div>`;
  document.getElementById('hpr-file').addEventListener('change', e => {
    Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: res => {
        let avg = 0;
        res.data.forEach(r => {
           const pd = formatDateFlexible(r.purchase_date), sd = formatDateFlexible(r.sale_date);
           const pv = +r.purchase_value, sv = +r.sale_value;
           if (pd && sd && pv) {
               const days = Math.max(1, (sd - pd)/(1000*60*60*24));
               const hpr = (sv - pv)/pv;
               avg += (Math.pow(1+hpr, 365/days)-1);
           }
        });
        document.getElementById('hpr-res').innerText = `Avg Annualised Return: ${pct(avg/res.data.length)}`;
        document.getElementById('hpr-res').classList.remove('hidden');
    }});
  });
}

// Geo Performance
function renderGeo() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><input id="geo-file" type="file" accept=".csv" class="file-input"><div id="geo-chart" style="height:300px;"></div></div>`;
    document.getElementById('geo-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            const map = new Map();
            res.data.forEach(r => {
                const s = r.state||r.region; const aum = +r.aum;
                if(s) { if(!map.has(s)) map.set(s,0); map.set(s, map.get(s)+aum); }
            });
            const x = Array.from(map.keys()), y = Array.from(map.values());
            Plotly.newPlot('geo-chart', [{x, y, type:'bar', marker:{color:'#6366f1'}}], {title:'State-wise AUM', margin:{t:30}});
        }});
    });
}

// ALM
function renderAlm() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="grid grid-cols-2 gap-2 text-xs"><label>Shock (bps)</label><input id="alm-shock" type="number" value="200" class="border rounded p-1"></div><input id="alm-file" type="file" accept=".csv" class="file-input"><div id="alm-res" class="font-mono text-sm"></div></div>`;
    document.getElementById('alm-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            let pv=0, pvShock=0;
            const shock = +document.getElementById('alm-shock').value/10000;
            res.data.forEach(r => {
                const t = +r.bucket_months/12, cf = +r.cashflow, y = +r.yield_pct/100;
                if(t && cf) {
                    pv += cf/Math.pow(1+y, t);
                    pvShock += cf/Math.pow(1+y+shock, t);
                }
            });
            document.getElementById('alm-res').innerHTML = `PV Base: ${moneyFmt.format(pv)}<br>PV Shock: ${moneyFmt.format(pvShock)}<br>Delta: <span class="text-red-600">${moneyFmt.format(pvShock-pv)}</span>`;
        }});
    });
}

// Macro
function renderMacro() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div id="macro-chart" style="height:400px;"></div>`;
    const data = [{x:['Q1','Q2','Q3','Q4'], y:[6.1, 7.2, 6.5, 7.8], name:'GDP Growth %', type:'scatter'}, {x:['Q1','Q2','Q3','Q4'], y:[5.5, 5.1, 4.8, 5.2], name:'CPI Inflation %', type:'bar', yaxis:'y2', opacity:0.5}];
    const layout = {title:'Macro Indicators (Sample)', yaxis:{title:'GDP'}, yaxis2:{title:'CPI', overlaying:'y', side:'right'}};
    Plotly.newPlot('macro-chart', data, layout);
}

// DA Calc
function renderDa() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="grid grid-cols-2 gap-2 text-xs"><label>Sell Rate %</label><input id="da-sell" type="number" value="9.5" class="border rounded p-1"></div><input id="da-file" type="file" accept=".csv" class="file-input"><div id="da-res" class="font-mono text-sm"></div></div>`;
    document.getElementById('da-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, complete: res => {
            let totalSpreadPV = 0;
            const sellRate = +document.getElementById('da-sell').value/100;
            res.data.forEach(r => {
                const pos = +(r.POS||r.pos), bRate = +(r['End borrower Rate']||r.borrower_rate)/100, ten = +(r['Residual Tenure']||r.residual);
                if(pos && bRate && ten) {
                    const spread = bRate - sellRate;
                    for(let i=1; i<=ten; i++) totalSpreadPV += (pos * spread/12) / Math.pow(1+0.08/12, i);
                }
            });
            document.getElementById('da-res').innerText = `Total PV of Spread (IO Strip): ${moneyFmt.format(totalSpreadPV)}`;
        }});
    });
}

// Reg Validator
function renderRegValidator() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><select id="reg-type" class="border p-1"><option>CRILC</option><option>RBI_ALM</option></select><input id="reg-file" type="file" accept=".csv" class="file-input"><div id="reg-res" class="text-sm"></div></div>`;
    document.getElementById('reg-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, complete: res => {
            const req = { CRILC:['loan_id','pan','dpd','os'], RBI_ALM:['bucket','inflow','outflow'] };
            const type = document.getElementById('reg-type').value;
            const miss = req[type].filter(f => !res.meta.fields.includes(f));
            document.getElementById('reg-res').innerHTML = miss.length ? `<span class="text-red-600">Missing: ${miss.join(', ')}</span>` : `<span class="text-green-600">Schema Validated. Rows: ${res.data.length}</span>`;
        }});
    });
}

// EWS
function renderEws() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><input id="ews-file" type="file" accept=".csv" class="file-input"><div class="overflow-auto max-h-60 border rounded"><table class="w-full text-xs"><tbody id="ews-body"></tbody></table></div></div>`;
    document.getElementById('ews-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], { header:true, complete: res => {
            const tbody = document.getElementById('ews-body'); tbody.innerHTML='';
            res.data.forEach(r => {
                const dpd = +r.dpd;
                const risk = dpd>30 ? 'HIGH' : (dpd>0 ? 'MED' : 'LOW');
                const col = risk==='HIGH'?'text-red-600 font-bold':(risk==='MED'?'text-yellow-600':'text-green-600');
                tbody.innerHTML += `<tr><td class="p-2 border-t">${r.loan_id}</td><td class="p-2 border-t">DPD:${dpd}</td><td class="p-2 border-t ${col}">${risk}</td></tr>`;
            });
        }});
    });
}

/* ==========================================================================
   4. RISK & OPS (NPA, CO-LENDING, STATIC POOL)
   ========================================================================== */

function renderNpaProvisioning() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-3"><div class="text-xs bg-blue-50 p-2 border text-blue-800">RBI Norms: Std 0.4%, SS 15/25%, D1 25%, D2 40%, D3 100%</div><input id="npa-file" type="file" accept=".csv" class="file-input"><div id="npa-res" class="grid grid-cols-2 gap-4 pt-2"></div></div>`;
    document.getElementById('npa-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], {header:true, complete: res=>{
            let prov=0, tot=0;
            res.data.forEach(r=>{
                const os=+r.os_balance, dpd=+r.dpd; tot+=os;
                if(dpd<=90) prov+=os*0.004;
                else if(dpd<=455) prov+=os*0.15; 
                else prov+=os*0.4; 
            });
            document.getElementById('npa-res').innerHTML = `<div class="p-3 border rounded bg-white text-center"><div>Portfolio</div><div class="font-bold">${moneyFmt.format(tot)}</div></div><div class="p-3 border rounded bg-white text-center"><div>Provision</div><div class="font-bold text-red-600">${moneyFmt.format(prov)}</div></div>`;
        }});
    });
}

function renderCoLending() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="max-w-2xl mx-auto bg-white p-6 border rounded space-y-4"><div class="grid grid-cols-2 gap-4 text-sm"><label>Cust ROI</label><input id="clm-croi" type="number" value="18" class="border p-1"><label>Bank Share %</label><input id="clm-bshare" type="number" value="80" class="border p-1"><label>Bank Rate</label><input id="clm-broi" type="number" value="9.5" class="border p-1"></div><button id="clm-go" class="w-full bg-indigo-600 text-white py-2 rounded">Calc NBFC Rate</button><div id="clm-out" class="hidden text-center font-bold text-xl text-indigo-700 pt-4"></div></div>`;
    document.getElementById('clm-go').onclick = () => {
        const c=+document.getElementById('clm-croi').value, b=+document.getElementById('clm-bshare').value/100, br=+document.getElementById('clm-broi').value;
        const nshare = 1-b;
        const nrate = (c - (br*b))/nshare;
        document.getElementById('clm-out').innerText = `NBFC Rate: ${nrate.toFixed(2)}%`;
        document.getElementById('clm-out').classList.remove('hidden');
    };
}

function renderStaticPool() {
    const c = document.getElementById('tool-container');
    c.innerHTML = `<div class="space-y-2"><input id="sp-file" type="file" accept=".csv" class="file-input"><div id="sp-heat" class="overflow-auto p-2 border rounded bg-white min-h-[200px]"></div></div>`;
    document.getElementById('sp-file').addEventListener('change', e => {
        Papa.parse(e.target.files[0], {header:true, complete:res=>{
            let html='<table class="w-full text-xs border">', mobs=new Set();
            res.data.forEach(r=>mobs.add(+r.mob));
            let mobArr=Array.from(mobs).sort((a,b)=>a-b);
            html+='<tr><th class="border p-1">Vintage</th>'+mobArr.map(m=>`<th class="border p-1">${m}</th>`).join('')+'</tr>';
            let vints={}; res.data.forEach(r=>{ if(!vints[r.vintage]) vints[r.vintage]={}; vints[r.vintage][r.mob]=+r.value; });
            Object.keys(vints).sort().forEach(v=>{
                html+=`<tr><td class="border p-1 font-bold">${v}</td>`+mobArr.map(m=>{
                    let val=vints[v][m]; return `<td class="border p-1 text-center" style="background-color:rgba(255,0,0,${val?val/10:0})">${val?val.toFixed(2)+'%':''}</td>`;
                }).join('')+'</tr>';
            });
            document.getElementById('sp-heat').innerHTML = html+'</table>';
        }});
    });
}

function renderAnnualLossRate() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Principal</label><input id="alr-prin" type="number" value="1000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Coupon % (Annual)</label><input id="alr-rate" type="number" value="12" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (Months)</label><input id="alr-tenor" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Frequency</label>
          <select id="alr-freq" class="w-full border rounded p-2">
            <option value="monthly" selected>Monthly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
        <div><label class="text-xs text-slate-500">Prepayment % per Period</label><input id="alr-prepay" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Lifetime Loss % of Orig</label><input id="alr-loss" type="number" value="4" class="w-full border rounded p-2"></div>
      </div>
      <button id="alr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Annualised Loss Rate</button>
      <div id="alr-res" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
      <div id="alr-chart" class="h-64"></div>
      <div class="text-xs text-slate-500">Method: Converts lifetime loss (as % of original principal) into an annualised risk premium by dividing expected loss amount by time-weighted exposure (sum of avg outstanding * years), factoring amortisation and constant prepayment per period.</div>
    </div>
  `;
  document.getElementById('alr-run').onclick = () => {
    const prin = +document.getElementById('alr-prin').value;
    const rate = +document.getElementById('alr-rate').value;
    const tenorM = +document.getElementById('alr-tenor').value;
    const freq = document.getElementById('alr-freq').value;
    const prepayPct = +document.getElementById('alr-prepay').value / 100;
    const lossPct = +document.getElementById('alr-loss').value / 100;
    const monthsPer = freq === 'quarterly' ? 3 : 1;
    const periods = Math.ceil(tenorM / monthsPer);
    const perRate = rate / (12 / monthsPer) / 100;
    const perEmi = perRate === 0 ? prin / periods : prin * perRate * Math.pow(1 + perRate, periods) / (Math.pow(1 + perRate, periods) - 1);
    let bal = prin, exposureTime = 0, walNum = 0, sched = [];

    for (let p = 1; p <= periods; p++) {
      const interest = bal * perRate;
      const schedPrin = Math.min(bal, Math.max(0, perEmi - interest));
      const prepay = bal * prepayPct;
      const totalPrin = Math.min(bal, schedPrin + prepay);
      const endBal = bal - totalPrin;
      const avgBal = (bal + endBal) / 2;
      const years = monthsPer / 12;
      exposureTime += avgBal * years;
      walNum += totalPrin * p * years;
      sched.push({ period: p, balStart: bal, interest, schedPrin, prepay, endBal });
      bal = endBal;
      if (bal <= 1) break;
    }

    const lossAmount = prin * lossPct;
    const annualLossRate = exposureTime > 0 ? lossAmount / exposureTime : 0; // annualised spread as % of outstanding
    const wal = prin > 0 ? walNum / prin : 0;

    document.getElementById('alr-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Lifetime Loss</div><div class="font-bold text-lg text-red-600">${moneyFmt.format(lossAmount)}</div><div class="text-xs text-slate-500">${(lossPct*100).toFixed(2)}% of orig</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Annualised Risk Premium</div><div class="font-bold text-lg text-indigo-700">${(annualLossRate*100).toFixed(2)}%</div><div class="text-xs text-slate-500">${(annualLossRate*10000).toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Exposure Time (Principal-Years)</div><div class="font-bold text-lg">${moneyFmt.format(exposureTime)}</div><div class="text-xs text-slate-500">Avg Outstand ${moneyFmt.format(exposureTime / (tenorM/12 || 1))}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">WAL (approx)</div><div class="font-bold text-lg">${wal.toFixed(2)} yrs</div><div class="text-xs text-slate-500">Freq ${freq}, Prepay ${(prepayPct*100).toFixed(1)}%</div></div>
    `;

    const trace = {
      x: sched.map(r => r.period),
      y: sched.map(r => r.balStart),
      type: 'scatter',
      name: 'Outstanding',
      line: { color: '#6366f1' }
    };
    Plotly.newPlot('alr-chart', [trace], { margin:{t:20}, xaxis:{title:'Period'}, yaxis:{title:'Outstanding'} });
  };
}

function renderDelinqLadder() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">PAR30 %</label><input id="dl-30" type="number" value="6" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PAR60 %</label><input id="dl-60" type="number" value="3.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PAR90 %</label><input id="dl-90" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cure 30 %</label><input id="dl-cure30" type="number" value="65" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cure 60 %</label><input id="dl-cure60" type="number" value="35" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="dl-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">WAL (yrs)</label><input id="dl-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Portfolio OS</label><input id="dl-os" type="number" value="10000000" class="w-full border rounded p-2"></div>
      </div>
      <button id="dl-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Convert Ladder</button>
      <div id="dl-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('dl-run').onclick = () => {
    const par30=+document.getElementById('dl-30').value/100;
    const par60=+document.getElementById('dl-60').value/100;
    const par90=+document.getElementById('dl-90').value/100;
    const cure30=+document.getElementById('dl-cure30').value/100;
    const cure60=+document.getElementById('dl-cure60').value/100;
    const lgd=+document.getElementById('dl-lgd').value/100;
    const wal=+document.getElementById('dl-wal').value;
    const os=+document.getElementById('dl-os').value;
    const b30 = Math.max(0, par30 - par60);
    const b60 = Math.max(0, par60 - par90);
    const b90 = Math.max(0, par90);
    const defFrom60 = b60 * (1 - cure60);
    const defFrom30 = b30 * (1 - cure30) * (1 - cure60);
    const totalDefaultPct = b90 + defFrom60 + defFrom30;
    const lifetimeLossPct = totalDefaultPct * lgd * 100;
    const lossAmt = os * totalDefaultPct * lgd;
    const spread = wal>0 ? (lossAmt/os)/wal : 0;
    document.getElementById('dl-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Implied Default %</div><div class="font-bold text-lg">${(totalDefaultPct*100).toFixed(2)}%</div><div class="text-xs text-slate-500">30→60 ${defFrom30>0? (defFrom30*100).toFixed(2)+'%':''}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Lifetime Loss</div><div class="font-bold text-lg text-red-600">${lifetimeLossPct.toFixed(2)}%</div><div class="text-xs text-slate-500">${moneyFmt.format(lossAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Annualised Spread</div><div class="font-bold text-lg text-indigo-700">${(spread*10000).toFixed(0)} bps</div><div class="text-xs text-slate-500">WAL ${wal} yrs</div></div>
    `;
  };
}

function renderProductMixRisk() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="pm-base" type="number" value="400" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Default WAL (yrs)</label><input id="pm-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Prepay Adj Factor</label><input id="pm-prepayf" type="number" value="0.8" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Optional: Pool OS</label><input id="pm-os" type="number" value="10000000" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Products (name,share%,PD%,LGD%,prepay%/yr)</label>
        <textarea id="pm-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs">MFI,40,4,50,20
LAP,25,2,35,10
PL,25,5,60,25
Vehicle,10,3,45,18</textarea>
      </div>
      <button id="pm-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Uplift</button>
      <div id="pm-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div class="overflow-auto max-h-64 border rounded"><table class="w-full text-xs"><tbody id="pm-table"></tbody></table></div>
    </div>
  `;
  document.getElementById('pm-run').onclick = () => {
    const base=+document.getElementById('pm-base').value;
    const wal=+document.getElementById('pm-wal').value;
    const prepayF=+document.getElementById('pm-prepayf').value;
    const os=+document.getElementById('pm-os').value;
    const lines=document.getElementById('pm-rows').value.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
    let totalShare=0, weightedEL=0, weightedWal=0;
    const rows=[];
    lines.forEach(l=>{
      const p=l.split(',').map(v=>v.trim());
      if(p.length<5) return;
      const name=p[0], share=+p[1]/100, pd=+p[2]/100, lgd=+p[3]/100, prepay=+p[4]/100;
      if(share<=0) return;
      totalShare += share;
      const el=pd*lgd;
      const adjWal = wal * (1 - prepay*prepayF);
      weightedEL += share*el;
      weightedWal += share*adjWal;
      rows.push({name, share, el, adjWal});
    });
    const avgWal = weightedWal/(totalShare||1);
    const spread = avgWal>0 ? (weightedEL)/(avgWal)*10000 : 0;
    const uplift = spread - base;
    document.getElementById('pm-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Weighted EL</div><div class="font-bold text-lg text-red-600">${(weightedEL*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Adj WAL</div><div class="font-bold text-lg">${avgWal.toFixed(2)} yrs</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Risk Premium</div><div class="font-bold text-lg text-indigo-700">${spread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Uplift vs base ${uplift.toFixed(0)} bps</div></div>
    `;
    const body = rows.map(r=>`<tr><td class="p-2 border">${r.name}</td><td class="p-2 border text-right">${(r.share*100).toFixed(1)}%</td><td class="p-2 border text-right">${(r.el*100).toFixed(2)}%</td><td class="p-2 border text-right">${r.adjWal.toFixed(2)}</td></tr>`).join('');
    document.getElementById('pm-table').innerHTML = `<tr class="bg-slate-100"><th class="p-2 border text-left">Product</th><th class="p-2 border text-right">Share</th><th class="p-2 border text-right">EL %</th><th class="p-2 border text-right">Adj WAL</th></tr>${body}`;
  };
}

function renderSeverityFrequency() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">PD %</label><input id="sf-pd" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="sf-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">WAL (yrs)</label><input id="sf-wal" type="number" value="1.5" step="0.1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="sf-base" type="number" value="400" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PD Add-on (bps/1pp)</label><input id="sf-pdadd" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD Add-on (bps/5pp)</label><input id="sf-lgdadd" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Target Buffer bps</label><input id="sf-buf" type="number" value="50" class="w-full border rounded p-2"></div>
      </div>
      <button id="sf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Decompose</button>
      <div id="sf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('sf-run').onclick = () => {
    const pd=+document.getElementById('sf-pd').value/100;
    const lgd=+document.getElementById('sf-lgd').value/100;
    const wal=+document.getElementById('sf-wal').value;
    const base=+document.getElementById('sf-base').value;
    const pdAdd=+document.getElementById('sf-pdadd').value;
    const lgdAdd=+document.getElementById('sf-lgdadd').value;
    const buf=+document.getElementById('sf-buf').value;
    const el = pd*lgd;
    const spread = wal>0 ? (el/wal)*10000 : 0;
    const pdLever = (pd*100)*pdAdd;
    const lgdLever = (lgd*100/5)*lgdAdd;
    const total = base + spread + pdLever + lgdLever + buf;
    document.getElementById('sf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">EL</div><div class="font-bold text-lg text-red-600">${(el*100).toFixed(2)}%</div><div class="text-xs text-slate-500">Spread from EL ${(spread).toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Frequency Lever</div><div class="font-bold text-lg">${pdLever.toFixed(0)} bps</div><div class="text-xs text-slate-500">PD ${(pd*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Severity Lever</div><div class="font-bold text-lg">${lgdLever.toFixed(0)} bps</div><div class="text-xs text-slate-500">LGD ${(lgd*100).toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Total Suggested Spread</div><div class="font-bold text-lg text-indigo-700">${total.toFixed(0)} bps</div><div class="text-xs text-slate-500">Includes base ${base} + buffer ${buf}</div></div>
    `;
  };
}

function renderPtpTracker() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">PTP Horizon (days)</label><input id="ptp-hor" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Max Days Late to Count</label><input id="ptp-late" type="number" value="5" class="w-full border rounded p-2"></div>
      </div>
      <textarea id="ptp-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="date,amount,status,paid_date(optional)">2025-01-01,25000,promise,2025-01-03
2025-01-02,18000,broken,
2025-01-03,12000,promise,2025-01-10</textarea>
      <button id="ptp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Track PTP</button>
      <div id="ptp-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ptp-run').onclick = () => {
    const hor=+document.getElementById('ptp-hor').value;
    const late=+document.getElementById('ptp-late').value;
    const lines=document.getElementById('ptp-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let promised=0, kept=0, broken=0;
    lines.forEach(l=>{
      const p=l.split(','); if(p.length<3) return;
      const amt=+p[1]; const status=(p[2]||'').toLowerCase();
      promised += amt;
      if(status==='promise'){
        const paidDate = p[3] ? new Date(p[3]) : null;
        const promiseDate = p[0] ? new Date(p[0]) : null;
        const diffDays = paidDate && promiseDate ? (paidDate - promiseDate)/(1000*60*60*24) : Infinity;
        if(paidDate && diffDays <= (hor+late)) kept += amt; else broken += amt;
      } else if(status==='kept') kept += amt; else broken += amt;
    });
    const hitRate = promised ? (kept/promised)*100 : 0;
    document.getElementById('ptp-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Promised</div><div class="font-bold text-lg">${moneyFmt.format(promised)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Kept</div><div class="font-bold text-lg text-green-700">${moneyFmt.format(kept)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Hit Rate</div><div class="font-bold text-lg ${hitRate>=50?'text-green-700':'text-red-600'}">${hitRate.toFixed(1)}%</div><div class="text-xs text-slate-500">Broken ${moneyFmt.format(broken)}</div></div>
    `;
  };
}

function renderSettlementOptimizer() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Bucket OS</label><input id="so-os" type="number" value="5000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Min Offer %</label><input id="so-min" type="number" value="40" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Expected Uptake %</label><input id="so-uptake" type="number" value="25" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cost-to-Collect %</label><input id="so-ctc" type="number" value="3" class="w-full border rounded p-2"></div>
      </div>
      <button id="so-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Optimize Offer</button>
      <div id="so-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('so-run').onclick = () => {
    const os=+document.getElementById('so-os').value;
    const min=+document.getElementById('so-min').value/100;
    const uptake=+document.getElementById('so-uptake').value/100;
    const ctc=+document.getElementById('so-ctc').value/100;
    const settleAmt=os*min*uptake;
    const ctcAmt=os*ctc;
    const net=settleAmt-ctcAmt;
    document.getElementById('so-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Offer Collected</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(settleAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cost-to-Collect</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(ctcAmt)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net</div><div class="font-bold text-lg ${net>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(net)}</div></div>
    `;
  };
}

function renderRollRateCube() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <textarea id="rrc-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="from,to,rate%">0,0,85
0,30,10
0,60,3
30,0,30
30,60,50
60,90,20
90,wo,40</textarea>
      <button id="rrc-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Build Cube</button>
      <div id="rrc-table" class="overflow-auto max-h-80 border rounded"></div>
    </div>
  `;
  document.getElementById('rrc-run').onclick = () => {
    const lines=document.getElementById('rrc-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rates={}; const cats=new Set();
    lines.forEach(l=>{ const p=l.split(','); if(p.length<3)return; const f=p[0], t=p[1], r=+p[2]; cats.add(f); cats.add(t); rates[`${f}|${t}`]=r; });
    const headers=Array.from(cats);
    let html='<table class="w-full text-xs"><tr><th class="p-2 border">From\\To</th>'+headers.map(h=>`<th class="p-2 border">${h}</th>`).join('')+'</tr>';
    headers.forEach(f=>{
      html+=`<tr><td class="p-2 border font-semibold">${f}</td>`+headers.map(t=>{
        const r=rates[`${f}|${t}`]; return `<td class="p-2 border text-right ${r>=50?'text-red-600':'text-slate-700'}">${isFinite(r)?r.toFixed(1)+'%':''}</td>`;
      }).join('')+'</tr>';
    });
    html+='</table>';
    document.getElementById('rrc-table').innerHTML = html;
  };
}

function renderCureForecast() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Max Cure %</label><input id="cf-max" type="number" value="85" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Midpoint (days)</label><input id="cf-mid" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Steepness</label><input id="cf-k" type="number" value="0.2" step="0.05" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Horizon (days)</label><input id="cf-hor" type="number" value="90" class="w-full border rounded p-2"></div>
      </div>
      <button id="cf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast Cure</button>
      <div id="cf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div id="cf-chart" class="h-64"></div>
    </div>
  `;
  document.getElementById('cf-run').onclick = () => {
    const max=+document.getElementById('cf-max').value/100;
    const mid=+document.getElementById('cf-mid').value;
    const k=+document.getElementById('cf-k').value;
    const hor=+document.getElementById('cf-hor').value;
    const xs=[], ys=[];
    for(let d=0; d<=hor; d+=5){
      const cure = max/(1+Math.exp(-k*(d-mid)));
      xs.push(d); ys.push(cure*100);
    }
    const day30 = max/(1+Math.exp(-k*(30-mid)))*100;
    const day60 = max/(1+Math.exp(-k*(60-mid)))*100;
    document.getElementById('cf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cure @30d</div><div class="font-bold text-lg">${day30.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Cure @60d</div><div class="font-bold text-lg">${day60.toFixed(1)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Max Cure</div><div class="font-bold text-lg text-indigo-700">${(max*100).toFixed(1)}%</div></div>
    `;
    Plotly.newPlot('cf-chart', [{x:xs, y:ys, type:'scatter', line:{color:'#6366f1'}}], {margin:{t:20}, xaxis:{title:'Days'}, yaxis:{title:'Cure %'}});
  };
}

function renderFieldRoute() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Max Visits/Day</label><input id="fr-max" type="number" value="8" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Distance Penalty (per km)</label><input id="fr-pen" type="number" value="1" class="w-full border rounded p-2"></div>
      </div>
      <textarea id="fr-rows" rows="6" class="w-full border rounded p-3 font-mono text-xs" placeholder="name,amount,km_from_base">Asha,15000,5
Ravi,22000,12
Meera,9000,3
Suman,14000,2
Kiran,18000,9</textarea>
      <button id="fr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Plan Visits</button>
      <div id="fr-res" class="overflow-auto max-h-80 border rounded"></div>
    </div>
  `;
  document.getElementById('fr-run').onclick = () => {
    const max=+document.getElementById('fr-max').value;
    const pen=+document.getElementById('fr-pen').value;
    const lines=document.getElementById('fr-rows').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rows=lines.map(l=>{ const p=l.split(','); return {name:p[0], amt:+p[1], dist:+p[2], score:(+p[1])-(pen*(+p[2]))}; }).sort((a,b)=>b.score-a.score);
    const pick=rows.slice(0, max);
    const html=pick.map(r=>`<tr><td class="p-2 border">${r.name}</td><td class="p-2 border text-right">${moneyFmt.format(r.amt)}</td><td class="p-2 border text-right">${r.dist||0} km</td><td class="p-2 border text-right">${r.score.toFixed(0)}</td></tr>`).join('');
    document.getElementById('fr-res').innerHTML = `<table class="w-full text-xs"><tr class="bg-slate-100"><th class="p-2 border text-left">Cust</th><th class="p-2 border text-right">Amount</th><th class="p-2 border text-right">Dist</th><th class="p-2 border text-right">Priority</th></tr>${html}</table>`;
  };
}

function renderLegalRoi() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Claim Amount</label><input id="lr-claim" type="number" value="1000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Legal Fees</label><input id="lr-fee" type="number" value="80000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Win Rate %</label><input id="lr-win" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Recovery % on Win</label><input id="lr-rec" type="number" value="55" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Timeline (months)</label><input id="lr-time" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Discount Rate %</label><input id="lr-disc" type="number" value="12" class="w-full border rounded p-2"></div>
      </div>
      <button id="lr-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute ROI</button>
      <div id="lr-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('lr-run').onclick = () => {
    const claim=+document.getElementById('lr-claim').value;
    const fee=+document.getElementById('lr-fee').value;
    const win=+document.getElementById('lr-win').value/100;
    const rec=+document.getElementById('lr-rec').value/100;
    const time=+document.getElementById('lr-time').value;
    const disc=+document.getElementById('lr-disc').value/1200;
    const expected = claim*rec*win;
    const pv = expected/Math.pow(1+disc, time);
    const roi = fee>0 ? (pv-fee)/fee : 0;
    const annual = time>0 ? Math.pow(pv/fee, 12/time)-1 : roi;
    document.getElementById('lr-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Expected Recovery</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(expected)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV @Discount</div><div class="font-bold text-lg">${moneyFmt.format(pv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">ROI</div><div class="font-bold text-lg ${roi>=0?'text-green-700':'text-red-600'}">${(roi*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Annualised ${(annual*100).toFixed(1)}%</div></div>
    `;
  };
}

function renderNetYield() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Customer Rate %</label><input id="ny-rate" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="ny-cof" type="number" value="9" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Opex bps</label><input id="ny-opex" type="number" value="200" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Credit Cost %</label><input id="ny-cc" type="number" value="2.5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Fee % (annualised)</label><input id="ny-fee" type="number" value="1" class="w-full border rounded p-2"></div>
      </div>
      <button id="ny-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Net Yield</button>
      <div id="ny-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ny-run').onclick = () => {
    const rate=+document.getElementById('ny-rate').value;
    const cof=+document.getElementById('ny-cof').value;
    const opex=+document.getElementById('ny-opex').value/100; // bps to %
    const cc=+document.getElementById('ny-cc').value;
    const fee=+document.getElementById('ny-fee').value;
    const net = rate + fee - cof - opex - cc;
    document.getElementById('ny-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Gross Yield</div><div class="font-bold text-lg">${rate.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Costs (CoF+Opex+CC)</div><div class="font-bold text-lg text-red-600">${(cof+opex+cc).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Yield</div><div class="font-bold text-lg text-indigo-700">${net.toFixed(2)}%</div><div class="text-xs text-slate-500">Includes fee ${fee.toFixed(2)}%</div></div>
    `;
  };
}

function renderFeeImpact() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Principal</label><input id="fi-amt" type="number" value="500000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Fee % (Upfront)</label><input id="fi-fee" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate %</label><input id="fi-rate" type="number" value="16" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tenor (M)</label><input id="fi-ten" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Amortize Fee? (Y/N)</label><select id="fi-amort" class="w-full border rounded p-2"><option value="yes">Yes</option><option value="no" selected>No</option></select></div>
        <div><label class="text-xs text-slate-500">Discount Rate %</label><input id="fi-discount" type="number" value="12" class="w-full border rounded p-2"></div>
      </div>
      <button id="fi-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compare Impact</button>
      <div id="fi-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('fi-run').onclick = () => {
    const p=+document.getElementById('fi-amt').value;
    const feePct=+document.getElementById('fi-fee').value/100;
    const rate=+document.getElementById('fi-rate').value;
    const ten=+document.getElementById('fi-ten').value;
    const amort=document.getElementById('fi-amort').value==='yes';
    const disc=+document.getElementById('fi-discount').value/1200;
    const feeAmt=p*feePct;
    const emi=calcEmi(p, rate, ten);
    let pvUpfront = feeAmt; // received at t0
    let pvAmort = 0;
    if(amort){
      const feePer = feeAmt/ten;
      for(let i=1;i<=ten;i++){ pvAmort += feePer / Math.pow(1+disc, i); }
    }
    document.getElementById('fi-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Fee Amount</div><div class="font-bold text-lg">${moneyFmt.format(feeAmt)}</div><div class="text-xs text-slate-500">EMI ${moneyFmt.format(emi)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV (Upfront)</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(pvUpfront)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">PV (Amortized)</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(pvAmort)}</div><div class="text-xs text-slate-500">${amort?'Spread over tenor':'N/A'}</div></div>
    `;
  };
}

function renderCrossSell() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Base Conversion %</label><input id="cs-base" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Uplift %</label><input id="cs-uplift" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Revenue per Convert</label><input id="cs-rev" type="number" value="1500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Cost per Outreach</label><input id="cs-cost" type="number" value="50" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Base Population</label><input id="cs-pop" type="number" value="10000" class="w-full border rounded p-2"></div>
      </div>
      <button id="cs-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast</button>
      <div id="cs-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('cs-run').onclick = () => {
    const base=+document.getElementById('cs-base').value/100;
    const uplift=+document.getElementById('cs-uplift').value/100;
    const rev=+document.getElementById('cs-rev').value;
    const cost=+document.getElementById('cs-cost').value;
    const pop=+document.getElementById('cs-pop').value;
    const baseConv = pop*base;
    const newConv = pop*(base+uplift);
    const incrConv = newConv - baseConv;
    const gross = newConv*rev;
    const spend = pop*cost;
    const roi = spend>0 ? (gross-spend)/spend : 0;
    document.getElementById('cs-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Conversions</div><div class="font-bold text-lg">${newConv.toFixed(0)}</div><div class="text-xs text-slate-500">Base ${baseConv.toFixed(0)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Revenue</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(gross)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">ROI</div><div class="font-bold text-lg ${roi>=0?'text-green-700':'text-red-600'}">${(roi*100).toFixed(1)}%</div><div class="text-xs text-slate-500">Spend ${moneyFmt.format(spend)}</div></div>
    `;
  };
}

function renderPrepayPenalty() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Portfolio OS</label><input id="pp-os" type="number" value="100000000" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Annual Prepay %</label><input id="pp-pre" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Penalty %</label><input id="pp-pen" type="number" value="3" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Attrition Sensitivity (pp per %pen)</label><input id="pp-sens" type="number" value="0.8" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="pp-cof" type="number" value="9" class="w-full border rounded p-2"></div>
      </div>
      <button id="pp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Optimize</button>
      <div id="pp-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('pp-run').onclick = () => {
    const os=+document.getElementById('pp-os').value;
    const pre=+document.getElementById('pp-pre').value/100;
    const pen=+document.getElementById('pp-pen').value/100;
    const sens=+document.getElementById('pp-sens').value/100;
    const cof=+document.getElementById('pp-cof').value/100;
    const penaltyIncome = os*pre*pen;
    const churnImpact = os*pre*(pen*100*sens/100); // attrition increase proportional to sensitivity
    const carryLoss = churnImpact*cof;
    const net = penaltyIncome - carryLoss;
    document.getElementById('pp-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Penalty Income</div><div class="font-bold text-lg text-indigo-700">${moneyFmt.format(penaltyIncome)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Extra Attrition OS</div><div class="font-bold text-lg text-amber-700">${moneyFmt.format(churnImpact)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Impact</div><div class="font-bold text-lg ${net>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(net)}</div><div class="text-xs text-slate-500">Carry loss ${moneyFmt.format(carryLoss)}</div></div>
    `;
  };
}

function renderLossLeader() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">CAC</label><input id="ll-cac" type="number" value="1500" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Promo Loss per Cust</label><input id="ll-loss" type="number" value="800" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Monthly Gross Margin</label><input id="ll-mgm" type="number" value="150" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Churn % / month</label><input id="ll-churn" type="number" value="4" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LTV Uplift % (cross/upsell)</label><input id="ll-uplift" type="number" value="25" class="w-full border rounded p-2"></div>
      </div>
      <button id="ll-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Calculate Payback</button>
      <div id="ll-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('ll-run').onclick = () => {
    const cac=+document.getElementById('ll-cac').value;
    const loss=+document.getElementById('ll-loss').value;
    const mgm=+document.getElementById('ll-mgm').value;
    const churn=+document.getElementById('ll-churn').value/100;
    const uplift=+document.getElementById('ll-uplift').value/100;
    const baseLtv = mgm / (churn>0 ? churn : 0.01);
    const totalLtv = baseLtv * (1+uplift);
    const payback = (cac+loss)/(mgm>0?mgm:1);
    const netUnit = totalLtv - (cac+loss);
    document.getElementById('ll-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Base LTV</div><div class="font-bold text-lg">${moneyFmt.format(baseLtv)}</div><div class="text-xs text-slate-500">With uplift ${moneyFmt.format(totalLtv)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Payback (months)</div><div class="font-bold text-lg text-indigo-700">${payback.toFixed(1)}</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Net Unit Profit</div><div class="font-bold text-lg ${netUnit>=0?'text-green-700':'text-red-600'}">${moneyFmt.format(netUnit)}</div></div>
    `;
  };
}
function renderVintageLossForecaster() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-5xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Horizon (MOB)</label><input id="vlf-hor" type="number" value="36" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Tail Decay (% of last delta)</label><input id="vlf-decay" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Band Width %</label><input id="vlf-band" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Price Cushion bps</label><input id="vlf-cush" type="number" value="50" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Vintage Data (mob,cum_loss%)</label>
        <textarea id="vlf-data" rows="6" class="w-full border rounded p-3 font-mono text-xs">1,0.20
2,0.32
3,0.45
4,0.55
5,0.63
6,0.70
9,0.85
12,0.95
15,1.05
18,1.10</textarea>
      </div>
      <button id="vlf-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Forecast Lifetime Loss</button>
      <div id="vlf-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div id="vlf-chart" class="h-72"></div>
    </div>
  `;
  document.getElementById('vlf-run').onclick = () => {
    const hor = +document.getElementById('vlf-hor').value;
    const decay = +document.getElementById('vlf-decay').value / 100;
    const band = +document.getElementById('vlf-band').value / 100;
    const cushion = +document.getElementById('vlf-cush').value;
    const lines = document.getElementById('vlf-data').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let pts = lines.map(l => { const p=l.split(','); return { mob:+p[0], loss:+p[1] }; }).filter(p=>p.mob>0 && p.loss>=0).sort((a,b)=>a.mob-b.mob);
    if (!pts.length) return;
    const data = [];
    // interpolate missing mobs
    for (let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1];
      data.push(a);
      const gap = b.mob - a.mob;
      if (gap>1){
        const step = (b.loss - a.loss)/gap;
        for(let g=1; g<gap; g++) data.push({ mob:a.mob+g, loss:a.loss+step*g });
      }
    }
    data.push(pts[pts.length-1]);
    let lastLoss = data[data.length-1].loss;
    let lastDelta = data.length>1 ? data[data.length-1].loss - data[data.length-2].loss : 0;
    for (let m = data[data.length-1].mob+1; m<=hor; m++){
      lastDelta = lastDelta * decay;
      lastLoss = lastLoss + lastDelta;
      data.push({ mob:m, loss:lastLoss });
    }
    const finalLoss = data[data.length-1].loss;
    const low = finalLoss*(1-band), high = finalLoss*(1+band);
    document.getElementById('vlf-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Forecast Lifetime Loss</div><div class="font-bold text-lg text-indigo-700">${finalLoss.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Confidence Band</div><div class="font-bold text-lg">${low.toFixed(2)}% - ${high.toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Pricing Cushion</div><div class="font-bold text-lg text-amber-700">${cushion} bps</div></div>
    `;
    Plotly.newPlot('vlf-chart', [
      { x:data.map(d=>d.mob), y:data.map(d=>d.loss), type:'scatter', name:'Forecast', line:{color:'#6366f1'} },
      { x:[data[0].mob, data[data.length-1].mob], y:[low, low], mode:'lines', name:'Lower', line:{dash:'dot', color:'#22c55e'} },
      { x:[data[0].mob, data[data.length-1].mob], y:[high, high], mode:'lines', name:'Upper', line:{dash:'dot', color:'#ef4444'} },
    ], { margin:{t:20}, xaxis:{title:'MOB'}, yaxis:{title:'Cum Loss %'} });
  };
}

function renderStressUplift() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-3xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Base Spread (bps)</label><input id="su-base" type="number" value="450" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">GDP Shock (ppt)</label><input id="su-gdp" type="number" value="2" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Inflation Shock (ppt)</label><input id="su-inf" type="number" value="1" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate Shock (bps)</label><input id="su-rate" type="number" value="100" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">GDP Sens (bps/ppt)</label><input id="su-gdpw" type="number" value="30" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Infl Sens (bps/ppt)</label><input id="su-infw" type="number" value="15" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Rate Sens (bps/100bps)</label><input id="su-ratew" type="number" value="10" class="w-full border rounded p-2"></div>
      </div>
      <button id="su-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Recommend Uplift</button>
      <div id="su-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('su-run').onclick = () => {
    const base = +document.getElementById('su-base').value;
    const gdp = +document.getElementById('su-gdp').value;
    const inf = +document.getElementById('su-inf').value;
    const rate = +document.getElementById('su-rate').value;
    const gw = +document.getElementById('su-gdpw').value;
    const iw = +document.getElementById('su-infw').value;
    const rw = +document.getElementById('su-ratew').value;
    const uplift = gdp*gw + inf*iw + (rate/100)*rw;
    const stressed = base + uplift;
    document.getElementById('su-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Base Spread</div><div class="font-bold text-lg">${base} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Stress Uplift</div><div class="font-bold text-lg text-amber-700">${uplift.toFixed(0)} bps</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Stressed Spread</div><div class="font-bold text-lg text-indigo-700">${stressed.toFixed(0)} bps</div></div>
    `;
  };
}

function renderCoLendFls() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-slate-500">Bank Share %</label><input id="fls-bank" type="number" value="80" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">NBFC Share %</label><input id="fls-nbfc" type="number" value="20" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">First-Loss / FLDG % of Pool</label><input id="fls-fl" type="number" value="5" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">PD %</label><input id="fls-pd" type="number" value="4" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">LGD %</label><input id="fls-lgd" type="number" value="45" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Target ROE Buffer bps</label><input id="fls-roe" type="number" value="150" class="w-full border rounded p-2"></div>
      </div>
      <button id="fls-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Split Spread</button>
      <div id="fls-res" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
    </div>
  `;
  document.getElementById('fls-run').onclick = () => {
    const bShare = +document.getElementById('fls-bank').value/100;
    const nShare = +document.getElementById('fls-nbfc').value/100;
    const fl = +document.getElementById('fls-fl').value/100;
    const pd = +document.getElementById('fls-pd').value/100;
    const lgd = +document.getElementById('fls-lgd').value/100;
    const roe = +document.getElementById('fls-roe').value;
    const el = pd*lgd;
    const residual = Math.max(0, el - fl);
    const bankLoss = residual * bShare;
    const nbfcLoss = residual * nShare + fl;
    const bankSpread = bankLoss*10000 + roe;
    const nbfcSpread = nbfcLoss*10000 + roe;
    document.getElementById('fls-res').innerHTML = `
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Pool EL</div><div class="font-bold text-lg text-red-600">${(el*100).toFixed(2)}%</div><div class="text-xs text-slate-500">First-loss ${ (fl*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">Bank Allocation</div><div class="font-bold text-lg text-indigo-700">${bankSpread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Net loss ${(bankLoss*100).toFixed(2)}%</div></div>
      <div class="p-3 border rounded bg-slate-50"><div class="text-xs text-slate-500">NBFC Allocation</div><div class="font-bold text-lg text-amber-700">${nbfcSpread.toFixed(0)} bps</div><div class="text-xs text-slate-500">Net loss ${(nbfcLoss*100).toFixed(2)}%</div></div>
    `;
  };
}

function renderBureauPricing() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-5xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div><label class="text-xs text-slate-500">Base Rate %</label><input id="bp-base" type="number" value="18" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">CoF %</label><input id="bp-cof" type="number" value="9" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">Opex bps</label><input id="bp-opex" type="number" value="200" class="w-full border rounded p-2"></div>
        <div><label class="text-xs text-slate-500">ROE Target bps</label><input id="bp-roe" type="number" value="300" class="w-full border rounded p-2"></div>
      </div>
      <div>
        <label class="text-xs text-slate-500">Bands (from-to, annualised loss %)</label>
        <textarea id="bp-bands" rows="6" class="w-full border rounded p-3 font-mono text-xs">750,800,1.8
700,749,3.0
650,699,4.2
600,649,6.5</textarea>
      </div>
      <button id="bp-run" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-semibold">Compute Band Pricing</button>
      <div id="bp-res" class="overflow-auto max-h-72 border rounded"></div>
    </div>
  `;
  document.getElementById('bp-run').onclick = () => {
    const base = +document.getElementById('bp-base').value;
    const cof = +document.getElementById('bp-cof').value;
    const opex = +document.getElementById('bp-opex').value;
    const roe = +document.getElementById('bp-roe').value;
    const lines = document.getElementById('bp-bands').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const rows = lines.map(l => {
      const p = l.split(',').map(v=>v.trim());
      return { from:+p[0], to:+p[1], loss:+p[2] };
    }).filter(r=>r.loss>=0);
    const html = rows.map(r => {
      const lossBps = r.loss*100;
      const reqRate = (cof*100 + opex + lossBps + roe)/100; // convert bps back to %
      const premium = (reqRate - base)*100;
      return `<tr>
        <td class="p-2 border text-center">${r.from}-${r.to}</td>
        <td class="p-2 border text-right">${r.loss.toFixed(2)}%</td>
        <td class="p-2 border text-right">${reqRate.toFixed(2)}%</td>
        <td class="p-2 border text-right ${premium>=0?'text-red-600':'text-green-700'}">${premium.toFixed(0)} bps</td>
      </tr>`;
    }).join('');
    document.getElementById('bp-res').innerHTML = `
      <table class="w-full text-xs">
        <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2 border">Score Band</th><th class="p-2 border">Ann Loss %</th><th class="p-2 border">Req Rate %</th><th class="p-2 border">Premium vs Base</th></tr></thead>
        <tbody>${html}</tbody>
      </table>
    `;
  };
}

function renderExcelToolkit() {
  const c = document.getElementById('tool-container');
  c.innerHTML = `
    <div class="max-w-4xl mx-auto bg-white border rounded-xl p-6 shadow-sm space-y-4 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">Percent Change</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <input id="xtk-old" type="number" value="100" class="border rounded p-2" placeholder="Old">
            <input id="xtk-new" type="number" value="125" class="border rounded p-2" placeholder="New">
          </div>
          <div id="xtk-pc" class="text-lg font-bold text-indigo-700">+25.0%</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">CAGR</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <input id="xtk-beg" type="number" value="100" class="border rounded p-2" placeholder="Start">
            <input id="xtk-end" type="number" value="200" class="border rounded p-2" placeholder="End">
            <input id="xtk-yrs" type="number" value="3" class="border rounded p-2" placeholder="Years">
          </div>
          <div id="xtk-cagr" class="text-lg font-bold text-indigo-700">25.99%</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">EMI</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <input id="xtk-amt" type="number" value="500000" class="border rounded p-2" placeholder="Amount">
            <input id="xtk-ir" type="number" value="10" class="border rounded p-2" placeholder="Rate %">
            <input id="xtk-mon" type="number" value="60" class="border rounded p-2" placeholder="Months">
          </div>
          <div id="xtk-emi" class="text-lg font-bold text-indigo-700">${moneyFmt.format(calcEmi(500000,10,60))}</div>
        </div>
        <div class="border rounded-lg p-4 bg-slate-50 space-y-3">
          <div class="font-semibold text-slate-700 text-sm">Weighted Average</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <textarea id="xtk-wt" rows="3" class="border rounded p-2 font-mono text-xs" placeholder="value,weight">10,2
20,3
30,1</textarea>
          </div>
          <div id="xtk-wavg" class="text-lg font-bold text-indigo-700">—</div>
        </div>
      </div>
    </div>
  `;
  const recalc = () => {
    const old = +document.getElementById('xtk-old').value;
    const nw = +document.getElementById('xtk-new').value;
    const pc = old ? ((nw-old)/old)*100 : 0;
    document.getElementById('xtk-pc').innerText = `${pc>=0?'+':''}${pc.toFixed(1)}%`;
    const beg = +document.getElementById('xtk-beg').value;
    const end = +document.getElementById('xtk-end').value;
    const yrs = +document.getElementById('xtk-yrs').value;
    const cagr = beg>0 && yrs>0 ? Math.pow(end/beg,1/yrs)-1 : 0;
    document.getElementById('xtk-cagr').innerText = `${(cagr*100).toFixed(2)}%`;
    const emi = calcEmi(+document.getElementById('xtk-amt').value, +document.getElementById('xtk-ir').value, +document.getElementById('xtk-mon').value);
    document.getElementById('xtk-emi').innerText = moneyFmt.format(emi);
    const lines = document.getElementById('xtk-wt').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let num=0, den=0;
    lines.forEach(l=>{
      const p=l.split(',').map(v=>+v.trim());
      if(p.length>=2 && isFinite(p[0]) && isFinite(p[1])){ num += p[0]*p[1]; den += p[1]; }
    });
    document.getElementById('xtk-wavg').innerText = den? (num/den).toFixed(2) : '—';
  };
  ['xtk-old','xtk-new','xtk-beg','xtk-end','xtk-yrs','xtk-amt','xtk-ir','xtk-mon','xtk-wt'].forEach(id=>{
    document.getElementById(id).addEventListener('input', recalc);
  });
  recalc();
}

// Generic Prototype Renderer (for catalog apps)
function renderPrototype(meta) {
    const c = document.getElementById('tool-container');
    c.innerHTML = `
      <div class="max-w-4xl mx-auto bg-white border rounded-xl shadow-sm p-6 space-y-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Prototype</div>
            <h3 class="text-xl font-bold text-slate-900">${meta.title}</h3>
            <p class="text-sm text-slate-600">${meta.shortDescription || ''}</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 text-xs font-semibold px-3 py-1">Coming Soon</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <div class="text-xs font-semibold text-slate-500 mb-2">What it will do</div>
            <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
              ${(meta.usageNotes||[]).map(n => `<li>${n}</li>`).join('') || '<li>Feature list coming soon.</li>'}
            </ul>
          </div>
          <div class="bg-white border border-dashed border-slate-300 rounded-lg p-4">
            <div class="text-xs font-semibold text-slate-500 mb-2">Planned Inputs</div>
            <p class="text-sm text-slate-700">CSV/Manual inputs will mirror the pattern used across other tools (columns, validation, quick summary).</p>
            <div class="mt-3">
              <button class="px-3 py-2 text-xs rounded bg-slate-800 text-white">Design Spec Placeholder</button>
            </div>
          </div>
        </div>
        <div class="text-xs text-slate-500">Note: This is a UX placeholder to reserve the slot as we scale to 100 apps. Full logic will follow the same self-contained pattern.</div>
      </div>
    `;
}
</script>
</body>
</html>
